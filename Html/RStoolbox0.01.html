<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>RStoolbox0.01</title>
<!-- 2014-09-22 Mon 15:18 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="tian" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">RStoolbox0.01</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. cloudMask.R</a></li>
<li><a href="#sec-2">2. estimateSHV.R</a></li>
<li><a href="#sec-3">3. internalFunctions.R</a></li>
<li><a href="#sec-4">4. radCor.R</a></li>
<li><a href="#sec-5">5. readMeta.R</a></li>
<li><a href="#sec-6">6. RStoolbox.R</a></li>
<li><a href="#sec-7">7. spectralIndices.R</a></li>
<li><a href="#sec-8">8. superClass.R</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> cloudMask.R</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Very simple cloud detection for imagery with blue and thermal bands</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">x</span><span style="color: #cccccc;"> RasterBrick or RasterStack with reflectance and brightness temperature OR the mask of a previous run of \code{cloudMask} with \code{returnDiffLayer=TRUE}. </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">threshold</span><span style="color: #cccccc;"> cloud detection threshold. If not provided it will be guessed. Everything *above* this threshold will be considered a cloud pixel (unless it is removed by filtering afterwards).</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">minCloudSize</span><span style="color: #cccccc;"> minimum number of cloud pixels in window</span><span style="color: #daa520;">1</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">windowSize</span><span style="color: #daa520;">1</span><span style="color: #cccccc;"> odd number, rectangular moving window to remove clouds which arre too small (likely artefacts)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">windowSize</span><span style="color: #daa520;">2</span><span style="color: #cccccc;"> odd number, rectangular buffer around cluster centers</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">sanitize</span><span style="color: #cccccc;"> logical. Should small clouds (possibly false positives) be removed by filtering? If \code{TRUE} windowSize</span><span style="color: #daa520;">1</span><span style="color: #cccccc;"> must be specified.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">maskGrowing</span><span style="color: #cccccc;"> logical. Applies simple region-growing (rectangular buffering) to the cloud mask. If \code{TRUE} windowSize</span><span style="color: #daa520;">2</span><span style="color: #cccccc;"> must be specified.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">lowBand</span><span style="color: #cccccc;"> bandname or number for the blue band</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">tirBand</span><span style="color: #cccccc;"> bandname or number for the thermal band</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">plot</span><span style="color: #cccccc;"> logical. Provides plots of the cloud mask for all sub-steps (sanitizing etc.) Helpful to find proper parametrization.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #cccccc;"> logical. Print messages or supress.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">returnDiffLayer</span><span style="color: #cccccc;"> logical. If \code{TRUE}, the difference layer will be returned along with the cloudmask. This option allows to re-use the difference layer in cloudMask.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@note</span><span style="color: #cccccc;"> Typically clouds are cold in the thermal region and have high reflectance in short wavelengths (blue). By differencing the two bands and thresholding a rough cloud mask can be obtained.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> More sophisticated approaches can be found elsewhere, e.g. \link[https://code.google.com/p/fmask/]{fmask}.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> It can make sense to find a suitable threshold on a cropped version of the scene. Also make sure you make use of the \code{returnDiffLayer} argument to save yourself one processing step.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Sanitizing and region growing can be seen as final polishing, i.e. as long as the pure cloud centers are not detected properly, you can turn those two arguments off if they take too long to calculate.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Once your mask detects obvious cloud pixels properly re-enable sanitizing and regionGrowing for fine tuning if desired. Finally, once a suitable threshold is established re-run cloudMask on the whole scene with this threshold and go get a coffee.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@examples</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> \dontrun{</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> ls &lt;- stackMeta("path/to/MTL.txt")</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> ls_cor &lt;- radCor(ls, "path/to/MTL.txt") </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> ls_cmask &lt;-cloudMask(ls_cor, returnDiffLayer = TRUE)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> }</span>
<span style="color: #ff6347;">cloudMask</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(x, threshold, minCloudSize, windowSize<span style="color: #daa520;">1</span> = <span style="color: #daa520;">5</span>, windowSize<span style="color: #daa520;">2</span> = <span style="color: #daa520;">11</span>, maskGrowing = <span style="color: #daa520;">TRUE</span>, sanitize = <span style="color: #daa520;">TRUE</span>, lowBand = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>, tirBand = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">"</span>, plot = <span style="color: #daa520;">TRUE</span>, verbose = <span style="color: #daa520;">TRUE</span>, returnDiffLayer = <span style="color: #daa520;">FALSE</span>){

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Set-up graphics device</span>
        op <span style="color: #ff00ff;">&lt;-</span> par(mfrow = c(<span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span> + sum(sanitize, maskGrowing)))

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calculate or re-reuse cloud difference layer </span>
        <span style="color: #00ffff;">if</span>(<span style="color: #00ff00;">"CDIFF"</span> %<span style="color: #00ffff;">in</span>% names(x)) {
                <span style="color: #00ffff;">if</span>(verbose) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Re-using CDIFF layer from previous run."</span>)
                cdiff <span style="color: #ff00ff;">&lt;-</span> x[[<span style="color: #00ff00;">"CDIFF"</span>]]
        } <span style="color: #00ffff;">else</span> {
                cdiff <span style="color: #ff00ff;">&lt;-</span> x[[lowBand]] - x[[tirBand]]
                names(cdiff) <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"CDIFF"</span>
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Guess threshold</span>
        <span style="color: #00ffff;">if</span>(missing(threshold)) {
                threshold <span style="color: #ff00ff;">&lt;-</span> quantile(cdiff@data@max:cdiff@data@min, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">45</span>)
                <span style="color: #00ffff;">if</span>(verbose) {<span style="color: #00ffff;">message</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Estimated cloud threshold should be between "</span>, round(cdiff@data@min), <span style="color: #00ff00;">" and "</span>, round(cdiff@data@max)) )
                        <span style="color: #00ffff;">message</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Guessed threshold (rounded): "</span>, round(threshold)))
                }
        }
        <span style="color: #00ffff;">if</span>(threshold &lt; cdiff@data@min | threshold &gt; cdiff@data@max) <span style="color: #00ffff;">warning</span>(<span style="color: #00ff00;">"Threshold is not within the estimated data range"</span>, call. = <span style="color: #daa520;">FALSE</span>)

        <span style="color: #00ffff;">if</span>(plot) plot(cdiff, main = <span style="color: #00ff00;">"Cloud layer: blue - tir difference"</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Thresholding</span>
        <span style="color: #00ffff;">if</span>(verbose) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Begin thresholding"</span>)
        cmask <span style="color: #ff00ff;">&lt;-</span> cdiff &gt; threshold
        cmask <span style="color: #ff00ff;">&lt;-</span> mask(cmask, cmask, maskvalue = <span style="color: #daa520;">0</span>)

        <span style="color: #00ffff;">if</span>(plot) plot(cmask, main = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Cloud mask\nThreshold: "</span>, threshold))


        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Remove "clouds" smaller than minCloudSize</span>
        <span style="color: #00ffff;">if</span>(sanitize) {
                <span style="color: #00ffff;">if</span>(verbose) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Begin sanitzing"</span>)
                <span style="color: #00ffff;">if</span>(missing(minCloudSize)) minCloudSize <span style="color: #ff00ff;">&lt;-</span> windowSize<span style="color: #daa520;">1</span> ^ <span style="color: #daa520;">2</span>
                w <span style="color: #ff00ff;">&lt;-</span> matrix(ncol = windowSize<span style="color: #daa520;">1</span>, nrow = windowSize<span style="color: #daa520;">1</span>, <span style="color: #daa520;">1</span>)
                <span style="color: #00ffff;">if</span>(minCloudSize &gt;= windowSize^<span style="color: #daa520;">2</span>) {
                        cmod <span style="color: #ff00ff;">&lt;-</span> focal(cmask, w, na.rm = <span style="color: #daa520;">FALSE</span>)
                } <span style="color: #00ffff;">else</span> {
                        cmod <span style="color: #ff00ff;">&lt;-</span> focal(cmask, w, na.rm = <span style="color: #daa520;">TRUE</span>)   
                        cmod[cmod &lt; minCloudSize] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>         
                }
                cmod[cmod &lt; minCloudSize] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                cmod[!is.na(cmod)] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>L
                <span style="color: #00ffff;">if</span>(plot) plot(cmod, main = <span style="color: #00ff00;">"Sanitized cloud mask"</span>)

        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Buffer cloud centers (we could also do a circular buffer, but for now this should suffice)</span>
        <span style="color: #00ffff;">if</span>(maskGrowing){
                <span style="color: #00ffff;">if</span>(verbose) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Begin region-growing"</span>)
                w <span style="color: #ff00ff;">&lt;-</span> matrix(ncol = windowSize<span style="color: #daa520;">2</span>, nrow = windowSize<span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span>)
                cmod <span style="color: #ff00ff;">&lt;-</span> focal(cmod, w, na.rm = <span style="color: #daa520;">TRUE</span> )
                cmod[!is.na(cmod)] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>L
                <span style="color: #00ffff;">if</span>(plot) plot(cmod, main = <span style="color: #00ff00;">"Region-grown cloud mask"</span>)

        }

        <span style="color: #00ffff;">if</span>(plot){
                plotRGB(x, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, title = <span style="color: #00ff00;">"Final mask"</span>, stretch = <span style="color: #00ff00;">"lin"</span>)
                plot(cmod,  legend = <span style="color: #daa520;">FALSE</span>, add = T, col = <span style="color: #00ff00;">"yellow"</span>)
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Reset par</span>
        par(op)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Return</span>
        names(cmod) <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"CMASK"</span>
        <span style="color: #00ffff;">if</span>(returnDiffLayer) cmod <span style="color: #ff00ff;">&lt;-</span> stack(cmod, cdiff)
        <span style="color: #00ffff;">return</span>(cmod)    
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> estimateSHV.R</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Estimate image haze for dark object subtraction procedures</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">x</span><span style="color: #cccccc;"> raster object or a previous result from \code{estimateSHV(x , returnTables = TRUE} from which to estimate haze</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">band</span><span style="color: #cccccc;"> character. Band or bandname from which to estimate SHV (optinal if x contains only one layer)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">darkProp</span><span style="color: #cccccc;"> proportion of pixels estimated to be dark</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">plot</span><span style="color: #cccccc;"> display histograms and haze values</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">returnTables</span><span style="color: #cccccc;"> return the frequency table per layer. Only takes effect if x is a Raster* object. If x is a result of estimateSHV tables will always be returned.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span><span style="color: #cccccc;"> </span>
<span style="color: #ff6347;">estimateSHV</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(x, hazeBand, darkProp = <span style="color: #daa520;">0</span>.<span style="color: #daa520;">02</span>, plot = <span style="color: #daa520;">FALSE</span>, returnTables = <span style="color: #daa520;">TRUE</span>) {

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Initial or repeated run?</span>
        <span style="color: #00ffff;">if</span>(inherits(x, <span style="color: #00ff00;">"Raster"</span>)) {
                preCalc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        } <span style="color: #00ffff;">else</span> {
                <span style="color: #00ffff;">if</span>(is.list(x) &amp; <span style="color: #00ff00;">"table"</span> %<span style="color: #00ffff;">in</span>% names(x)) {
                        preCalc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span> 
                } <span style="color: #00ffff;">else</span> {
                        <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"x must be a Raster* object or the result of a previous run of estimateSHV(Raster*, ) with argument 'returnTables = TRUE'"</span>, call. = <span style="color: #daa520;">FALSE</span>)
                }       
        }

        <span style="color: #00ffff;">if</span>(!preCalc){
                <span style="color: #00ffff;">if</span>(missing(hazeBand)){ 
                        <span style="color: #00ffff;">if</span>(nlayers(x) == <span style="color: #daa520;">1</span>) {
                                hazeBand <span style="color: #ff00ff;">&lt;-</span> names(x)        
                        } <span style="color: #00ffff;">else</span> {
                                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Please specify the band from which you want to estimate the haze dn"</span>)
                        }       
                        <span style="color: #00ffff;">if</span>(is.numeric(hazeBand)) hazeBand <span style="color: #ff00ff;">&lt;-</span> names(x)[hazeBand]
                }

        } <span style="color: #00ffff;">else</span> {

                <span style="color: #00ffff;">if</span>(is.numeric(hazeBand)) hazeBand <span style="color: #ff00ff;">&lt;-</span> names(x$table)[hazeBand]
                preCalcAvail <span style="color: #ff00ff;">&lt;-</span> hazeBand %<span style="color: #00ffff;">in</span>% names(x$table)
                <span style="color: #00ffff;">if</span>(!any(preCalcAvail))  <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Cannot estimate SHV because tables are missing for all specified bands"</span>, call. = <span style="color: #daa520;">FALSE</span>)

                <span style="color: #00ffff;">if</span>(any(!preCalcAvail)) {
                        <span style="color: #00ffff;">warning</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Cannot estimate SHV for &gt;&gt; "</span>, hazeBand[!preCalcAvail], <span style="color: #00ff00;">" &lt;&lt; because tables are missing."</span>), call. = <span style="color: #daa520;">FALSE</span>)
                        hazeBand <span style="color: #ff00ff;">&lt;-</span> hazeBand[preCalcAvail]                              
                }       
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Decide whether we open multiple devices</span>
        multiple <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(length(hazeBand) &gt; <span style="color: #daa520;">1</span>) <span style="color: #daa520;">TRUE</span> <span style="color: #00ffff;">else</span> <span style="color: #daa520;">FALSE</span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Run estimation for each band separately</span>
        out   <span style="color: #ff00ff;">&lt;-</span> lapply(hazeBand, <span style="color: #00ffff;">function</span>(bi) {
                                <span style="color: #00ffff;">if</span>(inherits(x, <span style="color: #00ff00;">"Raster"</span>)) {
                                        tf <span style="color: #ff00ff;">&lt;-</span> freq(x[[bi]], useNA = <span style="color: #00ff00;">"no"</span>) 
                                } <span style="color: #00ffff;">else</span> {
                                        <span style="color: #00ffff;">if</span>(is.list(x) &amp; <span style="color: #00ff00;">"table"</span> %<span style="color: #00ffff;">in</span>% names(x)) {
                                                preCalc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
                                                tf <span style="color: #ff00ff;">&lt;-</span> x$table[[bi]]
                                        } <span style="color: #00ffff;">else</span> {
                                                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"x must be a Raster* object or the result of a previous run of estimateSHV() with argument 'returnTables = TRUE'"</span>, call. = <span style="color: #daa520;">FALSE</span>)
                                        }
                                }
                                tf <span style="color: #ff00ff;">&lt;-</span> tf[tf[,<span style="color: #daa520;">1</span>] &gt; <span style="color: #daa520;">0</span>,]
                                tf[,<span style="color: #daa520;">2</span>] <span style="color: #ff00ff;">&lt;-</span> tf[,<span style="color: #daa520;">2</span>]/sum(tf[,<span style="color: #daa520;">2</span>])
                                dtf <span style="color: #ff00ff;">&lt;-</span> c(diff(tf[,<span style="color: #daa520;">2</span>]),<span style="color: #daa520;">0</span>) / c(diff(tf[,<span style="color: #daa520;">1</span>]),<span style="color: #daa520;">0</span>)

                                SHV <span style="color: #ff00ff;">&lt;-</span> tf[which(dtf &gt; darkProp)[<span style="color: #daa520;">1</span>], <span style="color: #daa520;">1</span>] 
                                <span style="color: #00ffff;">if</span>(is.na(SHV)) <span style="color: #00ffff;">warning</span>(paste(<span style="color: #00ff00;">"darkProp for band"</span>, bi, <span style="color: #00ff00;">"was chosen too high. It exceeds the value range."</span>), call. = <span style="color: #daa520;">FALSE</span>)

                                <span style="color: #00ffff;">if</span>(plot){
                                        <span style="color: #00ffff;">if</span>(multiple) x<span style="color: #daa520;">11</span>()
                                        par(mfrow = c(<span style="color: #daa520;">1</span>,<span style="color: #daa520;">2</span>))

                                        plot(tf, xlab = <span style="color: #00ff00;">"DN"</span>, ylab = <span style="color: #00ff00;">"Frequency"</span>, type = <span style="color: #00ff00;">"l"</span>, main = bi)
                                        abline(v = tf[tf[,<span style="color: #daa520;">1</span>]==SHV,<span style="color: #daa520;">1</span>], col=<span style="color: #00ff00;">"red"</span>)
                                        text(SHV, max(tf[,<span style="color: #daa520;">2</span>]), pos=<span style="color: #daa520;">4</span>, label = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"SHV_DN = "</span>, SHV), col =<span style="color: #00ff00;">"red"</span>)

                                        plot(dtf, type=<span style="color: #00ff00;">"l"</span>, xlab = <span style="color: #00ff00;">"DN"</span>, ylab = <span style="color: #00ff00;">"diff(Frequency)"</span>, main = bi)
                                        abline(v = tf[tf[,<span style="color: #daa520;">1</span>]==SHV,<span style="color: #daa520;">1</span>], col=<span style="color: #00ff00;">"red"</span>)
                                        abline(h = darkProp, col = <span style="color: #00ff00;">"#</span><span style="color: #daa520;">00000070</span><span style="color: #00ff00;">"</span>, lty = <span style="color: #daa520;">2</span>)
                                        text(max(tf[,<span style="color: #daa520;">1</span>]), darkProp, label = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"darkProp = "</span>, darkProp), col = <span style="color: #00ff00;">"#</span><span style="color: #daa520;">00000070</span><span style="color: #00ff00;">"</span>)
                                        text(SHV, max(dtf, na.rm = <span style="color: #daa520;">TRUE</span>), pos=<span style="color: #daa520;">4</span>, label = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"SHV_DN = "</span>, SHV), col =<span style="color: #00ff00;">"red"</span>)

                                }

                                <span style="color: #00ffff;">return</span>(list(table = tf, SHV = SHV))
                        })

        SHV <span style="color: #ff00ff;">&lt;-</span> unlist(sapply(out, <span style="color: #00ff00;">"["</span>, <span style="color: #daa520;">2</span>))
        names(SHV) <span style="color: #ff00ff;">&lt;-</span> hazeBand

        <span style="color: #00ffff;">if</span>(!preCalc){
                table <span style="color: #ff00ff;">&lt;-</span> sapply(out, <span style="color: #00ff00;">"["</span>, <span style="color: #daa520;">1</span>)
                names(table) <span style="color: #ff00ff;">&lt;-</span> hazeBand
        } <span style="color: #00ffff;">else</span> {
                table <span style="color: #ff00ff;">&lt;-</span> x$table
        }
        <span style="color: #00ffff;">return</span>( <span style="color: #00ffff;">if</span>(!returnTables) SHV <span style="color: #00ffff;">else</span> list(SHV=SHV, table = table))
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> internalFunctions.R</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Estimates Earth-Sun distance (in AU) for a given date </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Function taken from the landsat package: S. Goslee (</span><span style="color: #daa520;">2012</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">adate</span><span style="color: #cccccc;"> character. date in format "YYYY-MM-DD"</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@keywords</span><span style="color: #cccccc;"> internal</span>
<span style="color: #ff6347;">.ESdist</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(adate){     
        edist <span style="color: #ff00ff;">&lt;-</span> julian(as.Date(adate), origin=as.Date(paste(substring(adate, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">4</span>), <span style="color: #00ff00;">"</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">"</span>, <span style="color: #00ff00;">"</span><span style="color: #daa520;">31</span><span style="color: #00ff00;">"</span>, sep=<span style="color: #00ff00;">"-"</span>)))[[<span style="color: #daa520;">1</span>]]
         <span style="color: #daa520;">1</span> - <span style="color: #daa520;">0</span>.<span style="color: #daa520;">016729</span> * cos((<span style="color: #daa520;">2</span>*pi) * (<span style="color: #daa520;">0</span>.<span style="color: #daa520;">9856</span> * (edist - <span style="color: #daa520;">4</span>)/<span style="color: #daa520;">360</span>))
}


<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Extract numbers from strings</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">x</span><span style="color: #cccccc;"> string or vector of strings</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">returnNumeric</span><span style="color: #cccccc;"> logical. should results be formatted \code{as.numeric}? If so, "</span><span style="color: #daa520;">05</span><span style="color: #cccccc;">" will be converted to </span><span style="color: #daa520;">5</span><span style="color: #cccccc;">. Set returnNumeric to \code{FALSE} to keep preceeding zeros.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@note</span><span style="color: #cccccc;"> decimal numbers will be returned as two separate numbers</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@keywords</span><span style="color: #cccccc;"> internal</span>
<span style="color: #ff6347;">.getNumeric</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(x, returnNumeric = <span style="color: #daa520;">TRUE</span>) {
        sapply(x, <span style="color: #00ffff;">function</span>(xi){
                                d <span style="color: #ff00ff;">&lt;-</span> strsplit(xi, <span style="color: #00ff00;">"[^[:digit:]]"</span>)[[<span style="color: #daa520;">1</span>]]
                                d <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(returnNumeric) as.numeric(d[d!=<span style="color: #00ff00;">""</span>]) <span style="color: #00ffff;">else</span> d[d!=<span style="color: #00ff00;">""</span>]
                                d
                        })
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> radCor.R</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Radiometric calibration and correction</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Implements several different methods for absolute radiometric correction of Landsat data.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> You can either specify a metadata file, or supply all neccesary values manually. With proper parametrization APREF and SDOS should work for other sensors as well.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">x</span><span style="color: #cccccc;"> raster object</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">metaData</span><span style="color: #cccccc;"> either the result of \code{readMeta} or a path to the meta data (MCL) file. </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">reflectance</span><span style="color: #cccccc;"> logical. If \code{TRUE} output will be reflectance, if \code{FALSE} it will be radiance</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">thermal</span><span style="color: #cccccc;"> logical. If \code{TRUE} thermal bands will be converted to brightness temperature (Kelvin).</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">bandSet</span><span style="color: #cccccc;"> numeric or character. original Landsat band numbers or names in the form of ("B</span><span style="color: #daa520;">1</span><span style="color: #cccccc;">", "B</span><span style="color: #daa520;">2</span><span style="color: #cccccc;">" etc). If set to 'full' all bands in the solar region will be processed.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">gain</span><span style="color: #cccccc;"> Band-specific sensor gain. Require either gain and offset or Grescale and Brescale to convert DN to radiance.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">offset</span><span style="color: #cccccc;"> Band-specific sensor offset. Require either gain and offset or Grescale and Brescale to convert DN to radiance.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">Grescale</span><span style="color: #cccccc;"> Band-specific sensor Grescale (gain). Require either gain and offset or Grescale and Brescale to convert DN to radiance.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">Brescale</span><span style="color: #cccccc;"> Band-specific sensor Brescale (bias). Require either gain and offset or Grescale and Brescale to convert DN to radiance.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">sunElev</span><span style="color: #cccccc;"> Sun elevation in degrees</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">satZenith</span><span style="color: #cccccc;"> sensor zenith angle (</span><span style="color: #daa520;">0</span><span style="color: #cccccc;"> for Landsat)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">d</span><span style="color: #cccccc;"> Earth-Sun distance in AU.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">esun</span><span style="color: #cccccc;"> Mean exo-atmospheric solar irradiance, as given by Chandler et al. </span><span style="color: #daa520;">2009</span><span style="color: #cccccc;"> or others.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">SHV</span><span style="color: #cccccc;"> starting haze value, can be estimated using estimateSHV(). if not provided and method is "DOS" or "COSTZ" SHV will be estimated in an automated fashion. Not needed for apparent reflectance.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">hazeBand</span><span style="color: #cccccc;"> band from which SHV was estimated.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">method</span><span style="color: #cccccc;"> Radiometric correction method to be used. There are currently four methods available (see Details):</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;">  "APREF", "DOS" (Chavez </span><span style="color: #daa520;">1989</span><span style="color: #cccccc;">), "COSTZ" (Chavez </span><span style="color: #daa520;">1996</span><span style="color: #cccccc;">), SDOS.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@note</span><span style="color: #cccccc;"> This was originally a fork of randcorr in the landsat package. It may be slower, however it works on Raster* objects and hence is memory-safe.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@details</span><span style="color: #cccccc;">  \describe{</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> \item{APREF}{Apparent reflectance}</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> \item{DOS}{Dark object subtratction following Chavez (</span><span style="color: #daa520;">1989</span><span style="color: #cccccc;">)}</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> \item{COSTZ}{Dark object subtraction following Chaves(</span><span style="color: #daa520;">1996</span><span style="color: #cccccc;">)}</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> \item{SDOS}{Simple dark object subtraction. Classical DOS, Lhaze must be estimated for each band separately.}</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> }</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@references</span><span style="color: #cccccc;"> S. Goslee (</span><span style="color: #daa520;">2011</span><span style="color: #cccccc;">): Analyzing Remote Sensing Data in R: The landsat Package. Journal of Statistical Software </span><span style="color: #daa520;">43</span><span style="color: #cccccc;">(</span><span style="color: #daa520;">4</span><span style="color: #cccccc;">).</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@seealso</span><span style="color: #cccccc;"> \link[landsat]{radiocorr} </span>
<span style="color: #ff6347;">radCor</span> <span style="color: #ff00ff;">&lt;-</span>       <span style="color: #00ffff;">function</span>(x, metaData, reflectance = <span style="color: #daa520;">TRUE</span>, thermal = <span style="color: #daa520;">TRUE</span>, satellite, bandSet = <span style="color: #00ff00;">"full"</span>, gain, offset, G_rescale, B_rescale,
                sunElev, satZenith = <span style="color: #daa520;">0</span>, d, esun, date, SHV, hazeBand, atHaze,  method = <span style="color: #00ff00;">"APREF"</span>){
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">http://landsat.usgs.gov/Landsat</span><span style="color: #daa520;">8</span><span style="color: #cccccc;">_Using_Product.php</span>

        <span style="color: #00ffff;">if</span>(!method %<span style="color: #00ffff;">in</span>% c(<span style="color: #00ff00;">"APREF"</span>, <span style="color: #00ff00;">"DOS"</span>, <span style="color: #00ff00;">"COSTZ"</span>, <span style="color: #00ff00;">"SDOS"</span>)) <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"method must be one of 'APREF', 'DOS', 'COSTZ' 'SDOS'"</span>, call.=<span style="color: #daa520;">FALSE</span>)

        <span style="color: #00ffff;">if</span>(!reflectance &amp; method != <span style="color: #00ff00;">"APREF"</span>){
                <span style="color: #00ffff;">warning</span>(<span style="color: #00ff00;">"For radiance calculations the 'method' argument is ignored"</span>)
                method <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"APREF"</span>
        }

        <span style="color: #00ffff;">if</span>(!missing(metaData)) {

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Read metadata from file</span>
                <span style="color: #00ffff;">if</span>(is.character(metaData)) metaData <span style="color: #ff00ff;">&lt;-</span> readMeta(metaData)

                satellite       <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$SPACECRAFT_ID
                sensor          <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$SENSOR_ID
                B_rescale       <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$RAD_OFFSET
                G_rescale       <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$RAD_GAIN
                d                       <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$EARTH_SUN_DISTANCE
                sunElev         <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$SUN_ELEVATION
                rad             <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$RADIOMETRIC_RES
                K<span style="color: #daa520;">1</span>                      <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$K<span style="color: #daa520;">1</span>
                K<span style="color: #daa520;">2</span>                      <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$K<span style="color: #daa520;">2</span>

        } <span style="color: #00ffff;">else</span> {
                <span style="color: #cccccc;">###  </span><span style="color: #cccccc;">FIXME: HARD CODED !!</span>
                sensor = <span style="color: #daa520;">1</span>
                rad = <span style="color: #daa520;">8</span>
                <span style="color: #cccccc;">###</span>
                <span style="color: #00ffff;">if</span>(missing(G_rescale) | missing(B_rescale)){
                        <span style="color: #00ffff;">if</span>(missing(offset) | missing(gain)) {
                                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Please specify either a) metaData, b) gain and offset, c) B_rescale and G_rescale"</span>, call. = <span style="color: #daa520;">FALSE</span> )
                        } <span style="color: #00ffff;">else</span> {
                                B_rescale <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>/gain
                                G_rescale <span style="color: #ff00ff;">&lt;-</span> -offset/gain
                        }
                }


                <span style="color: #00ffff;">if</span>(missing(d)) {
                        <span style="color: #00ffff;">if</span>(missing(date)) { 
                                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Please specify either a) edist or b)date"</span>, call. = <span style="color: #daa520;">FALSE</span>) 
                        } <span style="color: #00ffff;">else</span> {
                                d <span style="color: #ff00ff;">&lt;-</span> .ESdist(date) 
                        }
                }
        }

        <span style="color: #00ffff;">if</span>(satellite == <span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">"</span> &amp; method != <span style="color: #00ff00;">"APREF"</span>) {
                <span style="color: #00ffff;">warning</span>(<span style="color: #00ff00;">"DOS, COSTZ and SDOS are currently not implemented for Landsat </span><span style="color: #daa520;">8</span><span style="color: #00ff00;">. Using official reflectance calibration coefficients, i.e. output corresponds to method = 'APREF'"</span>, call. = <span style="color: #daa520;">FALSE</span>) 
                method <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"APREF"</span>
        }

        satZenith       <span style="color: #ff00ff;">&lt;-</span> satZenith * pi / <span style="color: #daa520;">180</span>
        satphi          <span style="color: #ff00ff;">&lt;-</span> cos(satZenith)
        suntheta        <span style="color: #ff00ff;">&lt;-</span> cos((<span style="color: #daa520;">90</span> - sunElev) * pi / <span style="color: #daa520;">180</span>)       

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Query internal db    </span>
        sDB <span style="color: #ff00ff;">&lt;-</span> LANDSAT.db[[satellite]][[sensor]]

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">We use .getNumeric to deal with band name appendices (e.g. LS</span><span style="color: #daa520;">7</span><span style="color: #cccccc;"> can have to versions of band </span><span style="color: #daa520;">6</span><span style="color: #cccccc;">: B</span><span style="color: #daa520;">6</span><span style="color: #cccccc;">_VCID_</span><span style="color: #daa520;">1</span><span style="color: #cccccc;"> and B</span><span style="color: #daa520;">6</span><span style="color: #cccccc;">_VCID_</span><span style="color: #daa520;">2</span>
        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">which would not match the database name B</span><span style="color: #daa520;">6</span>
        sDB     <span style="color: #ff00ff;">&lt;-</span> sDB[match(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, sapply(.getNumeric(names(x)),<span style="color: #00ff00;">"["</span>,<span style="color: #daa520;">1</span>)), sDB$band),]      
        sDB             <span style="color: #ff00ff;">&lt;-</span> sDB[match(sDB$band, paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>,sapply(.getNumeric(names(x)),<span style="color: #00ff00;">"["</span>,<span style="color: #daa520;">1</span>))),]

        <span style="color: #00ffff;">if</span>(any(bandSet == <span style="color: #00ff00;">"full"</span>)) {
                bandSet <span style="color: #ff00ff;">&lt;-</span> names(x)
        } <span style="color: #00ffff;">else</span> {
                <span style="color: #00ffff;">if</span>(is.numeric(bandSet)) bandSet <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, bandSet)
        }       

        <span style="color: #00ffff;">if</span>(missing(metaData))   names(B_rescale) <span style="color: #ff00ff;">&lt;-</span> names(G_rescale) <span style="color: #ff00ff;">&lt;-</span> bandSet

        origBands       <span style="color: #ff00ff;">&lt;-</span> names(x)   
        corBands        <span style="color: #ff00ff;">&lt;-</span> sDB[!sDB$bandtype %<span style="color: #00ffff;">in</span>% c(<span style="color: #00ff00;">"TIR"</span>, <span style="color: #00ff00;">"PAN"</span>), <span style="color: #00ff00;">"band"</span>]
        bandSet         <span style="color: #ff00ff;">&lt;-</span> bandSet[bandSet %<span style="color: #00ffff;">in</span>% corBands]
        <span style="color: #00ffff;">if</span>(thermal){
                tirBands        <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(satellite==<span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">"</span>) c(<span style="color: #00ff00;">"B</span><span style="color: #daa520;">10</span><span style="color: #00ff00;">"</span>, <span style="color: #00ff00;">"B</span><span style="color: #daa520;">11</span><span style="color: #00ff00;">"</span>) <span style="color: #00ffff;">else</span> c(<span style="color: #00ff00;">"B</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">"</span>, <span style="color: #00ff00;">"B</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">_VCID_</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>, <span style="color: #00ff00;">"B</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">_VCID_</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">"</span>)     
                tirBands        <span style="color: #ff00ff;">&lt;-</span> origBands[origBands %<span style="color: #00ffff;">in</span>% tirBands]
        } <span style="color: #00ffff;">else</span> {
                tirBands <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
        }
        exclBands       <span style="color: #ff00ff;">&lt;-</span> origBands[!origBands %<span style="color: #00ffff;">in</span>% c(bandSet, tirBands)]

        <span style="color: #00ffff;">if</span>(length(exclBands) &gt; <span style="color: #daa520;">0</span>) {
                xexc <span style="color: #ff00ff;">&lt;-</span> x[[exclBands]] 
        } <span style="color: #00ffff;">else</span> {
                xexc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
        }

        <span style="color: #00ffff;">if</span>(missing(esun)) {
                esun <span style="color: #ff00ff;">&lt;-</span> sDB[,<span style="color: #00ff00;">"esun"</span>] 
                names(esun) <span style="color: #ff00ff;">&lt;-</span> sDB$band
        }
        xref <span style="color: #ff00ff;">&lt;-</span> x[[bandSet]]

        <span style="color: #00ffff;">if</span>(reflectance) {
                <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Bands to convert to reflectance: "</span>, paste(bandSet, collapse = <span style="color: #00ff00;">", "</span>))
                <span style="color: #00ffff;">if</span>(length(tirBands) &gt; <span style="color: #daa520;">0</span> &amp; thermal) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Thermal bands to convert to brightness temperatures: "</span>, paste(tirBands, collapse=<span style="color: #00ff00;">", "</span>))
                <span style="color: #00ffff;">if</span>(length(exclBands) &gt; <span style="color: #daa520;">0</span>) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Excluding bands: "</span>, paste(exclBands, collapse = <span style="color: #00ff00;">", "</span>))       
        } <span style="color: #00ffff;">else</span> {
                bandSet <span style="color: #ff00ff;">&lt;-</span> c(bandSet, tirBands)
                <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Bands to convert to toa radiance: "</span>, paste(bandSet, collapse = <span style="color: #00ff00;">", "</span>))
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Thermal processing</span>
        <span style="color: #00ffff;">if</span>(thermal &amp; reflectance &amp; length(tirBands) &gt; <span style="color: #daa520;">0</span>) {
                <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Processing thermal band(s)"</span>)
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Convert to radiance</span>
                L <span style="color: #ff00ff;">&lt;-</span> G_rescale[tirBands] * x[[tirBands]] + B_rescale[tirBands]
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Convert to temperature</span>
                xtir <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #daa520;">2</span> / log(K<span style="color: #daa520;">1</span>/L + <span style="color: #daa520;">1</span>) 
                names(xtir) <span style="color: #ff00ff;">&lt;-</span> tirBands
        } <span style="color: #00ffff;">else</span> {
                xtir <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
        }

        <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Processing radiance / reflectance"</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Radiance and reflectance processing</span>
        <span style="color: #00ffff;">if</span>(method == <span style="color: #00ff00;">"APREF"</span>) {
                TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                TAUv <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
                Lhaze <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>

        } <span style="color: #00ffff;">else</span> {

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Estimate SHV automatically</span>
                <span style="color: #00ffff;">if</span>(missing(SHV)){
                        <span style="color: #00ffff;">if</span>(missing(hazeBand))  hazeBand <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"B</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>
                        <span style="color: #00ffff;">if</span>(length(hazeBand) &gt; <span style="color: #daa520;">1</span>) {
                                <span style="color: #00ffff;">warning</span>(<span style="color: #00ff00;">"Automatic search for SHV values is intended for one band only. For more bands please estimate hzae DNs manually using estimateSHV() \nhazeBand was automatically reset to </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>)
                                hazeBand <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span> }
                        <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"SHV was not provided -&gt; Estimating SHV automatically"</span>)
                        dP <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">02</span>
                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">We suppress warnings because we search for a possible value autimatically in case we missed the first time</span>
                        SHV <span style="color: #ff00ff;">&lt;-</span> suppressWarnings(estimateSHV(x, hazeBand = hazeBand, darkProp = dP , plot = <span style="color: #daa520;">FALSE</span>, returnTables = <span style="color: #daa520;">TRUE</span>))
                        <span style="color: #00ffff;">while</span>(is.na(SHV[[<span style="color: #daa520;">1</span>]])){
                                dP      <span style="color: #ff00ff;">&lt;-</span> dP * <span style="color: #daa520;">0</span>.<span style="color: #daa520;">9</span>
                                SHV <span style="color: #ff00ff;">&lt;-</span> suppressWarnings(estimateSHV(SHV, hazeBand = hazeBand, darkProp = dP, plot = <span style="color: #daa520;">FALSE</span>, returnTables = <span style="color: #daa520;">TRUE</span>))
                        }
                        <span style="color: #00ffff;">message</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"SHV estimated as: "</span>, SHV[[<span style="color: #daa520;">1</span>]]))
                        SHV <span style="color: #ff00ff;">&lt;-</span> SHV[[<span style="color: #daa520;">1</span>]]
                }


                <span style="color: #cccccc;"># </span><span style="color: #cccccc;">For SDOS gain, offset, Lhaze and Esun must be provided as coresponding vectors of equal length</span>
                <span style="color: #00ffff;">if</span>(method == <span style="color: #00ff00;">"SDOS"</span>) hazeBand <span style="color: #ff00ff;">&lt;-</span> bandSet 
                TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                TAUv <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>                              
                <span style="color: #00ffff;">if</span> (method == <span style="color: #00ff00;">"COSTZ"</span>) {
                        TAUz <span style="color: #ff00ff;">&lt;-</span> suntheta
                        TAUv <span style="color: #ff00ff;">&lt;-</span> satphi
                }  

                <span style="color: #cccccc;">## </span><span style="color: #daa520;">1</span><span style="color: #cccccc;">% correction and conversion to radiance</span>
                Ldo <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">01</span> * ((esun[hazeBand] * suntheta * TAUz) + Edown) * TAUv / (pi * d ^ <span style="color: #daa520;">2</span>)
                Lhaze <span style="color: #ff00ff;">&lt;-</span> (SHV * G_rescale[hazeBand] + B_rescale[hazeBand]) - Ldo

                <span style="color: #00ffff;">if</span>(method %<span style="color: #00ffff;">in</span>% c(<span style="color: #00ff00;">"DOS"</span>, <span style="color: #00ff00;">"COSTZ"</span>)) {             
                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Pick atmoshpere type</span>
                        <span style="color: #00ffff;">if</span>(missing(atHaze)) {
                                atHaze.db <span style="color: #ff00ff;">&lt;-</span> data.frame(min = c(<span style="color: #daa520;">1</span>,<span style="color: #daa520;">56</span>,<span style="color: #daa520;">76</span>,<span style="color: #daa520;">96</span>,<span style="color: #daa520;">116</span>), max = c(<span style="color: #daa520;">55</span>,<span style="color: #daa520;">75</span>,<span style="color: #daa520;">95</span>,<span style="color: #daa520;">115</span>,<span style="color: #daa520;">255</span>)) / <span style="color: #daa520;">255</span> * (<span style="color: #daa520;">2</span>^rad-<span style="color: #daa520;">1</span>)
                                atHaze <span style="color: #ff00ff;">&lt;-</span> c(<span style="color: #00ff00;">"veryClear"</span>, <span style="color: #00ff00;">"clear"</span>, <span style="color: #00ff00;">"moderate"</span>, <span style="color: #00ff00;">"hazy"</span>, <span style="color: #00ff00;">"veryHazy"</span>)[Lhaze &gt; atHaze.db[,<span style="color: #daa520;">1</span>] &amp; Lhaze &lt;= atHaze.db[,<span style="color: #daa520;">2</span>]]
                                <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Selcting atmosphere: '"</span>, atHaze, <span style="color: #00ff00;">"'"</span>)
                        }               
                        Lhaze     <span style="color: #ff00ff;">&lt;-</span> Lhaze  * sDB[match(bandSet,sDB$band), paste<span style="color: #daa520;">0</span>(hazeBand,<span style="color: #00ff00;">"_"</span>, atHaze)]

                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calculate corrected RAD_haze</span>
                        NORM  <span style="color: #ff00ff;">&lt;-</span> G_rescale[bandSet] / G_rescale[hazeBand]
                        Lhaze <span style="color: #ff00ff;">&lt;-</span> Lhaze * NORM + B_rescale[bandSet]      
                }
                <span style="color: #cccccc;"># </span><span style="color: #cccccc;">In case Lhaze becomes negative we reset it to zero to prevent artefacts.</span>
                Lhaze [Lhaze &lt; <span style="color: #daa520;">0</span>] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        }

        B_rescale       <span style="color: #ff00ff;">&lt;-</span> B_rescale[bandSet]
        G_rescale       <span style="color: #ff00ff;">&lt;-</span> G_rescale[bandSet]
        esun <span style="color: #ff00ff;">&lt;-</span> esun[bandSet]

        <span style="color: #00ffff;">if</span>(satellite != <span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">"</span>){

                <span style="color: #00ffff;">if</span>(!reflectance) {
                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">TOA Radiance</span>
                        xref <span style="color: #ff00ff;">&lt;-</span>  ( xref * G_rescale + B_rescale) / suntheta
                } <span style="color: #00ffff;">else</span> {
                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">At-surface reflectance (precalculate coefficients to speed up raster processing)</span>
                        C <span style="color: #ff00ff;">&lt;-</span> (pi * d ^ <span style="color: #daa520;">2</span>)/(TAUv * (esun * suntheta * TAUz + Edown))     
                        b <span style="color: #ff00ff;">&lt;-</span> C * (B_rescale - Lhaze)
                        a <span style="color: #ff00ff;">&lt;-</span> C * G_rescale 
                        xref <span style="color: #ff00ff;">&lt;-</span>  a * xref  + b
                }

        } <span style="color: #00ffff;">else</span> {

                <span style="color: #00ffff;">if</span>(reflectance) {
                        B_rescale               <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$REF_OFFSET[bandSet]
                        G_rescale               <span style="color: #ff00ff;">&lt;-</span> metaData$UNIFIED_METADATA$REF_GAIN[bandSet]
                } 

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">At sensor radiance / reflectance</span>
                xref <span style="color: #ff00ff;">&lt;-</span>  (G_rescale * xref + B_rescale) / suntheta

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">At-surface reflectance?</span>
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Re-combine thermal, solar and excluded imagery</span>
        x <span style="color: #ff00ff;">&lt;-</span> stack(xref,xtir, xexc)
        x <span style="color: #ff00ff;">&lt;-</span> x[[origBands]]

        <span style="color: #00ffff;">return</span>(x)
}


<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Landsat auxilliary data. Taken from Chander et al </span><span style="color: #daa520;">2009</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> spatRes resampling: http://landsat.usgs.gov/band_designations_landsat_satellites.php</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@keywords</span><span style="color: #cccccc;"> internal</span>
LANDSAT.db <span style="color: #ff00ff;">&lt;-</span> list(
                LANDSAT<span style="color: #daa520;">5</span> = list (
                                TM = data.frame(band = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, <span style="color: #daa520;">1</span>:<span style="color: #daa520;">7</span>),
                                                bandtype = c(rep(<span style="color: #00ff00;">"REF"</span>, <span style="color: #daa520;">5</span>), <span style="color: #00ff00;">"TIR"</span>, <span style="color: #00ff00;">"REF"</span>),
                                                centerWavl = c(<span style="color: #daa520;">0</span>.<span style="color: #daa520;">485</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">569</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">66</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">840</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">676</span>, <span style="color: #daa520;">11</span>.<span style="color: #daa520;">435</span>, <span style="color: #daa520;">2</span>.<span style="color: #daa520;">223</span>),
                                                spatRes<span style="color: #daa520;">1</span> = rep(<span style="color: #daa520;">30</span>, <span style="color: #daa520;">7</span>),
                                                spatRes<span style="color: #daa520;">2</span> = c(rep(<span style="color: #daa520;">30</span>,<span style="color: #daa520;">5</span>), <span style="color: #daa520;">60</span>, <span style="color: #daa520;">30</span>), <span style="color: #cccccc;">## </span><span style="color: #cccccc;">TM Band </span><span style="color: #daa520;">6</span><span style="color: #cccccc;"> was acquired at </span><span style="color: #daa520;">120</span><span style="color: #cccccc;">-meter resolution, but products processed before February </span><span style="color: #daa520;">25</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">2010</span><span style="color: #cccccc;"> are resampled to </span><span style="color: #daa520;">60</span><span style="color: #cccccc;">-meter pixels. Products processed after February </span><span style="color: #daa520;">25</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">2010</span><span style="color: #cccccc;"> are resampled to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">-meter pixels.</span>
                                                esun = c(<span style="color: #daa520;">1983</span>, <span style="color: #daa520;">1796</span>, <span style="color: #daa520;">1536</span>, <span style="color: #daa520;">1031</span>, <span style="color: #daa520;">220</span>, <span style="color: #daa520;">NA</span>, <span style="color: #daa520;">83</span>.<span style="color: #daa520;">44</span>))
                ),
                LANDSAT<span style="color: #daa520;">7</span> = list(
                                ETM = data.frame(band = paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>,<span style="color: #daa520;">1</span>:<span style="color: #daa520;">8</span>),
                                                bandtype = c(rep(<span style="color: #00ff00;">"REF"</span>, <span style="color: #daa520;">5</span>), <span style="color: #00ff00;">"TIR"</span>, <span style="color: #00ff00;">"REF"</span>, <span style="color: #00ff00;">"PAN"</span>),
                                                spatRes<span style="color: #daa520;">1</span> = c(rep(<span style="color: #daa520;">30</span>, <span style="color: #daa520;">7</span>), <span style="color: #daa520;">15</span>),
                                                spatRes<span style="color: #daa520;">2</span> = c(rep(<span style="color: #daa520;">30</span>,<span style="color: #daa520;">5</span>), <span style="color: #daa520;">60</span>, <span style="color: #daa520;">30</span>, <span style="color: #daa520;">15</span>),  <span style="color: #cccccc;">## </span><span style="color: #cccccc;">ETM+ Band </span><span style="color: #daa520;">6</span><span style="color: #cccccc;"> is acquired at </span><span style="color: #daa520;">60</span><span style="color: #cccccc;">-meter resolution. Products processed after February </span><span style="color: #daa520;">25</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">2010</span><span style="color: #cccccc;"> are resampled to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">-meter pixels.</span>
                                                centerWavl = c(<span style="color: #daa520;">0</span>.<span style="color: #daa520;">485</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">560</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">660</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">835</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">650</span>,<span style="color: #daa520;">11</span>.<span style="color: #daa520;">335</span>,<span style="color: #daa520;">2</span>.<span style="color: #daa520;">220</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">706</span>),
                                                esun = c(<span style="color: #daa520;">1997</span>,<span style="color: #daa520;">1812</span>,<span style="color: #daa520;">1533</span>,<span style="color: #daa520;">1039</span>,<span style="color: #daa520;">230</span>.<span style="color: #daa520;">8</span>,<span style="color: #daa520;">NA</span>,<span style="color: #daa520;">84</span>.<span style="color: #daa520;">9</span>,<span style="color: #daa520;">1362</span>)
                                )
                ),
                LANDSAT<span style="color: #daa520;">8</span> = list(
                                OLI_TIRS = data.frame(band = c(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>,<span style="color: #daa520;">1</span>:<span style="color: #daa520;">11</span>), <span style="color: #00ff00;">"BQA"</span>),
                                                bandtype = c(rep(<span style="color: #00ff00;">"REF"</span>, <span style="color: #daa520;">7</span>), <span style="color: #00ff00;">"PAN"</span>, <span style="color: #00ff00;">"REF"</span>, <span style="color: #00ff00;">"TIR"</span>, <span style="color: #00ff00;">"TIR"</span>, <span style="color: #00ff00;">"QA"</span>),
                                                spatRes<span style="color: #daa520;">1</span> = c(rep(<span style="color: #daa520;">30</span>, <span style="color: #daa520;">7</span>), <span style="color: #daa520;">15</span>, rep(<span style="color: #daa520;">30</span>,<span style="color: #daa520;">4</span>)),
                                                spatRes<span style="color: #daa520;">2</span> = c(rep(<span style="color: #daa520;">30</span>, <span style="color: #daa520;">7</span>), <span style="color: #daa520;">15</span>, rep(<span style="color: #daa520;">30</span>,<span style="color: #daa520;">4</span>)),  <span style="color: #cccccc;">## </span><span style="color: #cccccc;">ETM+ Band </span><span style="color: #daa520;">6</span><span style="color: #cccccc;"> is acquired at </span><span style="color: #daa520;">60</span><span style="color: #cccccc;">-meter resolution. Products processed after February </span><span style="color: #daa520;">25</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">2010</span><span style="color: #cccccc;"> are resampled to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">-meter pixels.</span>
                                                centerWavl = c(<span style="color: #daa520;">0</span>.<span style="color: #daa520;">44</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">48</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">56</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">655</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">865</span>,<span style="color: #daa520;">1</span>.<span style="color: #daa520;">61</span>,<span style="color: #daa520;">2</span>.<span style="color: #daa520;">2</span>,<span style="color: #daa520;">0</span>.<span style="color: #daa520;">59</span>,<span style="color: #daa520;">1</span>.<span style="color: #daa520;">37</span>,<span style="color: #daa520;">10</span>.<span style="color: #daa520;">6</span>,<span style="color: #daa520;">11</span>.<span style="color: #daa520;">5</span>, <span style="color: #daa520;">NA</span>), 
                                                esun = c(<span style="color: #daa520;">NA</span>, <span style="color: #daa520;">2067</span>, <span style="color: #daa520;">1893</span>, <span style="color: #daa520;">1603</span>, <span style="color: #daa520;">972</span>.<span style="color: #daa520;">6</span>, <span style="color: #daa520;">245</span>, <span style="color: #daa520;">79</span>.<span style="color: #daa520;">72</span>, <span style="color: #daa520;">NA</span>, <span style="color: #daa520;">399</span>.<span style="color: #daa520;">7</span>, <span style="color: #daa520;">NA</span>, <span style="color: #daa520;">NA</span>, <span style="color: #daa520;">NA</span> ) <span style="color: #cccccc;">## </span><span style="color: #cccccc;">http://www.gisagmaps.com/landsat-</span><span style="color: #daa520;">8</span><span style="color: #cccccc;">-atco/ ##http://landsat.usgs.gov/Landsat</span><span style="color: #daa520;">8</span><span style="color: #cccccc;">_Using_Product.php</span>
                                )
                )

) 

exponents <span style="color: #ff00ff;">&lt;-</span> c(-<span style="color: #daa520;">4</span>, -<span style="color: #daa520;">2</span>, -<span style="color: #daa520;">1</span>, -.<span style="color: #daa520;">7</span>, -.<span style="color: #daa520;">5</span>)
<span style="color: #00ffff;">for</span>(s <span style="color: #00ffff;">in</span> names(LANDSAT.db)){
        bandType                <span style="color: #ff00ff;">&lt;-</span> LANDSAT.db[[s]][[<span style="color: #daa520;">1</span>]][,<span style="color: #00ff00;">"bandtype"</span>] == <span style="color: #00ff00;">"REF"</span>
        centerWavl              <span style="color: #ff00ff;">&lt;-</span> LANDSAT.db[[s]][[<span style="color: #daa520;">1</span>]][bandType, <span style="color: #00ff00;">"centerWavl"</span>] 
        bands                   <span style="color: #ff00ff;">&lt;-</span> LANDSAT.db[[s]][[<span style="color: #daa520;">1</span>]][bandType, <span style="color: #00ff00;">"band"</span>]

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calc Chavez Tab </span><span style="color: #daa520;">1</span>
        TAB<span style="color: #daa520;">1</span>                    <span style="color: #ff00ff;">&lt;-</span> sapply(exponents, <span style="color: #00ffff;">function</span>(x) centerWavl ^ x)
        rownames(TAB<span style="color: #daa520;">1</span>)  <span style="color: #ff00ff;">&lt;-</span> bands
        colnames(TAB<span style="color: #daa520;">1</span>)  <span style="color: #ff00ff;">&lt;-</span> c(<span style="color: #00ff00;">"veryClear"</span>, <span style="color: #00ff00;">"clear"</span>, <span style="color: #00ff00;">"moderate"</span>, <span style="color: #00ff00;">"hazy"</span>, <span style="color: #00ff00;">"veryHazy"</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calc Chavez Tab </span><span style="color: #daa520;">2</span><span style="color: #cccccc;">, but only until SHVB = B</span><span style="color: #daa520;">4</span><span style="color: #cccccc;">, larger wavelengths don't make sense to estimate haze</span>
        TAB<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> lapply(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, <span style="color: #daa520;">1</span>:<span style="color: #daa520;">4</span>), <span style="color: #00ffff;">function</span>(SHVB){ sweep(TAB<span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, TAB<span style="color: #daa520;">1</span>[SHVB,], <span style="color: #00ff00;">"/"</span>)})
        TAB<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> do.call(<span style="color: #00ff00;">"cbind"</span>, TAB<span style="color: #daa520;">2</span>)
        colnames(TAB<span style="color: #daa520;">2</span>) <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(rep(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, <span style="color: #daa520;">1</span>:<span style="color: #daa520;">4</span>), each = <span style="color: #daa520;">5</span>),<span style="color: #00ff00;">"_"</span>, colnames(TAB<span style="color: #daa520;">2</span>))

        LANDSAT.db[[s]][[<span style="color: #daa520;">1</span>]] <span style="color: #ff00ff;">&lt;-</span>  merge(LANDSAT.db[[s]][[<span style="color: #daa520;">1</span>]] , TAB<span style="color: #daa520;">2</span>, by.x = <span style="color: #00ff00;">"band"</span>, by.y = <span style="color: #00ff00;">"row.names"</span>, all.x = <span style="color: #daa520;">TRUE</span>, sort = <span style="color: #daa520;">FALSE</span>)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> readMeta.R</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Read landsat MTL metadata files</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Besides reading metadata, readMeta deals with legacy versions of Landsat metadata files and where possible adds missing information (radiometric gain and offset, earth-sun distance).</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">file</span><span style="color: #cccccc;"> path to Landsat MTL file (...MTL.txt)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">unifiedMetadata</span><span style="color: #cccccc;"> logical. If \code{TRUE} some relevant etadata of Landsat </span><span style="color: #daa520;">5</span><span style="color: #cccccc;">:</span><span style="color: #daa520;">8</span><span style="color: #cccccc;"> are homogenized into a standard format and appended to the original metadata.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@return</span><span style="color: #cccccc;"> Returns a list containing the Metadata of the MTL file, structured by the original grouping.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@import</span><span style="color: #cccccc;"> landsat</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #ff6347;">readMeta</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(file, unifiedMetadata = <span style="color: #daa520;">TRUE</span>){
        <span style="color: #00ffff;">if</span>(!grepl(<span style="color: #00ff00;">"MTL"</span>, file) &amp; !grepl(<span style="color: #00ff00;">"xml"</span>, file)) <span style="color: #00ffff;">warning</span>(<span style="color: #00ff00;">"The Landsat metadata file you have specified looks unusual. Typically the filename contains the string 'MTL' or 'xml'. Are you sure you specified the right file? \n I'll try to read it but check the results!"</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Read mtl file</span>
        metaDataFormat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(grepl(<span style="color: #00ff00;">'xml'</span>, file)) <span style="color: #00ff00;">"XML"</span> <span style="color: #00ffff;">else</span> <span style="color: #00ff00;">"MTL"</span>

        <span style="color: #00ffff;">if</span>(metaDataFormat == <span style="color: #00ff00;">"MTL"</span>) {
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">PROCESS LPS MTL FILES</span>

                meta <span style="color: #ff00ff;">&lt;-</span> read.delim(file, sep = <span style="color: #00ff00;">"="</span>, head = <span style="color: #daa520;">FALSE</span>, stringsAsFactors = <span style="color: #daa520;">FALSE</span>, strip.white = <span style="color: #daa520;">TRUE</span>, skip = <span style="color: #daa520;">1</span>, skipNul = <span style="color: #daa520;">TRUE</span>)
                meta <span style="color: #ff00ff;">&lt;-</span> meta[-(nrow(meta)-c(<span style="color: #daa520;">1</span>,<span style="color: #daa520;">0</span>)),]

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Retrieve groups</span>
                l <span style="color: #ff00ff;">&lt;-</span> meta[grep(<span style="color: #00ff00;">"GROUP"</span>,meta[,<span style="color: #daa520;">1</span>]),]

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Assemble metadata list</span>
                meta <span style="color: #ff00ff;">&lt;-</span> lapply(unique(l[,<span style="color: #daa520;">2</span>]), FUN = <span style="color: #00ffff;">function</span>(x){
                                        w <span style="color: #ff00ff;">&lt;-</span> which(meta[,<span style="color: #daa520;">2</span>] == x)
                                        m <span style="color: #ff00ff;">&lt;-</span> meta[(w[<span style="color: #daa520;">1</span>]+<span style="color: #daa520;">1</span>):(w[<span style="color: #daa520;">2</span>]-<span style="color: #daa520;">1</span>),]
                                        rownames(m) <span style="color: #ff00ff;">&lt;-</span> m[,<span style="color: #daa520;">1</span>]
                                        m <span style="color: #ff00ff;">&lt;-</span> m[ , <span style="color: #daa520;">2</span>, drop = <span style="color: #daa520;">FALSE</span>]
                                        colnames(m) <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"VALUE"</span>
                                        <span style="color: #00ffff;">return</span>(m)
                                })

                names(meta) <span style="color: #ff00ff;">&lt;-</span> unique(l[,<span style="color: #daa520;">2</span>])

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Legacy MTL? </span>
                legacy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"PROCESSING_SOFTWARE"</span> %<span style="color: #00ffff;">in</span>% rownames(meta$PRODUCT_METADATA)
                <span style="color: #00ffff;">if</span>(legacy) <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"This scene was processed before August </span><span style="color: #daa520;">29</span><span style="color: #00ff00;">, </span><span style="color: #daa520;">2012</span><span style="color: #00ff00;">. Using MTL legacy format. Some minor infos such as SCENE_ID will be missing"</span>)

                <span style="color: #00ffff;">if</span>(unifiedMetadata){

                        meta[[<span style="color: #00ff00;">"UNIFIED_METADATA"</span>]] <span style="color: #ff00ff;">&lt;-</span> list(
                                        SPACECRAFT_ID           = {SAT <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"LANDSAT"</span>, .getNumeric(meta$PRODUCT_METADATA[<span style="color: #00ff00;">"SPACECRAFT_ID"</span>,]))},
                                        SENSOR_ID                       = meta$PRODUCT_METADATA[<span style="color: #00ff00;">"SENSOR_ID"</span>,]   ,                       
                                        SCENE_ID                        = meta$METADATA_FILE_INFO[<span style="color: #00ff00;">"LANDSAT_SCENE_ID"</span>,],  <span style="color: #cccccc;">## </span><span style="color: #cccccc;">could assemble name for legacy files: http://landsat.usgs.gov/naming_conventions_scene_identifiers.php</span>
                                        DATA_TYPE                       = <span style="color: #00ffff;">if</span>(!legacy) meta$PRODUCT_METADATA[<span style="color: #00ff00;">"DATA_TYPE"</span>,] <span style="color: #00ffff;">else</span> meta$PRODUCT_METADATA[<span style="color: #00ff00;">"PRODUCT_TYPE"</span>,],
                                        ACQUISITION_DATE        = {date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(!legacy) meta$PRODUCT_METADATA[<span style="color: #00ff00;">"DATE_ACQUIRED"</span>,] <span style="color: #00ffff;">else</span> meta$PRODUCT_METADATA[<span style="color: #00ff00;">"ACQUISITION_DATE"</span>,]},
                                        PROCESSING_DATE         = <span style="color: #00ffff;">if</span>(!legacy) meta$METADATA_FILE_INFO[<span style="color: #00ff00;">"FILE_DATE"</span>,] <span style="color: #00ffff;">else</span> meta$METADATA_FILE_INFO[<span style="color: #00ff00;">"PRODUCT_CREATION_TIME"</span>,], 
                                        PATH                            = as.numeric(meta$PRODUCT_METADATA[<span style="color: #00ff00;">"WRS_PATH"</span>,]),
                                        ROW                                     = <span style="color: #00ffff;">if</span>(!legacy) as.numeric(meta$PRODUCT_METADATA[<span style="color: #00ff00;">"WRS_ROW"</span>,]) <span style="color: #00ffff;">else</span> as.numeric(meta$PRODUCT_METADATA[<span style="color: #00ff00;">"STARTING_ROW"</span>,]),
                                        RADIOMETRIC_RES         = <span style="color: #00ffff;">if</span>(SAT == <span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">"</span>) <span style="color: #daa520;">16</span> <span style="color: #00ffff;">else</span> <span style="color: #daa520;">8</span>,                              
                                        FILES                           = {files <span style="color: #ff00ff;">&lt;-</span> row.names(meta[[<span style="color: #00ff00;">"PRODUCT_METADATA"</span>]])[grep(<span style="color: #00ff00;">"^.*FILE_NAME"</span>, row.names(meta$PRODUCT_METADATA))]
                                                files <span style="color: #ff00ff;">&lt;-</span> files[grep(<span style="color: #00ff00;">"^.*BAND"</span>,files)]
                                                files <span style="color: #ff00ff;">&lt;-</span> meta[[<span style="color: #00ff00;">"PRODUCT_METADATA"</span>]][files,]     },

                                        BANDS                           = {junk <span style="color: #ff00ff;">&lt;-</span> unique(sapply(str_split(files, <span style="color: #00ff00;">"_B"</span>), <span style="color: #00ff00;">"["</span> ,<span style="color: #daa520;">1</span> ))
                                                bds <span style="color: #ff00ff;">&lt;-</span> str_replace(str_replace(files, paste<span style="color: #daa520;">0</span>(junk,<span style="color: #00ff00;">"_"</span>), <span style="color: #00ff00;">""</span>), {<span style="color: #00ffff;">if</span>(SAT==<span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">"</span>) <span style="color: #00ff00;">"</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">.TIF"</span> <span style="color: #00ffff;">else</span> <span style="color: #00ff00;">".TIF"</span>}, <span style="color: #00ff00;">""</span>)
                                        },
                                        BAND_TYPE                       = {
                                                ty <span style="color: #ff00ff;">&lt;-</span> rep(<span style="color: #00ff00;">"image"</span>, length(bds))
                                                ty[grepl(<span style="color: #00ff00;">"QA"</span>, bds)] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"qa"</span>
                                                ty
                                        },
                                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">INSOLATION</span>
                                        NA_VALUE                        = rep(<span style="color: #daa520;">0</span>, length(ty)),
                                        SUN_AZIMUTH                     = <span style="color: #00ffff;">if</span>(!legacy) as.numeric(meta$IMAGE_ATTRIBUTES[<span style="color: #00ff00;">"SUN_AZIMUTH"</span>,]) <span style="color: #00ffff;">else</span> as.numeric(meta$PRODUCT_PARAMETERS[<span style="color: #00ff00;">"SUN_AZIMUTH"</span>,]),
                                        SUN_ELEVATION           = <span style="color: #00ffff;">if</span>(!legacy) as.numeric(meta$IMAGE_ATTRIBUTES[<span style="color: #00ff00;">"SUN_ELEVATION"</span>,]) <span style="color: #00ffff;">else</span> as.numeric(meta$PRODUCT_PARAMETERS[<span style="color: #00ff00;">"SUN_ELEVATION"</span>,]),
                                        EARTH_SUN_DISTANCE  = {es <span style="color: #ff00ff;">&lt;-</span> meta$IMAGE_ATTRIBUTES[<span style="color: #00ff00;">"EARTH_SUN_DISTANCE"</span>,]
                                                <span style="color: #00ffff;">if</span>(is.null(es) || is.na(es)) es <span style="color: #ff00ff;">&lt;-</span> .ESdist(date)
                                                as.numeric(es)}
                        )

                        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">RADIOMETRIC CORRECTION/RESCALING PARAMETERS</span>
                        RADCOR <span style="color: #ff00ff;">&lt;-</span>  <span style="color: #00ffff;">if</span>(!legacy) { list(          
                                                                RAD_OFFSET                              = {
                                                                        r <span style="color: #ff00ff;">&lt;-</span> meta$RADIOMETRIC_RESCALING
                                                                        r[,<span style="color: #daa520;">1</span>]           <span style="color: #ff00ff;">&lt;-</span> as.numeric(r[,<span style="color: #daa520;">1</span>])
                                                                        bandnames       <span style="color: #ff00ff;">&lt;-</span> str_c(<span style="color: #00ff00;">"B"</span>, str_replace(rownames(r), <span style="color: #00ff00;">"^.*_BAND_"</span>, <span style="color: #00ff00;">""</span>))
                                                                        go                      <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"RADIANCE_ADD*"</span>, rownames(r))
                                                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                                                        ro},
                                                                RAD_GAIN                                = {go                   <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"RADIANCE_MULT*"</span>, rownames(r))
                                                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                                                        ro},
                                                                REF_OFFSET                              = {     go                      <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"REFLECTANCE_ADD*"</span>, rownames(r))
                                                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                                                        ro},
                                                                REF_GAIN                                = {go                   <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"REFLECTANCE_MULT*"</span>, rownames(r))
                                                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                                                        ro})

                                        } <span style="color: #00ffff;">else</span> {

                                                bandnames <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, .getNumeric(rownames(meta$MIN_MAX_RADIANCE)))
                                                bandnames <span style="color: #ff00ff;">&lt;-</span> bandnames[seq(<span style="color: #daa520;">1</span>, length(bandnames), <span style="color: #daa520;">2</span>)]

                                                L <span style="color: #ff00ff;">&lt;-</span> diff(as.numeric(meta$MIN_MAX_RADIANCE[,<span style="color: #daa520;">1</span>]))
                                                L <span style="color: #ff00ff;">&lt;-</span> L[seq(<span style="color: #daa520;">1</span>, length(L), <span style="color: #daa520;">2</span>)] 

                                                Q <span style="color: #ff00ff;">&lt;-</span> diff(as.numeric(meta$MIN_MAX_PIXEL_VALUE[,<span style="color: #daa520;">1</span>]))  
                                                Q <span style="color: #ff00ff;">&lt;-</span> Q[seq(<span style="color: #daa520;">1</span>, length(Q), <span style="color: #daa520;">2</span>)]

                                                RAD_GAIN        <span style="color: #ff00ff;">&lt;-</span> L/Q
                                                RAD_OFFSET      <span style="color: #ff00ff;">&lt;-</span> as.numeric(meta$MIN_MAX_RADIANCE[,<span style="color: #daa520;">1</span>])[seq(<span style="color: #daa520;">2</span>,nrow(meta$MIN_MAX_RADIANCE),<span style="color: #daa520;">2</span>)] - (RAD_GAIN) * <span style="color: #daa520;">1</span>

                                                names(RAD_OFFSET) <span style="color: #ff00ff;">&lt;-</span> names(RAD_GAIN) <span style="color: #ff00ff;">&lt;-</span> bandnames

                                                list(RAD_OFFSET = RAD_OFFSET, RAD_GAIN = RAD_GAIN)

                                        }

         <span style="color: #00ffff;">if</span>(SAT == <span style="color: #00ff00;">"LANDSAT</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">"</span>){
                                RADCOR$K<span style="color: #daa520;">1</span> ={ r <span style="color: #ff00ff;">&lt;-</span> meta$TIRS_THERMAL_CONSTANTS
                                        r[,<span style="color: #daa520;">1</span>]           <span style="color: #ff00ff;">&lt;-</span> as.numeric(r[,<span style="color: #daa520;">1</span>])
                                        bandnames       <span style="color: #ff00ff;">&lt;-</span> str_c(<span style="color: #00ff00;">"B"</span>, str_replace(rownames(r), <span style="color: #00ff00;">"^.*_BAND_"</span>, <span style="color: #00ff00;">""</span>))
                                        go                      <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"K</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>, rownames(r))
                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                        ro}
                                RADCOR$K<span style="color: #daa520;">2</span> = {go                 <span style="color: #ff00ff;">&lt;-</span> grep(<span style="color: #00ff00;">"K</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">"</span>, rownames(r))
                                        ro                      <span style="color: #ff00ff;">&lt;-</span> r[go,]
                                        names(ro)       <span style="color: #ff00ff;">&lt;-</span> bandnames[go]
                                        ro}                             
                        } <span style="color: #00ffff;">else</span> {
                                TAB<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;-</span> list(LANDSAT<span style="color: #daa520;">4</span> = c(B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">671</span>.<span style="color: #daa520;">62</span>,B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">1284</span>.<span style="color: #daa520;">3</span>), <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TAB</span><span style="color: #daa520;">7</span><span style="color: #cccccc;"> from Chander </span><span style="color: #daa520;">2009</span>
                                                LANDSAT<span style="color: #daa520;">5</span> = c(B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">607</span>.<span style="color: #daa520;">76</span>,B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">1260</span>.<span style="color: #daa520;">56</span>),
                                                LANDSAT<span style="color: #daa520;">7</span> = c(B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">666</span>.<span style="color: #daa520;">09</span>,B<span style="color: #daa520;">6</span>=<span style="color: #daa520;">1282</span>.<span style="color: #daa520;">71</span>))

                                RADCOR$K<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> TAB<span style="color: #daa520;">7</span>[[SAT]][<span style="color: #daa520;">1</span>]
                                RADCOR$K<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> TAB<span style="color: #daa520;">7</span>[[SAT]][<span style="color: #daa520;">2</span>]
                        }

                        meta[[<span style="color: #00ff00;">"UNIFIED_METADATA"</span>]] <span style="color: #ff00ff;">&lt;-</span> c(meta[[<span style="color: #00ff00;">"UNIFIED_METADATA"</span>]], RADCOR)
                }
        } <span style="color: #00ffff;">else</span> {
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">PROCESS ESPA LEDAPS XML FILES</span>
                meta <span style="color: #ff00ff;">&lt;-</span> xmlParse(file)
                meta <span style="color: #ff00ff;">&lt;-</span> xmlToList(meta)
                names(meta$bands) <span style="color: #ff00ff;">&lt;-</span> str_replace_all(unlist(sapply(meta$bands, <span style="color: #00ff00;">"["</span>, <span style="color: #00ff00;">"long_name"</span>)), <span style="color: #00ff00;">" "</span>, <span style="color: #00ff00;">"_"</span>)

                <span style="color: #00ffff;">if</span>(unifiedMetadata){

                        atts <span style="color: #ff00ff;">&lt;-</span> sapply(meta$bands, <span style="color: #00ff00;">"["</span>, <span style="color: #00ff00;">".attrs"</span>)

                        meta[[<span style="color: #00ff00;">"UNIFIED_METADATA"</span>]] <span style="color: #ff00ff;">&lt;-</span> list(
                                        SPACECRAFT_ID           = {SAT <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"LANDSAT"</span>, .getNumeric(meta$global_metadata$satellite))},
                                        SENSOR_ID                       = meta$global_metadata$instrument,                      
                                        SCENE_ID                        = SID <span style="color: #ff00ff;">&lt;-</span> str_replace(meta$global_metadata$lpgs_metadata_file, <span style="color: #00ff00;">"_MTL.txt"</span>, <span style="color: #00ff00;">""</span>),  <span style="color: #cccccc;">## </span><span style="color: #cccccc;">could assemble name for legacy files: http://landsat.usgs.gov/naming_conventions_scene_identifiers.php</span>
                                        DATA_TYPE                       = <span style="color: #00ffff;">if</span>(meta$bands[[<span style="color: #daa520;">1</span>]]$.attrs[<span style="color: #00ff00;">"product"</span>] == <span style="color: #00ff00;">"sr_refl"</span>) <span style="color: #00ff00;">"SR"</span>, 
                                        ACQUISITION_DATE        = {date <span style="color: #ff00ff;">&lt;-</span> meta$global_metadata$acquisition_date},
                                        PROCESSING_DATE         = meta$bands[[<span style="color: #daa520;">1</span>]]$production_date, 
                                        PATH                            = as.numeric(meta$global_metadata$wrs[<span style="color: #00ff00;">"path"</span>]),
                                        ROW                                     = as.numeric(meta$global_metadata$wrs[<span style="color: #00ff00;">"row"</span>]),

                                        FILES                           = {files <span style="color: #ff00ff;">&lt;-</span> sapply(meta$bands, <span style="color: #00ff00;">"[["</span>, <span style="color: #00ff00;">"file_name"</span>)
                                                names(files) <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
                                                files},                                 
                                        BANDS                           = {     
                                                bds <span style="color: #ff00ff;">&lt;-</span> grepl(<span style="color: #00ff00;">"_band"</span>, files)
                                                toa <span style="color: #ff00ff;">&lt;-</span> grepl(<span style="color: #00ff00;">"_toa_"</span>, files)
                                                qas <span style="color: #ff00ff;">&lt;-</span> grepl(<span style="color: #00ff00;">"qa"</span>, files)       
                                                bnames                          <span style="color: #ff00ff;">&lt;-</span> toupper(str_replace(files, paste<span style="color: #daa520;">0</span>(SID, <span style="color: #00ff00;">"_"</span>), <span style="color: #00ff00;">""</span>))                                    
                                                bnames[bds]                     <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"B"</span>, .getNumeric(bnames[bds]))
                                                bnames[bds &amp; qas]       <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(bnames[bds &amp; qas], <span style="color: #00ff00;">"_QA"</span>)
                                                bnames                          <span style="color: #ff00ff;">&lt;-</span> str_replace(str_replace(str_replace(bnames, <span style="color: #00ff00;">"\\.TIF"</span>, <span style="color: #00ff00;">""</span>), <span style="color: #00ff00;">"SR_"</span>, <span style="color: #00ff00;">""</span>), <span style="color: #00ff00;">"TOA_"</span>, <span style="color: #00ff00;">""</span>)
                                                bnames[toa]             <span style="color: #ff00ff;">&lt;-</span> paste<span style="color: #daa520;">0</span>(bnames[toa], <span style="color: #00ff00;">"_TOA"</span>)
                                                bnames
                                        },
                                        BAND_TYPE                       = {ty <span style="color: #ff00ff;">&lt;-</span> sapply(atts, <span style="color: #00ff00;">"["</span> , <span style="color: #00ff00;">"category"</span>)
                                                names(ty) <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
                                                ty
                                        },
                                        NA_VALUE                        = as.numeric(sapply(atts, <span style="color: #00ff00;">"["</span> , <span style="color: #00ff00;">"fill_value"</span>)),
                                        SATURATE_VALUE          = as.numeric(sapply(atts, <span style="color: #00ff00;">"["</span> , <span style="color: #00ff00;">"saturate_value"</span>)),
                                        SCALE_FACTOR            = as.numeric(sapply(atts, <span style="color: #00ff00;">"["</span> , <span style="color: #00ff00;">"scale_factor"</span>)),

                                        SUN_AZIMUTH                     = as.numeric(meta$global_metadata$solar_angles[<span style="color: #00ff00;">"azimuth"</span>]),
                                        SUN_ELEVATION           = <span style="color: #daa520;">90</span> - as.numeric(meta$global_metadata$solar_angles[<span style="color: #00ff00;">"zenith"</span>]),
                                        EARTH_SUN_DISTANCE  = {.ESdist(date)}
                        )

                }

        }
        <span style="color: #00ffff;">return</span>(meta)
}





<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Import separate Landsat files into single stack</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Reads Landsat MTL or XML metadata files and loads single Landsat Tiffs into a rasterStack.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Be aware that by default stackLS() does NOT import panchromatic bands nor thermal bands with resolutions != </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">file</span><span style="color: #cccccc;"> character. Path to Landsat MTL metadata file.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">allResolutions</span><span style="color: #cccccc;"> logical. if \code{TRUE} a list will be returned with length = unique spatial resolutions.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">resampleTIR</span><span style="color: #cccccc;"> logical. As of  the USGS resamples TIR bands to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m. Use this option if you use data processed prior to February </span><span style="color: #daa520;">25</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">2010</span><span style="color: #cccccc;"> which has not been resampled.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">resamplingMethod</span><span style="color: #cccccc;"> character. Method to use for TUR resampling ('ngb' or 'bilinear'). Defaults to 'ngb' (nearest neighbor).</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">products</span><span style="color: #cccccc;"> character vector. Which products should be returned in the stack? (only relevant for LS</span><span style="color: #daa520;">8</span><span style="color: #cccccc;"> and LEDAPS processed products). 'image': image data, 'index': multiband indices, 'qa' quality flag bands. </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@return</span><span style="color: #cccccc;"> Either a list of rasterStacks comprising all resolutions or only one rasterStack comprising only </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m resolution imagery</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@note</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Be aware that by default stackLS() does NOT import panchromatic bands nor thermal bands with resolutions != </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m. Use the allResolutions argument to import all layers.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> The USGS uses cubic convolution to resample TIR bands to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m resolution. In the opinion of the author this may not be the best choice for supersampling. </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Therefore the default method in this implementation is nearest neighbor. Keep this in mind if you plan to compare TIR bands created by differing resampling routines.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Typically, however, you will already have the USGS </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m TIR products, so no need to worry...</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #ff6347;">stackMeta</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(file, allResolutions = <span style="color: #daa520;">FALSE</span>,  resampleTIR = <span style="color: #daa520;">FALSE</span>, resamplingMethod = <span style="color: #00ff00;">"ngb"</span>, products = c(<span style="color: #00ff00;">"image"</span>, <span style="color: #00ff00;">"index"</span>, <span style="color: #00ff00;">"qa"</span>)){

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Read metadata and extract layer file names</span>
        meta  <span style="color: #ff00ff;">&lt;-</span> readMeta(file)
        files <span style="color: #ff00ff;">&lt;-</span> meta$UNIFIED_METADATA$FILES

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Load layers</span>
        path  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(basename(file) != file)  str_replace(file, basename(file), <span style="color: #00ff00;">""</span>) <span style="color: #00ffff;">else</span> <span style="color: #daa520;">NULL</span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Import rasters</span>
        rl <span style="color: #ff00ff;">&lt;-</span> lapply(paste<span style="color: #daa520;">0</span>(path, files), raster)
        resL <span style="color: #ff00ff;">&lt;-</span> lapply(lapply(rl, res),<span style="color: #00ff00;">"["</span>, <span style="color: #daa520;">1</span>)

        <span style="color: #00ffff;">if</span>(any(resL &gt; <span style="color: #daa520;">30</span>)) {
                <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"Your Landsat data includes TIR band(s) which were not resampled to </span><span style="color: #daa520;">30</span><span style="color: #00ff00;">m.</span>
<span style="color: #00ff00;">                                                \nYou can set resampleTIR = TRUE to resample TIR bands to </span><span style="color: #daa520;">30</span><span style="color: #00ff00;">m if you want a single stack"</span>)

                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Resample TIR to </span><span style="color: #daa520;">30</span><span style="color: #cccccc;">m</span>
                <span style="color: #00ffff;">if</span>(resampleTIR){
                        <span style="color: #00ffff;">for</span>(i <span style="color: #00ffff;">in</span> which(resL &gt; <span style="color: #daa520;">30</span>))
                                rl[[i]] <span style="color: #ff00ff;">&lt;-</span> resample(rl[[i]], rl[[which(resL == <span style="color: #daa520;">30</span>)[<span style="color: #daa520;">1</span>]]], method = resamplingMethod)             
                }
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Stack</span>
        returnRes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">if</span>(allResolutions) unlist(unique(resL)) <span style="color: #00ffff;">else</span> <span style="color: #daa520;">30</span>

        LS      <span style="color: #ff00ff;">&lt;-</span> lapply(returnRes, <span style="color: #00ffff;">function</span>(x){
                                s                       <span style="color: #ff00ff;">&lt;-</span> stack(rl[resL == x])
                                names(s)        <span style="color: #ff00ff;">&lt;-</span> meta$UNIFIED_METADATA$BANDS[resL == x]
                                NAvalue(s)      <span style="color: #ff00ff;">&lt;-</span> meta$UNIFIED_METADATA$NA_VALUE[resL == x]    
                                s <span style="color: #ff00ff;">&lt;-</span> s[[ which(names(s) %<span style="color: #00ffff;">in</span>% meta$UNIFIED_METADATA$BANDS[meta$UNIFIED_METADATA$BAND_TYPE %<span style="color: #00ffff;">in</span>% products])        ]]
                                s
                        })

        <span style="color: #00ffff;">if</span>(!allResolutions) LS <span style="color: #ff00ff;">&lt;-</span> LS[[<span style="color: #daa520;">1</span>]]

        <span style="color: #00ffff;">return</span>(LS)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> RStoolbox.R</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> RStoolbox: A Collection of Remote Sensing Tools</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@name</span><span style="color: #cccccc;"> RStoolbox</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@import</span><span style="color: #cccccc;"> raster rgeos geosphere plyr randomForest stringr</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@docType</span><span style="color: #cccccc;"> package</span>
<span style="color: #daa520;">NULL</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> spectralIndices.R</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Spectral indices</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">inputRaster</span><span style="color: #cccccc;"> Raster* object. Typically remote sensing imagery, which is to be classified.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">indices</span><span style="color: #cccccc;"> character. one or more spectral indices </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">sensor</span><span style="color: #cccccc;"> if a sensor is specified \code{bands} is populated automatically. Specifying a sensor requires the layernames in inputRaster to match the official band designations formatted as "B</span><span style="color: #daa520;">1</span><span style="color: #cccccc;">", "B</span><span style="color: #daa520;">2</span><span style="color: #cccccc;">" etc.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">bands</span><span style="color: #cccccc;"> list of band designations. See notes for details</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">maskRaster</span><span style="color: #cccccc;"> Raster layer containing a binary mask to exclude areas from prediction.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #cccccc;"> logical. prints progress, statistics and graphics during execution</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">...</span><span style="color: #cccccc;"> further arguments such as filename etc. passed to \link[raster]{writeRaster}</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@return</span><span style="color: #cccccc;"> rasterBrick or rasterStack</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@seealso</span><span style="color: #cccccc;"> \code{\link[raster]{overlay}} </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@examples</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> r &lt;- raster(ncol=</span><span style="color: #daa520;">10</span><span style="color: #cccccc;">,nrow=</span><span style="color: #daa520;">10</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> r[] &lt;- sample(</span><span style="color: #daa520;">1</span><span style="color: #cccccc;">:</span><span style="color: #daa520;">155</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">100</span><span style="color: #cccccc;">, TRUE)</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> r &lt;- stack(r, r + </span><span style="color: #daa520;">90</span><span style="color: #cccccc;"> + rnorm(</span><span style="color: #daa520;">100</span><span style="color: #cccccc;">, </span><span style="color: #daa520;">10</span><span style="color: #cccccc;">)) </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> names(r) &lt;- c("red", "nir")</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> SI &lt;- spectralIndices(r, indices = c("SR", "NDVI"), bands = list(NIR = "nir", RED = "red"))</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> plot(SI)</span>
<span style="color: #ff6347;">spectralIndices</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(inputRaster, indices = <span style="color: #00ff00;">"NDVI"</span>, sensor, bands , maskRaster = <span style="color: #daa520;">NULL</span>, verbose = <span style="color: #daa520;">FALSE</span>, ... ) {
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: add indices</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: add examples</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: add formulas to help file</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: internal sensor db</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: value checks?</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: check sensor list for correctness and extend it </span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Sensor db</span>
        SENSORS <span style="color: #ff00ff;">&lt;-</span> list(
                        LANDSAT<span style="color: #daa520;">5</span> = list(BLUE = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>, GREEN = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">"</span>, RED = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">"</span>, NIR = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">"</span>, MIR = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">"</span>),
                        LANDSAT<span style="color: #daa520;">7</span> = list(BLUE = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">"</span>, GREEN = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">"</span>, RED = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">"</span>, NIR = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">"</span>),
                        LANDSAT<span style="color: #daa520;">8</span> = list(BLUE = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">"</span>, GREEN = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">"</span>, RED = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">"</span>, NIR = <span style="color: #00ff00;">"B</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">"</span>)
        )

        <span style="color: #00ffff;">if</span>(!missing(sensor)){
                <span style="color: #00ffff;">if</span>(!sensor %<span style="color: #00ffff;">in</span>% names(SENSORS)) <span style="color: #00ffff;">stop</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Unknown sensor. Please provide the 'bands' argument or 'sensor' as one of "</span>, names(SENSORS)))
                bands <span style="color: #ff00ff;">&lt;-</span> SENSORS[[sensor]]
                <span style="color: #00ffff;">if</span>(any(!bands %<span style="color: #00ffff;">in</span>% names(inputRaster))) <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Bandnames of inputRaster do not match the required format or are missing. Please provide 'bands' argument manually or make sure the names(inputRaster) follow the 'B</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">' 'B</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'  ... format if you want to make use of the 'sensor' argument."</span>)
        }
        bands <span style="color: #ff00ff;">&lt;-</span> lapply(bands, <span style="color: #00ffff;">function</span>(x) <span style="color: #00ffff;">if</span>(is.character(x)) which(names(inputRaster) == x) <span style="color: #00ffff;">else</span> x )

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Internal db</span>
        INDICES <span style="color: #ff00ff;">&lt;-</span>  list(
                        SR              = <span style="color: #00ffff;">function</span>(NIR, RED) {NIR / RED},
                        DVI             = <span style="color: #00ffff;">function</span>(NIR, RED) {NIR-RED},
                        NDVI    = <span style="color: #00ffff;">function</span>(NIR, RED) {(NIR-RED)/(NIR+RED)}, 
                        TVI     = <span style="color: #00ffff;">function</span>(NIR, RED) {(((NIR-RED)/(NIR+RED))+<span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>)^<span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>}, 
                        MSAVI   = <span style="color: #00ffff;">function</span>(NIR, RED) {NIR + <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span> - (<span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span> * sqrt((<span style="color: #daa520;">2</span> * NIR + <span style="color: #daa520;">1</span>)^<span style="color: #daa520;">2</span> - <span style="color: #daa520;">8</span> * (NIR - (<span style="color: #daa520;">2</span> * RED))))},
                        MSAVI<span style="color: #daa520;">2</span>  = <span style="color: #00ffff;">function</span>(NIR, RED) {(<span style="color: #daa520;">2</span> * (NIR + <span style="color: #daa520;">1</span>) - sqrt((<span style="color: #daa520;">2</span> * NIR + <span style="color: #daa520;">1</span>)^<span style="color: #daa520;">2</span> - <span style="color: #daa520;">8</span> * (NIR - RED))) / <span style="color: #daa520;">2</span>},
                        GEMI    = <span style="color: #00ffff;">function</span>(NIR, RED) {(((NIR^<span style="color: #daa520;">2</span> - RED^<span style="color: #daa520;">2</span>) * <span style="color: #daa520;">2</span> + (NIR * <span style="color: #daa520;">1</span>.<span style="color: #daa520;">5</span>) + (RED * <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>) ) / (NIR + RED + <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>)) * (<span style="color: #daa520;">1</span> - ((((NIR^<span style="color: #daa520;">2</span> - RED^<span style="color: #daa520;">2</span>) * <span style="color: #daa520;">2</span> + (NIR * <span style="color: #daa520;">1</span>.<span style="color: #daa520;">5</span>) + (RED * <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>) ) / (NIR + RED + <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>)) * <span style="color: #daa520;">0</span>.<span style="color: #daa520;">25</span>)) - ((RED - <span style="color: #daa520;">0</span>.<span style="color: #daa520;">125</span>) / (<span style="color: #daa520;">1</span> - RED))},                   
                        SLAVI   = <span style="color: #00ffff;">function</span>(RED, MIR) {NIR / (RED + MIR)},
                        EVI             = <span style="color: #00ffff;">function</span>(NIR, RED, BLUE) {G * ((NIR - RED) / (NIR + C<span style="color: #daa520;">1</span> * RED - C<span style="color: #daa520;">2</span> * BLUE + L))}<span style="color: #cccccc;"># </span><span style="color: #cccccc;">include a G or L specification in command</span>
        )

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Get arguments and check for mising arguments</span>
        args <span style="color: #ff00ff;">&lt;-</span> lapply(indices, <span style="color: #00ffff;">function</span>(index) {
                                need <span style="color: #ff00ff;">&lt;-</span> names(formals(INDICES[[index]]))        
                                <span style="color: #00ffff;">if</span>(any(!need %<span style="color: #00ffff;">in</span>% names(bands))) <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Band specification(s) of &gt;&gt; "</span>, paste(names(bands)[!names(bands) %<span style="color: #00ffff;">in</span>% need], collapse = <span style="color: #00ff00;">","</span>), 
                                                        <span style="color: #00ff00;">" &lt;&lt; are missing or do not match layer names in the brick/stack. \nPlease specify the correct layer number or name in a list, e.g. bands = list(RED = 'B</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">', NIR = 'B</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">')"</span>, call. = <span style="color: #daa520;">FALSE</span>)
                                need <span style="color: #ff00ff;">&lt;-</span> unlist(bands[need])
                        })
        names(args) <span style="color: #ff00ff;">&lt;-</span> indices 

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">We do this in a separate step, so we can throw an error before we start the calculations</span>
        inList <span style="color: #ff00ff;">&lt;-</span> lapply(indices, <span style="color: #00ffff;">function</span>(index) {
                                <span style="color: #00ffff;">if</span>(verbose) print(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"Calculating "</span>, index))
                        m<span style="color: #ff00ff;">&lt;-</span>     overlay(inputRaster[[args[[index]]]], fun = INDICES[[index]])
                        })

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Combine and return</span>
        outStack <span style="color: #ff00ff;">&lt;-</span> stack(inList)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Write file if filename is provided. Doing it this way we write the file twice. We could provide filenames to overlay instead and return a stack so we only write once. </span>
        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">But then we have an output of n single files instead of one multi-layer file containing all indices.</span>
        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Maybe we should make this optional</span>
        <span style="color: #00ffff;">if</span>(any(grepl(<span style="color: #00ff00;">"file"</span>, names(list(...))))) outStack <span style="color: #ff00ff;">&lt;-</span>  writeRaster(outStack, ...)

        names(outStack) <span style="color: #ff00ff;">&lt;-</span> indices       

        <span style="color: #00ffff;">return</span>(outStack)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> superClass.R</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> Supervised Classification</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">inputRaster</span><span style="color: #cccccc;"> Raster* object. Typically remote sensing imagery, which is to be classified.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">trainingData</span><span style="color: #cccccc;"> SpatialPolygonsDataFrame containing the training data used to train the classifier.  </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">classAttributes</span><span style="color: #cccccc;"> character giving the column in \code{trainingData}, which contains the class attribute. Can be omitted, when \code{trainingData} has only one column.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">nSamples</span><span style="color: #cccccc;"> number of samples per land cover class</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">filename</span><span style="color: #cccccc;"> path to output file (optional). If \code{NULL}, standard raster handling will apply, i.e. storage either in memory or in the raster temp directory.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">maskRaster</span><span style="color: #cccccc;"> Raster layer containing a binary mask to exclude areas from prediction.</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #cccccc;"> logical. prints progress, statistics and graphics during execution</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">predict</span><span style="color: #cccccc;"> logical. \code{TRUE} (default) will return a classified map, \code{FALSE} will only train the classifier</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@param</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">...</span><span style="color: #cccccc;"> further arguments to be passed to randomForest</span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@return</span><span style="color: #cccccc;"> A list containing [[</span><span style="color: #daa520;">1</span><span style="color: #cccccc;">]] the model, [[</span><span style="color: #daa520;">2</span><span style="color: #cccccc;">]] the predicted raster and [[</span><span style="color: #daa520;">3</span><span style="color: #cccccc;">]] the class mapping  </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #00ffff;">@seealso</span><span style="color: #cccccc;"> \code{\link{randomForest}} </span>
<span style="color: #cccccc; font-weight: bold;">#</span><span style="color: #cccccc; font-weight: bold;">'</span><span style="color: #cccccc;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #ff6347;">superClass</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span>(inputRaster, trainingData, classAttributes = <span style="color: #daa520;">NULL</span>, nSamples = <span style="color: #daa520;">100</span>, filename = <span style="color: #daa520;">NULL</span>, maskRaster = <span style="color: #daa520;">NULL</span>, verbose = <span style="color: #daa520;">FALSE</span>, predict = <span style="color: #daa520;">TRUE</span>, overwrite = <span style="color: #daa520;">TRUE</span>, ...) {
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: point vector data</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: enable regression mode</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: cross-validation</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: make classifier modular</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: add examples</span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">TODO: check applicability of raster:::.intersectExtent </span>
        <span style="color: #cccccc;"># </span><span style="color: #cccccc;">DISCUSS: demo data</span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Filetypes</span>
        <span style="color: #00ffff;">if</span>(!inherits(inputRaster, <span style="color: #00ff00;">'Raster'</span>)) <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"inputRaster must be a raster object (RasterLayer,RasterBrick or RasterStack)"</span>, call.=<span style="color: #daa520;">FALSE</span>)
        <span style="color: #00ffff;">if</span>(!inherits(trainingData, <span style="color: #00ff00;">'SpatialPolygonsDataFrame'</span>)) <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"traingData must be a SpatialPolygonsDataFrame"</span>, call.=<span style="color: #daa520;">FALSE</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Attribute column</span>
        <span style="color: #00ffff;">if</span>(is.null(classAttributes)){
                <span style="color: #00ffff;">if</span>(ncol(trainingData) == <span style="color: #daa520;">1</span>) {
                        classAttributes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                        <span style="color: #00ffff;">message</span>(<span style="color: #00ff00;">"You did not specify the classAttributes column. \nSince your trainingData only contains one column we assume this is it"</span>)
                } <span style="color: #00ffff;">else</span> {
                        <span style="color: #00ffff;">stop</span>(paste(<span style="color: #00ff00;">"Dont't know which column in trainingData contains the class attribute. \nPlease specify classAttributes as one of: "</span>, paste(colnames(trainingData@data),collapse=<span style="color: #00ff00;">", "</span>)), call. = <span style="color: #daa520;">FALSE</span>)
                }
        } 
        <span style="color: #00ffff;">if</span>(!classAttributes %<span style="color: #00ffff;">in</span>% colnames(trainingData@data)) 
                <span style="color: #00ffff;">stop</span>(paste<span style="color: #daa520;">0</span>(<span style="color: #00ff00;">"The column "</span>, classAttributes, <span style="color: #00ff00;">" does not exist in trainingData. \nAvailable columns are: "</span>, colnames(trainingData@data,collapse=<span style="color: #00ff00;">", "</span>)), call. = <span style="color: #daa520;">FALSE</span>) 

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Check projections</span>
        <span style="color: #00ffff;">if</span>(!compareCRS(inputRaster, trainingData)) 
                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"Projection of trainingData does not match inputRaster"</span>)
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">DISCUSS: Should we do a spTransform of vector data here, or require proper projection from the user?</span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Check overlap of vector and raster data      </span>
        <span style="color: #00ffff;">if</span>(!gIntersects(as(extent(inputRaster),<span style="color: #00ff00;">"SpatialPolygons"</span>), as(extent(trainingData),<span style="color: #00ff00;">"SpatialPolygons"</span>))) 
                <span style="color: #00ffff;">stop</span>(<span style="color: #00ff00;">"inputRaster and trainingData do not overlap"</span>)

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calculate area weighted number of samples per polygon</span>
        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">this way we'll end up with n &gt; nSamples, but make sure to sample each polygon at least once</span>
        <span style="color: #00ffff;">if</span>(is.projected(trainingData)){
                trainingData[[<span style="color: #00ff00;">"area"</span>]] <span style="color: #ff00ff;">&lt;-</span> gArea(trainingData, byid = <span style="color: #daa520;">TRUE</span>)
        } <span style="color: #00ffff;">else</span> {
                trainingData[[<span style="color: #00ff00;">"area"</span>]] <span style="color: #ff00ff;">&lt;-</span> areaPolygon(trainingData)             
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Calculate optimal nSamples per class</span>
        trainingData@data[[<span style="color: #00ff00;">"order"</span>]] <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>:nrow(trainingData)            
        weights <span style="color: #ff00ff;">&lt;-</span> ddply(trainingData@data, .variables = classAttributes, .fun = here(mutate), nSamplesClass = ceiling(nSamples * area / sum(area)))
        trainingData@data <span style="color: #ff00ff;">&lt;-</span> weights[order(weights$order),]

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Get random coordinates within polygons</span>
        xy  <span style="color: #ff00ff;">&lt;-</span> lapply(seq_along(trainingData), <span style="color: #00ffff;">function</span>(i_poly){        
                                pts <span style="color: #ff00ff;">&lt;-</span> spsample(trainingData[i_poly, ], type = <span style="color: #00ff00;">"random"</span>, n = trainingData@data[i_poly,<span style="color: #00ff00;">"nSamplesClass"</span>], iter = <span style="color: #daa520;">20</span>) 
                        })
        xy <span style="color: #ff00ff;">&lt;-</span> do.call(<span style="color: #00ff00;">"rbind"</span>, xy)

        <span style="color: #cccccc;">### </span><span style="color: #cccccc;">Display, verbose only</span>
        <span style="color: #00ffff;">if</span>(verbose) {
                plot(inputRaster,<span style="color: #daa520;">1</span>)
                plot(trainingData, add = T)
                points(xy, pch = <span style="color: #daa520;">3</span>, cex = <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span>)
        }       

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Extract response and predictors and combine in final training set</span>
        <span style="color: #00ffff;">if</span>(verbose) print(<span style="color: #00ff00;">"Begin extract"</span>)
        dataSet <span style="color: #ff00ff;">&lt;-</span> data.frame(
                        response = as.factor(over(x = xy, y = trainingData)[[classAttributes]]),
                        extract(inputRaster, xy, cellnumbers = <span style="color: #daa520;">TRUE</span>))

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Discard duplicate cells</span>
        dataSet <span style="color: #ff00ff;">&lt;-</span> dataSet[!duplicated(dataSet[,<span style="color: #00ff00;">"cells"</span>]),]
        dataSet <span style="color: #ff00ff;">&lt;-</span> dataSet[,colnames(dataSet) != <span style="color: #00ff00;">"cells"</span>]

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Unique classes</span>
        classes <span style="color: #ff00ff;">&lt;-</span> unique(trainingData[[classAttributes]])
        classMapping <span style="color: #ff00ff;">&lt;-</span> data.frame(classID = as.numeric(classes), class = levels(classes))

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">TRAIN ######################### </span>
        <span style="color: #00ffff;">if</span>(verbose) print(<span style="color: #00ff00;">"Starting to calculate random forest model"</span>) 
        model <span style="color: #ff00ff;">&lt;-</span> randomForest(response ~ . , data = dataSet, na.action = na.omit, confusion = <span style="color: #daa520;">TRUE</span>, ...)                

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">PREDICT ######################### </span>
        progress <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"none"</span>
        <span style="color: #00ffff;">if</span>(verbose) { print(<span style="color: #00ff00;">"Starting spatial predict"</span>)
                progress <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"text"</span>
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Don't know whether we need this, who would be crazy enough to do more than </span><span style="color: #daa520;">255</span><span style="color: #cccccc;"> classes...</span>
        ifelse(length(classes) &lt; <span style="color: #daa520;">255</span>, dataType <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"INT</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">U"</span>,  dataType <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ff00;">"INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">U"</span>)

        <span style="color: #00ffff;">if</span>(is.null(filename)){
                spatPred <span style="color: #ff00ff;">&lt;-</span> predict(inputRaster, model, progress = progress, dataType = dataType, overwrite = overwrite)
        } <span style="color: #00ffff;">else</span> {
                spatPred <span style="color: #ff00ff;">&lt;-</span> predict(inputRaster, model, filename = filename, progress = progress, dataType = dataType, overwrite = overwrite)
        }

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Print summary stats</span>
        <span style="color: #00ffff;">if</span>(verbose)
                print(paste<span style="color: #daa520;">0</span>(paste<span style="color: #daa520;">0</span>(rep(<span style="color: #00ff00;">"*"</span>,<span style="color: #daa520;">20</span>), collapse = <span style="color: #00ff00;">""</span>),<span style="color: #00ff00;">" Classification summary "</span> ,paste<span style="color: #daa520;">0</span>(rep(<span style="color: #00ff00;">"*"</span>,<span style="color: #daa520;">20</span>), collapse = <span style="color: #00ff00;">""</span>)))
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Samples total</span>
                <span style="color: #cccccc;">## </span><span style="color: #cccccc;">Samples per class</span>
                print(model)
        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">TODO: calculate users,producer's accuracies and kappas</span>

        <span style="color: #cccccc;">## </span><span style="color: #cccccc;">DISCUSS: should we return sample points as well?</span>
        <span style="color: #00ffff;">return</span>(list(model = model, map = spatPred, classMapping = classMapping)) 

}
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: tian</p>
<p class="date">Created: 2014-09-22 Mon 15:18</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.7c)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
