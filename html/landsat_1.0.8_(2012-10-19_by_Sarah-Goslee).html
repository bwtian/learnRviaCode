<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>landsat_1.0.8_(2012-10-19_by_Sarah-Goslee)</title>
<!-- 2014-09-15 Mon 21:49 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="tian" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">landsat_1.0.8_(2012-10-19_by_Sarah-Goslee)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. BSL.R</a></li>
<li><a href="#sec-2">2. clouds.R</a></li>
<li><a href="#sec-3">3. ddate.R</a></li>
<li><a href="#sec-4">4. DOS.R</a></li>
<li><a href="#sec-5">5. ESdist.R</a></li>
<li><a href="#sec-6">6. georef.R</a></li>
<li><a href="#sec-7">7. geoshift.R</a></li>
<li><a href="#sec-8">8. histmatch.R</a></li>
<li><a href="#sec-9">9. lssub.R</a></li>
<li><a href="#sec-10">10. minnaert.R</a></li>
<li><a href="#sec-11">11. movingwindow.R</a></li>
<li><a href="#sec-12">12. PIF.R</a></li>
<li><a href="#sec-13">13. radiocorr.R</a></li>
<li><a href="#sec-14">14. RCS.R</a></li>
<li><a href="#sec-15">15. relnorm.R</a></li>
<li><a href="#sec-16">16. slopeasp.R</a></li>
<li><a href="#sec-17">17. tasscap.R</a></li>
<li><a href="#sec-18">18. thermalband.R</a></li>
<li><a href="#sec-19">19. topocorr.R</a></li>
</ul>
</div>
</div>
<ul class="org-ul">
<li>Package: landsat
</li>
<li>Type: Package
</li>
<li>Title: Radiometric and topographic correction of satellite imagery
</li>
<li>Version: 1.0.8
</li>
<li>Date: 2012-10-19
</li>
<li>Author: Sarah Goslee
</li>
<li>Maintainer: Sarah Goslee &lt;sarah.goslee@ars.usda.gov&gt;
</li>
<li>Depends: R (&gt;= 2.15.0), rgdal, sp (&gt;= 1.0)
</li>
<li>Imports: lmodel2, mgcv
</li>
<li>Description: Processing of Landsat or other multispectral satellite
</li>
<li>imagery. Includes relative normalization, image-based
</li>
<li>radiometric correction, and topographic correction options.
</li>
<li>License: GPL (&gt;= 2)
</li>
<li>LazyLoad: yes
</li>
<li>Packaged: 2012-10-22 15:31:59 UTC; sarahg
</li>
<li>Repository: CRAN
</li>
<li>Date/Publication: 2012-10-22 16:44:46
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> BSL.R</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">BSL</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span>, method <span style="color: #ff00ff;">=</span> quantile, ulimit <span style="color: #ff00ff;">=</span> .<span style="color: #daa520;">99</span>, llimit <span style="color: #ff00ff;">=</span> .<span style="color: #daa520;">005</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> 

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
        band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">4</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">4</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> 

    bsl.joint <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    bsl.joint <span style="color: #ff00ff;">&lt;-</span> bsl.joint<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>bsl.joint, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>!<span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>, <span style="color: #20b2aa;">]</span>
    bsl.joint <span style="color: #ff00ff;">&lt;-</span> bsl.joint<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>bsl.joint, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>, <span style="color: #20b2aa;">]</span>
    ratio<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&lt;-</span> bsl.joint<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span>bsl.joint<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> quantile<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bsl.lmodel<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>bsl.joint<span style="color: #20b2aa;">[</span>ratio<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>ratio<span style="color: #daa520;">43</span>, llimit<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> ~ bsl.joint<span style="color: #20b2aa;">[</span>ratio<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>ratio<span style="color: #daa520;">43</span>, llimit<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> minimum<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        bsl.min <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>bsl.joint<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, levels<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>:<span style="color: #daa520;">254</span><span style="color: #20b2aa;">)</span>
        bsl.min <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">split</span><span style="color: #20b2aa;">(</span>bsl.joint<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, bsl.min, drop<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        bsl.min <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>bsl.min, min<span style="color: #20b2aa;">)</span>
        bsl.lmodel<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span>bsl.min<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>bsl.min<span style="color: #20b2aa;">)))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Method not found.\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    bsl.lm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>bsl.lmodel<span style="color: #daa520;">2</span>$regression.results<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>, <span style="color: #daa520;">2</span>:<span style="color: #daa520;">3</span><span style="color: #20b2aa;">])</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>bsl.lm<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>Intercept, Slope<span style="color: #20b2aa;">)</span>

    bsl.test <span style="color: #ff00ff;">&lt;-</span> bsl.joint
    bsl.test<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">255</span> <span style="color: #ff00ff;">-</span> bsl.test<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> 
    bsl.test <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>bsl.test, <span style="color: #daa520;">1</span>, sum<span style="color: #20b2aa;">)</span>

    bsl.top <span style="color: #ff00ff;">&lt;-</span> bsl.joint<span style="color: #20b2aa;">[</span>ratio<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>ratio<span style="color: #daa520;">43</span>, ulimit, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    bsl.test <span style="color: #ff00ff;">&lt;-</span> bsl.test<span style="color: #20b2aa;">[</span>ratio<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>ratio<span style="color: #daa520;">43</span>, ulimit, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)]</span>
    bsl.top <span style="color: #ff00ff;">&lt;-</span> bsl.top<span style="color: #20b2aa;">[</span>bsl.test <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>bsl.test<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>bsl.top<span style="color: #20b2aa;">)))</span> bsl.top <span style="color: #ff00ff;">&lt;-</span> bsl.top<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">sample</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>bsl.top<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>,<span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>BSL<span style="color: #ff00ff;">=</span>bsl.lm, top<span style="color: #ff00ff;">=</span>bsl.top<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> clouds.R</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">clouds</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span>, band<span style="color: #daa520;">6</span>, level <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0014</span>, buffer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>







    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        results <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>
        dims <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>@grid@cells.dim
        band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            results <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>
            dims <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>@grid@cells.dim
            band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            results <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>
            dims <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
            band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> 

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">6</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">6</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>
        band<span style="color: #daa520;">6</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">6</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">6</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">6</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            band<span style="color: #daa520;">6</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">6</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> 

    cloudmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ifelse</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span>band<span style="color: #daa520;">6</span> <span style="color: #ff00ff;">&gt;</span> level, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> 

    cloudmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">movingwindow</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>cloudmask,  nrow<span style="color: #ff00ff;">=</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, ncol<span style="color: #ff00ff;">=</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>, <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, buffer*buffer<span style="color: #20b2aa;">)</span>, buffer, buffer<span style="color: #20b2aa;">))</span>
    cloudmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ifelse</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>cloudmask<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">NA</span><span style="color: #20b2aa;">)</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> cloudmask
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>cloudmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>cloudmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> 
        results <span style="color: #ff00ff;">&lt;-</span> cloudmask

    results
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> ddate.R</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ddate</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>year, month, day<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>year<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        month <span style="color: #ff00ff;">&lt;-</span> year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
        day <span style="color: #ff00ff;">&lt;-</span> year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
        year <span style="color: #ff00ff;">&lt;-</span> year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    year <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">julian</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>year, month, day, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">))</span>, origin<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>year<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">12</span>, <span style="color: #daa520;">31</span>, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">)))[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">365</span>

<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> DOS.R</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">DOS</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>sat<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span>, scattering.coef<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">4</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, <span style="color: #ff00ff;">-</span>.<span style="color: #daa520;">7</span>, <span style="color: #ff00ff;">-</span>.<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>, SHV, SHV.band, gain, offset, Grescale, Brescale, sunelev, edist, Esun<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">198</span>.<span style="color: #daa520;">3</span>, <span style="color: #daa520;">179</span>.<span style="color: #daa520;">6</span>, <span style="color: #daa520;">153</span>.<span style="color: #daa520;">6</span>, <span style="color: #daa520;">103</span>.<span style="color: #daa520;">1</span>, <span style="color: #daa520;">22</span>, <span style="color: #daa520;">8</span>.<span style="color: #daa520;">34</span><span style="color: #20b2aa;">)</span>, blackadjust <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">01</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>sat <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>
        bands <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>
            lmin<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">45</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">52</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">63</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">76</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">55</span>, <span style="color: #daa520;">2</span>.<span style="color: #daa520;">08</span><span style="color: #20b2aa;">)</span>,
            lmax<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">52</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">60</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">69</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">90</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">75</span>, <span style="color: #daa520;">2</span>.<span style="color: #daa520;">35</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>sat <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>
        bands <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>
            lmin<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">45</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">52</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">63</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">77</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">55</span>, <span style="color: #daa520;">2</span>.<span style="color: #daa520;">09</span><span style="color: #20b2aa;">)</span>,
            lmax<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">52</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">60</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">69</span>, <span style="color: #daa520;">0</span>.<span style="color: #daa520;">90</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">75</span>, <span style="color: #daa520;">2</span>.<span style="color: #daa520;">35</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Unknown satellite.\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span>, band<span style="color: #daa520;">2</span>, band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span>, band<span style="color: #daa520;">5</span>, band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>


    scattering.mean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>bands, <span style="color: #daa520;">1</span>, mean<span style="color: #20b2aa;">)</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>scattering.coef<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>scattering.mean<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">colnames</span><span style="color: #20b2aa;">(</span>scattering.mean<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>coef, scattering.coef, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>
    scattering.mean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>scattering.mean, <span style="color: #daa520;">2</span>, scattering.coef, ^<span style="color: #20b2aa;">)</span>
    scattering.mean.pct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>scattering.mean, <span style="color: #daa520;">2</span>, <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>scattering.mean, <span style="color: #daa520;">2</span>, sum<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">/</span><span style="color: #20b2aa;">)</span>

    scattering.approx <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>scattering.coef<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>scattering.approx<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">colnames</span><span style="color: #20b2aa;">(</span>scattering.approx<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>coef, scattering.coef, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>
    grain <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0001</span>
    <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        thisband <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>bands<span style="color: #20b2aa;">[</span>i, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, bands<span style="color: #20b2aa;">[</span>i, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, by<span style="color: #ff00ff;">=</span>grain<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>j <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>scattering.coef<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            scattering.approx<span style="color: #20b2aa;">[</span>i, j<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mean</span><span style="color: #20b2aa;">(</span>thisband ^ scattering.coef<span style="color: #20b2aa;">[</span>j<span style="color: #20b2aa;">])</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    scattering.approx.pct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>scattering.approx, <span style="color: #daa520;">2</span>, <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>scattering.approx, <span style="color: #daa520;">2</span>, sum<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">/</span><span style="color: #20b2aa;">)</span>



    corrband.mean <span style="color: #ff00ff;">&lt;-</span> scattering.mean<span style="color: #20b2aa;">[</span>SHV.band, <span style="color: #20b2aa;">]</span>
    corrband.mean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>scattering.mean, <span style="color: #daa520;">2</span>, corrband.mean, <span style="color: #ff00ff;">/</span><span style="color: #20b2aa;">)</span>
    corrband.approx <span style="color: #ff00ff;">&lt;-</span> scattering.approx<span style="color: #20b2aa;">[</span>SHV.band, <span style="color: #20b2aa;">]</span>
    corrband.approx <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>scattering.approx, <span style="color: #daa520;">2</span>, corrband.approx, <span style="color: #ff00ff;">/</span><span style="color: #20b2aa;">)</span>






    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>offset<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        offset <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * Brescale <span style="color: #ff00ff;">/</span> Grescale
        gain <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span>Grescale
    <span style="color: #20b2aa;">}</span>
    NORM <span style="color: #ff00ff;">&lt;-</span> gain <span style="color: #ff00ff;">/</span> gain<span style="color: #20b2aa;">[</span>SHV.band<span style="color: #20b2aa;">]</span>

    suntheta <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span><span style="color: #ff00ff;">-</span>sunelev<span style="color: #20b2aa;">)</span> * pi <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">180</span>
    suntheta <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>suntheta<span style="color: #20b2aa;">)</span>

    Eo <span style="color: #ff00ff;">&lt;-</span> Esun<span style="color: #20b2aa;">[</span>SHV.band<span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span>edist^<span style="color: #daa520;">2</span>


    SHV <span style="color: #ff00ff;">&lt;-</span> SHV <span style="color: #ff00ff;">-</span> gain<span style="color: #20b2aa;">[</span>SHV.band<span style="color: #20b2aa;">]</span> * blackadjust * Eo * suntheta <span style="color: #ff00ff;">/</span> pi

    SHV <span style="color: #ff00ff;">&lt;-</span> SHV <span style="color: #ff00ff;">-</span> offset<span style="color: #20b2aa;">[</span>SHV.band<span style="color: #20b2aa;">]</span>
    DNfinal.mean <span style="color: #ff00ff;">&lt;-</span> SHV * corrband.mean 
    DNfinal.mean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>DNfinal.mean, <span style="color: #daa520;">1</span>, NORM, *<span style="color: #20b2aa;">)</span>
    DNfinal.mean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>DNfinal.mean, <span style="color: #daa520;">1</span>, offset, <span style="color: #ff00ff;">+</span><span style="color: #20b2aa;">)</span>
    DNfinal.approx <span style="color: #ff00ff;">&lt;-</span> SHV * corrband.approx 
    DNfinal.approx <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>DNfinal.approx, <span style="color: #daa520;">1</span>, NORM, *<span style="color: #20b2aa;">)</span>
    DNfinal.approx <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sweep</span><span style="color: #20b2aa;">(</span>DNfinal.approx, <span style="color: #daa520;">1</span>, offset, <span style="color: #ff00ff;">+</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>DNfinal.mean <span style="color: #ff00ff;">=</span> DNfinal.mean, DNfinal.approx <span style="color: #ff00ff;">=</span> DNfinal.approx<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> ESdist.R</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ESdist</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>adate<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>



    edist <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">julian</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>adate<span style="color: #20b2aa;">)</span>, origin<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">substring</span><span style="color: #20b2aa;">(</span>adate, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">12</span>, <span style="color: #daa520;">31</span>, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">)))[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    edist <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">016729</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">2</span>*pi<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">9856</span> * <span style="color: #20b2aa;">(</span>edist <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>

    edist
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> georef.R</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">georef</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>target, tofix, maxdist <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1000</span>, startx <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span>, starty <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>




    target <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>target<span style="color: #20b2aa;">)</span>
    tofix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">)</span>


    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span> startx !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span> | starty !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        padx <span style="color: #ff00ff;">&lt;-</span> pady <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>startx<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>starty<span style="color: #20b2aa;">))</span>
        target <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">geoshift</span><span style="color: #20b2aa;">(</span>target, padx, pady, <span style="color: #daa520;">0</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        tofix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">geoshift</span><span style="color: #20b2aa;">(</span>tofix, padx, pady, startx, starty<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>target<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>target and tofix must be the same size.\n<span style="color: #20b2aa;">)</span>

    thisx <span style="color: #ff00ff;">&lt;-</span> thisy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    currrmse <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">((</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>target<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">))</span>^<span style="color: #daa520;">2</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>target<span style="color: #20b2aa;">))</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">)))))</span>
    prevrmse <span style="color: #ff00ff;">&lt;-</span> currrmse <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    maxx <span style="color: #ff00ff;">&lt;-</span> maxy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    newx <span style="color: #ff00ff;">&lt;-</span> newy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    initrmse <span style="color: #ff00ff;">&lt;-</span> currrmse
    <span style="color: #00ffff;">while</span><span style="color: #20b2aa;">(</span>currrmse <span style="color: #ff00ff;">&lt;</span> prevrmse<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">9</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">colnames</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x, y, RMSE<span style="color: #20b2aa;">)</span>
        target<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">geoshift</span><span style="color: #20b2aa;">(</span>target, maxx, maxy, <span style="color: #daa520;">0</span>,  <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        target<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>target<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        currrow <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>newx<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, newx<span style="color: #ff00ff;">+</span><span style="color: #daa520;">1</span>, by<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>y <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>newy<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, newy<span style="color: #ff00ff;">+</span><span style="color: #daa520;">1</span>, by<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                tofix<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">geoshift</span><span style="color: #20b2aa;">(</span>tofix, maxx, maxy, x, y<span style="color: #20b2aa;">)</span>
                tofix<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
                results<span style="color: #20b2aa;">[</span>currrow, <span style="color: #daa520;">1</span>:<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
                results<span style="color: #20b2aa;">[</span>currrow, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">((</span>target<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">-</span> tofix<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>^<span style="color: #daa520;">2</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>target<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #daa520;">2</span><span style="color: #20b2aa;">))))</span>
                currrow <span style="color: #ff00ff;">&lt;-</span> currrow <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        prevrmse <span style="color: #ff00ff;">&lt;-</span> currrmse
        currrmse <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">[</span>, RMSE<span style="color: #20b2aa;">])</span>
        newx <span style="color: #ff00ff;">&lt;-</span> results<span style="color: #20b2aa;">[</span>results<span style="color: #20b2aa;">[</span>,RMSE<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> currrmse, x<span style="color: #20b2aa;">]</span>
        newy <span style="color: #ff00ff;">&lt;-</span> results<span style="color: #20b2aa;">[</span>results<span style="color: #20b2aa;">[</span>,RMSE<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> currrmse, y<span style="color: #20b2aa;">]</span>
        maxx <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newx<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newx<span style="color: #ff00ff;">+</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        maxy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newy<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newy<span style="color: #ff00ff;">+</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>


        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newx<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> maxdist | <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>newy<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> maxdist<span style="color: #20b2aa;">)</span> currrmse <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">9999</span>

    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>shiftx<span style="color: #ff00ff;">=</span>newx, shifty<span style="color: #ff00ff;">=</span>newy, initrmse<span style="color: #ff00ff;">=</span>initrmse, currrmse<span style="color: #ff00ff;">=</span>currrmse<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> geoshift.R</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">geoshift</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>mat, padx, pady, shiftx, shifty, nodata<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NA</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>
    results <span style="color: #ff00ff;">&lt;-</span> mat
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">))</span> mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        newmat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>nodata, nrow<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">2</span> * padx<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">2</span> * pady<span style="color: #20b2aa;">))</span>
        newmat<span style="color: #20b2aa;">[(</span>shiftx <span style="color: #ff00ff;">+</span> padx <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> shiftx <span style="color: #ff00ff;">+</span> padx<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">(</span>shifty <span style="color: #ff00ff;">+</span> pady <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> shifty <span style="color: #ff00ff;">+</span> pady<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> mat
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        mat.data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span>
        mat.data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">geoshift</span><span style="color: #20b2aa;">(</span>mat.data, padx, pady, shiftx, shifty, nodata<span style="color: #ff00ff;">=</span>nodata<span style="color: #20b2aa;">)</span>
        mat@data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>mat.data<span style="color: #20b2aa;">))</span>

        mat.grid <span style="color: #ff00ff;">&lt;-</span> mat@grid
        mat.grid@cellcentre.offset<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.grid@cellcentre.offset<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span>padx * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
        mat.grid@cellcentre.offset<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.grid@cellcentre.offset<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span>pady * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
        mat.grid@cells.dim<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.integer</span><span style="color: #20b2aa;">(</span>mat.grid@cells.dim<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">2</span>*padx<span style="color: #20b2aa;">)</span>
        mat.grid@cells.dim<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.integer</span><span style="color: #20b2aa;">(</span>mat.grid@cells.dim<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">2</span>*pady<span style="color: #20b2aa;">)</span>
        mat@grid <span style="color: #ff00ff;">&lt;-</span> mat.grid


        mat.bbox <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>mat<span style="color: #20b2aa;">)</span>
        mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>, min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>, min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span>padx * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
        mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>, max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>, max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>padx * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
        mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>, min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>, min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span>pady * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
        mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>, max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> mat.bbox<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>, max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>pady * mat.grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
        mat@bbox <span style="color: #ff00ff;">&lt;-</span> mat.bbox
    <span style="color: #20b2aa;">}</span>


    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results <span style="color: #ff00ff;">&lt;-</span> mat
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>newmat<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> newmat
    <span style="color: #00ffff;">else</span> 
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>

    results
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> histmatch.R</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">histmatch</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>master, tofix, mask, minval<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, maxval<span style="color: #ff00ff;">=</span><span style="color: #daa520;">255</span>, by<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>


        results <span style="color: #ff00ff;">&lt;-</span> tofix 
        master <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>master<span style="color: #20b2aa;">))</span>
        tofix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">))</span> mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>master<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">))</span>
    results.final <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">))</span>
    master <span style="color: #ff00ff;">&lt;-</span> master<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span>
    tofix <span style="color: #ff00ff;">&lt;-</span> tofix<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span>
        breaks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>minval, maxval, by<span style="color: #ff00ff;">=</span>by<span style="color: #20b2aa;">)</span>
        master.cdf <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">hist</span><span style="color: #20b2aa;">(</span>master, breaks<span style="color: #ff00ff;">=</span>breaks, plot<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> 
        master.cdf <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #ff6347;">cumsum</span><span style="color: #20b2aa;">(</span>master.cdf$counts<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>master.cdf$counts<span style="color: #20b2aa;">)))</span>
        tofix.cdf <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">hist</span><span style="color: #20b2aa;">(</span>tofix, breaks<span style="color: #ff00ff;">=</span>breaks, plot<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> 
        tofix.cdf <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #ff6347;">cumsum</span><span style="color: #20b2aa;">(</span>tofix.cdf$counts<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>tofix.cdf$counts<span style="color: #20b2aa;">)))</span>


        results.recode <span style="color: #ff00ff;">&lt;-</span> breaks
    results.values <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">))</span>






    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">in</span> <span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>breaks<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        testvals <span style="color: #ff00ff;">&lt;-</span> breaks<span style="color: #20b2aa;">[</span>master.cdf <span style="color: #ff00ff;">&lt;</span> tofix.cdf<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]]</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>testvals<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> 
            results.recode<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>testvals<span style="color: #20b2aa;">)</span>
        results.values<span style="color: #20b2aa;">[</span>tofix <span style="color: #ff00ff;">&gt;</span> breaks<span style="color: #20b2aa;">[</span>i<span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> &amp; tofix <span style="color: #ff00ff;">&lt;=</span> breaks<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> results.recode<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    results.final<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> results.values
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> results.final
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>results.final, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>results.final, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span>
        results <span style="color: #ff00ff;">&lt;-</span> results.final
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>recode<span style="color: #ff00ff;">=</span>results.recode, newimage<span style="color: #ff00ff;">=</span>results<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> lssub.R</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">lssub</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>filename, outname, centerx, centery, centerepsg, widthx, widthy<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>


    lsinfo <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>gdalinfo , filename, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>, intern<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    lsorigin <span style="color: #ff00ff;">&lt;-</span> lsinfo<span style="color: #20b2aa;">[</span><span style="color: #daa520;">23</span><span style="color: #20b2aa;">]</span>
    lsorigin <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span>lsorigin,  <span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]][</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    lsorigin <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\\<span style="color: #20b2aa;">(</span>, , lsorigin<span style="color: #20b2aa;">)</span>
    lsorigin <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\\<span style="color: #20b2aa;">)</span>, , lsorigin<span style="color: #20b2aa;">)</span>
    lsorigin <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span>lsorigin, ,<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> lsinfo<span style="color: #20b2aa;">[</span><span style="color: #daa520;">24</span><span style="color: #20b2aa;">]</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span>lspixelsize,  <span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]][</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\\<span style="color: #20b2aa;">(</span>, , lspixelsize<span style="color: #20b2aa;">)</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\\<span style="color: #20b2aa;">)</span>, , lspixelsize<span style="color: #20b2aa;">)</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span>lspixelsize, ,<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>
    lspixelsize <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>lspixelsize<span style="color: #20b2aa;">)</span>
    lsepsg <span style="color: #ff00ff;">&lt;-</span> lsinfo<span style="color: #20b2aa;">[</span><span style="color: #daa520;">22</span><span style="color: #20b2aa;">]</span>
    lsepsg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span>lsepsg, <span style="color: #00ff00;">")[[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]][</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">]</span>

<span style="color: #00ff00;">    if(!missing(centerepsg)) {</span>
<span style="color: #00ff00;">        if(centerepsg != lsepsg) {</span>
<span style="color: #00ff00;">            cat(reprojecting...\n)</span>
<span style="color: #00ff00;">            newcenter &lt;- system(paste(echo , centerx,  , centery,  | gdaltransform -s_srs EPSG:, centerepsg,  -t_srs EPSG:, lsepsg, </span>
<span style="color: #00ff00;">                sep=), intern=TRUE)</span>
<span style="color: #00ff00;">            newcenter &lt;- as.numeric(strsplit(newcenter,  )[[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]][</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">:</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">])</span>
<span style="color: #00ff00;">            centerx &lt;- newcenter[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">            centery &lt;- newcenter[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">    }</span>

<span style="color: #00ff00;">    shiftval &lt;- centerx - lsorigin[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">    shiftval &lt;- ((shiftval / lspixelsize[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]) - floor(shiftval / lspixelsize[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">])) * lspixelsize[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">    if(shiftval != </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>

<span style="color: #00ff00;">        centerx &lt;- centerx - shiftval</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    shiftval &lt;- centery - lsorigin[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">    shiftval &lt;- ((shiftval / lspixelsize[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]) - floor(shiftval / lspixelsize[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">])) * lspixelsize[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]</span>
<span style="color: #00ff00;">    if(shiftval != </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>

<span style="color: #00ff00;">        centery &lt;- centery - shiftval</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    system(paste(gdal_translate -projwin , centerx - (lspixelsize[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]*widthx),  , centery + (lspixelsize[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]*widthy),  , centerx + (lspixelsize[</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]*widthx),  , centery - (lspixelsize[</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]*widthy),  , filename,  , outname, sep=), intern=TRUE)</span>
<span style="color: #00ff00;">    invisible()</span>
<span style="color: #00ff00;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> minnaert.R</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">minnaert</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth, na.value<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NA</span>, GRASS.aspect<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, IL.epsilon<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span>, slopeclass <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">15</span>, <span style="color: #daa520;">20</span>, <span style="color: #daa520;">25</span>, <span style="color: #daa520;">30</span>, <span style="color: #daa520;">45</span><span style="color: #20b2aa;">)</span>, coverclass<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>GRASS.aspect<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>aspect<span style="color: #20b2aa;">)</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * aspect <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">90</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>aspect <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%%</span> <span style="color: #daa520;">360</span>
    <span style="color: #20b2aa;">}</span>
    sloper <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span>
    sloped <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span>
    aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>aspect<span style="color: #20b2aa;">)</span>
    sunzenith <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #ff00ff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    x.orig <span style="color: #ff00ff;">&lt;-</span> x
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    x<span style="color: #20b2aa;">[</span>x <span style="color: #ff00ff;">==</span> na.value<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    IL <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sloper<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>sloper<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">-</span> aspect<span style="color: #20b2aa;">)</span>
    IL<span style="color: #20b2aa;">[</span>IL <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> IL.epsilon
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">))</span> 
        coverclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>




    K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, IL <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>, slope<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>sloped<span style="color: #20b2aa;">))</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>coverclass, <span style="color: #20b2aa;">]</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$IL <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>

    targetslope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">180</span><span style="color: #ff00ff;">/</span>pi<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
    allcoef <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">)[</span>K$slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$IL<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))[</span>K$slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]))[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">colnames</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>midpoint, n, k<span style="color: #20b2aa;">)</span>
    results<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">diff</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span> <span style="color: #ff00ff;">+</span> slopeclass<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    K.cut <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>K$slope, slopeclass<span style="color: #20b2aa;">))</span> 
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>slopeclass is inappropriate <span style="color: #00ffff;">for</span> these <span style="color: #ff6347;">data</span> <span style="color: #20b2aa;">(</span>empty classes<span style="color: #20b2aa;">)</span>\n<span style="color: #20b2aa;">)</span>
    results<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)</span>

   <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)])))</span> <span style="color: #20b2aa;">{</span>
        results<span style="color: #20b2aa;">[</span>i, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">)[</span>K.cut <span style="color: #ff00ff;">==</span> i<span style="color: #20b2aa;">]</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$IL<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))[</span>K.cut <span style="color: #ff00ff;">==</span> i<span style="color: #20b2aa;">]))[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #20b2aa;">}</span>
    model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>results, <span style="color: #ff6347;">gam</span><span style="color: #20b2aa;">(</span>k ~ <span style="color: #ff6347;">s</span><span style="color: #20b2aa;">(</span>midpoint, k<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>midpoint<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)))</span>
    K.all <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>midpoint <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)))</span>
    K.all<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">&gt;</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> 
    K.all<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span> 
    K.all <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>model, newdata<span style="color: #ff00ff;">=</span>K.all<span style="color: #20b2aa;">)</span>
    K.all<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    K.all<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    xout <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)))</span> ^ K.all
    xout<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))[</span>K.all <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span> 

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x.orig<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x.orig@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>xout<span style="color: #20b2aa;">)</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x.orig
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>allcoef<span style="color: #ff00ff;">=</span>allcoef, classcoef<span style="color: #ff00ff;">=</span>results, model<span style="color: #ff00ff;">=</span>model, minnaert<span style="color: #ff00ff;">=</span>xout<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> movingwindow.R</h2>
<div class="outline-text-2" id="text-11">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">movingwindow</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, kernel<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>

    results <span style="color: #ff00ff;">&lt;-</span> x
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    mwoffset <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>kernel<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span>
    newmat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">in</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">+</span>mwoffset<span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span>mwoffset<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>j <span style="color: #00ffff;">in</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">+</span>mwoffset<span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span>mwoffset<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            newmat<span style="color: #20b2aa;">[</span>i, j<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>kernel * x<span style="color: #20b2aa;">[(</span>i<span style="color: #ff00ff;">-</span>mwoffset<span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span>i<span style="color: #ff00ff;">+</span>mwoffset<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">(</span>j<span style="color: #ff00ff;">-</span>mwoffset<span style="color: #20b2aa;">)</span>:<span style="color: #20b2aa;">(</span>j<span style="color: #ff00ff;">+</span>mwoffset<span style="color: #20b2aa;">)])</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>newmat<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>newmat, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>newmat, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
    results
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> PIF.R</h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">PIF</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span>, band<span style="color: #daa520;">7</span>, level<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">99</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
        pifgrid <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        pifgrid <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> 

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.asciigrid</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    band<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">4</span><span style="color: #ff00ff;">/</span>band<span style="color: #daa520;">3</span>

    band<span style="color: #daa520;">43</span>.level <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">43</span>, <span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span>level, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    band<span style="color: #daa520;">7</span>.level <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">7</span>, level, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

    pifmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ifelse</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">43</span> <span style="color: #ff00ff;">&lt;</span> band<span style="color: #daa520;">43</span>.level &amp; band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&gt;</span> band<span style="color: #daa520;">7</span>.level &amp; band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">255</span>, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>


    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        pifgrid@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> pifmask
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">))</span>
        pifgrid <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>pifmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">))</span>
        pifgrid <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>pifmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>pifgrid<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> 
        pifgrid <span style="color: #ff00ff;">&lt;-</span> pifmask

    pifgrid
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> radiocorr.R</h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">radiocorr</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, gain, offset, Grescale, Brescale, sunelev, satzenith<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, edist, Esun, Lhaze, method<span style="color: #ff00ff;">=</span>apparentreflectance<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>
    results <span style="color: #ff00ff;">&lt;-</span> x
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    METHODS <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>apparentreflectance, DOS, COSTZ, DOS<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    method <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pmatch</span><span style="color: #20b2aa;">(</span>method, METHODS<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>method<span style="color: #20b2aa;">))</span> 
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>invalid method<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> 
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>ambiguous method<span style="color: #20b2aa;">)</span>
    suntheta <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span><span style="color: #ff00ff;">-</span>sunelev<span style="color: #20b2aa;">)</span> * pi <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">180</span>
    suntheta <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>suntheta<span style="color: #20b2aa;">)</span>
    satzenith <span style="color: #ff00ff;">&lt;-</span> satzenith * pi <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">180</span>
    satphi <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>satzenith<span style="color: #20b2aa;">)</span>


    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>offset<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        offset <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * Brescale <span style="color: #ff00ff;">/</span> Grescale
        gain <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span>Grescale
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>
        TAUv <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>
        Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span> 
        Lhaze <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>
        TAUv <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>
        Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span> 
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>Lhaze<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>This model requires Lhaze to be specified.\n<span style="color: #20b2aa;">)</span>   
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        TAUz <span style="color: #ff00ff;">&lt;-</span> suntheta
        TAUv <span style="color: #ff00ff;">&lt;-</span> satphi
        Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>Lhaze<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>This model requires Lhaze to be specified.\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> 
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        TAUv <span style="color: #ff00ff;">&lt;-</span> TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        taudiff <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            tau <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">9999</span>
            Edown <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>

        Lhaze.orig <span style="color: #ff00ff;">&lt;-</span> Lhaze

        <span style="color: #00ffff;">while</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>taudiff<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0000001</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            taudiff <span style="color: #ff00ff;">&lt;-</span> tau




            Eo <span style="color: #ff00ff;">&lt;-</span> Esun<span style="color: #ff00ff;">/</span>edist^<span style="color: #daa520;">2</span>
            Lp <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>Lhaze <span style="color: #ff00ff;">-</span> offset<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> gain <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">01</span> * <span style="color: #20b2aa;">(</span>Eo * suntheta * TAUz <span style="color: #ff00ff;">+</span> Edown<span style="color: #20b2aa;">)</span> * TAUv <span style="color: #ff00ff;">/</span> pi
            taustep <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">4</span> * pi * Lp<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>Eo * suntheta<span style="color: #20b2aa;">)</span>
            <span style="color: #00ffff;">while</span><span style="color: #20b2aa;">(</span>taustep <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                Lhaze <span style="color: #ff00ff;">&lt;-</span> Lhaze <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>
                Lp <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>Lhaze <span style="color: #ff00ff;">-</span> offset<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> gain <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">01</span> * <span style="color: #20b2aa;">(</span>Eo * suntheta * TAUz <span style="color: #ff00ff;">+</span> Edown<span style="color: #20b2aa;">)</span> * TAUv <span style="color: #ff00ff;">/</span> pi
                taustep <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">4</span> * pi * Lp<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>Eo * suntheta<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>

            tau <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * suntheta * <span style="color: #ff6347;">log</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">4</span> * pi * Lp<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>Eo * suntheta<span style="color: #20b2aa;">))</span>
            TAUv <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">exp</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * tau <span style="color: #ff00ff;">/</span> satphi<span style="color: #20b2aa;">)</span>
            TAUz <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">exp</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * tau <span style="color: #ff00ff;">/</span> suntheta<span style="color: #20b2aa;">)</span>            
            Edown <span style="color: #ff00ff;">&lt;-</span> pi * Lp

                    taudiff <span style="color: #ff00ff;">&lt;-</span> taudiff <span style="color: #ff00ff;">-</span> tau
        <span style="color: #20b2aa;">}</span>

        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>Lhaze.orig, Lhaze<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Lhaze adjusted from , Lhaze.orig,  to , Lhaze, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>

        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>Lhaze<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>This model requires Lhaze to be specified.\n<span style="color: #20b2aa;">)</span>

    <span style="color: #20b2aa;">}</span>





    x <span style="color: #ff00ff;">&lt;-</span> x <span style="color: #ff00ff;">-</span> Lhaze
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">-</span> offset<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> gain


    x <span style="color: #ff00ff;">&lt;-</span>  <span style="color: #20b2aa;">(</span>pi * edist^<span style="color: #daa520;">2</span> * x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>TAUv * <span style="color: #20b2aa;">(</span>Esun * suntheta * TAUz <span style="color: #ff00ff;">+</span> Edown<span style="color: #20b2aa;">))</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> x
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>x, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> 
        results <span style="color: #ff00ff;">&lt;-</span> x

    results
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> RCS.R</h2>
<div class="outline-text-2" id="text-14">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">RCS</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>data.tc, level<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">01</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    rcsgrid <span style="color: #ff00ff;">&lt;-</span> data.tc$Brightness

    brightness <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>data.tc$Brightness<span style="color: #20b2aa;">))</span>
    greenness <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>data.tc$Greenness<span style="color: #20b2aa;">))</span>

    bright.llevel <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>brightness, level, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    bright.ulevel <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>brightness, <span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span>level, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    green.level <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>greenness, level, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

    rcsmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ifelse</span><span style="color: #20b2aa;">(</span>brightness <span style="color: #ff00ff;">&lt;</span> bright.llevel &amp; greenness <span style="color: #ff00ff;">&lt;</span> green.level, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    rcsmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ifelse</span><span style="color: #20b2aa;">(</span>brightness <span style="color: #ff00ff;">&gt;</span> bright.ulevel &amp; greenness <span style="color: #ff00ff;">&lt;</span> green.level, <span style="color: #daa520;">1</span>, rcsmask<span style="color: #20b2aa;">)</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> 
        rcsgrid@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> rcsmask
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">))</span> 
        rcsgrid <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>rcsmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">))</span> 
        rcsgrid <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>rcsmask, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>rcsgrid<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> 
        rcsgrid <span style="color: #ff00ff;">&lt;-</span> rcsmask
    rcsgrid
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> relnorm.R</h2>
<div class="outline-text-2" id="text-15">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">relnorm</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>master, tofix, mask, method<span style="color: #ff00ff;">=</span>MA, nperm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1000</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>




    results <span style="color: #ff00ff;">&lt;-</span> tofix
    master <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>master<span style="color: #20b2aa;">))</span>
    tofix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>tofix<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span> 
        mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>master<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    master.mask <span style="color: #ff00ff;">&lt;-</span> master<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span>
    x.mask <span style="color: #ff00ff;">&lt;-</span> tofix<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span>
    master.lm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>master.mask ~ x.mask, nperm<span style="color: #ff00ff;">=</span>nperm<span style="color: #20b2aa;">)</span>

    master.lm <span style="color: #ff00ff;">&lt;-</span> master.lm$regression.results<span style="color: #20b2aa;">[</span>master.lm$regression.results<span style="color: #20b2aa;">[</span>, Method<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> method, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>master.lm<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^ *, , <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>master.lm<span style="color: #20b2aa;">))</span>

    x.transform <span style="color: #ff00ff;">&lt;-</span> master.lm$Slope * tofix <span style="color: #ff00ff;">+</span> master.lm$Intercept

    x.transform<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>mask<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> x.transform
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>x.transform, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>x.transform, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> 
        results <span style="color: #ff00ff;">&lt;-</span> x.transform
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>regression.results <span style="color: #ff00ff;">=</span> master.lm, newimage <span style="color: #ff00ff;">=</span> results<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> slopeasp.R</h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">slopeasp</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span> <span style="color: #20b2aa;">(</span>x, EWres, NSres, EWkernel, NSkernel, smoothing <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> 
<span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        xmat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
       xmat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>EWres<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            EWres <span style="color: #ff00ff;">&lt;-</span> x@grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>EWres must be specified <span style="color: #00ffff;">if</span> x is not a SpatialGridDataFrame.\n<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>NSres<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            NSres <span style="color: #ff00ff;">&lt;-</span> x@grid@cellsize<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>NSres must be specified <span style="color: #00ffff;">if</span> x is not a SpatialGridDataFrame.\n<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>EWkernel<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        EWkernel <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #daa520;">0</span>, <span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #daa520;">0</span>, <span style="color: #daa520;">2</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, 
            <span style="color: #daa520;">0</span>, <span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span>, ncol <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">3</span>, nrow <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">3</span>, byrow <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    EW.mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">movingwindow</span><span style="color: #20b2aa;">(</span>xmat, EWkernel<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>EWres
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>NSkernel<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        NSkernel <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #daa520;">2</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #daa520;">0</span>, <span style="color: #daa520;">0</span>, <span style="color: #daa520;">0</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span>, 
            <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span>, ncol <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">3</span>, nrow <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">3</span>, byrow <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    NS.mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">movingwindow</span><span style="color: #20b2aa;">(</span>xmat, NSkernel<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>NSres
    slope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span>EW.mat^<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">+</span> NS.mat^<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>smoothing<span style="color: #20b2aa;">)</span>
    slope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">180</span><span style="color: #ff00ff;">/</span>pi<span style="color: #20b2aa;">)</span> * slope
    aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">180</span> <span style="color: #ff00ff;">-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">180</span><span style="color: #ff00ff;">/</span>pi<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>NS.mat<span style="color: #ff00ff;">/</span>EW.mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">90</span> * <span style="color: #20b2aa;">(</span>EW.mat<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>EW.mat<span style="color: #20b2aa;">))</span>
    aspect<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        temp <span style="color: #ff00ff;">&lt;-</span> x
        temp@data<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span>aspect<span style="color: #20b2aa;">))</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> temp
        temp@data<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span>
        slope <span style="color: #ff00ff;">&lt;-</span> temp
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>slope <span style="color: #ff00ff;">=</span> slope, aspect <span style="color: #ff00ff;">=</span> aspect<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> tasscap.R</h2>
<div class="outline-text-2" id="text-17">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">tasscap</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>basename, sat<span style="color: #ff00ff;">=</span><span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>







    band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">1</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    band<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">2</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">3</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">4</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    band<span style="color: #daa520;">5</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">5</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>basename, <span style="color: #daa520;">7</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        output.sgdf <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>
            use.sgdf <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        band<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">1</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        band<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">2</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        band<span style="color: #daa520;">3</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">3</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        band<span style="color: #daa520;">4</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">4</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        band<span style="color: #daa520;">5</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">5</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        band<span style="color: #daa520;">7</span> <span style="color: #ff00ff;">&lt;-</span> band<span style="color: #daa520;">7</span>@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    all.bands <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span>, band<span style="color: #daa520;">2</span>, band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span>, band<span style="color: #daa520;">5</span>, band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>sat <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        tc.coef <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>


     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3561</span>,     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3972</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3904</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">6966</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2286</span>,       <span style="color: #daa520;">0</span>.<span style="color: #daa520;">1596</span>,    
    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">3344</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">3544</span>,     <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">4556</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">6966</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0242</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">2630</span>,    
     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2626</span>,     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2141</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0926</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0656</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">7629</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">5388</span>,    
     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0805</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0498</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">1950</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1327</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5752</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">7775</span>,    
    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">7252</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0202</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">6683</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0631</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1494</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0274</span>,    
     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">4000</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">8172</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3832</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0602</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1095</span>,       <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0985</span>     
    <span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">6</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>sat <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        tc.coef <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>


     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2043</span>,     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">4158</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5524</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">5741</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3124</span>,       <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2303</span>,    
    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1603</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">2819</span>,     <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">4934</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">7940</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0002</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1446</span>,    
     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0315</span>,     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2021</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3102</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">1594</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">6806</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">6109</span>,    
    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">2117</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0284</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">1302</span>,   <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1007</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">6529</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">7078</span>,    
    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">8669</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">1835</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3856</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0408</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">1132</span>,       <span style="color: #daa520;">0</span>.<span style="color: #daa520;">2272</span>,    
     <span style="color: #daa520;">0</span>.<span style="color: #daa520;">3677</span>,    <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">8200</span>,      <span style="color: #daa520;">0</span>.<span style="color: #daa520;">4354</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0518</span>,    <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0066</span>,      <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0104</span>     
    <span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">6</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>sat not recognized.\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">colnames</span><span style="color: #20b2aa;">(</span>tc.coef<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>band<span style="color: #daa520;">1</span>, band<span style="color: #daa520;">2</span>, band<span style="color: #daa520;">3</span>, band<span style="color: #daa520;">4</span>, band<span style="color: #daa520;">5</span>, band<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rownames</span><span style="color: #20b2aa;">(</span>tc.coef<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>Brightness, Greenness, Wetness, Fourth, Fifth, Sixth<span style="color: #20b2aa;">)</span>
    tc.coef <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span>tc.coef<span style="color: #20b2aa;">)</span>
    output <span style="color: #ff00ff;">&lt;-</span> all.bands <span style="color: #ff00ff;">%</span>*<span style="color: #ff00ff;">%</span> tc.coef
    output <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>output<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span>:<span style="color: #daa520;">3</span><span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>use.sgdf<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        Brightness <span style="color: #ff00ff;">&lt;-</span> output.sgdf
        Brightness@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> output<span style="color: #20b2aa;">[</span>, Brightness<span style="color: #20b2aa;">]</span>
        Greenness <span style="color: #ff00ff;">&lt;-</span> output.sgdf
        Greenness@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> output<span style="color: #20b2aa;">[</span>, Greenness<span style="color: #20b2aa;">]</span>
        Wetness <span style="color: #ff00ff;">&lt;-</span> output.sgdf
        Wetness@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> output<span style="color: #20b2aa;">[</span>, Wetness<span style="color: #20b2aa;">]</span>
        output <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>Brightness<span style="color: #ff00ff;">=</span>Brightness, Greenness<span style="color: #ff00ff;">=</span>Greenness, Wetness<span style="color: #ff00ff;">=</span>Wetness<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    output
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> thermalband.R</h2>
<div class="outline-text-2" id="text-18">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">thermalband</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, band<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>band <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> band.coefs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">055376</span>, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">18</span>, <span style="color: #daa520;">607</span>.<span style="color: #daa520;">76</span>, <span style="color: #daa520;">1260</span>.<span style="color: #daa520;">56</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>band <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">61</span><span style="color: #20b2aa;">)</span> band.coefs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">067087</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">07</span>, <span style="color: #daa520;">666</span>.<span style="color: #daa520;">09</span>, <span style="color: #daa520;">1282</span>.<span style="color: #daa520;">71</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>band <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">62</span><span style="color: #20b2aa;">)</span> band.coefs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">037205</span>, <span style="color: #daa520;">3</span>.<span style="color: #daa520;">16</span>, <span style="color: #daa520;">666</span>.<span style="color: #daa520;">09</span>, <span style="color: #daa520;">1282</span>.<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>
        results <span style="color: #ff00ff;">&lt;-</span> x
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>

        x <span style="color: #ff00ff;">&lt;-</span> x * band.coefs<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> band.coefs<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
        x <span style="color: #ff00ff;">&lt;-</span> band.coefs<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">log</span><span style="color: #20b2aa;">(</span>band.coefs<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span>x <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span>
        results@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> x
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>x, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
        results <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>x, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>results<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> 
        results <span style="color: #ff00ff;">&lt;-</span> x

    results
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> topocorr.R</h2>
<div class="outline-text-2" id="text-19">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">topocorr</span> <span style="color: #ff00ff;">&lt;-</span>
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth, method<span style="color: #ff00ff;">=</span>cosine, na.value<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NA</span>, GRASS.aspect<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, IL.epsilon<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>GRASS.aspect<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>aspect<span style="color: #20b2aa;">)</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span> * aspect <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">90</span>
        aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>aspect <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%%</span> <span style="color: #daa520;">360</span>
    <span style="color: #20b2aa;">}</span>
    slope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span>
    aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>aspect<span style="color: #20b2aa;">)</span>
    sunzenith <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #ff00ff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    x.orig <span style="color: #ff00ff;">&lt;-</span> x
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    x<span style="color: #20b2aa;">[</span>x <span style="color: #ff00ff;">==</span> na.value<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    IL <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">-</span> aspect<span style="color: #20b2aa;">)</span>
    IL<span style="color: #20b2aa;">[</span>IL <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> IL.epsilon
        METHODS <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>cosine, improvedcosine, minnaert, minslope, ccorrection, gamma, SCS, illumination<span style="color: #20b2aa;">)</span>
        method <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pmatch</span><span style="color: #20b2aa;">(</span>method, METHODS<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>method<span style="color: #20b2aa;">))</span> 
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>invalid method<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> 
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>ambiguous method<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">){</span>

        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>IL<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        ILmean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mean</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>x * <span style="color: #20b2aa;">(</span>ILmean <span style="color: #ff00ff;">-</span> IL<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>ILmean<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        targetslope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>


            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">])</span>, x <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">])</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> 
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>IL<span style="color: #20b2aa;">)</span> ^ K
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        targetslope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>


            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">])</span>, x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">])</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> 
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)))</span> ^ K
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        band.lm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">))</span>
        C <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> C<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #ff00ff;">+</span> C<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


        viewterrain <span style="color: #ff00ff;">&lt;-</span> pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span> <span style="color: #ff00ff;">-</span> slope
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>pi <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>viewterrain<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span><span style="color: #ff00ff;">/</span>IL
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        xout <span style="color: #ff00ff;">&lt;-</span> IL
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> 
        xout<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x.orig<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialGridDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x.orig@data<span style="color: #20b2aa;">[</span>,<span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>xout<span style="color: #20b2aa;">)</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x.orig
    <span style="color: #20b2aa;">}</span>
    xout
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: tian</p>
<p class="date">Created: 2014-09-15 Mon 21:49</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.7c)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
