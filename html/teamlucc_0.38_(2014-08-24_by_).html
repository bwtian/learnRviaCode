<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>teamlucc_0.38_(2014-08-24_by_)</title>
<!-- 2014-09-15 Mon 20:58 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="tian" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">teamlucc_0.38_(2014-08-24_by_)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. accuracy.R</a></li>
<li><a href="#sec-2">2. apply_windowed.R</a></li>
<li><a href="#sec-3">3. auto_calc_predictors.R</a></li>
<li><a href="#sec-4">4. auto_chg_detect.R</a></li>
<li><a href="#sec-5">5. auto_classify.R</a></li>
<li><a href="#sec-6">6. auto_cloud_fill.R</a></li>
<li><a href="#sec-7">7. auto_gap_fill.R</a></li>
<li><a href="#sec-8">8. auto_normalize.R</a></li>
<li><a href="#sec-9">9. auto_preprocess_landsat.R</a></li>
<li><a href="#sec-10">10. auto_QA_stats.R</a></li>
<li><a href="#sec-11">11. auto_setup_dem.R</a></li>
<li><a href="#sec-12">12. browse_image.R</a></li>
<li><a href="#sec-13">13. chg_dir.R</a></li>
<li><a href="#sec-14">14. chg_mag.R</a></li>
<li><a href="#sec-15">15. chg_traj_stats.R</a></li>
<li><a href="#sec-16">16. chg_traj.R</a></li>
<li><a href="#sec-17">17. class_statistics.R</a></li>
<li><a href="#sec-18">18. classify.R</a></li>
<li><a href="#sec-19">19. cloud_remove.R</a></li>
<li><a href="#sec-20">20. color_image.R</a></li>
<li><a href="#sec-21">21. compcont.R</a></li>
<li><a href="#sec-22">22. DFPS.R</a></li>
<li><a href="#sec-23">23. ee_plot.R</a></li>
<li><a href="#sec-24">24. ee_read.R</a></li>
<li><a href="#sec-25">25. espa_download.R</a></li>
<li><a href="#sec-26">26. espa_extract.R</a></li>
<li><a href="#sec-27">27. espa_scenelist.R</a></li>
<li><a href="#sec-28">28. fill_gaps.R</a></li>
<li><a href="#sec-29">29. get_band_names_from_hdr.R</a></li>
<li><a href="#sec-30">30. get_extent_polys.R</a></li>
<li><a href="#sec-31">31. get_metadata_item.R</a></li>
<li><a href="#sec-32">32. gridsample.R</a></li>
<li><a href="#sec-33">33. linear_stretch.R</a></li>
<li><a href="#sec-34">34. ls_catalog.R</a></li>
<li><a href="#sec-35">35. match_rasters.R</a></li>
<li><a href="#sec-36">36. minnaert_samp.R</a></li>
<li><a href="#sec-37">37. normalize.R</a></li>
<li><a href="#sec-38">38. overlay_poly.R</a></li>
<li><a href="#sec-39">39. pixel_data.R</a></li>
<li><a href="#sec-40">40. proj4comp.R</a></li>
<li><a href="#sec-41">41. RcppExports.R</a></li>
<li><a href="#sec-42">42. sample_raster.R</a></li>
<li><a href="#sec-43">43. scale_raster.R</a></li>
<li><a href="#sec-44">44. simplify_polygon.R</a></li>
<li><a href="#sec-45">45. split_classes.R</a></li>
<li><a href="#sec-46">46. SVIs.R</a></li>
<li><a href="#sec-47">47. teamlucc-package.R</a></li>
<li><a href="#sec-48">48. threshold.R</a></li>
<li><a href="#sec-49">49. topocorr_samp.R</a></li>
<li><a href="#sec-50">50. topographic_corr.R</a></li>
<li><a href="#sec-51">51. tpa2df.R</a></li>
<li><a href="#sec-52">52. tpadf2raster.R</a></li>
<li><a href="#sec-53">53. track_time.R</a></li>
<li><a href="#sec-54">54. train_classifier.R</a></li>
<li><a href="#sec-55">55. tts2df.R</a></li>
<li><a href="#sec-56">56. ttsdf2raster.R</a></li>
<li><a href="#sec-57">57. unstack_ledapscdr.R</a></li>
<li><a href="#sec-58">58. utm_zone.R</a></li>
</ul>
</div>
</div>
<ul class="org-ul">
<li>Package: teamlucc
</li>
<li>Version: 0.38
</li>
<li>Date: 2014-08-24
</li>
<li>Title: TEAM land use and cover change data processing toolkit
</li>
<li>Authors@R: c(person(&ldquo;Alex&rdquo;, &ldquo;Zvoleff&rdquo;, email="azvoleff@conservation.org&rdquo;,
</li>
<li>role=c(&ldquo;aut&rdquo;, &ldquo;cre&rdquo;)), person(&ldquo;Sarah&rdquo;, &ldquo;Goslee&rdquo;, role = &ldquo;ctb&rdquo;),
</li>
<li>person(&ldquo;Xiaolin&rdquo;, &ldquo;Zhu&rdquo;, role = &ldquo;ctb&rdquo;))
</li>
<li>Maintainer: Alex Zvoleff &lt;azvoleff@conservation.org&gt;
</li>
<li>Depends:
</li>
<li>R (&gt;= 2.10.0),
</li>
<li>Rcpp (&gt;= 0.11.0),
</li>
<li>methods,
</li>
<li>raster (&gt;= 2.2-6)
</li>
<li>Imports:
</li>
<li>sp,
</li>
<li>foreach,
</li>
<li>iterators,
</li>
<li>glcm,
</li>
<li>wrspathrow,
</li>
<li>rgeos,
</li>
<li>rgdal,
</li>
<li>mgcv,
</li>
<li>dplyr,
</li>
<li>lmodel2,
</li>
<li>reshape2,
</li>
<li>ggplot2,
</li>
<li>stringr,
</li>
<li>kernlab,
</li>
<li>e1071,
</li>
<li>randomForest,
</li>
<li>SDMTools,
</li>
<li>grid,
</li>
<li>spatial.tools,
</li>
<li>RCurl,
</li>
<li>gdalUtils,
</li>
<li>caret,
</li>
<li>maptools,
</li>
<li>mclust,
</li>
<li>lubridate,
</li>
<li>XML
</li>
<li>Suggests:
</li>
<li>testthat,
</li>
<li>landsat
</li>
<li>LinkingTo: Rcpp, RcppArmadillo
</li>
<li>SystemRequirements: To perform gap filling of Landsat 7 SLC-off images or
</li>
<li>Landsat scenes with heavy clouds using the IDL code by Xiaolin Zhu at the
</li>
<li>Ohio State University requires licenses for both EXELIS IDL and ENVI, and
</li>
<li>ENVI version 5 or greater.
</li>
<li>Description: teamlucc is a set of routines to support analyzing land use and
</li>
<li>cover change (LUCC) in R. The package was designed to support analyzing
</li>
<li>LUCC in the Zone of Interaction (ZOIs) of monitoring sites in the Tropical
</li>
<li>Ecology Assessment and Monitoring (TEAM) Network.
</li>
<li>License: GPL (&gt;= 3)
</li>
<li>URL: <a href="https://www.azvoleff.com/teamlucc">https://www.azvoleff.com/teamlucc</a>
</li>
<li>BugReports: <a href="https://github.com/azvoleff/teamlucc/issues">https://github.com/azvoleff/teamlucc/issues</a>
</li>
<li>LazyData: true
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> accuracy.R</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span>accuracy, slots<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>ct<span style="color: #ff00ff;">=</span>table, pop_ct<span style="color: #ff00ff;">=</span>table, Q<span style="color: #ff00ff;">=</span>numeric, 
                             A<span style="color: #ff00ff;">=</span>numeric, n_test<span style="color: #ff00ff;">=</span>numeric,
                             pop<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">summary.accuracy</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    obj <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    obj<span style="color: #20b2aa;">[[</span>class<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>Q<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> object@Q
    obj<span style="color: #20b2aa;">[[</span>A<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> object@A
    obj<span style="color: #20b2aa;">[[</span>ct<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> object@ct
    obj<span style="color: #20b2aa;">[[</span>pop_ct<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> object@pop_ct
    obj<span style="color: #20b2aa;">[[</span>n_test<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> object@n_test
    margined_pop_ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>object@pop_ct<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>overall_acc<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> margined_pop_ct<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>margined_pop_ct<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>obj<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> summary.accuracy
    obj
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">print.summary.accuracy</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Object of class <span style="color: #00ff00;">", x[[class]], "</span>\n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Testing samples:\t, x<span style="color: #20b2aa;">[[</span>n_test<span style="color: #20b2aa;">]]</span>, \n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>Sample contingency table:\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>ct<span style="color: #20b2aa;">]]))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>Population contingency table:\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>      <span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>pop_ct<span style="color: #20b2aa;">]]))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Overall accuracy:\t, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>overall_acc<span style="color: #20b2aa;">]]</span>, digits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, \n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Quantity disagreement:\t\t, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>Q<span style="color: #20b2aa;">]]</span>, digits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, \n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Allocation disagreement:\t, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>A<span style="color: #20b2aa;">]]</span>, digits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, \n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">invisible</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">print.accuracy</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #ff00ff;">=</span>accuracy<span style="color: #20b2aa;">)</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span>error_adj_area, slots<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>adj_areas<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>numeric, y<span style="color: #ff00ff;">=</span>table<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    pop <span style="color: #ff00ff;">&lt;-</span> x
    ct <span style="color: #ff00ff;">&lt;-</span> y
    Wi <span style="color: #ff00ff;">&lt;-</span> pop <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span>
    adj_area_est <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>Wi * <span style="color: #20b2aa;">(</span>ct <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)))</span>

    std_err_p <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>Wi^<span style="color: #daa520;">2</span> *
                              <span style="color: #20b2aa;">(((</span>ct <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>*<span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> ct <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">/</span>
                               <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))))</span>

    std_err_area <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> * std_err_p
    adj_area_mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>pop, adj_area_est, std_err_area, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * std_err_area<span style="color: #20b2aa;">)</span>
    adj_area_mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>adj_area_mat, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>Mapped area, Adj. area, S.E., 
                                     <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * S.E.<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>error_adj_area, adj_area_mat<span style="color: #ff00ff;">=</span>adj_area_mat<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>numeric, y<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> table
    <span style="color: #ff6347;">adj_areas</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>accuracy, y<span style="color: #ff00ff;">=</span>missing<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    pop <span style="color: #ff00ff;">&lt;-</span> x@pop
    ct <span style="color: #ff00ff;">&lt;-</span> x@ct
    <span style="color: #ff6347;">adj_areas</span><span style="color: #20b2aa;">(</span>pop, ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #ff00ff;">=</span>error_adj_area<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>Object of class: error_adj_area\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>Accuracy<span style="color: #ff00ff;">-</span>adjusted area table:\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object@adj_area_mat<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">plot.error_adj_area</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    classes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>x@adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    areas <span style="color: #ff00ff;">&lt;-</span> x@adj_area_mat<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    se <span style="color: #ff00ff;">&lt;-</span> x@adj_area_mat<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    plt_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>classes, y<span style="color: #ff00ff;">=</span>areas, se<span style="color: #ff00ff;">=</span>se<span style="color: #20b2aa;">)</span>
    y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span> 
    <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>plt_data, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">geom_bar</span><span style="color: #20b2aa;">(</span>stat<span style="color: #ff00ff;">=</span>identity<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> 
        <span style="color: #ff6347;">geom_errorbar</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>ymin<span style="color: #ff00ff;">=</span>y <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * se, ymax<span style="color: #ff00ff;">=</span>y <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * se<span style="color: #20b2aa;">)</span>, width<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">25</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
        <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span>Class<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">ylab</span><span style="color: #20b2aa;">(</span>Area<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_pop_ct</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>ct, pop<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    nijsum <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>
    Ni <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>pop, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>

    pop_ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>ct <span style="color: #ff00ff;">/</span> nijsum<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>Ni <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> table
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_Q</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    qg_mat <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>qg_mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_A</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    diag_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">diag</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    ag_mat <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">2</span> * <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> pop_ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span>,
                             <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> pop_ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">])</span>, <span style="color: #daa520;">1</span>, min<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ag_mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.add_ct_margins</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>ct, digits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>




    diag_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">diag</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    users_acc <span style="color: #ff00ff;">&lt;-</span> ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    prod_acc <span style="color: #ff00ff;">&lt;-</span> ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    overall_acc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">addmargins</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]][</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> Total
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]][</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> Total
    ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>ct, Producers<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>users_acc, <span style="color: #daa520;">NA</span><span style="color: #20b2aa;">))</span>
    ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>ct, Users<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>prod_acc, <span style="color: #daa520;">NA</span>, overall_acc<span style="color: #20b2aa;">))</span>
    ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>ct, digits<span style="color: #ff00ff;">=</span>digits<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>predicted<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>,
                         observed<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]])</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> table
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> 
           <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>accuracy<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>train, test_data<span style="color: #ff00ff;">=</span>ANY, pop<span style="color: #ff00ff;">=</span>ANY, class_col<span style="color: #ff00ff;">=</span>missing, reclass_mat<span style="color: #ff00ff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            test_data <span style="color: #ff00ff;">&lt;-</span> x$trainingData
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> .outcome<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> y
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            test_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>test_data@y, 
                               test_data@x,
                               training_flag<span style="color: #ff00ff;">=</span>test_data@training_flag<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>training_flag <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>no training_flag variable found <span style="color: #ff00ff;">-</span> assuming none of <span style="color: #00ff00;">"test_data"</span> was used <span style="color: #00ffff;">for</span> model training<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>test_data$training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>test_data$training_flag<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cannot conduct accuracy assessment without independent testing data<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        test_data <span style="color: #ff00ff;">&lt;-</span> test_data<span style="color: #20b2aa;">[</span>!test_data$training_flag, <span style="color: #20b2aa;">]</span>
        complete_rows <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>complete_rows<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>ignored, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>complete_rows<span style="color: #20b2aa;">)</span>, 
                          rows because of missing data<span style="color: #20b2aa;">))</span>
            test_data <span style="color: #ff00ff;">&lt;-</span> test_data<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        predicted <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>x, test_data<span style="color: #20b2aa;">)</span>
        observed <span style="color: #ff00ff;">&lt;-</span> test_data$y
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>RasterLayer, test_data<span style="color: #ff00ff;">=</span>pixel_data, pop<span style="color: #ff00ff;">=</span>ANY, class_col<span style="color: #ff00ff;">=</span>missing, reclass_mat<span style="color: #ff00ff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>test_data@training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cannot conduct accuracy assessment without independent testing data<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>test_data@training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

            predicted <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, test_data@polys, small<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
            observed <span style="color: #ff00ff;">&lt;-</span> test_data@y
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>

            predicted <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, test_data@polys<span style="color: #20b2aa;">[</span>!test_data@training_flag<span style="color: #20b2aa;">]</span>, 
                                 small<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
            observed <span style="color: #ff00ff;">&lt;-</span> test_data@y<span style="color: #20b2aa;">[</span>!test_data@training_flag<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        predicted <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>predicted, labels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>observed<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>RasterLayer, test_data<span style="color: #ff00ff;">=</span>SpatialPolygonsDataFrame, pop<span style="color: #ff00ff;">=</span>ANY, class_col<span style="color: #ff00ff;">=</span>character, reclass_mat<span style="color: #ff00ff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>x, test_data, class_col<span style="color: #ff00ff;">=</span>class_col<span style="color: #20b2aa;">)</span>




        observed <span style="color: #ff00ff;">&lt;-</span> ext@y
        predicted <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>ext@x<span style="color: #20b2aa;">[</span>, <span style="color: #20b2aa;">]</span>, labels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>ext@y<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">calc_accuracy</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>reclass_mat<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>reclass_mat not yet supported<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>predicted, observed<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>pop was not provided <span style="color: #ff00ff;">-</span> assuming sample frequencies equal population frequencies<span style="color: #20b2aa;">)</span>
        pop <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> RasterLayer<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        pop <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>pop, useNA<span style="color: #ff00ff;">=</span>no<span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>number of classes <span style="color: #00ffff;">in</span> pop must be equal to <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>integer, numeric<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> must be equal to number of classes <span style="color: #00ffff;">in</span> the predicted data<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span> 
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>pop must be a numeric vector or integer vector of length equal to the number of classes <span style="color: #00ffff;">in</span> x, or a RasterLayer, or <span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pop_ct <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_pop_ct</span><span style="color: #20b2aa;">(</span>ct, pop<span style="color: #20b2aa;">)</span>
    Q <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_Q</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
    A <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_A</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>accuracy, ct<span style="color: #ff00ff;">=</span>ct, pop_ct<span style="color: #ff00ff;">=</span>pop_ct, Q<span style="color: #ff00ff;">=</span>Q, A<span style="color: #ff00ff;">=</span>A, 
               n_test<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>observed<span style="color: #20b2aa;">)</span>, pop<span style="color: #ff00ff;">=</span>pop<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> apply_windowed.R</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">apply_windowed</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, fun, edge<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>, chunksize<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, filename<span style="color: #ff00ff;">=</span>, 
                          overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, datatype<span style="color: #ff00ff;">=</span>FLT<span style="color: #daa520;">4</span>S, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> numeric<span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span>edge <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>edge must be a length <span style="color: #daa520;">2</span> positive numeric<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>chunksize<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>x, chunksize<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_blocks <span style="color: #ff00ff;">&lt;-</span> bs$n


    bs_mod <span style="color: #ff00ff;">&lt;-</span> bs

    bs_mod$row<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> bs_mod$row<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>

    bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>

    bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span>n_blocks <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span>n_blocks <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">+</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span>bs_mod$row <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>too many blocks to read without edge effects <span style="color: #ff00ff;">-</span> try increasing chunksize<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">((</span>bs_mod$nrows <span style="color: #ff00ff;">+</span> bs_mod$row <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>too many blocks to read without edge effects <span style="color: #ff00ff;">-</span> try increasing chunksize<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    started_writes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        this_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x, row<span style="color: #ff00ff;">=</span>bs_mod$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                nrows<span style="color: #ff00ff;">=</span>bs_mod$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                format<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>
        out_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">fun</span><span style="color: #20b2aa;">(</span>this_block, ...<span style="color: #20b2aa;">)</span>
        layer_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]]</span>



        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>block_num !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> out_block<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>, , <span style="color: #20b2aa;">]</span>






            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>



        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>block_num !<span style="color: #ff00ff;">=</span> n_blocks<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> out_block<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">((</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">-</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">+</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span>, , <span style="color: #20b2aa;">]</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!started_writes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>, values<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>filename <span style="color: #ff00ff;">==</span> <span style="color: #20b2aa;">)</span> filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
            out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #ff00ff;">=</span>filename, overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                              datatype<span style="color: #ff00ff;">=</span>datatype<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> layer_names
            started_writes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #20b2aa;">}</span>


        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">aperm</span><span style="color: #20b2aa;">(</span>out_block, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>out_block, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">aperm</span><span style="color: #20b2aa;">(</span>out_block, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
            out_block <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>out_block, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, out_block, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">calc_glcm_edge</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>shift, window<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> shift <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.vector</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>shift, length<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> &amp;&amp;
         !<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> ||
        !<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>shift must be a list of length <span style="color: #daa520;">2</span> integer vectors, or a <span style="color: #daa520;">2</span> column matrix<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        shift <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    neg_shifts <span style="color: #ff00ff;">&lt;-</span> shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">][</span>shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span>
    pos_shifts <span style="color: #ff00ff;">&lt;-</span> shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">][</span>shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>neg_shifts<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> neg_shifts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pos_shifts<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> pos_shifts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>neg_shifts<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">ceiling</span><span style="color: #20b2aa;">(</span>window<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>,
             <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>pos_shifts<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">ceiling</span><span style="color: #20b2aa;">(</span>window<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> auto_calc_predictors.R</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">auto_calc_predictors</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, dem, slopeaspect, output_path<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                                 ext<span style="color: #ff00ff;">=</span>tif, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, notify<span style="color: #ff00ff;">=</span>print,
                                 ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>input image, x, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span>.<span style="color: #20b2aa;">]</span>, , ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Predictor calculation<span style="color: #20b2aa;">)</span>

    preproc_regex <span style="color: #ff00ff;">&lt;-</span> ^<span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span>,<span style="color: #daa520;">3</span><span style="color: #20b2aa;">}</span>_<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}</span>_<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}</span>_L<span style="color: #20b2aa;">[</span><span style="color: #daa520;">457</span><span style="color: #20b2aa;">][</span>ET<span style="color: #20b2aa;">]</span><span style="color: #ff6347;">SR</span><span style="color: #20b2aa;">(</span>_tc<span style="color: #20b2aa;">)</span>?

    image_basename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    image_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        output_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    mask_stack_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, _masks., ext<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, mask_stack_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        mask_stack_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">((</span>_tc<span style="color: #20b2aa;">)</span>?., ext, $<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_masks., ext<span style="color: #20b2aa;">)</span>, x<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, mask_stack_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>using masks file with old <span style="color: #ff6347;">format</span> <span style="color: #20b2aa;">(</span>pre v<span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> teamlucc naming<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>could not find masks file<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>mask_stack_file<span style="color: #20b2aa;">)</span>
    image_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>maskvals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #20b2aa;">(</span>maskvals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>maskvals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>maskvals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">})</span>


    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating MSAVI<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                 <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, _MSAVI<span style="color: #daa520;">2</span>., ext<span style="color: #20b2aa;">))</span>
    MSAVI<span style="color: #daa520;">2</span>_layer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                           nir<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>


    MSAVI<span style="color: #daa520;">2</span>_layer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_layer, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
            vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>vals * <span style="color: #daa520;">10000</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, filename<span style="color: #ff00ff;">=</span>MSAVI<span style="color: #daa520;">2</span>_filename, overwrite<span style="color: #ff00ff;">=</span>overwrite, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating MSAVI<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating GLCM textures<span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_glcm_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                      <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, 
                                            _MSAVI<span style="color: #daa520;">2</span>_glcm., ext<span style="color: #20b2aa;">))</span>
    glcm_statistics <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>mean, variance, homogeneity, contrast, 
                         dissimilarity, entropy, second_moment, 
                         correlation<span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_layer<span style="color: #20b2aa;">[</span>image_mask<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>



    dots <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>...<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>window <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>dots<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        dots$window <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>shift <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>dots<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        dots$shift <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    edge <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc_glcm_edge</span><span style="color: #20b2aa;">(</span>dots$shift, dots$window<span style="color: #20b2aa;">)</span>


    apply_windowed_args <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>MSAVI<span style="color: #daa520;">2</span>_layer, fun<span style="color: #ff00ff;">=</span>glcm, edge<span style="color: #ff00ff;">=</span>edge, min_x<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, 
                             max_x<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10000</span>, filename<span style="color: #ff00ff;">=</span>MSAVI<span style="color: #daa520;">2</span>_glcm_filename, 
                             overwrite<span style="color: #ff00ff;">=</span>overwrite, statistics<span style="color: #ff00ff;">=</span>glcm_statistics, 
                             na_opt<span style="color: #ff00ff;">=</span>center<span style="color: #20b2aa;">)</span>
    apply_windowed_args <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>apply_windowed_args, dots<span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_glcm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">do.call</span><span style="color: #20b2aa;">(</span>apply_windowed, apply_windowed_args<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>glcm, glcm_statistics, sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating GLCM textures<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Processing slopeaspect<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>slope, aspect<span style="color: #20b2aa;">)</span>






        aspect_cut <span style="color: #ff00ff;">&lt;-</span> raster::<span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slopeaspect$aspect<span style="color: #ff00ff;">/</span><span style="color: #daa520;">1000</span>,
                                  <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">45</span>, <span style="color: #daa520;">135</span>, <span style="color: #daa520;">225</span>, <span style="color: #daa520;">315</span>, <span style="color: #daa520;">361</span><span style="color: #20b2aa;">)</span>*<span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">))</span>

        aspect_cut<span style="color: #20b2aa;">[</span>aspect_cut <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>aspect_cut<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> aspect
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Processing slopeaspect<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>


    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Writing predictors<span style="color: #20b2aa;">)</span>
    predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>,
                        MSAVI<span style="color: #daa520;">2</span>_layer,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_mean<span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_variance<span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_dissimilarity<span style="color: #20b2aa;">))</span>
    predictor_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>b<span style="color: #daa520;">1</span>, b<span style="color: #daa520;">2</span>, b<span style="color: #daa520;">3</span>, b<span style="color: #daa520;">4</span>, b<span style="color: #daa520;">5</span>, b<span style="color: #daa520;">7</span>, msavi, 
                         msavi_glcm_mean, msavi_glcm_variance, 
                         msavi_glcm_dissimilarity<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>dem<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>predictors, dem<span style="color: #20b2aa;">)</span>
        predictor_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>predictor_names, elev<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>predictors, slopeaspect$slope, aspect_cut<span style="color: #20b2aa;">)</span>
        predictor_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>predictor_names, slope, aspect<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    predictors_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                     <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, _predictors., 
                                            ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> predictor_names
    predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>predictors, image_mask, maskvalue<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, 
                       filename<span style="color: #ff00ff;">=</span>predictors_filename, 
                       overwrite<span style="color: #ff00ff;">=</span>overwrite, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> predictor_names


    predictors_mask_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                          <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, 
                                                 _predictors_masks., ext<span style="color: #20b2aa;">))</span>
    mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>mask_stack, filename<span style="color: #ff00ff;">=</span>predictors_mask_filename, 
                              overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                              datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Writing predictors<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Predictor calculation<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> auto_chg_detect.R</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">auto_chg_detect</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_classes, t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, output_path, 
                            output_basename, ext<span style="color: #ff00ff;">=</span>tif, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, 
                            chg_threshold<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, notify<span style="color: #ff00ff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span>.<span style="color: #20b2aa;">]</span>, , ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change detection<span style="color: #20b2aa;">)</span>



    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change magnitude and direction<span style="color: #20b2aa;">)</span>
    chg_dir_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, 
                                                     _chgdir., ext<span style="color: #20b2aa;">))</span>
    chg_dir_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">chg_dir</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, filename<span style="color: #ff00ff;">=</span>chg_dir_filename, 
                             overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    chg_mag_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, 
                                                     _chgmag., ext<span style="color: #20b2aa;">))</span>
    chg_mag_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">chg_mag</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, filename<span style="color: #ff00ff;">=</span>chg_mag_filename, 
                             overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change magnitude and direction<span style="color: #20b2aa;">)</span>



    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change trajectories<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>chg_threshold<span style="color: #20b2aa;">))</span> chg_threshold <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">threshold</span><span style="color: #20b2aa;">(</span>chg_mag_image<span style="color: #20b2aa;">)</span>

    <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Using threshold<span style="color: #ff00ff;">=</span>, chg_threshold<span style="color: #20b2aa;">))</span>
    chg_traj_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                   <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, _chgtraj., ext<span style="color: #20b2aa;">))</span>
    chg_traj_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">chg_traj</span><span style="color: #20b2aa;">(</span>chg_mag_image, chg_dir_image, 
                             chg_threshold<span style="color: #ff00ff;">=</span>chg_threshold, overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                             filename<span style="color: #ff00ff;">=</span>chg_traj_filename<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change trajectories<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Change detection<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> auto_classify.R</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">auto_classify</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>predictor_file, train_shp, output_path, 
                          class_col<span style="color: #ff00ff;">=</span>Poly_Type, training<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">6</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, 
                          notify<span style="color: #ff00ff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, train_shp<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>train_shp, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, predictor_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>predictor_file, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running auto_classify<span style="color: #20b2aa;">)</span>
    predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>predictor_file<span style="color: #20b2aa;">)</span>
    pred_rast_basename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>predictor_file<span style="color: #20b2aa;">))</span>
    train_polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readOGR</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>train_shp<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>train_shp<span style="color: #20b2aa;">)))</span>
    train_polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>train_polys, <span style="color: #ff6347;">crs</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">))</span>
    train_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>predictors, train_polys, class_col<span style="color: #ff00ff;">=</span>class_col, 
                             training<span style="color: #ff00ff;">=</span>training<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running classification<span style="color: #20b2aa;">)</span>
    classification <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">classify</span><span style="color: #20b2aa;">(</span>predictors, train_data<span style="color: #20b2aa;">)</span>
    model <span style="color: #ff00ff;">&lt;-</span> classification$model
    <span style="color: #ff6347;">save</span><span style="color: #20b2aa;">(</span>model, file<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                  predmodel.RData, sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>classification$pred_classes,
                filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                      predclasses.tif, 
                                                      sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">))</span>,
                datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>classification$pred_probs<span style="color: #20b2aa;">)</span>,
                filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                      predprobs.tif, 
                                                      sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">))</span>,
                datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running classification<span style="color: #20b2aa;">)</span>






    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running accuracy assessment<span style="color: #20b2aa;">)</span>
    acc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">accuracy</span><span style="color: #20b2aa;">(</span>classification$model, 
                    pop<span style="color: #ff00ff;">=</span>classification$pred_classes<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>acc<span style="color: #20b2aa;">)</span>,
                   file<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, predacc.txt, sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">)))</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running accuracy assessment<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Running auto_classify<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> auto_cloud_fill.R</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">pct_clouds</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    num_clouds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span>, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    num_clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span>, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>num_clouds <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>num_clouds <span style="color: #ff00ff;">+</span> num_clear<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">auto_cloud_fill</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>data_dir, wrspath, wrsrow, start_date, end_date, 
                            out_name, base_date<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, tc<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, ext<span style="color: #ff00ff;">=</span>tif,
                            sensors<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">4</span>T, L<span style="color: #daa520;">5</span>T, L<span style="color: #daa520;">7</span>E, L<span style="color: #daa520;">8</span>C<span style="color: #20b2aa;">)</span>, 
                            img_type<span style="color: #ff00ff;">=</span>CDR, threshold<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, max_iter<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span>, 
                            notify<span style="color: #ff00ff;">=</span>print, verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, data_dir<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>data_dir does not exist<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output folder does not exist<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> out_name<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>out_name should not have a file extension<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span>.<span style="color: #20b2aa;">]</span>, , ext<span style="color: #20b2aa;">)</span>
    output_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, ., ext<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, output_file<span style="color: #20b2aa;">)</span> &amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output file <span style="color: #00ff00;">", output_file, "</span> already exists<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>sensors <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">4</span>T, L<span style="color: #daa520;">5</span>T, L<span style="color: #daa520;">7</span>E, L<span style="color: #daa520;">8</span>C<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">"sensors"</span> must be a list of one or more of: <span style="color: #00ff00;">"L</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">T"</span>, <span style="color: #00ff00;">"L</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">T"</span>, <span style="color: #00ff00;">"L</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">E"</span>, <span style="color: #00ff00;">"L</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">C"</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    log_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, _log.txt<span style="color: #20b2aa;">)</span>, open<span style="color: #ff00ff;">=</span>wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">msg</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>txt, \n<span style="color: #20b2aa;">)</span>, file<span style="color: #ff00ff;">=</span>log_file, append<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>msg<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Cloud fill<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span>
    wrspath <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, wrspath<span style="color: #20b2aa;">)</span>
    wrsrow <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, wrsrow<span style="color: #20b2aa;">)</span>

    prefix_re <span style="color: #ff00ff;">&lt;-</span> ^<span style="color: #20b2aa;">([</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]</span>*_<span style="color: #20b2aa;">)</span>?

    pathrow_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>wrspath, wrsrow, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">)</span>
    date_re <span style="color: #ff00ff;">&lt;-</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">19</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">01</span><span style="color: #20b2aa;">]))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0123</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #ff00ff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sensor_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">((</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">((</span>, sensors,<span style="color: #20b2aa;">))</span>, collapse<span style="color: #ff00ff;">=</span>|<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">)</span>, SR<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #ff00ff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sensor_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">((</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">((</span>, sensors,<span style="color: #20b2aa;">))</span>, collapse<span style="color: #ff00ff;">=</span>|<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">)</span>, L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_tc., ext, $<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>., ext, $<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    file_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix_re, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pathrow_re, date_re, sensor_re, 
                                       sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">)</span>, suffix_re<span style="color: #20b2aa;">)</span>
    img_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>data_dir, pattern<span style="color: #ff00ff;">=</span>file_re, recursive<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, date_re<span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #ff00ff;">%</span>Y<span style="color: #ff00ff;">-%</span>j<span style="color: #20b2aa;">)</span>
    which_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">((</span>img_dates <span style="color: #ff00ff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span> &amp;
                          <span style="color: #20b2aa;">(</span>img_dates <span style="color: #ff00ff;">&lt;</span> end_date<span style="color: #20b2aa;">))</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">]</span>
    img_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>data_dir, img_files<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no images found <span style="color: #ff00ff;">-</span> check date_dir, check wrspath, wrsrow, start_date, and end_date<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Only, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>,
                   <span style="color: #ff6347;">image</span><span style="color: #20b2aa;">(</span>s<span style="color: #20b2aa;">)</span> found. Need at least two images to perform cloud fill<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Found, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">image</span><span style="color: #20b2aa;">(</span>s<span style="color: #20b2aa;">)))</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Analyzing cloud cover <span style="color: #00ffff;">in</span> input images<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    fmasks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    fill_QAs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    imgs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>img_file <span style="color: #00ffff;">in</span> img_files<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        masks_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>, _masks., ext<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, masks_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            masks_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>suffix_re, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_masks., ext<span style="color: #20b2aa;">)</span>, img_file<span style="color: #20b2aa;">)</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, masks_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>using masks file with old <span style="color: #ff6347;">format</span> <span style="color: #20b2aa;">(</span>pre v<span style="color: #daa520;">0</span>.<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> teamlucc naming<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>could not find masks file<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        this_fill_QA <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        fill_QAs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_QAs, this_fill_QA<span style="color: #20b2aa;">)</span>
        this_fmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        fmasks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fmasks, this_fmask<span style="color: #20b2aa;">)</span>
        this_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>
        imgs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>imgs, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>this_img<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>imgs, res<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, orig<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>fmasks, res<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, orig<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    freq_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">)</span>, useNA<span style="color: #ff00ff;">=</span>no, merge<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

    freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Analyzing cloud cover <span style="color: #00ffff;">in</span> input images<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating cloud masks<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>


    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>base_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        clear_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table$value <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        base_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        base_date_diff <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> 
                                 <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>x, base_date<span style="color: #20b2aa;">)))</span>
        base_date_diff <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>base_date_diff <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>


        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>base_img_index<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            base_img_index <span style="color: #ff00ff;">&lt;-</span> base_img_index<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>


    base_fmask <span style="color: #ff00ff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    base_fill_QA <span style="color: #ff00ff;">&lt;-</span> fill_QAs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>









    <span style="color: #ff6347;">calc_cloud_mask</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>fmask, img<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>

        ret<span style="color: #20b2aa;">[</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">2</span>






        ret<span style="color: #20b2aa;">[(</span>ret !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>ret !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>img<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        fmasks<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, imgs<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]][[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>, fun<span style="color: #ff00ff;">=</span>calc_cloud_mask, 
                             datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]))</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    imgs <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_mask <span style="color: #ff00ff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    fmasks <span style="color: #ff00ff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_img_date <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>base_img_index<span style="color: #20b2aa;">]</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Using image from, base_img_date, as base image.<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Calculating cloud masks<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Masking base image<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>



    base_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_img, base_mask,
        fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>base_vals, mask_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

            base_vals<span style="color: #20b2aa;">[</span>mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>

            base_vals<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>base_vals<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>

            base_vals<span style="color: #20b2aa;">[</span>mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>base_vals<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>, 
        filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    cur_pct_clouds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Base image has , <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>cur_pct_clouds, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">%</span> cloud cover before fill<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Masking base image<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">while</span> <span style="color: #20b2aa;">((</span>cur_pct_clouds <span style="color: #ff00ff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">&lt;</span> max_iter<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>imgs<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Fill iteration, n <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>





        fill_areas <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">)</span>,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>base_mask_vals, fill_mask_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>base_mask_vals<span style="color: #20b2aa;">))</span>

                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>

                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>


                ret<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>base_mask_vals<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>


                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
        fill_areas_freq <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>fill_areas, useNA<span style="color: #ff00ff;">=</span>no, merge<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>


        fill_areas_freq <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">)</span>



        avail_fill_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq$value <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>avail_fill_row<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>No fill pixels available. Stopping fill.<span style="color: #20b2aa;">))</span>
            <span style="color: #00ffff;">break</span>
        <span style="color: #20b2aa;">}</span>

        fill_areas_freq <span style="color: #ff00ff;">&lt;-</span> fill_areas_freq<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> value<span style="color: #20b2aa;">)]</span>
        fill_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #20b2aa;">]</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>fill_img_index<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> ||
            <span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, fill_img_index<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>No fill pixels available. Stopping fill.<span style="color: #20b2aa;">))</span>
            <span style="color: #00ffff;">break</span>
        <span style="color: #20b2aa;">}</span>
        fill_img <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        imgs <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        base_img_mask <span style="color: #ff00ff;">&lt;-</span> fill_areas<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        fmasks <span style="color: #ff00ff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        fill_img_date <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>fill_img_index<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>

        base_img_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ConnCompLabel</span><span style="color: #20b2aa;">(</span>base_img_mask<span style="color: #20b2aa;">)</span>

        <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img_mask<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> INT<span style="color: #daa520;">2</span>S
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Filling image from , base_img_date,
                           with image from , fill_img_date, .<span style="color: #20b2aa;">))</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Performing fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        base_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove</span><span style="color: #20b2aa;">(</span>base_img, fill_img, base_img_mask, 
                                 out_name<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, 
                                 verbose<span style="color: #ff00ff;">=</span>verbose, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span>





        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Performing fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>

        base_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, base_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>mask_vals, filled_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                mask_vals<span style="color: #20b2aa;">[(</span>mask_vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>filled_vals !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>mask_vals<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>, 
            filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        cur_pct_clouds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Base image has , <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>cur_pct_clouds, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>,
                          <span style="color: #ff00ff;">%</span> cloud cover remaining<span style="color: #20b2aa;">))</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Fill iteration, n <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        n <span style="color: #ff00ff;">&lt;-</span> n <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_img, filename<span style="color: #ff00ff;">=</span>output_file, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, 
                            overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>













    mask_output_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, _masks., ext<span style="color: #20b2aa;">)</span>
    filled_fmask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, base_fmask,
        fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>after_fill, before_fill<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            ret <span style="color: #ff00ff;">&lt;-</span> after_fill

            ret<span style="color: #20b2aa;">[(</span>after_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>before_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>

            ret<span style="color: #20b2aa;">[(</span>after_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>before_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">3</span>

            ret<span style="color: #20b2aa;">[</span>after_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">4</span>

            ret<span style="color: #20b2aa;">[</span>before_fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">255</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
    final_masks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>base_fill_QA, filled_fmask<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>final_masks<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_QA, fmask<span style="color: #20b2aa;">)</span>
    final_masks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>final_masks, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>, 
                               filename<span style="color: #ff00ff;">=</span>mask_output_file, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Cloud fill<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>log_file<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>filled<span style="color: #ff00ff;">=</span>base_img, mask<span style="color: #ff00ff;">=</span>final_masks<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> auto_gap_fill.R</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">pct_gap</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>gap_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    num_gap <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>gap_mask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span>, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    num_clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>gap_mask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span>, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>num_gap <span style="color: #ff00ff;">/</span> num_clear<span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">auto_gap_fill</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>data_dir, wrspath, wrsrow, start_date, end_date, 
                          base_date<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, tc<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, threshold<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, n_cpus<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, 
                          notify<span style="color: #ff00ff;">=</span>print, verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>auto_gap_fill not yet supported<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, data_dir<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>data_dir does not exist<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Gap fill<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_cpus <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sfQuickInit</span><span style="color: #20b2aa;">(</span>n_cpus<span style="color: #20b2aa;">)</span>
    wrspath <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, wrspath<span style="color: #20b2aa;">)</span>
    wrsrow <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, wrsrow<span style="color: #20b2aa;">)</span>

    prefix_re <span style="color: #ff00ff;">&lt;-</span> ^<span style="color: #20b2aa;">([</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]</span>*_<span style="color: #20b2aa;">)</span>?

    pathrow_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>wrspath, wrsrow, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">)</span>
    date_re <span style="color: #ff00ff;">&lt;-</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">19</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">01</span><span style="color: #20b2aa;">]))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0123</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>
    sensor_re <span style="color: #ff00ff;">&lt;-</span><span style="color: #20b2aa;">((</span>L<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">]</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">7</span>E<span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">8</span>C<span style="color: #20b2aa;">))</span>SR
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #ff00ff;">&lt;-</span> _tc.tif$
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #ff00ff;">&lt;-</span> .tif$
    <span style="color: #20b2aa;">}</span>
    file_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix_re, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pathrow_re, date_re, sensor_re, 
                                       sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">)</span>, suffix_re<span style="color: #20b2aa;">)</span>
    img_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>data_dir, pattern<span style="color: #ff00ff;">=</span>file_re, recursive<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, date_re<span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #ff00ff;">%</span>Y<span style="color: #ff00ff;">-%</span>j<span style="color: #20b2aa;">)</span>
    which_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">((</span>img_dates <span style="color: #ff00ff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span> &amp;
                          <span style="color: #20b2aa;">(</span>img_dates <span style="color: #ff00ff;">&lt;</span> end_date<span style="color: #20b2aa;">))</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">]</span>
    img_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>data_dir, img_files<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no images found <span style="color: #ff00ff;">-</span> check date_dir, check wrspath, wrsrow, start_date, and end_date<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Only, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>,
                   <span style="color: #ff6347;">image</span><span style="color: #20b2aa;">(</span>s<span style="color: #20b2aa;">)</span> found. Need at least two images to perform gap fill<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Found, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">image</span><span style="color: #20b2aa;">(</span>s<span style="color: #20b2aa;">)))</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Analyzing cloud cover and gaps <span style="color: #00ffff;">in</span> input images<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    masks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    imgs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>img_file <span style="color: #00ffff;">in</span> img_files<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        masks_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>suffix_re, _masks.tif, img_file<span style="color: #20b2aa;">)</span>
        this_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        masks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>masks, this_mask<span style="color: #20b2aa;">)</span>
        this_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>
        imgs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>imgs, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>this_img<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    freq_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">)</span>, merge<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

    freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Analyzing cloud cover and gaps <span style="color: #00ffff;">in</span> input images<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>


    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>base_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        clear_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>freq_table$value<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        base_date_diff <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> 
                                 <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>x, base_date<span style="color: #20b2aa;">)))</span>
        base_date_diff <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>base_date_diff <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>













    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        masks<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]))</span> | <span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>imgs<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        imgs<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">][</span>masks<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    imgs <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_mask <span style="color: #ff00ff;">&lt;-</span> masks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    masks <span style="color: #ff00ff;">&lt;-</span> masks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_img_date <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>base_img_index<span style="color: #20b2aa;">]</span>
    img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>


    start_pct_gap <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pct_gap</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Base image has , <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>start_pct_gap, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">%</span> gap before fill<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>start_pct_gap <span style="color: #ff00ff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Performing gap fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>





        fill_areas <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>mask_img <span style="color: #00ffff;">in</span> masks<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            fill_areas <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_areas, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>base_mask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span> &amp; mask_img <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        fill_areas_freq <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fill_areas<span style="color: #20b2aa;">)</span>, useNA<span style="color: #ff00ff;">=</span>no, merge<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>



        avail_fill_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq$value <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        fill_img_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
        fill_img <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        imgs <span style="color: #ff00ff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        cloud_mask <span style="color: #ff00ff;">&lt;-</span> fill_areas<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        fill_img_mask <span style="color: #ff00ff;">&lt;-</span> masks<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        masks <span style="color: #ff00ff;">&lt;-</span> masks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        fill_img_date <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>fill_img_index<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>


        coded_cloud_mask<span style="color: #20b2aa;">[</span>fill_img_mask<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>
        <span style="color: #ff6347;">NAvalue</span><span style="color: #20b2aa;">(</span>coded_cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Filling image from , base_img_date,
                           with image from , fill_img_date, as input image...<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">fill_gaps</span><span style="color: #20b2aa;">(</span>base_img, fill_img, imgs, verbose<span style="color: #ff00ff;">=</span>verbose, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span>Fill complete.<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>


        base_mask<span style="color: #20b2aa;">[</span>coded_cloud_mask <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        max_iter <span style="color: #ff00ff;">&lt;-</span> max_iter <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            final_pct_gap <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pct_gap</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Base image has , <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>final_pct_gap, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">%</span> gap remaining<span style="color: #20b2aa;">))</span>
            timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Performing gap fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span>Percent gap <span style="color: #ff00ff;">&lt;</span> threshold. Skipping gap fill.<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Gap fill<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_cpus <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sfQuickStop</span><span style="color: #20b2aa;">(</span>n_cpus<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> auto_normalize.R</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">auto_normalize</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>image_files, base, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    image_stacks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>image_files, stack<span style="color: #20b2aa;">)</span>
    mask_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span>, _masks, 
                         <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">))</span>
    mask_stacks <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>mask_files, stack<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        base_img_file <span style="color: #ff00ff;">&lt;-</span> base
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>length of image_files is <span style="color: #daa520;">1</span> but no base image was supplied<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>


        <span style="color: #ff6347;">pct_clouds</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            clouded_pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>cloud_mask, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

                <span style="color: #20b2aa;">(</span>vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>vals <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">})</span>
            num_clouds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>clouded_pixels, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

            num_clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">255</span>, stat<span style="color: #ff00ff;">=</span>sum, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>num_clouds <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>num_clouds <span style="color: #ff00ff;">+</span> num_clear<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        cloud_cover <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">)</span>,
                 .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc, stringr, rgdal<span style="color: #20b2aa;">)</span>,
                 .combine<span style="color: #ff00ff;">=</span>c<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>

            <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]])</span>
        <span style="color: #20b2aa;">}</span>
        base_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>cloud_cover <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>cloud_cover<span style="color: #20b2aa;">))</span>

        base_img <span style="color: #ff00ff;">&lt;-</span> image_stacks<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        image_stacks <span style="color: #ff00ff;">&lt;-</span> image_stacks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_index<span style="color: #20b2aa;">]</span>
        base_img_file <span style="color: #ff00ff;">&lt;-</span> image_files<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        image_files <span style="color: #ff00ff;">&lt;-</span> image_files<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_index<span style="color: #20b2aa;">]</span>
        base_mask <span style="color: #ff00ff;">&lt;-</span> mask_stacks<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        mask_stacks <span style="color: #ff00ff;">&lt;-</span> mask_stacks<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>base_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    base_copy_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>base_img_file<span style="color: #20b2aa;">)</span>, 
                                 _normbase.tif<span style="color: #20b2aa;">)</span>
    base_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_img, filename<span style="color: #ff00ff;">=</span>base_copy_filename, 
                            datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                            overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    base_mask_copy_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>base_img_file<span style="color: #20b2aa;">)</span>, 
                                      _normbase_masks.tif<span style="color: #20b2aa;">)</span>
    base_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_mask, filename<span style="color: #ff00ff;">=</span>base_mask_copy_filename, 
                             datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                             overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_stacks<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">))</span>
    image_file<span style="color: #ff00ff;">=</span>image_stack<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>

    <span style="color: #ff6347;">foreach</span> <span style="color: #20b2aa;">(</span>image_file<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span>, image_stack<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>image_stacks<span style="color: #20b2aa;">)</span>, 
             mask_stack<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">)</span>,
             .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc, stringr, tools<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Preprocessing , image_file<span style="color: #20b2aa;">))</span>
        output_normed_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_file<span style="color: #20b2aa;">)</span>, 
                                     _normalized.tif<span style="color: #20b2aa;">)</span>
        output_normed_masks_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_file<span style="color: #20b2aa;">)</span>, 
                                           _normalized_masks.tif<span style="color: #20b2aa;">)</span>

        missing_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>, mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>,
                            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>base_vals, this_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

            <span style="color: #20b2aa;">(</span>base_vals !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>this_vals !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">500000</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            size <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">500000</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            size <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        normed_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">normalize</span><span style="color: #20b2aa;">(</span>base_img, image_stack, missing_vals, size<span style="color: #ff00ff;">=</span>size<span style="color: #20b2aa;">)</span>
        normed_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>normed_image, filename<span style="color: #ff00ff;">=</span>output_normed_file, 
                                    datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                                    overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
        mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>mask_stack, 
                                  filename<span style="color: #ff00ff;">=</span>output_normed_masks_file, 
                                  datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                                  overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> auto_preprocess_landsat.R</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_gdalinfo_item</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>item, gdalinfo_text<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    gdalinfo_text <span style="color: #ff00ff;">&lt;-</span> gdalinfo_text<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span> <span style="color: #20b2aa;">]</span>*, item<span style="color: #20b2aa;">)</span>, gdalinfo_text<span style="color: #20b2aa;">)]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>gdalinfo_text<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>more than one item found<span style="color: #20b2aa;">)</span>
    gdalinfo_text <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">([</span> <span style="color: #20b2aa;">]</span>*, item, <span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>, , gdalinfo_text<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>gdalinfo_text<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">get_mtl_item</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>item, mtl_txt<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    mtl_txt <span style="color: #ff00ff;">&lt;-</span> mtl_txt<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span> <span style="color: #20b2aa;">]</span>*, item<span style="color: #20b2aa;">)</span>, mtl_txt<span style="color: #20b2aa;">)]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>mtl_txt<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>more than one item found<span style="color: #20b2aa;">)</span>
    mtl_txt <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">([</span> <span style="color: #20b2aa;">]</span>*, item,  <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">)</span>, , mtl_txt<span style="color: #20b2aa;">)</span>

    mtl_txt <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #00ff00;">", , mtl_txt)</span>
<span style="color: #00ff00;">    mtl_txt &lt;- gsub("</span>$, , mtl_txt<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>mtl_txt<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">get_metadata</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>ls_file, img_type<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    meta <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #ff00ff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ls_file_gdalinfo <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gdalinfo</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>
        aq_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>AcquisitionDate, ls_file_gdalinfo<span style="color: #20b2aa;">)</span>
        meta$aq_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">strptime</span><span style="color: #20b2aa;">(</span>aq_date, format<span style="color: #ff00ff;">=%</span>Y<span style="color: #ff00ff;">-%</span>m<span style="color: #ff00ff;">-%</span>dT<span style="color: #ff00ff;">%</span>H:<span style="color: #ff00ff;">%</span>M:<span style="color: #ff00ff;">%</span>OSZ, tz<span style="color: #ff00ff;">=</span>UTC<span style="color: #20b2aa;">)</span>
        meta$WRS_Path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>WRS_Path, ls_file_gdalinfo<span style="color: #20b2aa;">)))</span>
        meta$WRS_Row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>WRS_Row, ls_file_gdalinfo<span style="color: #20b2aa;">)))</span>
        meta$sunelev <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">90</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>SolarZenith, ls_file_gdalinfo<span style="color: #20b2aa;">))</span>
        meta$sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>SolarAzimuth, ls_file_gdalinfo<span style="color: #20b2aa;">))</span>
        meta$short_name  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span>ShortName, ls_file_gdalinfo<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #ff00ff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>_MTL.txt$, ls_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>ls_file must be a *_MTL.txt file<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        mtl_txt <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readLines</span><span style="color: #20b2aa;">(</span>ls_file, warn<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        aq_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>DATE_ACQUIRED, mtl_txt<span style="color: #20b2aa;">)</span>
        aq_time <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>SCENE_CENTER_TIME, mtl_txt<span style="color: #20b2aa;">)</span>
        meta$aq_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">strptime</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>aq_date, <span style="color: #daa520;">T</span>, aq_time<span style="color: #20b2aa;">)</span>, format<span style="color: #ff00ff;">=%</span>Y<span style="color: #ff00ff;">-%</span>m<span style="color: #ff00ff;">-%</span>dT<span style="color: #ff00ff;">%</span>H:<span style="color: #ff00ff;">%</span>M:<span style="color: #ff00ff;">%</span>OSZ, tz<span style="color: #ff00ff;">=</span>UTC<span style="color: #20b2aa;">)</span>
        meta$WRS_Path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>WRS_PATH, mtl_txt<span style="color: #20b2aa;">)))</span>
        meta$WRS_Row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>WRS_ROW, mtl_txt<span style="color: #20b2aa;">)))</span>
        meta$sunelev <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>SUN_ELEVATION, mtl_txt<span style="color: #20b2aa;">))</span>
        meta$sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>SUN_AZIMUTH, mtl_txt<span style="color: #20b2aa;">))</span>


        satellite <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span>SPACECRAFT_ID, mtl_txt<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">[</span><span style="color: #daa520;">4578</span><span style="color: #20b2aa;">])</span>
        sensor_string <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>, ^<span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">)))</span>
        meta$short_name  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>,
                                   <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                                   <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, img_type<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>meta<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">calc_cloud_mask</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>mask_stack, mask_type, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #ff00ff;">==</span> fmask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>








        cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>mask_stack$fmask_band,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>fmask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">6</span>S<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>mask_stack$fill_QA,
                              mask_stack$cloud_QA, 
                              mask_stack$cloud_shadow_QA, 
                              mask_stack$adjacent_cloud_QA,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>fill, clo, sha, adj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>fill <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>clo <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>sha <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | 
                       <span style="color: #20b2aa;">(</span>adj <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #ff00ff;">==</span> both<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>mask_stack$fmask_band, 
                              mask_stack$cloud_QA, 
                              mask_stack$cloud_shadow_QA, 
                              mask_stack$adjacent_cloud_QA,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>fmask, clo, sha, adj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">((</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | 
                       <span style="color: #20b2aa;">(</span>clo <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>sha <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>adj <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>unrecognized option <span style="color: #00ff00;">", cloud_mask, "</span> <span style="color: #00ffff;">for</span> mask_type<span style="color: #00ff00;">"))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    return(cloud_mask)</span>
<span style="color: #00ff00;">}</span>
<span style="color: #ff6347;">build_band_vrt</span><span style="color: #00ff00;"> &lt;- function(ls_file, band_vrt_file, img_type) {</span>
<span style="color: #00ff00;">    image_bands &lt;- c(band</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">, band</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">, band</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">, band</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">, band</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">, band</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">    if (img_type == CDR) {</span>
<span style="color: #00ff00;">        sds &lt;- get_subdatasets(ls_file)</span>
<span style="color: #00ff00;">        band_sds &lt;- sds[grepl(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(:(, paste(image_bands, collapse=|), )$), sds)]</span>
<span style="color: #00ff00;">        gdalbuildvrt(band_sds, band_vrt_file, separate=TRUE)</span>
<span style="color: #00ff00;">    } else if (img_type == L</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">T) {</span>
<span style="color: #00ff00;">        if (!grepl(_MTL.txt$, ls_file)) {</span>
<span style="color: #00ff00;">            stop(ls_file must be a *_MTL.txt file)</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        ls_file_base &lt;- gsub(_MTL.txt, , ls_file)</span>
<span style="color: #00ff00;">        ls_files &lt;- dir(dirname(ls_file_base),</span>
<span style="color: #00ff00;">                        pattern=paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(basename(ls_file_base), _B[</span><span style="color: #daa520;">123457</span><span style="color: #00ff00;">].((TIF)|(tif))$),</span>
<span style="color: #00ff00;">                        full.names=TRUE)</span>
<span style="color: #00ff00;">        gdalbuildvrt(ls_files, band_vrt_file, separate=TRUE)</span>
<span style="color: #00ff00;">    } else {</span>
<span style="color: #00ff00;">        stop(paste(img_type, is not a recognized img_type))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    return(image_bands)</span>
<span style="color: #00ff00;">}</span>
<span style="color: #ff6347;">build_mask_vrt</span><span style="color: #00ff00;"> &lt;- function(ls_file, mask_vrt_file, img_type) {</span>
<span style="color: #00ff00;">    if (img_type == CDR) {</span>
<span style="color: #00ff00;">        mask_bands &lt;- c(fill_QA, cfmask_band, cloud_QA, cloud_shadow_QA, </span>
<span style="color: #00ff00;">                        adjacent_cloud_QA)</span>
<span style="color: #00ff00;">        sds &lt;- get_subdatasets(ls_file)</span>

<span style="color: #00ff00;">        if (any(grepl(fmask_band, sds))) {</span>
<span style="color: #00ff00;">            warning(Using "</span>fmask_band<span style="color: #00ff00;">" instead of newer "</span>cfmask_band<span style="color: #00ff00;">" band name)</span>
<span style="color: #00ff00;">            mask_bands[grepl(^cfmask_band$, mask_bands)] &lt;- fmask_band</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        mask_sds &lt;- sds[grepl(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(:(, paste(mask_bands, collapse=|), )$), sds)]</span>
<span style="color: #00ff00;">        stopifnot(length(mask_sds) == </span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">        gdalbuildvrt(mask_sds, mask_vrt_file, separate=TRUE, srcnodata=None)</span>
<span style="color: #00ff00;">    } else if (img_type == L</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">T) {</span>
<span style="color: #00ff00;">        mask_bands &lt;- c(fill_QA, fmask_band)</span>
<span style="color: #00ff00;">        if (!grepl(_MTL.txt$, ls_file)) {</span>
<span style="color: #00ff00;">            stop(ls_file must be a *_MTL.txt file)</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        ls_file_base &lt;- gsub(_MTL.txt, , ls_file)</span>
<span style="color: #00ff00;">        fmask_file &lt;- dir(dirname(ls_file_base),</span>
<span style="color: #00ff00;">                          pattern=paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(basename(ls_file_base), _MTLFmask$),</span>
<span style="color: #00ff00;">                          full.names=TRUE)</span>


<span style="color: #00ff00;">        qa_mask_file &lt;- extension(rasterTmpFile(), .tif)</span>

<span style="color: #00ff00;">        qa_mask &lt;- calc(raster(fmask_file),</span>
<span style="color: #00ff00;">                        fun=function(x) {</span>
<span style="color: #00ff00;">                            out &lt;- x == </span><span style="color: #daa520;">255</span>
<span style="color: #00ff00;">                            out[x == </span><span style="color: #daa520;">255</span><span style="color: #00ff00;">] &lt;- </span><span style="color: #daa520;">255</span>
<span style="color: #00ff00;">                            return(out)</span>
<span style="color: #00ff00;">                        }, datatype=INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S, filename=qa_mask_file)</span>



<span style="color: #00ff00;">        gdalbuildvrt(c(qa_mask_file, fmask_file), mask_vrt_file, </span>
<span style="color: #00ff00;">                     separate=TRUE, allow_projection_difference=TRUE,</span>
<span style="color: #00ff00;">                     srcnodata=None)</span>
<span style="color: #00ff00;">    } else {</span>
<span style="color: #00ff00;">        stop(paste(img_type, is not a recognized img_type))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    return(mask_bands)</span>
<span style="color: #00ff00;">}</span>
<span style="color: #ff6347;">auto_preprocess_landsat</span><span style="color: #00ff00;"> &lt;- function(image_dirs, prefix, img_type=CDR, </span>
<span style="color: #00ff00;">                                    tc=FALSE, dem_path=NULL, aoi=NULL, </span>
<span style="color: #00ff00;">                                    output_path=NULL, mask_type=fmask, </span>
<span style="color: #00ff00;">                                    mask_output=FALSE, n_cpus=</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">, </span>
<span style="color: #00ff00;">                                    cleartmp=FALSE,  overwrite=FALSE, </span>
<span style="color: #00ff00;">                                    of=GTiff, ext=tif, notify=print, </span>
<span style="color: #00ff00;">                                    verbose=FALSE) {</span>
<span style="color: #00ff00;">    if (grepl(_, prefix)) {</span>
<span style="color: #00ff00;">        stop(prefix cannot contain underscores (_))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (tc &amp;&amp; is.null(dem_path)) {</span>
<span style="color: #00ff00;">        stop(dem_path must be supplied if tc=TRUE)</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (tc &amp;&amp; !file_test(-d, dem_path)) {</span>
<span style="color: #00ff00;">        stop(paste(dem_path, does not exist))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (!is.null(output_path) &amp;&amp; !file_test(-d, output_path)) {</span>
<span style="color: #00ff00;">        stop(paste(output_path, does not exist))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (!is.null(aoi)) {</span>
<span style="color: #00ff00;">        if (length(aoi) &gt; </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">            stop(aoi should be a SpatialPolygonsDataFrame of length </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        stopifnot(is.projected(aoi))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    ext &lt;- gsub(^[.], , ext)</span>

<span style="color: #00ff00;">    if (img_type == CDR) {</span>
<span style="color: #00ff00;">        ls_regex &lt;- ^(lndsr.)?((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[a-zA-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}.hdf$</span>
<span style="color: #00ff00;">    } else if (img_type == L</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">T) {</span>
<span style="color: #00ff00;">        ls_regex &lt;- ((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[a-zA-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}_MTL.txt$</span>
<span style="color: #00ff00;">    } else {</span>
<span style="color: #00ff00;">        stop(paste(img_type, is not a recognized img_type))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (img_type == CDR) {</span>
<span style="color: #00ff00;">        stopifnot(mask_type %in% c(fmask, </span><span style="color: #daa520;">6</span><span style="color: #00ff00;">S, both))</span>
<span style="color: #00ff00;">    } else if (img_type == L</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">T) {</span>
<span style="color: #00ff00;">        stopifnot(mask_type == fmask)</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    ls_files &lt;- c()</span>
<span style="color: #00ff00;">    for (image_dir in image_dirs) {</span>
<span style="color: #00ff00;">        if (!file_test(-d, image_dir)) {</span>
<span style="color: #00ff00;">            stop(paste(image_dir, does not exist))</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        ls_files &lt;- c(ls_files, dir(image_dir, pattern=ls_regex, full.names=TRUE))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    if (length(ls_files) == </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">        stop(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(No Landsat files found using img_type="</span>, img_type, <span style="color: #00ff00;">".))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    for (ls_file in ls_files) {</span>


<span style="color: #00ff00;">        meta &lt;- get_metadata(ls_file, img_type)</span>
<span style="color: #00ff00;">        image_basename &lt;- paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(meta$WRS_Path, -, meta$WRS_Row, _,</span>
<span style="color: #00ff00;">                                 format(meta$aq_date, %Y-%j), _, meta$short_name)</span>
<span style="color: #00ff00;">        if (is.null(output_path)) {</span>
<span style="color: #00ff00;">            this_output_path &lt;- dirname(ls_file)</span>
<span style="color: #00ff00;">        } else {</span>
<span style="color: #00ff00;">            this_output_path  &lt;- output_path</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        if (tc) {</span>
<span style="color: #00ff00;">            output_filename &lt;- file.path(this_output_path,</span>
<span style="color: #00ff00;">                                         paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(prefix, _, image_basename, </span>
<span style="color: #00ff00;">                                                _tc., ext))</span>
<span style="color: #00ff00;">        } else {</span>

<span style="color: #00ff00;">            output_filename &lt;- file.path(this_output_path,</span>
<span style="color: #00ff00;">                                         paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(prefix, _, image_basename, </span>
<span style="color: #00ff00;">                                                ., ext))</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        log_file &lt;- file(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(file_path_sans_ext(output_filename), _log.txt), open=wt)</span>
<span style="color: #00ff00;">        </span><span style="color: #ff6347;">msg</span><span style="color: #00ff00;"> &lt;- function(txt) {</span>
<span style="color: #00ff00;">            cat(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(txt, \n), file=log_file, append=TRUE)</span>
<span style="color: #00ff00;">            print(txt)</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        timer &lt;- Track_time(msg)</span>
<span style="color: #00ff00;">        timer &lt;- start_timer(timer, label=paste(Preprocessing, image_basename))</span>




<span style="color: #00ff00;">        if (verbose) timer &lt;- start_timer(timer, label=cropping and reprojecting)</span>
<span style="color: #00ff00;">        band_vrt_file &lt;- extension(rasterTmpFile(), .vrt)</span>
<span style="color: #00ff00;">        band_names &lt;- build_band_vrt(ls_file, band_vrt_file, img_type)</span>
<span style="color: #00ff00;">        mask_vrt_file &lt;- extension(rasterTmpFile(), .vrt)</span>
<span style="color: #00ff00;">        mask_band_names &lt;- build_mask_vrt(ls_file, mask_vrt_file, img_type)</span>
<span style="color: #00ff00;">        this_pathrow_poly &lt;- pathrow_poly(as.numeric(meta$WRS_Path), </span>
<span style="color: #00ff00;">                                          as.numeric(meta$WRS_Row))</span>
<span style="color: #00ff00;">        if (!is.null(aoi)) {</span>
<span style="color: #00ff00;">            to_srs &lt;- proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(aoi)</span>
<span style="color: #00ff00;">        } else {</span>
<span style="color: #00ff00;">            to_srs &lt;- utm_zone(this_pathrow_poly, proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string=TRUE)</span>
<span style="color: #00ff00;">        }</span>

<span style="color: #00ff00;">        this_pathrow_poly &lt;- spTransform(this_pathrow_poly, CRS(to_srs))</span>
<span style="color: #00ff00;">        if (!is.null(aoi)) {</span>


<span style="color: #00ff00;">            crop_area &lt;- gIntersection(this_pathrow_poly, aoi, byid=TRUE)</span>
<span style="color: #00ff00;">        } else {</span>


<span style="color: #00ff00;">            crop_area &lt;- this_pathrow_poly</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        out_te &lt;- as.numeric(bbox(crop_area))</span>

<span style="color: #00ff00;">        to_res &lt;- c(</span><span style="color: #daa520;">30</span><span style="color: #00ff00;">, </span><span style="color: #daa520;">30</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">        out_te &lt;- normalize_extent(out_te, to_res)</span>
<span style="color: #00ff00;">        image_stack_reproj_file &lt;- extension(rasterTmpFile(), ext)</span>
<span style="color: #00ff00;">        image_stack &lt;- gdalwarp(band_vrt_file,</span>
<span style="color: #00ff00;">                                dstfile=image_stack_reproj_file,</span>
<span style="color: #00ff00;">                                te=out_te, t_srs=to_srs, tr=to_res, </span>
<span style="color: #00ff00;">                                r=cubicspline, output_Raster=TRUE, of=of, </span>
<span style="color: #00ff00;">                                multi=TRUE, wo=paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(NUM_THREADS=, n_cpus), </span>
<span style="color: #00ff00;">                                overwrite=overwrite, ot=Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">        names(image_stack) &lt;- band_names</span>
<span style="color: #00ff00;">        mask_stack_reproj_file &lt;- extension(rasterTmpFile(), paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(., ext))</span>
<span style="color: #00ff00;">        mask_stack &lt;- gdalwarp(mask_vrt_file,</span>
<span style="color: #00ff00;">                               dstfile=mask_stack_reproj_file,</span>
<span style="color: #00ff00;">                               te=out_te, t_srs=to_srs, tr=to_res, </span>
<span style="color: #00ff00;">                               r=near, output_Raster=TRUE, of=of, </span>
<span style="color: #00ff00;">                               multi=TRUE, wo=paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(NUM_THREADS=, n_cpus), </span>
<span style="color: #00ff00;">                               overwrite=overwrite, ot=Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">)</span>


<span style="color: #00ff00;">        names(mask_stack) &lt;- mask_band_names</span>
<span style="color: #00ff00;">        if (verbose) timer &lt;- stop_timer(timer, label=cropping and reprojecting)</span>


<span style="color: #00ff00;">        if (tc) {</span>
<span style="color: #00ff00;">            if (verbose) timer &lt;- start_timer(timer, label=topocorr)</span>


<span style="color: #00ff00;">            slopeaspect_filename &lt;- file.path(dem_path,</span>
<span style="color: #00ff00;">                                              paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(slopeaspect_, </span>
<span style="color: #00ff00;">                                                     meta$WRS_Path, -, meta$WRS_Row, ., ext))</span>
<span style="color: #00ff00;">            slopeaspect &lt;- brick(slopeaspect_filename)</span>
<span style="color: #00ff00;">            if (!proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">comp(proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(image_stack), proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(slopeaspect))) {</span>
<span style="color: #00ff00;">                stop(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(slopeaspect and image_stack projections do not match.\nslopeaspect proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string: , </span>
<span style="color: #00ff00;">                            proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(slopeaspect), \nimage_stack proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string: ,</span>
<span style="color: #00ff00;">                            proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(image_stack)))</span>
<span style="color: #00ff00;">            } else {</span>


<span style="color: #00ff00;">                proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(slopeaspect) &lt;- proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string(image_stack)</span>
<span style="color: #00ff00;">            }</span>
<span style="color: #00ff00;">            compareRaster(slopeaspect, image_stack, orig=TRUE)</span>
<span style="color: #00ff00;">            image_stack_mask &lt;- calc_cloud_mask(mask_stack, mask_type)</span>
<span style="color: #00ff00;">            image_stack_masked &lt;- image_stack</span>
<span style="color: #00ff00;">            image_stack_masked[image_stack_mask] &lt;- NA</span>
<span style="color: #00ff00;">            if (ncell(image_stack_masked) &gt; </span><span style="color: #daa520;">500000</span><span style="color: #00ff00;">) {</span>



<span style="color: #00ff00;">                sampleindices &lt;- sampleRegular(image_stack_masked, size=</span><span style="color: #daa520;">500000</span><span style="color: #00ff00;">, </span>
<span style="color: #00ff00;">                                               cells=TRUE)</span>
<span style="color: #00ff00;">                sampleindices &lt;- as.vector(sampleindices[, </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">])</span>
<span style="color: #00ff00;">            } else {</span>
<span style="color: #00ff00;">                sampleindices &lt;- NULL</span>
<span style="color: #00ff00;">            }</span>



<span style="color: #00ff00;">            slopeaspect_flt &lt;- stack(raster(slopeaspect, layer=</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">) / </span><span style="color: #daa520;">10000</span><span style="color: #00ff00;">,</span>
<span style="color: #00ff00;">                                     raster(slopeaspect, layer=</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">) / </span><span style="color: #daa520;">1000</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">            image_stack_tc &lt;- topographic_corr(image_stack_masked, </span>
<span style="color: #00ff00;">                                               slopeaspect_flt, meta$sunelev, </span>
<span style="color: #00ff00;">                                               meta$sunazimuth, </span>
<span style="color: #00ff00;">                                               method=minnaert_full, </span>
<span style="color: #00ff00;">                                               asinteger=TRUE, </span>
<span style="color: #00ff00;">                                               sampleindices=sampleindices)</span>
<span style="color: #00ff00;">            if (!mask_output) {</span>


<span style="color: #00ff00;">                image_stack_tc[image_stack_mask] &lt;- image_stack[image_stack_mask]</span>
<span style="color: #00ff00;">            }</span>
<span style="color: #00ff00;">            image_stack &lt;- image_stack_tc</span>

<span style="color: #00ff00;">            if (verbose) timer &lt;- stop_timer(timer, label=topocorr)</span>
<span style="color: #00ff00;">        }</span>


<span style="color: #00ff00;">        if (verbose) timer &lt;- start_timer(timer, label=writing data)</span>
<span style="color: #00ff00;">        mask_stack_path &lt;- paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(file_path_sans_ext(output_filename), </span>
<span style="color: #00ff00;">                                  _masks., ext)</span>
<span style="color: #00ff00;">        mask_stack &lt;- writeRaster(stack(mask_stack$fill_QA,</span>
<span style="color: #00ff00;">                                        mask_stack$fmask_band),</span>
<span style="color: #00ff00;">                                  filename=mask_stack_path, </span>
<span style="color: #00ff00;">                                  overwrite=overwrite, datatype=INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S)</span>
<span style="color: #00ff00;">        names(mask_stack) &lt;- c(fill_QA, fmask_band)</span>
<span style="color: #00ff00;">        image_stack &lt;- writeRaster(image_stack, filename=output_filename, </span>
<span style="color: #00ff00;">                                   overwrite=overwrite, datatype=INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S)</span>
<span style="color: #00ff00;">        if (verbose) timer &lt;- stop_timer(timer, label=writing data)</span>
<span style="color: #00ff00;">        timer &lt;- stop_timer(timer, label=paste(Preprocessing, image_basename))</span>
<span style="color: #00ff00;">        close(log_file)</span>
<span style="color: #00ff00;">        if (cleartmp) removeTmpFiles(h=</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> auto_QA_stats.R</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_freq</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>band, value, freq_table<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    band_col <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>band, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>value <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> freq_table<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    frac <span style="color: #ff00ff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> value, band_col<span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>frac<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>frac, <span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">auto_QA_stats</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>image_dirs, aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lndsr_regex <span style="color: #ff00ff;">&lt;-</span> ^<span style="color: #20b2aa;">(</span>lndsr.<span style="color: #20b2aa;">)</span>?<span style="color: #20b2aa;">((</span>LT<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LT<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">}[</span><span style="color: #daa520;">12</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">}[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>
    mask_bands <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_QA, fmask_band<span style="color: #20b2aa;">)</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>image_dir <span style="color: #00ffff;">in</span> image_dirs<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        lndsr_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>image_dir, pattern<span style="color: #ff00ff;">=</span>lndsr_regex<span style="color: #20b2aa;">)</span>
        image_basenames <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>lndsr_files,lndsr_regex<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_basenames<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>no files found <span style="color: #00ffff;">in</span>, image_dir<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>image_basename <span style="color: #00ffff;">in</span> image_basenames<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Processing , image_basename, ...<span style="color: #20b2aa;">))</span>
            metadata_string <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>image_basename, 
                                           <span style="color: #20b2aa;">((</span>LT<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LT<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">13</span><span style="color: #20b2aa;">})</span>
            sensor <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>metadata_string, ^<span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">)))</span>
            year <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">13</span><span style="color: #20b2aa;">)</span>
            julian_day <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">14</span>, <span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
            img_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>
            img_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">9</span><span style="color: #20b2aa;">)</span>
            mask_band_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
            <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>mask_band <span style="color: #00ffff;">in</span> mask_bands<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                mask_band_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>mask_band_files,
                                     <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>image_dir, 
                                                     image_basename<span style="color: #20b2aa;">)</span>, 
                                           mask_band, sep<span style="color: #ff00ff;">=</span>_<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>
            mask_band_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>mask_band_files, .tif<span style="color: #20b2aa;">)</span>
            mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>mask_band_files<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> mask_bands
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Raster<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        aoi <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">projectRaster</span><span style="color: #20b2aa;">(</span>aoi, mask_stack<span style="color: #20b2aa;">)</span>
                    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                        aoi <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>aoi, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)))</span>
                    <span style="color: #20b2aa;">}</span>
                <span style="color: #20b2aa;">}</span>
                mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">crop</span><span style="color: #20b2aa;">(</span>mask_stack, aoi<span style="color: #20b2aa;">)</span>
                mask_stack <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>mask_stack, aoi<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            freq_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>mask_stack, useNA<span style="color: #ff00ff;">=</span>no, merge<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

            freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>img_path,
                                    img_row,
                                    year,
                                    julian_day,
                                    sensor,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fill_QA, <span style="color: #daa520;">0</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fill_QA, <span style="color: #daa520;">255</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">0</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">1</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">2</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">3</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">4</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span>fmask_band, <span style="color: #daa520;">255</span>, freq_table<span style="color: #20b2aa;">))))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>path, row, year, julian, sensor,
                    fill_QA_notfill, fill_QA_fill, fmask_clear, 
                    fmask_water, fmask_cloud_shadow, fmask_snow, 
                    fmask_cloud, fmask_fill<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> auto_setup_dem.R</h2>
<div class="outline-text-2" id="text-11">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">normalize_extent</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>te, res<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">30</span>, <span style="color: #daa520;">30</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>

    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>

    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>

    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">auto_setup_dem</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>aoi, output_path, dem_extents, of<span style="color: #ff00ff;">=</span>GTiff, 
                           ext<span style="color: #ff00ff;">=</span>tif, n_cpus<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, 
                           crop_to_aoi<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, notify<span style="color: #ff00ff;">=</span>print, verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>aoi should be a SpatialPolygonsDataFrame of length <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.projected</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span>
    ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span>.<span style="color: #20b2aa;">]</span>, , ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    pathrows <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pathrow_num</span><span style="color: #20b2aa;">(</span>aoi, wrs_type<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span>, wrs_mode<span style="color: #ff00ff;">=</span>D, as_polys<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    aoi_prproj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>aoi, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)))</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Processing DEMS <span style="color: #00ffff;">for</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, 
                                            path<span style="color: #ff00ff;">/</span>rows<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>crop_to_aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


        pathrows_cropped <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gIntersection</span><span style="color: #20b2aa;">(</span>pathrows, aoi_prproj, byid<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>pathrows_cropped<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>
        pathrows_cropped <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>pathrows_cropped, 
                                                     data<span style="color: #ff00ff;">=</span>pathrows@data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        pathrows_cropped <span style="color: #ff00ff;">&lt;-</span> pathrows
    <span style="color: #20b2aa;">}</span>





    pathrows_utm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>pathrows_cropped,
                                <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone</span><span style="color: #20b2aa;">(</span>pathrows_cropped, proj<span style="color: #daa520;">4</span>string<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)))</span>
    pathrows_buffered <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gBuffer</span><span style="color: #20b2aa;">(</span>pathrows_utm, width<span style="color: #ff00ff;">=</span><span style="color: #daa520;">500</span>, byid<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, 
                                 <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>dem_extents<span style="color: #20b2aa;">)))</span>
    intersecting <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.logical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gIntersects</span><span style="color: #20b2aa;">(</span>dem_extents, 
                                           <span style="color: #ff6347;">gUnaryUnion</span><span style="color: #20b2aa;">(</span>pathrows_buffered<span style="color: #20b2aa;">)</span>, byid<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>intersecting<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no intersecting dem extents found<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        dem_extents <span style="color: #ff00ff;">&lt;-</span> dem_extents<span style="color: #20b2aa;">[</span>intersecting, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    dem_list <span style="color: #ff00ff;">&lt;-</span> dem_extents$filename
    dem_rasts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>dem_list, raster<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>dem_list<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


        dem_prj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>dem_rasts<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>dem_rasts, projection<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> dem_prj<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>each DEM <span style="color: #00ffff;">in</span> dem_list must have the same projection<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>


        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Mosaicking DEMs<span style="color: #20b2aa;">)</span>
        mosaic_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>

        mosaic_te <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>pathrows_buffered<span style="color: #20b2aa;">))</span>

        <span style="color: #ff6347;">mosaic_rasters</span><span style="color: #20b2aa;">(</span>dem_list, mosaic_file, te<span style="color: #ff00ff;">=</span>mosaic_te, of<span style="color: #ff00ff;">=</span>of, 
                       overwrite<span style="color: #ff00ff;">=</span>overwrite, ot<span style="color: #ff00ff;">=</span>Int<span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
        dem_mosaic <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>mosaic_file<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span>Mosaicking DEMs<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        dem_mosaic <span style="color: #ff00ff;">&lt;-</span> dem_rasts<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
        mosaic_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>dem_mosaic<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        pathrow <span style="color: #ff00ff;">&lt;-</span> pathrows<span style="color: #20b2aa;">[</span>n, <span style="color: #20b2aa;">]</span>
        pathrow_label <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, pathrow@data$PATH<span style="color: #20b2aa;">)</span>, 
                               <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">03</span>i, pathrow@data$ROW<span style="color: #20b2aa;">)</span>, sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">)</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Processing , n,  of , 
                                                 <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, : , 
                                                 pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer,
                                          label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Cropping<span style="color: #ff00ff;">/</span>reprojecting DEM mosaic crop <span style="color: #00ffff;">for</span>, 
                                          pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>crop_to_aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span>
            pathrow_tosrs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>pathrow, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>to_srs<span style="color: #20b2aa;">))</span>
            to_ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gIntersection</span><span style="color: #20b2aa;">(</span>pathrow_tosrs, aoi, byid<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">utm_zone</span><span style="color: #20b2aa;">(</span>pathrow, proj<span style="color: #daa520;">4</span>string<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            to_ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">projectExtent</span><span style="color: #20b2aa;">(</span>pathrow, to_srs<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        dem_te <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>to_ext<span style="color: #20b2aa;">))</span>

        to_res <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">30</span>, <span style="color: #daa520;">30</span><span style="color: #20b2aa;">)</span>
        dem_te <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">normalize_extent</span><span style="color: #20b2aa;">(</span>dem_te, to_res<span style="color: #20b2aa;">)</span>

        dem_mosaic_crop_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                         <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>dem_, pathrow_label, 
                                                ., ext<span style="color: #20b2aa;">))</span>
        dem_mosaic_crop <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gdalwarp</span><span style="color: #20b2aa;">(</span>mosaic_file, 
                                    dstfile<span style="color: #ff00ff;">=</span>dem_mosaic_crop_filename,
                                    te<span style="color: #ff00ff;">=</span>dem_te, t_srs<span style="color: #ff00ff;">=</span>to_srs, tr<span style="color: #ff00ff;">=</span>to_res, 
                                    r<span style="color: #ff00ff;">=</span>cubicspline, output_Raster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                                    multi<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, of<span style="color: #ff00ff;">=</span>of,
                                    wo<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>NUM_THREADS<span style="color: #ff00ff;">=</span>, n_cpus<span style="color: #20b2aa;">)</span>, 
                                    overwrite<span style="color: #ff00ff;">=</span>overwrite, ot<span style="color: #ff00ff;">=</span>Int<span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer,
                                         label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Cropping<span style="color: #ff00ff;">/</span>reprojecting DEM mosaic crop <span style="color: #00ffff;">for</span>, 
                                         pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Calculating slope<span style="color: #ff00ff;">/</span>aspect <span style="color: #00ffff;">for</span>, 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
        slopeaspect_filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                          <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>slopeaspect_,
                                                 pathrow_label, ., ext<span style="color: #20b2aa;">))</span>

        slopeaspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">terrain</span><span style="color: #20b2aa;">(</span>dem_mosaic_crop, opt<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>slope, aspect<span style="color: #20b2aa;">))</span>
        slopeaspect$aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>slopeaspect$aspect, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">2</span>*pi<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
            vals
            <span style="color: #20b2aa;">})</span>


        slopeaspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">10000</span><span style="color: #20b2aa;">)</span>,
                             <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">1000</span><span style="color: #20b2aa;">))</span>
        slopeaspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>slopeaspect, filename<span style="color: #ff00ff;">=</span>slopeaspect_filename, 
                                   overwrite<span style="color: #ff00ff;">=</span>overwrite, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Calculating slope<span style="color: #ff00ff;">/</span>aspect <span style="color: #00ffff;">for</span>, 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
        timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>Processing , n,  of , 
                                                <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, : , 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Processing DEMS <span style="color: #00ffff;">for</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, 
                                            path<span style="color: #ff00ff;">/</span>rows<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> browse_image.R</h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">plotprep</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, maxpixels<span style="color: #ff00ff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">255</span>, x_fun<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, size<span style="color: #ff00ff;">=</span>maxpixels, asRaster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, useGDAL<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>x, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> DN_min
        vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> DN_max
        vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">((</span>vals <span style="color: #ff00ff;">-</span> DN_min<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>DN_max <span style="color: #ff00ff;">-</span> DN_min<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">255</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>x_fun<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">x_fun</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">1</span>U<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">browse_image</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, m<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, maxpixels<span style="color: #ff00ff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">255</span>, 
                         r<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span>, g<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span>, b<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, x_fun<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, m_fun<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span> <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">plotprep</span><span style="color: #20b2aa;">(</span>x, maxpixels<span style="color: #ff00ff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #ff00ff;">=</span>DN_min, DN_max<span style="color: #ff00ff;">=</span>DN_max, 
                  x_fun<span style="color: #ff00ff;">=</span>x_fun<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m_fun<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        m <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>m, fun<span style="color: #ff00ff;">=</span>m_fun, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        m <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>m, size<span style="color: #ff00ff;">=</span>maxpixels, asRaster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, useGDAL<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #ff6347;">par</span><span style="color: #20b2aa;">(</span>mfrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">else</span> <span style="color: #ff6347;">par</span><span style="color: #20b2aa;">(</span>mfrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">plotRGB</span><span style="color: #20b2aa;">(</span>x, r<span style="color: #ff00ff;">=</span>r, g<span style="color: #ff00ff;">=</span>g, b<span style="color: #ff00ff;">=</span>b, maxpixels<span style="color: #ff00ff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">plot</span><span style="color: #20b2aa;">(</span>m, maxpixels<span style="color: #ff00ff;">=</span>maxpixels, axes<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, legend<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, box<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">plotRGB</span><span style="color: #20b2aa;">(</span>x, r<span style="color: #ff00ff;">=</span>r, g<span style="color: #ff00ff;">=</span>g, b<span style="color: #ff00ff;">=</span>b, maxpixels<span style="color: #ff00ff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> chg_dir.R</h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">chg_dir</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, filename, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> coordinate systems do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> extents do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> probability maps have differing number of classes<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output file already exists and overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_classes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_classes <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cannot calculate change probabilities <span style="color: #00ffff;">for</span> only one class<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>






















    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
        overwrite <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
    <span style="color: #20b2aa;">}</span>

    bs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #ff00ff;">=</span>filename, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span>Processing block , block_num,  of , bs$n, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        dims <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">))</span>
        t<span style="color: #daa520;">1</span>p_bl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, row<span style="color: #ff00ff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                 nrows<span style="color: #ff00ff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                        dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        t<span style="color: #daa520;">2</span>p_bl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p, row<span style="color: #ff00ff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                       nrows<span style="color: #ff00ff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                        dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        chg_dirs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc_chg_dir</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p_bl, t<span style="color: #daa520;">2</span>p_bl<span style="color: #20b2aa;">)</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, chg_dirs, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> chg_mag.R</h2>
<div class="outline-text-2" id="text-14">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">chg_mag</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, filename, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> coordinate systems do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> extents do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span> and t<span style="color: #daa520;">1</span> probability maps have differing number of classes<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output file already exists and overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_classes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">calc_chg_mag</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, n_classes, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>

            chgmag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p <span style="color: #ff00ff;">-</span> t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>

            chgmag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p <span style="color: #ff00ff;">-</span> t<span style="color: #daa520;">1</span>p, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>pixel<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pixel^<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
        chgmag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>chgmag, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>chgmag<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #ff00ff;">=</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #ff00ff;">=</span>t<span style="color: #daa520;">2</span>p, fun<span style="color: #ff00ff;">=</span>calc_chg_mag, 
                        args<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>n_classes<span style="color: #ff00ff;">=</span>n_classes<span style="color: #20b2aa;">)</span>, 
                        outbands<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, outfiles<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, ...<span style="color: #20b2aa;">)</span>




    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #ff00ff;">=</span>filename, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> chg_traj_stats.R</h2>
<div class="outline-text-2" id="text-15">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">chg_traj_stats</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>traj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    chg_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>traj$chg_traj<span style="color: #20b2aa;">))</span>
    summ_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>Traj_Code<span style="color: #ff00ff;">=</span>traj$traj_lut$Code,
                             Trajectory<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>traj$traj_lut$t<span style="color: #daa520;">0</span>_name, traj$traj_lut$t<span style="color: #daa520;">1</span>_name, 
                                              sep<span style="color: #ff00ff;">=-</span><span style="color: #20b2aa;">))</span>
    summ_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>summ_table, n_pixels<span style="color: #ff00ff;">=</span>chg_table<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>chg_table<span style="color: #20b2aa;">)</span>, summ_table$Traj_Code<span style="color: #20b2aa;">)])</span>
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>summ_table<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    summ_table$Frac_Chg <span style="color: #ff00ff;">&lt;-</span> summ_table$n_pixels <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>summ_table$n_pixels<span style="color: #20b2aa;">)</span>
    summ_table$Frac_Tot <span style="color: #ff00ff;">&lt;-</span> summ_table$n_pixels <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>traj$chg_traj<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>summ_table<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> chg_traj.R</h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">traj_lut</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>class_codes, class_names<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lut <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">expand.grid</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span>_code<span style="color: #ff00ff;">=</span>class_codes, t<span style="color: #daa520;">1</span>_code<span style="color: #ff00ff;">=</span>class_codes<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>class_names<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_names<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_codes<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>class_names must be <span style="color: #daa520;">NULL</span> or a vector of length equal to number of classes <span style="color: #00ffff;">in</span> initial image<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        lut$t<span style="color: #daa520;">0</span>_name <span style="color: #ff00ff;">&lt;-</span> class_names<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">0</span>_code, class_codes<span style="color: #20b2aa;">)]</span>
        lut$t<span style="color: #daa520;">1</span>_name <span style="color: #ff00ff;">&lt;-</span> class_names<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">1</span>_code, class_codes<span style="color: #20b2aa;">)]</span>
    <span style="color: #20b2aa;">}</span>


    lut$Code <span style="color: #ff00ff;">&lt;-</span> lut$t<span style="color: #daa520;">0</span>_code <span style="color: #ff00ff;">+</span> lut$t<span style="color: #daa520;">1</span>_code * <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_codes<span style="color: #20b2aa;">)</span>


    lut <span style="color: #ff00ff;">&lt;-</span> lut<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">0</span>_code <span style="color: #ff00ff;">==</span> lut$t<span style="color: #daa520;">1</span>_code<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>lut<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">chg_traj</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir, chg_threshold, filename, 
                     overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>chg_mag has more than <span style="color: #daa520;">1</span> layer<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>chg_dir has more than <span style="color: #daa520;">1</span> layer<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output file already exists and overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">calc_chg_traj</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir, chg_threshold, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


        chg_dir<span style="color: #20b2aa;">[</span>chg_mag <span style="color: #ff00ff;">&lt;</span> chg_threshold<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span>
        chg_dir<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span>
        chg_dir <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>chg_dir, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #ff00ff;">=</span>chg_mag, chg_dir<span style="color: #ff00ff;">=</span>chg_dir, fun<span style="color: #ff00ff;">=</span>calc_chg_traj,
                        args<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>chg_threshold<span style="color: #ff00ff;">=</span>chg_threshold<span style="color: #20b2aa;">)</span>,
                        datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, ...<span style="color: #20b2aa;">)</span>


    out<span style="color: #20b2aa;">[</span>out <span style="color: #ff00ff;">==</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>



    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #ff00ff;">=</span>filename, overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                           datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> class_statistics.R</h2>
<div class="outline-text-2" id="text-17">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">class_statistics</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, class_col<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Coordinate systems do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialPolygonsDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>x, y, class_col<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterBrick, 
                                         RasterStack<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>class_statistics cannot yet handle Raster* objects<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">melt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>pixels@x, y<span style="color: #ff00ff;">=</span>pixels@y<span style="color: #20b2aa;">)</span>, idvar<span style="color: #ff00ff;">=</span>y<span style="color: #20b2aa;">)</span>

    value<span style="color: #ff00ff;">=</span>variable<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
    class_stats <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>pixels, y, variable<span style="color: #20b2aa;">)</span>, mean<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">mean</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, 
                             sd<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">sd</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, min<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, max<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, 
                             n_pixels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">))</span>
    class_stats <span style="color: #ff00ff;">&lt;-</span> class_stats<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>class_stats$variable, class_stats$y<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> classify.R</h2>
<div class="outline-text-2" id="text-18">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">classify</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, model, classes_file, prob_file, factors<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, 
                     overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>RasterBrick <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>prob_file<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, prob_file<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output file, prob_file, already exists and overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>classes_file<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, classes_file<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output file, classes_file, already exists and overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">make_preds</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>inrast, model, factors, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        band_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">][[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>

        inrast_mat <span style="color: #ff00ff;">&lt;-</span> inrast
        <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast_mat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>*<span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">])</span>
        inrast_df <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>inrast_mat<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> band_names


        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                factor_var <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)[</span>n<span style="color: #20b2aa;">]</span>
                factor_col <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> factor_var<span style="color: #20b2aa;">)</span>
                inrast_df<span style="color: #20b2aa;">[</span>, factor_col<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">[</span>, factor_col<span style="color: #20b2aa;">]</span>, 
                                                  levels<span style="color: #ff00ff;">=</span>factors<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]])</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        good_obs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span>
        preds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>good_obs<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            good_preds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>model, inrast_df<span style="color: #20b2aa;">[</span>good_obs, <span style="color: #20b2aa;">]</span>, type<span style="color: #ff00ff;">=</span>prob<span style="color: #20b2aa;">)</span>
            preds<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>good_obs<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>good_preds<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        preds_array <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>preds, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                          <span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>preds_array<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    probs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #ff00ff;">=</span>x, fun<span style="color: #ff00ff;">=</span>make_preds,
                          args<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>model<span style="color: #ff00ff;">=</span>model, factors<span style="color: #ff00ff;">=</span>factors<span style="color: #20b2aa;">)</span>,
                          filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                          datatype<span style="color: #ff00ff;">=</span>FLT<span style="color: #daa520;">4</span>S, .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>randomForest<span style="color: #20b2aa;">)</span>,
                          setMinMax<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>



    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>prob_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        probs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>probs, filename<span style="color: #ff00ff;">=</span>prob_file, overwrite<span style="color: #ff00ff;">=</span>overwrite, 
                             datatype<span style="color: #ff00ff;">=</span>FLT<span style="color: #daa520;">4</span>S<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>probs<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>classes_file<span style="color: #20b2aa;">))</span> classes_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
    classes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>probs, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

            out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>vals <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>

            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #ff00ff;">=</span>INT<span style="color: #daa520;">2</span>S, filename<span style="color: #ff00ff;">=</span>classes_file, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>classes<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> prediction
    codes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>code<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>, class<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>classes<span style="color: #ff00ff;">=</span>classes, probs<span style="color: #ff00ff;">=</span>probs, codes<span style="color: #ff00ff;">=</span>codes<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> cloud_remove.R</h2>
<div class="outline-text-2" id="text-19">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">check_ENVI_IDL</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    idl_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">-</span>e <span style="color: #00ff00;">"e=ENVI(/HEADLESS)"</span><span style="color: #20b2aa;">)</span>, 
                      intern<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>Restored file: ENVI, idl_out<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">format_IDL_param</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>varname, varvalue<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #ff00ff;">=</span><span style="color: #00ff00;">", varvalue, "</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.list</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, varvalue<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>
                <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, <span style="color: #00ff00;">", varvalue[n], "</span><span style="color: #20b2aa;">)</span>
                <span style="color: #20b2aa;">}</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, , <span style="color: #20b2aa;">)</span>
                <span style="color: #20b2aa;">}</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, <span style="color: #20b2aa;">]</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #ff00ff;">=</span>, varvalue, \n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>param<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_remove_IDL</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name,
                             algorithm, num_class, min_pixel, max_pixel, 
                             cloud_nbh, DN_min, DN_max, 
                             verbose, idl, byblock, overwrite,
                             patch_long<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1000</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>verbose not supported with CLOUD_REMOVE and CLOUD_REMOVE_FAST algorithms<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">==</span> CLOUD_REMOVE_FAST<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        script_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, CLOUD_REMOVE_FAST.pro, 
                                   package<span style="color: #ff00ff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
        function_name <span style="color: #ff00ff;">&lt;-</span> CLOUD_REMOVE_FAST
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">==</span> CLOUD_REMOVE<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        script_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, CLOUD_REMOVE.pro, 
                                   package<span style="color: #ff00ff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
        function_name <span style="color: #ff00ff;">&lt;-</span> CLOUD_REMOVE
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>unrecognized cloud fill algorithm <span style="color: #00ff00;">", algorithm, "</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>x, idl<span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, idl<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>IDL not found <span style="color: #ff00ff;">-</span> check <span style="color: #00ff00;">"idl"</span> parameter<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">check_ENVI_IDL</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Unable to load ENVI <span style="color: #00ffff;">in</span> IDL <span style="color: #ff00ff;">-</span> do you have ENVI and IDL licenses, and ENVI <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">5</span>.<span style="color: #daa520;">0</span>?<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!byblock<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        patch_long <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>


    orig_proj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    orig_ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>



    dummy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span>def_format <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">()</span>$format<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #ff00ff;">=</span>ENVI<span style="color: #20b2aa;">)</span>
    cloudy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>cloudy, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, 
                          datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>clear, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>cloud_mask, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, 
                              datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    cloudy_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    clear_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span>
    cloud_mask_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span>
    dummy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #ff00ff;">=</span>def_format<span style="color: #20b2aa;">))</span>
    param_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>cloudy_file, clear_file, mask_file, out_name, 
                     num_class, min_pixel, extent<span style="color: #daa520;">1</span>, DN_min, DN_max, 
                     patch_long<span style="color: #20b2aa;">)</span>
    param_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cloudy_file, clear_file, cloud_mask_file, out_name, 
                       num_class, min_pixel, cloud_nbh, DN_min, DN_max, 
                       patch_long<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span>format_IDL_param, param_names, param_vals<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>idl_params, collapse<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>
    script_dir <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>script_path<span style="color: #20b2aa;">)</span>
    idl_script <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">(</span>fileext<span style="color: #ff00ff;">=</span>.pro<span style="color: #20b2aa;">)</span>
    idl_cmd <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>CD, <span style="color: #00ff00;">", script_dir, "</span>\n, idl_params, function_name, ,, 
                      <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>param_names, collapse<span style="color: #ff00ff;">=</span>,<span style="color: #20b2aa;">)</span>, \nexit<span style="color: #20b2aa;">)</span>
    f <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>idl_script, wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_cmd, f<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl_script<span style="color: #20b2aa;">))</span>, intern<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    log_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span>, _idllog.txt<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\r, , idl_out<span style="color: #20b2aa;">)</span>
    f <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>log_file, wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_out, f<span style="color: #20b2aa;">)</span> 
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span>
    filled<span style="color: #20b2aa;">[</span>filled <span style="color: #ff00ff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>

    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_ext
    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>filled, filename<span style="color: #ff00ff;">=</span>out_name, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                          datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_fill_rasterengine</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, 
                                    num_class, min_pixel, max_pixel, cloud_nbh, 
                                    DN_min, DN_max, verbose, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    dims<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>


    cloudy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>cloudy, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>clear, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>cloud_mask, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, dims, 
                                  num_class,  min_pixel, max_pixel, cloud_nbh, 
                                  DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>


    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>filled, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">call_cpp_cloud_fill</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, dims, 
                                num_class, min_pixel, max_pixel, cloud_nbh, 
                                DN_min, DN_max, verbose, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">==</span> teamlucc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, 
                             min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, 
                             verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">==</span> simple<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cloud_fill_simple</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, 
                                    cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>unrecognized cloud fill algorithm <span style="color: #00ff00;">", algorithm, "</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_remove_R</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name, algorithm, 
                           num_class, min_pixel, max_pixel, cloud_nbh, DN_min, 
                           DN_max, verbose, byblock, overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>byblock<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>cloudy, values<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, out_name, overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span>Processing block , block_num,  of , bs$n, ...<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            dims <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">))</span>
            cloudy_bl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>cloudy, row<span style="color: #ff00ff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                              nrows<span style="color: #ff00ff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                               dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
            clear_bl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>clear, row<span style="color: #ff00ff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                            nrows<span style="color: #ff00ff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                            dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
            cloud_mask_bl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>cloud_mask, 
                                                  row<span style="color: #ff00ff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                                  nrows<span style="color: #ff00ff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>, 
                                   dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
            filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy_bl, clear_bl, cloud_mask_bl, 
                                          algorithm, dims, num_class, 
                                          min_pixel, max_pixel, cloud_nbh, 
                                          DN_min, DN_max, verbose<span style="color: #ff00ff;">&gt;</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
            out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, filled, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
        <span style="color: #20b2aa;">}</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>











    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        dims <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
        out_datatype <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>cloudy, values<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, filename<span style="color: #ff00ff;">=</span>out_name<span style="color: #20b2aa;">)</span>


        cloudy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span>, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        cloud_mask <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span>, dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, 
                                      dims, num_class, min_pixel, max_pixel, 
                                      cloud_nbh, DN_min, DN_max, verbose<span style="color: #ff00ff;">&gt;</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>out, filled<span style="color: #20b2aa;">)</span>
        out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, out_name, datatype<span style="color: #ff00ff;">=</span>out_datatype, 
                           overwrite<span style="color: #ff00ff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_remove</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                         algorithm<span style="color: #ff00ff;">=</span>simple,
                         num_class<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span>, min_pixel<span style="color: #ff00ff;">=</span><span style="color: #daa520;">20</span>, max_pixel<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1000</span>, 
                         cloud_nbh<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10000</span>, 
                         idl<span style="color: #ff00ff;">=</span>C:<span style="color: #ff00ff;">/</span>Program Files<span style="color: #ff00ff;">/</span>Exelis<span style="color: #ff00ff;">/</span>IDL<span style="color: #daa520;">83</span><span style="color: #ff00ff;">/</span>bin<span style="color: #ff00ff;">/</span>bin.x<span style="color: #daa520;">86</span>_<span style="color: #daa520;">64</span><span style="color: #ff00ff;">/</span>idl.exe,
                         verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, byblock<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>CLOUD_REMOVE, CLOUD_REMOVE_FAST, teamlucc, 
                           simple<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>algorithm must be one of <span style="color: #00ff00;">"CLOUD_REMOVE"</span>, <span style="color: #00ff00;">"CLOUD_REMOVE_FAST"</span>, <span style="color: #00ff00;">"teamlucc"</span>, or <span style="color: #00ff00;">"simple"</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span>Using <span style="color: #00ff00;">", algorithm, "</span> algorithm.<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cloudy must be a Raster* object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>clear must be a Raster* object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cloud_mask must be a RasterLayer object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>cloudy, clear<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>number of layers <span style="color: #00ffff;">in</span> cloudy must match number of layers <span style="color: #00ffff;">in</span> clear<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>cloud_mask should have only one layer<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out_name <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        out_name <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">normalizePath</span><span style="color: #20b2aa;">(</span>out_name, mustWork<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output folder does not exist<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, out_name<span style="color: #20b2aa;">)</span> &amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output file already exists <span style="color: #ff00ff;">-</span> use a different <span style="color: #00ff00;">"out_name"</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>CLOUD_REMOVE, CLOUD_REMOVE_FAST<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove_IDL</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name,
                                   algorithm, num_class, min_pixel, max_pixel, 
                                   cloud_nbh, DN_min, DN_max, verbose, idl, 
                                   byblock, overwrite, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc, simple<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove_R</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name, 
                                 algorithm, num_class, min_pixel, max_pixel, 
                                 cloud_nbh, DN_min, DN_max, verbose, byblock, 
                                 overwrite, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>unrecognized cloud fill algorithm <span style="color: #00ff00;">", algorithm, "</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-20" class="outline-2">
<h2 id="sec-20"><span class="section-number-2">20</span> color_image.R</h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">color_image</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, cls, outfile<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">reclassify</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)))</span>
    x.sp <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as</span><span style="color: #20b2aa;">(</span>x, SpatialPixelsDataFrame<span style="color: #20b2aa;">)</span>
    cls_colors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">col</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">rgb</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>


    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>x.sp$layer<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">254</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        gdaltype <span style="color: #ff00ff;">&lt;-</span> Int<span style="color: #daa520;">16</span>
        gdalmvFlag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">32768</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        gdaltype <span style="color: #ff00ff;">&lt;-</span> Byte
        gdalmvFlag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">255</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">writeGDAL</span><span style="color: #20b2aa;">(</span>x.sp, outfile, drivername<span style="color: #ff00ff;">=</span>ENVI, type<span style="color: #ff00ff;">=</span>gdaltype,
              colorTables<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cls_colors<span style="color: #20b2aa;">)</span>, catNames<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>,
              mvFlag<span style="color: #ff00ff;">=</span>gdalmvFlag<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-21" class="outline-2">
<h2 id="sec-21"><span class="section-number-2">21</span> compcont.R</h2>
<div class="outline-text-2" id="text-21">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">compcont</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">()</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>compcont is not yet finished<span style="color: #20b2aa;">)</span>

<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-22" class="outline-2">
<h2 id="sec-22"><span class="section-number-2">22</span> DFPS.R</h2>
<div class="outline-text-2" id="text-22">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">DFPS</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>chg_polys, chg_mag, radius<span style="color: #ff00ff;">=</span><span style="color: #daa520;">100</span>, delta<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">01</span>, m<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, maxiter<span style="color: #ff00ff;">=</span><span style="color: #daa520;">20</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    chg_pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>chg_mag, chg_polys<span style="color: #20b2aa;">))</span>
    nochg_polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gDifference</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gBuffer</span><span style="color: #20b2aa;">(</span>chg_polys, width<span style="color: #ff00ff;">=</span>radius<span style="color: #20b2aa;">)</span>, chg_polys<span style="color: #20b2aa;">)</span>
    nochg_pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>chg_mag, nochg_polys<span style="color: #20b2aa;">))</span>

    A <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>nochg_pixels<span style="color: #20b2aa;">)</span>


    Lmax <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    Lmin <span style="color: #ff00ff;">&lt;-</span> Lmax <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">2</span> * delta
    min_threshold <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span>
    max_threshold <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span>
    n <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">while</span> <span style="color: #20b2aa;">((</span>Lmax <span style="color: #ff00ff;">-</span> Lmin<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> delta &amp;&amp; n <span style="color: #ff00ff;">&lt;</span> maxiter<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        p <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>max_threshold <span style="color: #ff00ff;">-</span> min_threshold<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> m
        thresholds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>min_threshold, max_threshold, p<span style="color: #20b2aa;">)</span>
        L <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>threshold <span style="color: #00ffff;">in</span> thresholds<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            A<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>chg_pixels <span style="color: #ff00ff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span>
            A<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>nochg_pixels <span style="color: #ff00ff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span>

            L <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>L, <span style="color: #20b2aa;">((</span>A<span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> A<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> A<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        kmax <span style="color: #ff00ff;">&lt;-</span> thresholds<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>, L<span style="color: #20b2aa;">)]</span>
        min_threshold <span style="color: #ff00ff;">&lt;-</span> kmax <span style="color: #ff00ff;">-</span> p
        max_threshold <span style="color: #ff00ff;">&lt;-</span> kmax <span style="color: #ff00ff;">+</span> p
        Lmin <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>
        Lmax <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>
        n <span style="color: #ff00ff;">&lt;-</span> n <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>kmax<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-23" class="outline-2">
<h2 id="sec-23"><span class="section-number-2">23</span> ee_plot.R</h2>
<div class="outline-text-2" id="text-23">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ee_plot</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, start_date, end_date, min_clear<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">7</span>, exclude<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, 
                    normalize<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, title<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>start_date must be a <span style="color: #00ff00;">"Date"</span> object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>end_date must be a <span style="color: #00ff00;">"Date"</span> object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>x$Sensor <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> exclude<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x$Sensor <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>x$Sensor<span style="color: #20b2aa;">)</span>
    x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>x$WRS.Path, x$WRS.Row<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Frac_Clear <span style="color: #ff00ff;">&gt;=</span> min_clear, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> ||
        <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>both start_date and end_date must be provided<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        sel_interval <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>start_date, end_date<span style="color: #20b2aa;">)</span>
        x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Date.Acquired <span style="color: #ff00ff;">%</span>within<span style="color: #ff00ff;">%</span> sel_interval, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no data to plot <span style="color: #ff00ff;">-</span> try different start<span style="color: #ff00ff;">/</span>end dates<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!normalize<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        YearMonth<span style="color: #ff00ff;">=</span>Month<span style="color: #ff00ff;">=</span>Cum_Month<span style="color: #ff00ff;">=</span>Path_Row<span style="color: #ff00ff;">=</span>Sensor<span style="color: #ff00ff;">=</span>Frac_Clear<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span> 
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">transform</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>x, YearMonth<span style="color: #20b2aa;">)</span>,
                       Cum_Month<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">cumsum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>Month<span style="color: #20b2aa;">))))</span>
        p <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>xmin<span style="color: #ff00ff;">=</span>Month,
                           xmax<span style="color: #ff00ff;">=</span>Month <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>, 
                           ymin<span style="color: #ff00ff;">=</span>Cum_Month <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>, 
                           ymax<span style="color: #ff00ff;">=</span>Cum_Month,
                           colour<span style="color: #ff00ff;">=</span>Sensor,
                           fill<span style="color: #ff00ff;">=</span>Path_Row,
                           alpha<span style="color: #ff00ff;">=</span>Frac_Clear<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">geom_rect</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">facet_grid</span><span style="color: #20b2aa;">(</span>Year ~ ., scales<span style="color: #ff00ff;">=</span>free_y, space<span style="color: #ff00ff;">=</span>free_y<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span>Month<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">scale_x_continuous</span><span style="color: #20b2aa;">(</span>breaks<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">9</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">11</span>, <span style="color: #daa520;">12</span><span style="color: #20b2aa;">)</span>,
                               labels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>Jan, Feb, Mar, Apr, May, Jun, 
                                        Jul, Aug, Sep, Oct, Nov, Dec<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>panel.grid.minor.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, 
                  panel.grid.major.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  panel.grid.major.x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.ticks.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  axis.text.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">scale_colour_brewer</span><span style="color: #20b2aa;">(</span>type<span style="color: #ff00ff;">=</span>qual, palette<span style="color: #ff00ff;">=</span>Set<span style="color: #daa520;">1</span>, drop<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, name<span style="color: #ff00ff;">=</span>Sensor<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">scale_fill_brewer</span><span style="color: #20b2aa;">(</span>type<span style="color: #ff00ff;">=</span>qual, palette<span style="color: #ff00ff;">=</span>Set<span style="color: #daa520;">2</span>, drop<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, name<span style="color: #ff00ff;">=</span>Path<span style="color: #ff00ff;">/</span>Row<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">scale_alpha</span><span style="color: #20b2aa;">(</span>name<span style="color: #ff00ff;">=</span>Fraction Clear<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>

        YearMonth<span style="color: #ff00ff;">=</span>Path_Row<span style="color: #ff00ff;">=</span>Year<span style="color: #ff00ff;">=</span>Month<span style="color: #ff00ff;">=</span>Max_Frac_Clear<span style="color: #ff00ff;">=</span>Frac_Clear<span style="color: #ff00ff;">=</span>Sum_Max_Frac_Clear<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
        Frac_Clear_Stats <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>x, YearMonth, Path_Row<span style="color: #20b2aa;">)</span>,
                                      Year<span style="color: #ff00ff;">=</span>Year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, Month<span style="color: #ff00ff;">=</span>Month<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                                      Max_Frac_Clear<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>Frac_Clear<span style="color: #20b2aa;">))</span>
        Frac_Clear_Stats <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>Frac_Clear_Stats, YearMonth<span style="color: #20b2aa;">)</span>, 
                                      Year<span style="color: #ff00ff;">=</span>Year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, Month<span style="color: #ff00ff;">=</span>Month<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                                      Sum_Max_Frac_Clear<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>Max_Frac_Clear<span style="color: #20b2aa;">))</span>
        p <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>Frac_Clear_Stats, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>xmin<span style="color: #ff00ff;">=</span>Month <span style="color: #ff00ff;">+</span> .<span style="color: #daa520;">05</span>,
                                          xmax<span style="color: #ff00ff;">=</span>Month <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span>.<span style="color: #daa520;">05</span>, 
                                          ymin<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>, 
                                          ymax<span style="color: #ff00ff;">=</span>Sum_Max_Frac_Clear<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">geom_rect</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">facet_grid</span><span style="color: #20b2aa;">(</span>Year ~ .<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span>Month<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">ylab</span><span style="color: #20b2aa;">(</span>Total Fraction Clear<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">scale_x_continuous</span><span style="color: #20b2aa;">(</span>breaks<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">9</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">11</span>, <span style="color: #daa520;">12</span><span style="color: #20b2aa;">)</span>,
                               labels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>Jan, Feb, Mar, Apr, May, Jun, 
                                        Jul, Aug, Sep, Oct, Nov, Dec<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>panel.grid.minor.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, 
                  panel.grid.major.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  panel.grid.major.x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.ticks.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  axis.text.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #ff00ff;">+</span>
            <span style="color: #ff6347;">geom_hline</span><span style="color: #20b2aa;">(</span>yintercept<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>,<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$Path_Row<span style="color: #20b2aa;">)))</span>, colour<span style="color: #ff00ff;">=</span>white, linetype<span style="color: #ff00ff;">=</span>dashed<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>title<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        p <span style="color: #ff00ff;">&lt;-</span> p <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">ggtitle</span><span style="color: #20b2aa;">(</span>title<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>p<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-24" class="outline-2">
<h2 id="sec-24"><span class="section-number-2">24</span> ee_read.R</h2>
<div class="outline-text-2" id="text-24">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ee_read</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    scenes <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">read.csv</span><span style="color: #20b2aa;">(</span>x, stringsAsFactors<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, quote<span style="color: #ff00ff;">=</span>, 
                          na.strings<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>,  <span style="color: #20b2aa;">))</span>
    scenes$Sensor <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>scenes$Landsat.Scene.Identifier, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
    scenes$Sensor <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>scenes$Sensor<span style="color: #20b2aa;">)</span>

    yr_first <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">/</span>, scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    yr_last <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">/</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">}</span>$, scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>yr_first<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>yr_last<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>unrecognized date format <span style="color: #00ffff;">in</span> Date.Acquired column<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    acq_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    acq_date<span style="color: #20b2aa;">[</span>yr_first<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">[</span>yr_first<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">%</span>Y<span style="color: #ff00ff;">/%</span>m<span style="color: #ff00ff;">/%</span>d<span style="color: #20b2aa;">)</span>
    acq_date<span style="color: #20b2aa;">[</span>yr_last<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">[</span>yr_last<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">%</span>m<span style="color: #ff00ff;">/%</span>d<span style="color: #ff00ff;">/%</span>Y<span style="color: #20b2aa;">)</span>
    scenes$Date.Acquired <span style="color: #ff00ff;">&lt;-</span> acq_date
    scenes$Year <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #ff00ff;">%</span>Y<span style="color: #20b2aa;">))</span>
    scenes$Month <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #ff00ff;">%</span>m<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">-</span> .<span style="color: #daa520;">5</span>
    scenes$MonthFactor <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #ff00ff;">%</span>m<span style="color: #20b2aa;">))</span>
    scenes$Path_Row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>scenes$WRS.Path, scenes$WRS.Row, sep<span style="color: #ff00ff;">=/</span><span style="color: #20b2aa;">))</span>
    scenes$YearMonth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>scenes$Year, scenes$MonthFactor, sep<span style="color: #ff00ff;">=/</span><span style="color: #20b2aa;">)</span>
    scenes$Frac_Clear <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">100</span> <span style="color: #ff00ff;">-</span> scenes$Cloud.Cover<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">100</span>
    scenes <span style="color: #ff00ff;">&lt;-</span> scenes<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>scenes$WRS.Path, scenes$WRS.Row<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>no data found <span style="color: #00ffff;">in</span>, x,
                     <span style="color: #ff00ff;">-</span> is scenes an EarthExplorer CSV export?<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>


    scenes <span style="color: #ff00ff;">&lt;-</span> scenes<span style="color: #20b2aa;">[</span>scenes$Data.Category <span style="color: #ff00ff;">==</span> NOMINAL, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-25" class="outline-2">
<h2 id="sec-25"><span class="section-number-2">25</span> espa_download.R</h2>
<div class="outline-text-2" id="text-25">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">verify_download</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>espa_url, local_path<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    cksum_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">()</span>
    ret_code <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">download.file</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\\.tar\\.gz$, .cksum, espa_url<span style="color: #20b2aa;">)</span>, 
                              cksum_file, mode<span style="color: #ff00ff;">=</span>w, quiet<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Warning: problem downloading cksum <span style="color: #00ffff;">for</span>, local_path<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>



        espa_checksum <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scan</span><span style="color: #20b2aa;">(</span>cksum_file, what<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>integer, integer, 
                                                 character<span style="color: #20b2aa;">)</span>, quiet<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span>cksum_file<span style="color: #20b2aa;">)</span>
        local_size <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>local_path<span style="color: #20b2aa;">)</span>$size












        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>espa_checksum<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> !<span style="color: #ff00ff;">=</span> local_size<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">download_ESPA_file</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>espa_url, output_path<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    ret_code <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">download.file</span><span style="color: #20b2aa;">(</span>espa_url, output_path, mode<span style="color: #ff00ff;">=</span>wb<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Warning: problem downloading, output_path<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">verify_download</span><span style="color: #20b2aa;">(</span>espa_url, output_path<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Warning: checksum mismatch on, output_path<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">espa_download</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>email, order_ID, output_folder, username,
                          password<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Due to changes <span style="color: #00ffff;">in</span> the ESPA system, espa_download is not working as of <span style="color: #daa520;">7</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2014</span><span style="color: #20b2aa;">)</span>
    email_re <span style="color: #ff00ff;">&lt;-</span> ^<span style="color: #20b2aa;">[</span>A<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span>._<span style="color: #ff00ff;">%+-</span><span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">+</span>@<span style="color: #20b2aa;">[</span>A<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span>.<span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">+</span>\\.<span style="color: #20b2aa;">[</span>A<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span>,<span style="color: #daa520;">4</span><span style="color: #20b2aa;">}</span>$
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>email_re, email, ignore.case<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>email, does not appear to be a valid email address<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>






    mth_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">([</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    day_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">([</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>|<span style="color: #20b2aa;">([</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    yr_re  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">20</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>
    hr_re  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">([</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    min_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">([</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>|<span style="color: #20b2aa;">([</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]))</span>
    sec_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">([</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>|<span style="color: #20b2aa;">([</span><span style="color: #daa520;">1</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]))</span>
    order_id_re <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>^, mth_re, day_re, yr_re, <span style="color: #ff00ff;">-</span>,  hr_re, min_re, sec_re, $<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>order_id_re, order_ID<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>order_ID, does not appear to be a valid ESPA order ID<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_folder, does not appear to be a valid directory<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>


    email_noat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>@, <span style="color: #ff00ff;">%</span><span style="color: #daa520;">40</span>, email<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">options</span><span style="color: #20b2aa;">(</span>RCurlOptions<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cainfo<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>CurlSSL, cacert.pem, 
                                                 package<span style="color: #ff00ff;">=</span>RCurl<span style="color: #20b2aa;">)))</span>
    curl<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">getCurlHandle</span><span style="color: #20b2aa;">()</span>
    login_page <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getURL</span><span style="color: #20b2aa;">(</span>https:<span style="color: #ff00ff;">//</span>espa.cr.usgs.gov<span style="color: #ff00ff;">/</span>login<span style="color: #ff00ff;">/</span>, curl<span style="color: #ff00ff;">=</span>curl<span style="color: #20b2aa;">)</span>, \n<span style="color: #20b2aa;">))</span>
    csrfmiddlewaretoken <span style="color: #ff00ff;">&lt;-</span> login_page<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>csrfmiddlewaretoken, login_page<span style="color: #20b2aa;">)]</span>
    csrfmiddlewaretoken <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">((</span>value<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'), ,</span>
<span style="color: #00ff00;">                                str_extract(csrfmiddlewaretoken, </span>
<span style="color: #00ff00;">                                            value='</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">    params &lt;- list(username=username,</span>
<span style="color: #00ff00;">                   password=password,</span>
<span style="color: #00ff00;">                   submit=Log In,</span>
<span style="color: #00ff00;">                   next=,</span>
<span style="color: #00ff00;">                   csrfmiddlewaretoken=csrfmiddlewaretoken)</span>
<span style="color: #00ff00;">    post_res &lt;- postForm(https://espa.cr.usgs.gov/login,</span>
<span style="color: #00ff00;">                         .params=params, style=POST, curl=curl)</span>
<span style="color: #00ff00;">    tryCatch(espa_page &lt;- getURL(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(http://espa.cr.usgs.gov/ordering/status/, email_noat, </span>
<span style="color: #00ff00;">                             -, order_ID, curl=curl)),</span>
<span style="color: #00ff00;">             error=function(e) stop(error loading order - check order ID and email))</span>
<span style="color: #00ff00;">    url_re &lt;- paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(http://espa\\.cr\\.usgs\\.gov/orders/, email, -, </span>
<span style="color: #00ff00;">                     order_ID, /L[ET][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">14</span><span style="color: #00ff00;">}-SC[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">14</span><span style="color: #00ff00;">}\\.tar\\.gz)</span>
<span style="color: #00ff00;">    espa_urls &lt;- espa_page[grepl(url_re, espa_page)]</span>
<span style="color: #00ff00;">    espa_urls &lt;- str_extract(espa_urls, url_re)</span>
<span style="color: #00ff00;">    if (length(espa_urls) == </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">        stop(no download links found)</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    successes &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    failures &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    skips &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    message(paste(Found, length(espa_urls), ESPA downloads.))</span>
<span style="color: #00ff00;">    for (n in </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">:length(espa_urls)) {</span>
<span style="color: #00ff00;">        espa_url &lt;- espa_urls[n]</span>
<span style="color: #00ff00;">        img_file &lt;- basename(espa_url)</span>
<span style="color: #00ff00;">        output_path &lt;- file.path(output_folder, img_file)</span>
<span style="color: #00ff00;">        if (file.exists(output_path)) {</span>
<span style="color: #00ff00;">            if (verify_download(espa_url, output_path)) {</span>
<span style="color: #00ff00;">                message(paste(img_file, exists but has bad checksum - re-downloading file))</span>
<span style="color: #00ff00;">            } else {</span>
<span style="color: #00ff00;">                message(paste(img_file, exists and has good checksum - skipping download))</span>
<span style="color: #00ff00;">                skips &lt;- skips + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">                next</span>
<span style="color: #00ff00;">            }</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        if (download_ESPA_file(espa_url, output_path) == </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">            successes &lt;- successes + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">        } else {</span>
<span style="color: #00ff00;">            failures &lt;- failures + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    message(paste(successes, file(s) succeeded,, skips, file(s) skipped,, </span>
<span style="color: #00ff00;">                failures, file(s) failed.))</span>
<span style="color: #00ff00;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-26" class="outline-2">
<h2 id="sec-26"><span class="section-number-2">26</span> espa_extract.R</h2>
<div class="outline-text-2" id="text-26">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">espa_extract</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>in_folder, out_folder, pathrows<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, start_date<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                         end_date<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, sensors<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>in_folder, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, out_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>out_folder, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    zipfiles <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>in_folder, pattern<span style="color: #ff00ff;">=</span>^.*<span style="color: #ff6347;">.tar.gz</span><span style="color: #20b2aa;">(</span>ip<span style="color: #20b2aa;">)</span>?$<span style="color: #20b2aa;">)</span>

    img_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>, , <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, <span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">7</span><span style="color: #20b2aa;">}</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">))</span>, <span style="color: #ff00ff;">%</span>Y<span style="color: #ff00ff;">%</span>j<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span>
        inc_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>img_dates <span style="color: #ff00ff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span>
        zipfiles <span style="color: #ff00ff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span>
        inc_dates <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>img_dates <span style="color: #ff00ff;">&lt;</span> end_date<span style="color: #20b2aa;">)</span>
        zipfiles <span style="color: #ff00ff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    img_pathrows <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span>, , <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, <span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">}))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>pathrows, <span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">})))</span>
        inc_pathrows <span style="color: #ff00ff;">&lt;-</span> img_pathrows <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> pathrows
        zipfiles <span style="color: #ff00ff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
        img_pathrows <span style="color: #ff00ff;">&lt;-</span> img_pathrows<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    img_sensors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, ^<span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sensors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>sensors, ^<span style="color: #20b2aa;">((</span>LT<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">])</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))</span>$<span style="color: #20b2aa;">)))</span>
        inc_sensors <span style="color: #ff00ff;">&lt;-</span> img_sensors <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> sensors
        zipfiles <span style="color: #ff00ff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_pathrows <span style="color: #ff00ff;">&lt;-</span> img_pathrows<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_sensors <span style="color: #ff00ff;">&lt;-</span> img_sensors<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #ff00ff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    img_paths <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>img_pathrows, ^<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">})</span>
    img_rows <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>img_pathrows, <span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}</span>$<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>No images found<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        zipfile_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>in_folder, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>

        year <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_dates<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">%</span>Y<span style="color: #20b2aa;">)</span>
        julian_day <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_dates<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">%</span>j<span style="color: #20b2aa;">)</span>
        this_out_folder <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_folder,
                                     <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>img_paths<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>,<span style="color: #ff00ff;">-</span>, img_rows<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, _, year, 
                                            <span style="color: #ff00ff;">-</span>, julian_day, _, img_sensors<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, this_out_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">dir.create</span><span style="color: #20b2aa;">(</span>this_out_folder<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Skipping, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">-</span> output dir, 
                          this_out_folder, already exists.<span style="color: #20b2aa;">))</span>
            <span style="color: #00ffff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>n,  of , <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">)</span>, . Extracting , zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>,  to , this_out_folder<span style="color: #20b2aa;">))</span>
        ret_code <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">untar</span><span style="color: #20b2aa;">(</span>zipfile_path, exdir<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>this_out_folder<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>WARNING: error extracting, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #ff00ff;">-</span> <span style="color: #00ffff;">return</span> 
                          code, ret_code<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-27" class="outline-2">
<h2 id="sec-27"><span class="section-number-2">27</span> espa_scenelist.R</h2>
<div class="outline-text-2" id="text-27">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">espa_scenelist</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, start_date, end_date, out_file, min_clear<span style="color: #ff00ff;">=</span>.<span style="color: #daa520;">7</span>, 
                         exclude<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">())</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>start_date must be a <span style="color: #00ff00;">"Date"</span> object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> Date<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>end_date must be a <span style="color: #00ff00;">"Date"</span> object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> ||
        <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>both start_date and end_date must be provided<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        sel_interval <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>start_date, end_date<span style="color: #20b2aa;">)</span>
        x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Date.Acquired <span style="color: #ff00ff;">%</span>within<span style="color: #ff00ff;">%</span> sel_interval, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no data to download <span style="color: #ff00ff;">-</span> try different start<span style="color: #ff00ff;">/</span>end dates<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>x$Sensor <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> exclude<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Frac_Clear <span style="color: #ff00ff;">&gt;=</span> min_clear, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">write.table</span><span style="color: #20b2aa;">(</span>x$Landsat.Scene.Identifier, out_file, row.names<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, 
                col.names<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, quote<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, sep<span style="color: #ff00ff;">=</span>\n<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-28" class="outline-2">
<h2 id="sec-28"><span class="section-number-2">28</span> fill_gaps.R</h2>
<div class="outline-text-2" id="text-28">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">fill_gaps</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>, out_base<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, ext<span style="color: #ff00ff;">=</span>tif,
                      algorithm<span style="color: #ff00ff;">=</span>GNSPI_IDL, sample_size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">20</span>, size_wind<span style="color: #ff00ff;">=</span><span style="color: #daa520;">12</span>, 
                      class_num<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span>, 
                      DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>, patch_long<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1000</span>,
                      idl<span style="color: #ff00ff;">=</span>C:<span style="color: #ff00ff;">/</span>Program Files<span style="color: #ff00ff;">/</span>Exelis<span style="color: #ff00ff;">/</span>IDL<span style="color: #daa520;">83</span><span style="color: #ff00ff;">/</span>bin<span style="color: #ff00ff;">/</span>bin.x<span style="color: #daa520;">86</span>_<span style="color: #daa520;">64</span><span style="color: #ff00ff;">/</span>idl.exe,
                      verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>slc_off must be a Raster* object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>fill must be a Raster* object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>number of layers <span style="color: #00ffff;">in</span> slc_off must match number of layers <span style="color: #00ffff;">in</span> fill<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>slc_off, fill<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>GNSPI_IDL<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>algorithm must be <span style="color: #00ff00;">"GNSPI_IDL"</span> <span style="color: #ff00ff;">-</span> no other algorithms are supported<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">[</span>.<span style="color: #20b2aa;">]</span>, , ext<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>timeseries_img <span style="color: #00ffff;">in</span> timeseries<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>each timeseries image be a Raster* object<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>number of layers <span style="color: #00ffff;">in</span> slc_off must match number of layers of each image <span style="color: #00ffff;">in</span> timeseries<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>slc_off, timeseries_img<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out_base<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out_base <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">())</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        out_base <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">normalizePath</span><span style="color: #20b2aa;">(</span>out_base, mustWork<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_base<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output folder does not exist<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!overwrite &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_GNSPI., ext<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output file already exists <span style="color: #ff00ff;">-</span> use a different <span style="color: #00ff00;">"out_base"</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!overwrite &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_GNSPI_uncertainty., ext<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output uncertainty file already exists <span style="color: #ff00ff;">-</span> use a different <span style="color: #00ff00;">"out_base"</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #ff00ff;">==</span> GNSPI_IDL<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">fill_gaps_idl</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries, out_base, 
                                sample_size, size_wind, class_num, DN_min, 
                                DN_max, patch_long, idl, algorithm, ext, 
                                verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Native R gap filling not yet supported<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">fill_gaps_idl</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries, out_base, sample_size, 
                          size_wind, class_num, DN_min, DN_max, patch_long, 
                          idl, algorithm, ext, verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span> not supported when algorithm<span style="color: #ff00ff;">=</span><span style="color: #00ff00;">"GNSPI_IDL"</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    script_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, GNSPI.pro, package<span style="color: #ff00ff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>x, idl<span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, idl<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>IDL not found <span style="color: #ff00ff;">-</span> check <span style="color: #00ff00;">"idl"</span> parameter<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">check_ENVI_IDL</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Unable to load ENVI <span style="color: #00ffff;">in</span> IDL <span style="color: #ff00ff;">-</span> do you have ENVI and IDL licenses, and ENVI <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">5</span>.<span style="color: #daa520;">0</span>?<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>


    orig_proj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    orig_ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    orig_datatype <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>



    dummy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span>def_format <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">()</span>$format<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #ff00ff;">=</span>ENVI<span style="color: #20b2aa;">)</span>
    slc_off <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>slc_off, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    slc_off_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    fill <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>fill, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    fill_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)</span>
    timeseries_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>timeseries<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        timeseries_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>timeseries_img <span style="color: #00ffff;">in</span> timeseries<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timeseries_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>timeseries_img, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
            timeseries_files <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>timeseries_files, <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    temp_dir <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">tempdir</span><span style="color: #20b2aa;">()</span>
    dummy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #ff00ff;">=</span>def_format<span style="color: #20b2aa;">))</span>



    temp_out_base <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">())</span>
    param_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>slc_off_file, fill_file, timeseries_files,
                       temp_out_base, sample_size, size_wind, class_num,
                       DN_min, DN_max, patch_long, temp_dir<span style="color: #20b2aa;">)</span>
    param_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>slc_off_file, input_file, timeseries_files, 
                        out_base, sample_size, size_wind, class_num, 
                        DN_min, DN_max, patch_long, temp_dir<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span>format_IDL_param, param_names, param_vals<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>idl_params, collapse<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>
    script_dir <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>script_path<span style="color: #20b2aa;">)</span>
    idl_script <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">(</span>fileext<span style="color: #ff00ff;">=</span>.pro<span style="color: #20b2aa;">)</span>
    idl_cmd <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>CD, <span style="color: #00ff00;">", script_dir, "</span>\n, idl_params, GNSPI,, 
                      <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>param_names, collapse<span style="color: #ff00ff;">=</span>,<span style="color: #20b2aa;">)</span>, \nexit<span style="color: #20b2aa;">)</span>
    f <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>idl_script, wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_cmd, f<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl_script<span style="color: #20b2aa;">))</span>, intern<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    log_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, _GNSPI_idllog.txt<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>\r, , idl_out<span style="color: #20b2aa;">)</span>
    f <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>log_file, wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_out, f<span style="color: #20b2aa;">)</span> 
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>temp_out_base, _GNSPI.envi<span style="color: #20b2aa;">))</span>
    filled_out_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_GNSPI., ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_ext
    filled <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>filled, filename<span style="color: #ff00ff;">=</span>filled_out_file, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                          datatype<span style="color: #ff00ff;">=</span>orig_datatype<span style="color: #20b2aa;">)</span>
    uncertainty <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>temp_out_base, _GNSPI_uncertainty.envi<span style="color: #20b2aa;">))</span>
    uncertainty_out_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>_GNSPI_uncertainty., ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>uncertainty<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>uncertainty<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> orig_ext
    uncertainty <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>uncertainty, filename<span style="color: #ff00ff;">=</span>uncertainty_out_file, 
                               overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, datatype<span style="color: #ff00ff;">=</span>orig_datatype<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>filled<span style="color: #ff00ff;">=</span>filled, uncertainty<span style="color: #ff00ff;">=</span>uncertainty<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-29" class="outline-2">
<h2 id="sec-29"><span class="section-number-2">29</span> get_band_names_from_hdr.R</h2>
<div class="outline-text-2" id="text-29">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_band_names_from_hdr</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>hdr_file<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    txt <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readLines</span><span style="color: #20b2aa;">(</span>hdr_file<span style="color: #20b2aa;">)</span>
    line_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^band names, txt<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    band_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> line_num:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>band_names, <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">([</span>,<span style="color: #20b2aa;">}][[</span>:space:<span style="color: #20b2aa;">]]</span>*$, , txt<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(}</span>, txt<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">break</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>band_names<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-30" class="outline-2">
<h2 id="sec-30"><span class="section-number-2">30</span> get_extent_polys.R</h2>
<div class="outline-text-2" id="text-30">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_extent_polys</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.list</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">))</span> rast_list <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">)</span>
    proj<span style="color: #daa520;">4</span>strings <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>proj<span style="color: #daa520;">4</span>strings <span style="color: #ff00ff;">==</span> proj<span style="color: #daa520;">4</span>strings<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>every raster <span style="color: #00ffff;">in</span> rast_list must have the same projection<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    extents <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    filenames <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>

    extent_sps_list <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>extents, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">as</span><span style="color: #20b2aa;">(</span>x, SpatialPolygons<span style="color: #20b2aa;">))</span>


    extent_sps <span style="color: #ff00ff;">&lt;-</span> extent_sps_list<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            extent_sps <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spRbind</span><span style="color: #20b2aa;">(</span>extent_sps, <span style="color: #ff6347;">spChFIDs</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, 
                                                 <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>n<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>



    extent_polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>extent_sps, 
                                             data<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>filename<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>filenames<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>extent_polys<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> proj<span style="color: #daa520;">4</span>strings<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    extent_polys$filename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>extent_polys$filename<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>extent_polys<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-31" class="outline-2">
<h2 id="sec-31"><span class="section-number-2">31</span> get_metadata_item.R</h2>
<div class="outline-text-2" id="text-31">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_metadata_item</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, key<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    metadata_file <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x, .aux.xml<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>metadata_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Could not find metadata file, metadata_file<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    doc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">xmlInternalTreeParse</span><span style="color: #20b2aa;">(</span>metadata_file<span style="color: #20b2aa;">)</span>
    xpath_exp <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">//</span>MDI<span style="color: #20b2aa;">[</span>@key<span style="color: #ff00ff;">=</span><span style="color: #00ff00;">', key, '</span><span style="color: #20b2aa;">])</span>
    value <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">xpathApply</span><span style="color: #20b2aa;">(</span>doc, xpath_exp, xmlValue<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>multiple elements found<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no elements found<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-32" class="outline-2">
<h2 id="sec-32"><span class="section-number-2">32</span> gridsample.R</h2>
<div class="outline-text-2" id="text-32">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">gridsample</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, horizcells<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, vertcells<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, nsamp<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, 
                       rowmajor<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, replace<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


    horizstart <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> horizcells<span style="color: #20b2aa;">))</span>


    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        horizend <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">((</span>horizstart <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">)]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        horizend <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>


    vertstart <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> vertcells<span style="color: #20b2aa;">))</span>


    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        vertend <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">((</span>vertstart <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">)]</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        vertend <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>



    sampindices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">vector</span><span style="color: #20b2aa;">(</span>numeric, horizcells * vertcells * nsamp<span style="color: #20b2aa;">)</span>


    retval_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>


    cell<span style="color: #daa520;">1</span>row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>vertcellnum <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>


        cell<span style="color: #daa520;">1</span>col <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>


        cell_nrows <span style="color: #ff00ff;">&lt;-</span> vertend<span style="color: #20b2aa;">[</span>vertcellnum<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> vertstart<span style="color: #20b2aa;">[</span>vertcellnum<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>horizcellnum <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>


            cell<span style="color: #daa520;">1</span>colmajindex <span style="color: #ff00ff;">&lt;-</span> cell<span style="color: #daa520;">1</span>row <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>cell<span style="color: #daa520;">1</span>col <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>


            cell_ncols <span style="color: #ff00ff;">&lt;-</span> horizend<span style="color: #20b2aa;">[</span>horizcellnum<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> horizstart<span style="color: #20b2aa;">[</span>horizcellnum<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>



            cell_colmaj_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:cell_nrows, cell_ncols<span style="color: #20b2aa;">)</span>,
                                          nrow<span style="color: #ff00ff;">=</span>cell_nrows<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
                                   <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>cell<span style="color: #daa520;">1</span>colmajindex, by<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                                  length.out<span style="color: #ff00ff;">=</span>cell_ncols<span style="color: #20b2aa;">)</span>, 
                                              cell_nrows<span style="color: #20b2aa;">)</span>, nrow<span style="color: #ff00ff;">=</span>cell_nrows, 
                                          byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>
            samp_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sample</span><span style="color: #20b2aa;">(</span>cell_colmaj_indices, nsamp, replace<span style="color: #ff00ff;">=</span>replace<span style="color: #20b2aa;">)</span>
            sampindices<span style="color: #20b2aa;">[</span>retval_index:<span style="color: #20b2aa;">(</span>retval_index <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>samp_indices<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> samp_indices
            retval_index <span style="color: #ff00ff;">&lt;-</span> retval_index <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>samp_indices<span style="color: #20b2aa;">)</span>
            cell<span style="color: #daa520;">1</span>col  <span style="color: #ff00ff;">&lt;-</span> cell<span style="color: #daa520;">1</span>col <span style="color: #ff00ff;">+</span> cell_ncols
        <span style="color: #20b2aa;">}</span>
        cell<span style="color: #daa520;">1</span>row <span style="color: #ff00ff;">&lt;-</span> cell<span style="color: #daa520;">1</span>row <span style="color: #ff00ff;">+</span> cell_nrows
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>rowmajor<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sampindices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">((</span>sampindices <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%%</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> * <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">((</span>sampindices <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%/%</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>sampindices<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-33" class="outline-2">
<h2 id="sec-33"><span class="section-number-2">33</span> linear_stretch.R</h2>
<div class="outline-text-2" id="text-33">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">.do_stretch</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, pct, max_val<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lower <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>x, prob<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span> <span style="color: #ff00ff;">+</span> pct<span style="color: #ff00ff;">/</span><span style="color: #daa520;">100</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    upper <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>x, prob<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> pct<span style="color: #ff00ff;">/</span><span style="color: #daa520;">100</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    x<span style="color: #20b2aa;">[</span>x <span style="color: #ff00ff;">&gt;</span> upper<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> upper
    x<span style="color: #20b2aa;">[</span>x <span style="color: #ff00ff;">&lt;</span> lower<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> lower
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">((</span>x <span style="color: #ff00ff;">-</span> lower<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>upper<span style="color: #ff00ff;">-</span>lower<span style="color: #20b2aa;">))</span> * max_val
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">linear_stretch</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, pct<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span>, max_val<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>pct <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> | pct <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">50</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>pct must be <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span> and <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">50</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, pct, max_val<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterStack, RasterBrick<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>x, layer<span style="color: #ff00ff;">=</span>n<span style="color: #20b2aa;">))</span>,
                                          pct, max_val<span style="color: #20b2aa;">)</span>, layer<span style="color: #ff00ff;">=</span>n<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span>x, pct, max_val<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-34" class="outline-2">
<h2 id="sec-34"><span class="section-number-2">34</span> ls_catalog.R</h2>
<div class="outline-text-2" id="text-34">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ls_catalog</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>in_folder<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>in_folder, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>outer_item <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        outer_item_full <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>in_folder, outer_item<span style="color: #20b2aa;">)</span>

        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, outer_item_full<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>inner_item <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>outer_item_full<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            inner_item_full <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>outer_item_full, inner_item<span style="color: #20b2aa;">)</span>

            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, inner_item_full<span style="color: #20b2aa;">)</span> ||
                !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^<span style="color: #20b2aa;">(</span>lndsr.<span style="color: #20b2aa;">)</span>?<span style="color: #20b2aa;">((</span>LT<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LT<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">13</span><span style="color: #20b2aa;">}[</span>A<span style="color: #ff00ff;">-</span>Z<span style="color: #20b2aa;">]{</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">}[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>.hdf$, 
                       inner_item<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">next</span>
            <span style="color: #20b2aa;">}</span>
            metadata_string <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>inner_item, 
                                           <span style="color: #20b2aa;">((</span>LT<span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LT<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LE<span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>LC<span style="color: #daa520;">8</span><span style="color: #20b2aa;">))[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">13</span><span style="color: #20b2aa;">})</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^LT<span style="color: #daa520;">4</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #ff00ff;">&lt;-</span> LT<span style="color: #daa520;">4</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^LT<span style="color: #daa520;">5</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #ff00ff;">&lt;-</span> LT<span style="color: #daa520;">5</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^LE<span style="color: #daa520;">7</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #ff00ff;">&lt;-</span> LE<span style="color: #daa520;">7</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>^LC<span style="color: #daa520;">8</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #ff00ff;">&lt;-</span> LC<span style="color: #daa520;">8</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Skipping, inner_item,
                              <span style="color: #ff00ff;">-</span> cannot determine sensor from filename.<span style="color: #20b2aa;">))</span>
                <span style="color: #00ffff;">next</span>
            <span style="color: #20b2aa;">}</span>
            year <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">13</span><span style="color: #20b2aa;">)</span>
            julian_day <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">14</span>, <span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
            img_path <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>
            img_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">9</span><span style="color: #20b2aa;">)</span>
            img_date <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>year, julian_day<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">%</span>Y<span style="color: #ff00ff;">%</span>j<span style="color: #20b2aa;">)</span>
            out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>img_path,
                                    img_row,
                                    year,
                                    julian_day,
                                    sensor,
                                    <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_date, <span style="color: #ff00ff;">%</span>m<span style="color: #20b2aa;">)</span>, 
                                    <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_date, <span style="color: #ff00ff;">%</span>d<span style="color: #20b2aa;">)</span>,
                                    inner_item<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>no images found<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, byrow<span style="color: #ff00ff;">=</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>path, row, year, julian, sensor,
                    month, day, filename<span style="color: #20b2aa;">)</span>
    out <span style="color: #ff00ff;">&lt;-</span> out<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>out$path, out$row, out$year, out$julian, out$sensor<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-35" class="outline-2">
<h2 id="sec-35"><span class="section-number-2">35</span> match_rasters.R</h2>
<div class="outline-text-2" id="text-35">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">match_rasters</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>baseimg, matchimg, filename, method<span style="color: #ff00ff;">=</span>bilinear,
                          ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">projectRaster</span><span style="color: #20b2aa;">(</span>from<span style="color: #ff00ff;">=</span>matchimg, to<span style="color: #ff00ff;">=</span>baseimg, method<span style="color: #ff00ff;">=</span>method<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    matchimg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">crop</span><span style="color: #20b2aa;">(</span>matchimg, baseimg<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">resample</span><span style="color: #20b2aa;">(</span>matchimg, baseimg, method<span style="color: #ff00ff;">=</span>method<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extend</span><span style="color: #20b2aa;">(</span>matchimg, baseimg<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            matchimg <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>matchimg, filename<span style="color: #ff00ff;">=</span>filename, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-36" class="outline-2">
<h2 id="sec-36"><span class="section-number-2">36</span> minnaert_samp.R</h2>
<div class="outline-text-2" id="text-36">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">.calc_k_table</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, IL, slope, sampleindices, slopeclass,
                          coverclass, sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>x<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>,
                        IL<span style="color: #ff00ff;">=</span>IL<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>, 
                        slope<span style="color: #ff00ff;">=</span>slope<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">])</span>



        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">))</span> coverclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">)[</span>sampleindices<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, IL<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>, 
                        slope<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>coverclass, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>



    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>rowvals<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>rowvals<span style="color: #20b2aa;">)))</span>, <span style="color: #20b2aa;">]</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
    K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$IL <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
    k_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, nrow<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>, ncol<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>midpoint, n, k<span style="color: #20b2aa;">)</span>
    k_table$midpoint <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">diff</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span> <span style="color: #ff00ff;">+</span> slopeclass<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>

    K.cut <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>K$slope, slopeclass<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>slopeclass is inappropriate <span style="color: #00ffff;">for</span> these <span style="color: #ff6347;">data</span> <span style="color: #20b2aa;">(</span>empty classes<span style="color: #20b2aa;">)</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    k_table$n <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">for</span><span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)])))</span> <span style="color: #20b2aa;">{</span>
        k_table$k<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">)[</span>K.cut <span style="color: #ff00ff;">==</span> i<span style="color: #20b2aa;">]</span> ~ 
                                        <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$IL<span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))[</span>K.cut <span style="color: #ff00ff;">==</span> i<span style="color: #20b2aa;">]))[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">clean_intervals</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>counts, lims, n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">while</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;</span> n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        min_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span>,
                                            <span style="color: #ff6347;">rev</span><span style="color: #20b2aa;">(</span>counts <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>min_index <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #ff00ff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">(</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>min_index <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #ff00ff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>min_index<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #ff00ff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">(</span>min_index <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>

            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #ff00ff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>min_index<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        counts <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span>min_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>lims<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">minnaert_samp</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth,
                          IL.epsilon<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span>, slopeclass<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                          coverclass<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, sampleindices<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                          DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        slopeclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">12</span>,
                        <span style="color: #daa520;">15</span>, <span style="color: #daa520;">20</span>, <span style="color: #daa520;">25</span>, <span style="color: #daa520;">30</span>, <span style="color: #daa520;">45</span>, <span style="color: #daa520;">75</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        counts <span style="color: #ff00ff;">&lt;-</span> raster::<span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>raster::<span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slope, slopeclass,
                                           include.lowest<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, 
                               useNA<span style="color: #ff00ff;">=</span>no<span style="color: #20b2aa;">)</span>

        slopeclass <span style="color: #ff00ff;">&lt;-</span> slopeclass<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span>, <span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> counts<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])]</span>
        counts <span style="color: #ff00ff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        counts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>, slopeclass, 
                                       include.lowest<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, useNA<span style="color: #ff00ff;">=</span>no<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    slopeclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">clean_intervals</span><span style="color: #20b2aa;">(</span>counts, slopeclass<span style="color: #20b2aa;">[</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>insufficient sample size to develop k model <span style="color: #ff00ff;">-</span> try changing slopeclass or sampleindices<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    slopeclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>*pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span>, slopeclass<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">((</span>slopeclass <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; slopeclass <span style="color: #ff00ff;">&lt;=</span> pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>

    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>
    sunzenith <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #ff00ff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    IL <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_IL</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rm</span><span style="color: #20b2aa;">(</span>aspect, sunazimuth<span style="color: #20b2aa;">)</span>
    k_table <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_k_table</span><span style="color: #20b2aa;">(</span>x, IL, slope, sampleindices, slopeclass, 
                             coverclass, sunzenith<span style="color: #20b2aa;">)</span>

    k_model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>k_table, <span style="color: #ff6347;">bam</span><span style="color: #20b2aa;">(</span>k ~ <span style="color: #ff6347;">s</span><span style="color: #20b2aa;">(</span>midpoint, k<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>midpoint<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, data<span style="color: #ff00ff;">=</span>k_table<span style="color: #20b2aa;">))</span>


    slopeclass_max <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span>
    slopeclass_min <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span>
    slope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>slope,
                  fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> slopeclass_max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> slopeclass_max
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> slopeclass_min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
                      <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  <span style="color: #20b2aa;">})</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> midpoint
    K.all <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>slope, k_model<span style="color: #20b2aa;">)</span>
    K.all <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>K.all,
                  fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
                      <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  <span style="color: #20b2aa;">})</span>

    xout <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>x, IL, K.all,
                    fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x_vals, IL_vals, K.all_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        x_vals * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>IL_vals<span style="color: #20b2aa;">)</span> ^ K.all_vals
                    <span style="color: #20b2aa;">})</span>

    xout<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>K.all <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        xout <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>xout, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                     <span style="color: #20b2aa;">})</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>classcoef<span style="color: #ff00ff;">=</span>k_table, model<span style="color: #ff00ff;">=</span>k_model, minnaert<span style="color: #ff00ff;">=</span>xout, sampleindices<span style="color: #ff00ff;">=</span>sampleindices<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-37" class="outline-2">
<h2 id="sec-37"><span class="section-number-2">37</span> normalize.R</h2>
<div class="outline-text-2" id="text-37">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">normalize</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, msk, method<span style="color: #ff00ff;">=</span>MA, size<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    orig_datatype <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>size <span style="color: #ff00ff;">&lt;=</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>x, msk<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>size <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>


        x_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, size<span style="color: #ff00ff;">=</span>size, cells<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x_vals <span style="color: #ff00ff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">[</span>x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        y_vals <span style="color: #ff00ff;">&lt;-</span> y<span style="color: #20b2aa;">[</span>x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
        x_vals <span style="color: #ff00ff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        x_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
        y_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x_vals <span style="color: #ff00ff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
            y_vals <span style="color: #ff00ff;">&lt;-</span> y_vals<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>y_vals<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x_vals<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        unnormed_layer <span style="color: #ff00ff;">&lt;-</span> x_sample <span style="color: #ff00ff;">&lt;-</span> y_sample <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
        normed_y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unnormed_layer<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>,
                            x_sample<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>x_vals, by<span style="color: #ff00ff;">=</span>column<span style="color: #20b2aa;">)</span>,
                            y_sample<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>y_vals, by<span style="color: #ff00ff;">=</span>column<span style="color: #20b2aa;">)</span>,
                            .combine<span style="color: #ff00ff;">=</span>addLayer, .multicombine<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                            .init<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>,
                            .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>raster, lmodel<span style="color: #daa520;">2</span>, rgdal<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
            model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">suppressMessages</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>x_sample ~ y_sample, nperm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
            model <span style="color: #ff00ff;">&lt;-</span> model$regression.results<span style="color: #20b2aa;">[</span>model$regression.results<span style="color: #20b2aa;">[</span>, Method<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> method, <span style="color: #20b2aa;">]</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^ *, , <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
            normed_layer <span style="color: #ff00ff;">&lt;-</span> model$Slope * unnormed_layer <span style="color: #ff00ff;">+</span> model$Intercept
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">suppressMessages</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>x_vals ~ y_vals, nperm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
        model <span style="color: #ff00ff;">&lt;-</span> model$regression.results<span style="color: #20b2aa;">[</span>model$regression.results<span style="color: #20b2aa;">[</span>, Method<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">==</span> method, <span style="color: #20b2aa;">]</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^ *, , <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
        normed_y <span style="color: #ff00ff;">&lt;-</span> model$Slope * y <span style="color: #ff00ff;">+</span> model$Intercept
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        normed_y<span style="color: #20b2aa;">[</span>msk<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> y<span style="color: #20b2aa;">[</span>msk<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>normed_y<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-38" class="outline-2">
<h2 id="sec-38"><span class="section-number-2">38</span> overlay_poly.R</h2>
<div class="outline-text-2" id="text-38">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">overlay_poly</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, out, title<span style="color: #ff00ff;">=</span>, width<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span>, height<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span>, dpi<span style="color: #ff00ff;">=</span><span style="color: #daa520;">150</span>,
                         ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>overlay_poly is not yet supported<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x must be a one or three band image<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    maxpixels <span style="color: #ff00ff;">&lt;-</span> width*height*dpi^<span style="color: #daa520;">2</span>

    nl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>nl <span style="color: #ff00ff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, maxpixels*nl, ext<span style="color: #ff00ff;">=</span>y, asRaster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
    coords <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">xyFromCell</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">seq_len</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    dat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">linear_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    dat <span style="color: #ff00ff;">&lt;-</span> dat<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    coords <span style="color: #ff00ff;">&lt;-</span> coords<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        dat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rgb</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    dat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>coords, color<span style="color: #ff00ff;">=</span>dat<span style="color: #20b2aa;">)</span>
    color<span style="color: #ff00ff;">=</span>long<span style="color: #ff00ff;">=</span>lat<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>  
    <span style="color: #ff6347;">theme_set</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">theme_bw</span><span style="color: #20b2aa;">(</span>base_size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">8</span><span style="color: #20b2aa;">))</span>
    p <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
        <span style="color: #ff6347;">geom_raster</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>x, y, fill<span style="color: #ff00ff;">=</span>color<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">coord_fixed</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">+</span>
        <span style="color: #ff6347;">scale_fill_identity</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">+</span>
        <span style="color: #ff6347;">labs</span><span style="color: #20b2aa;">(</span>title<span style="color: #ff00ff;">=</span>title<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span>
        <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.text.x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.text.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              axis.title.x<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.title.y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              panel.background<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, panel.border<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              panel.grid.major<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, panel.grid.minor<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              plot.background<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.ticks<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              plot.margin<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unit</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, cm<span style="color: #20b2aa;">))</span>
    p
    <span style="color: #ff6347;">ggsave</span><span style="color: #20b2aa;">(</span>out, width<span style="color: #ff00ff;">=</span>width, height<span style="color: #ff00ff;">=</span>height, dpi<span style="color: #ff00ff;">=</span>dpi, ...<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-39" class="outline-2">
<h2 id="sec-39"><span class="section-number-2">39</span> pixel_data.R</h2>
<div class="outline-text-2" id="text-39">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span>pixel_data, slots<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>data.frame, y<span style="color: #ff00ff;">=</span>factor, 
                               pixel_src<span style="color: #ff00ff;">=</span>data.frame, training_flag<span style="color: #ff00ff;">=</span>logical, 
                               polys<span style="color: #ff00ff;">=</span>SpatialPolygonsDataFrame<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">summary.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    obj <span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    obj<span style="color: #20b2aa;">[[</span>class<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>n_classes<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>n_sources<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>object@polys$src<span style="color: #20b2aa;">))</span>
    obj<span style="color: #20b2aa;">[[</span>n_polys<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>object@polys<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>n_pixels<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>object@x<span style="color: #20b2aa;">)</span>
    training_df <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>object@y,
                              pixel_src<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">src_name</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>, 
                              training_flag<span style="color: #ff00ff;">=</span>object@training_flag<span style="color: #20b2aa;">)</span>
    y<span style="color: #ff00ff;">=</span>pixel_src<span style="color: #ff00ff;">=</span>training_flag<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span> 
    class_stats <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>training_df, y<span style="color: #20b2aa;">)</span>,
                             n_polys<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>pixel_src<span style="color: #20b2aa;">))</span>,
                             n_train_pixels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>,
                             n_test_pixels<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!training_flag<span style="color: #20b2aa;">)</span>,
                             train_frac<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> 
                                              <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> y<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> class
    obj<span style="color: #20b2aa;">[[</span>class_stats<span style="color: #20b2aa;">]]</span>  <span style="color: #ff00ff;">&lt;-</span> class_stats
    obj<span style="color: #20b2aa;">[[</span>n_training<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>n_testing<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span>training_frac<span style="color: #20b2aa;">]]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>object@training_flag<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>obj<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> summary.pixel_data
    obj
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">print.summary.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Object of class <span style="color: #00ff00;">", x[[class]], "</span>\n, sep <span style="color: #ff00ff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of classes:\t, x<span style="color: #20b2aa;">[[</span>n_classes<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of polygons:\t, x<span style="color: #20b2aa;">[[</span>n_polys<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of pixels:\t, x<span style="color: #20b2aa;">[[</span>n_pixels<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of sources:\t, x<span style="color: #20b2aa;">[[</span>n_sources<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>Training data statistics:\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>class_stats<span style="color: #20b2aa;">]])</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of training samples:\t, x<span style="color: #20b2aa;">[[</span>n_training<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Number of testing samples:\t, x<span style="color: #20b2aa;">[[</span>n_testing<span style="color: #20b2aa;">]]</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Training fraction:\t\t, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>training_frac<span style="color: #20b2aa;">]]</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, \n, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">invisible</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">length.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">levels.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">print.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">rbind.pixel_data</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>item <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>...<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x@x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@x, item@x<span style="color: #20b2aa;">)</span>
        x@y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>item@y<span style="color: #20b2aa;">)))</span>
        x@pixel_src <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@pixel_src, item@pixel_src<span style="color: #20b2aa;">)</span>
        x@training_flag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x@training_flag, item@training_flag<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>item@polys<span style="color: #20b2aa;">)))</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>training polygon IDs are not unique <span style="color: #ff00ff;">-</span> are src_names unique?<span style="color: #20b2aa;">)</span>
        x@polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spRbind</span><span style="color: #20b2aa;">(</span>x@polys, item@polys<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">([</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data, i<span style="color: #ff00ff;">=</span>character, j<span style="color: #ff00ff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, i, j, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>i <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", i, "</span>,  is not a class <span style="color: #00ffff;">in</span> this pixel_data object<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    sel_rows <span style="color: #ff00ff;">&lt;-</span> x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> i
    used_polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys@data$src, x@polys@data$ID<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> 
                        <span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>x@pixel_src<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>src, ID<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">initialize</span><span style="color: #20b2aa;">(</span>x, x<span style="color: #ff00ff;">=</span>x@x<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, y<span style="color: #ff00ff;">=</span>x@y<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span>, 
               pixel_src<span style="color: #ff00ff;">=</span>x@pixel_src<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, 
               training_flag<span style="color: #ff00ff;">=</span>x@training_flag<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span>, 
               polys<span style="color: #ff00ff;">=</span>x@polys<span style="color: #20b2aa;">[</span>used_polys, <span style="color: #20b2aa;">])</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> 
          <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>subsample, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata<span style="color: #ff00ff;">=</span>sources, type<span style="color: #ff00ff;">=</span>training, 
                                 flag<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>subsample<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>subsample, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data, size<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata, type, flag, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    row_IDs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>x@y,
                          pixel_src<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, x@pixel_src$ID<span style="color: #20b2aa;">)</span>,
                          row_num<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>size <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>strata <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>sources, classes<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>training, testing<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">==</span> training<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #ff00ff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>x@training_flag, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #ff00ff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>!x@training_flag, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    row_IDs <span style="color: #ff00ff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>row_IDs$y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>row_IDs<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>strata <span style="color: #ff00ff;">==</span> sources<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        y<span style="color: #ff00ff;">=</span>pixel_src<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
        row_IDs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>row_IDs, y, pixel_src<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>strata <span style="color: #ff00ff;">==</span> classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>row_IDs, y<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>size <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        samp_rows <span style="color: #ff00ff;">&lt;-</span> dplyr:::<span style="color: #ff6347;">sample_frac.grouped_df</span><span style="color: #20b2aa;">(</span>row_IDs, size<span style="color: #20b2aa;">)</span>$row_num
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        samp_rows <span style="color: #ff00ff;">&lt;-</span> dplyr:::<span style="color: #ff6347;">sample_n.grouped_df</span><span style="color: #20b2aa;">(</span>row_IDs, size<span style="color: #20b2aa;">)</span>$row_num
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>flag<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">==</span> testing<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">==</span> training<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        x@x <span style="color: #ff00ff;">&lt;-</span> x@x<span style="color: #20b2aa;">[</span>samp_rows, <span style="color: #20b2aa;">]</span>
        x@y <span style="color: #ff00ff;">&lt;-</span> x@y<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span>
        x@training_flag <span style="color: #ff00ff;">&lt;-</span> x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span>
        x@pixel_src <span style="color: #ff00ff;">&lt;-</span> x@pixel_src<span style="color: #20b2aa;">[</span>samp_rows, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>training_flag, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>training_flag, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #ff00ff;">&lt;-</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #ff00ff;">&lt;-</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #ff00ff;">&lt;-</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>


        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> value <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
        x@training_flag <span style="color: #ff00ff;">&lt;-</span> value
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        sel_rows <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> value <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sel_rows<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sel_rows<span style="color: #20b2aa;">))</span>
        x@training_flag<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> value
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>n_test, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>n_test<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>n_test, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!x@training_flag<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes<span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>n_train, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>n_train<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>n_train, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes<span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>src_name, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>src_name, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, _, x@pixel_src$ID<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>x@pixel_src<span style="color: #20b2aa;">[</span>x@y <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> classes, <span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>src, _, ID<span style="color: #20b2aa;">)))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #ff00ff;">&lt;-</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, value<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #ff00ff;">&lt;-</span><span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #ff00ff;">&lt;-</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        value <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>src_name must be equal to <span style="color: #daa520;">1</span> or number of polygons <span style="color: #00ffff;">in</span> x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    old_full_polyID <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys$src, x@polys$ID<span style="color: #20b2aa;">)</span>
    x@polys$src <span style="color: #ff00ff;">&lt;-</span> value
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@polys$src, _, x@polys$ID<span style="color: #20b2aa;">)</span>
    new_full_polyID <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys$src, x@polys$ID<span style="color: #20b2aa;">)</span>
    poly_pixel_match <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, x@pixel_src$ID<span style="color: #20b2aa;">)</span>, 
                              old_full_polyID<span style="color: #20b2aa;">)</span>
    x@pixel_src$src <span style="color: #ff00ff;">&lt;-</span> x@polys$src<span style="color: #20b2aa;">[</span>poly_pixel_match<span style="color: #20b2aa;">]</span>
    x@pixel_src$ID <span style="color: #ff00ff;">&lt;-</span> x@polys$ID<span style="color: #20b2aa;">[</span>poly_pixel_match<span style="color: #20b2aa;">]</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">get_pixels</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, polys, class_col, training<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, src<span style="color: #ff00ff;">=</span>none<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>Coordinate systems do not match<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>src<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>class_col<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> id<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>class_col cannot be named <span style="color: #00ff00;">"ID"</span> <span style="color: #20b2aa;">(</span>case insensitive<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    class_colnum <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>^, class_col, $<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_colnum<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", class_col, "</span> not found <span style="color: #00ffff;">in</span> polys<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    polys$ID <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span>
    polys$src <span style="color: #ff00ff;">&lt;-</span> src
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>polys$src, _, polys$ID<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        training_col_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>training, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training_col_index<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", training,  "</span> column not found <span style="color: #00ffff;">in</span> x<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.logical</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">[</span>training_col_index<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", training,  "</span> column must be a logical vector<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        training <span style="color: #ff00ff;">&lt;-</span> polys<span style="color: #20b2aa;">[</span>, <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>training, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp;&amp;
               <span style="color: #20b2aa;">(</span>training <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>training <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>training_flag <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">"training_flag"</span> column already present <span style="color: #00ffff;">in</span> polys<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>training <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


            polys$training_flag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">sample_strata</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                rand_vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">runif</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
                rand_vals <span style="color: #ff00ff;">&lt;=</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>rand_vals, training<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            polys$training_flag <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tapply</span><span style="color: #20b2aa;">(</span>polys@data$ID, 
                                                 polys@data<span style="color: #20b2aa;">[</span>class_colnum<span style="color: #20b2aa;">]</span>, 
                                                 sample_strata<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> &amp;&amp; <span style="color: #ff6347;">is.logical</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

        polys$training_flag <span style="color: #ff00ff;">&lt;-</span> training
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">"training"</span> must be a column name, vector of same length as polys, or length <span style="color: #daa520;">1</span> numeric<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, polys, small<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    poly_rows <span style="color: #ff00ff;">&lt;-</span> pixels$ID
    pixels <span style="color: #ff00ff;">&lt;-</span> pixels<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>pixels<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> ID<span style="color: #20b2aa;">)]</span>


    y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">make.names</span><span style="color: #20b2aa;">(</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, class_colnum<span style="color: #20b2aa;">]))</span>
    pixel_src <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>src<span style="color: #ff00ff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$src,
                            ID<span style="color: #ff00ff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$ID, 
                            stringsAsFactors<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>pixel_data, x<span style="color: #ff00ff;">=</span>pixels, y<span style="color: #ff00ff;">=</span>y, pixel_src<span style="color: #ff00ff;">=</span>pixel_src,
               training_flag<span style="color: #ff00ff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$training_flag,
               polys<span style="color: #ff00ff;">=</span>polys<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-40" class="outline-2">
<h2 id="sec-40"><span class="section-number-2">40</span> proj4comp.R</h2>
<div class="outline-text-2" id="text-40">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">proj4comp</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">+</span>init<span style="color: #ff00ff;">=</span>, x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">CRSargs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">+</span>init<span style="color: #ff00ff;">=</span>, y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">CRSargs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    x_proj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">+</span>proj<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    y_proj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff00ff;">+</span>proj<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_proj, y_proj<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>proj string is missing<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x_proj !<span style="color: #ff00ff;">=</span> y_proj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    x_ellps <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">+</span>ellps<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    y_ellps <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff00ff;">+</span>ellps<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_ellps, y_ellps<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>ellps string is missing<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x_ellps !<span style="color: #ff00ff;">=</span> y_ellps<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>utm, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x_proj<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        x_zone <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">+</span>zone<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
        y_zone <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff00ff;">+</span>zone<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_zone, y_zone<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>utm zone must be specified <span style="color: #00ffff;">for</span> utm projections<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x_zone !<span style="color: #ff00ff;">=</span> y_zone<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        x_south <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">+</span>south<span style="color: #20b2aa;">)</span>
        y_south <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">+</span>south<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_south<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_south<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>

            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">xor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_south<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_south<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>x_south !<span style="color: #ff00ff;">=</span> y_south<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>


                <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    x_datum <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">+</span>datum<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    y_datum <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff00ff;">+</span>datum<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_datum<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_datum<span style="color: #20b2aa;">))</span> &amp; <span style="color: #20b2aa;">(</span>x_datum !<span style="color: #ff00ff;">=</span> y_datum<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    x_units <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">+</span>units<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    y_units <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff00ff;">+</span>units<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">[</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_units<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_units<span style="color: #20b2aa;">))</span> &amp; <span style="color: #20b2aa;">(</span>x_units !<span style="color: #ff00ff;">=</span> y_units<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-41" class="outline-2">
<h2 id="sec-41"><span class="section-number-2">41</span> RcppExports.R</h2>
<div class="outline-text-2" id="text-41">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">threshold_Huang</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>data<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span>teamlucc_threshold_Huang, PACKAGE <span style="color: #ff00ff;">=</span> teamlucc, data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">calc_chg_dir</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span>teamlucc_calc_chg_dir, PACKAGE <span style="color: #ff00ff;">=</span> teamlucc, t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_fill</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, verbose <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span>teamlucc_cloud_fill, PACKAGE <span style="color: #ff00ff;">=</span> teamlucc, cloudy, clear, cloud_mask, dims, num_class, min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">cloud_fill_simple</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, cloud_nbh, DN_min, DN_max, verbose <span style="color: #ff00ff;">=</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span>teamlucc_cloud_fill_simple, PACKAGE <span style="color: #ff00ff;">=</span> teamlucc, cloudy, clear, cloud_mask, dims, num_class, cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-42" class="outline-2">
<h2 id="sec-42"><span class="section-number-2">42</span> sample_raster.R</h2>
<div class="outline-text-2" id="text-42">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">sample_raster</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, side<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">xres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, fields<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>, 
                          na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, exp<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        stratified <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span> !<span style="color: #ff00ff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x and strata must have the same coordinate system<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x and strata must have the same extent<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x and strata must have the same resolution<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        strat_sample <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleStratified</span><span style="color: #20b2aa;">(</span>strata, size, exp<span style="color: #ff00ff;">=</span>exp, na.rm<span style="color: #ff00ff;">=</span>na.rm<span style="color: #20b2aa;">)</span>
        cell_nums <span style="color: #ff00ff;">&lt;-</span> strat_sample<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        strataids <span style="color: #ff00ff;">&lt;-</span> strat_sample<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        stratified <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        cell_nums <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRandom</span><span style="color: #20b2aa;">(</span>x, size, exp<span style="color: #ff00ff;">=</span>exp, na.rm<span style="color: #ff00ff;">=</span>na.rm<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    xy <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">xyFromCell</span><span style="color: #20b2aa;">(</span>x, cell_nums<span style="color: #20b2aa;">)</span>

    xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">xres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span>
    xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">yres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span>


    xcoords <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">+</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    ycoords <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">-</span> side<span style="color: #20b2aa;">)</span>
    xycoords <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xcoords, ycoords<span style="color: #20b2aa;">)</span>,
                      dim<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>xcoords<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>xcoords<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>



    <span style="color: #ff6347;">make_Polygon</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slice<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">Polygon</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>slice<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, y<span style="color: #ff00ff;">=</span>slice<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">])))</span>
    <span style="color: #20b2aa;">}</span>
    polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>xycoords, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, make_Polygon<span style="color: #20b2aa;">)</span>


    polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>poly, ID<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">Polygons</span><span style="color: #20b2aa;">(</span>poly, ID<span style="color: #ff00ff;">=</span>ID<span style="color: #20b2aa;">)</span>,
                    polys, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)))</span>
    Sr <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygons</span><span style="color: #20b2aa;">(</span>polys, proj<span style="color: #daa520;">4</span>string<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>stratified<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>ID<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>Sr<span style="color: #20b2aa;">)</span>, strata<span style="color: #ff00ff;">=</span>strataids<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>ID<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>Sr<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>field <span style="color: #00ffff;">in</span> fields<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>out_data, <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)))</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> field
    <span style="color: #20b2aa;">}</span>

    polys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>Sr, data<span style="color: #ff00ff;">=</span>out_data<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;</span> size<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>length of polys <span style="color: #ff00ff;">&lt;</span> size. Try increasing exp.<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-43" class="outline-2">
<h2 id="sec-43"><span class="section-number-2">43</span> scale_raster.R</h2>
<div class="outline-text-2" id="text-43">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of<span style="color: #ff00ff;">=</span><span style="color: #daa520;">10</span>, max_out<span style="color: #ff00ff;">=</span><span style="color: #daa520;">32767</span>, 
                                    round_output<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, do_scaling<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>scale_raster<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">scale_layer</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!x@data@haveminmax<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span>no stored minimum and maximum values <span style="color: #ff00ff;">-</span> running setMinMax<span style="color: #20b2aa;">)</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">setMinMax</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    layer_max <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">minValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">maxValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))))</span>
    scale_factor <span style="color: #ff00ff;">&lt;-</span> power_of ^ <span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #20b2aa;">(</span>max_out <span style="color: #ff00ff;">/</span> layer_max, base<span style="color: #ff00ff;">=</span>power_of<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                  vals <span style="color: #ff00ff;">&lt;-</span> vals * scale_factor
                  <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>round_output<span style="color: #20b2aa;">)</span> vals <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  vals
                  <span style="color: #20b2aa;">})</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>scale_factor<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">scale_stack_or_brick</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    unscaled_layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        scale_outputs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unscaled_layer<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                 .combine<span style="color: #ff00ff;">=</span>addLayer, .multicombine<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                                 .init<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>, .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc<span style="color: #20b2aa;">)</span>,
                                 .export<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>scale_layer<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
            scale_output <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>unscaled_layer, power_of, max_out, 
                                        round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        scale_outputs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unscaled_layer<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                 .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>raster, teamlucc<span style="color: #20b2aa;">)</span>,
                                 .export<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>scale_layer<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
            scale_output <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>unscaled_layer, power_of, max_out, 
                                        round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>scale_outputs<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>scale_outputs<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>RasterStack<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scale_stack_or_brick</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, 
                                    do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>RasterBrick<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">scale_stack_or_brick</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, 
                                    do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-44" class="outline-2">
<h2 id="sec-44"><span class="section-number-2">44</span> simplify_polygon.R</h2>
<div class="outline-text-2" id="text-44">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">nverts</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    n_verts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sapply</span><span style="color: #20b2aa;">(</span>poly_obj@polygons, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> 
                      <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>y@Polygons<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>@coords<span style="color: #20b2aa;">))[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>n_verts<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        n_verts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>


        n_verts <span style="color: #ff00ff;">&lt;-</span> n_verts <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>n_verts<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">simplify_polygon</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>poly_obj, max_vertices, maxit<span style="color: #ff00ff;">=</span><span style="color: #daa520;">100</span>, 
                             multiplier<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>.<span style="color: #daa520;">05</span>, initial_tolerance<span style="color: #ff00ff;">=</span>dynamic<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> SpatialPolygonsDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        poly_data <span style="color: #ff00ff;">&lt;-</span> poly_obj@data
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        poly_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    <span style="color: #20b2aa;">}</span>
    n_parts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sapply</span><span style="color: #20b2aa;">(</span>poly_obj@polygons, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>n_parts<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>poly_obj contains more than one polygon<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_parts <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>poly_obj polygon is a multipart polygon<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>initial_tolerance <span style="color: #ff00ff;">==</span> dynamic<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        ext <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
        diag_seg_length <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">((</span>ext@xmax <span style="color: #ff00ff;">-</span> ext@xmin<span style="color: #20b2aa;">)</span>**<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">+</span>
                                <span style="color: #20b2aa;">(</span>ext@ymax <span style="color: #ff00ff;">-</span> ext@ymin<span style="color: #20b2aa;">)</span>**<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        tolerance <span style="color: #ff00ff;">&lt;-</span> diag_seg_length <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">100</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        tolerance <span style="color: #ff00ff;">&lt;-</span> initial_tolerance
    <span style="color: #20b2aa;">}</span>


    n_verts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nverts</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
    n <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #00ffff;">while</span> <span style="color: #20b2aa;">((</span>n_verts <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">&lt;</span> maxit<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>n_verts <span style="color: #ff00ff;">&gt;</span> max_vertices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        poly_obj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gSimplify</span><span style="color: #20b2aa;">(</span>poly_obj, tol<span style="color: #ff00ff;">=</span>tolerance<span style="color: #20b2aa;">)</span>
        n_verts <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">nverts</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
        tolerance <span style="color: #ff00ff;">&lt;-</span> tolerance * multiplier 
        n <span style="color: #ff00ff;">&lt;-</span> n <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">==</span> maxit<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Reached maximum <span style="color: #ff6347;">iterations</span> <span style="color: #20b2aa;">(</span>, maxit, <span style="color: #20b2aa;">)</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_verts <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Simplified polygon has no vertices.<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>n_verts <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Simplified polygon has only, n_verts, vertices.<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>poly_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        poly_obj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>poly_obj, data<span style="color: #ff00ff;">=</span>poly_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-45" class="outline-2">
<h2 id="sec-45"><span class="section-number-2">45</span> split_classes.R</h2>
<div class="outline-text-2" id="text-45">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">split_classes</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>train_data, split_levels, verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    y_reclass <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">vector</span><span style="color: #20b2aa;">(</span>numeric, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>split_levels<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        split_levels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>train_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>level <span style="color: #00ffff;">in</span> split_levels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        level_ind <span style="color: #ff00ff;">&lt;-</span> train_data@y <span style="color: #ff00ff;">==</span> level
        model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">Mclust</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">[</span>level_ind, <span style="color: #20b2aa;">])</span>
        y_reclass<span style="color: #20b2aa;">[</span>level_ind<span style="color: #20b2aa;">]</span>  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>train_data@y<span style="color: #20b2aa;">[</span>level_ind<span style="color: #20b2aa;">]</span>, 
                                       model$classification, sep<span style="color: #ff00ff;">=</span>_clust<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>level, split into, model$g, classes<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    y <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>y_reclass<span style="color: #20b2aa;">)</span>
    reclass_mat <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>split_name<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    reclass_mat$split_id <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span>reclass_mat$split_name<span style="color: #20b2aa;">)</span>
    reclass_mat$name <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>_clust<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*$, , reclass_mat$split_name<span style="color: #20b2aa;">)</span>
    reclass_mat$id <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>reclass_mat$name, <span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>reclass_mat$name<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>reclass_mat<span style="color: #ff00ff;">=</span>reclass_mat, y<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>y_reclass<span style="color: #20b2aa;">)))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-46" class="outline-2">
<h2 id="sec-46"><span class="section-number-2">46</span> SVIs.R</h2>
<div class="outline-text-2" id="text-46">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>NDVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">NDVI_calc</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">-</span> red<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">+</span> red<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>numeric, nir<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>matrix, nir<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>RasterLayer, nir<span style="color: #ff00ff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>red, nir, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> , ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>EVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">EVI_calc</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>.<span style="color: #daa520;">5</span>*<span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">-</span> red<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span> <span style="color: #ff00ff;">+</span> nir <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">6</span>*red <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">7</span>.<span style="color: #daa520;">5</span>*blue<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>numeric, red<span style="color: #ff00ff;">=</span>numeric, nir<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>matrix, red<span style="color: #ff00ff;">=</span>matrix, nir<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>RasterLayer, red<span style="color: #ff00ff;">=</span>RasterLayer, 
                           nir<span style="color: #ff00ff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>blue, red, nir, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">MSAVI2_calc</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>*nir <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span> <span style="color: #ff00ff;">-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">2</span>*nir <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>^<span style="color: #daa520;">2</span> <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">8</span>*<span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">-</span> red<span style="color: #20b2aa;">)))</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>numeric, nir<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>matrix, nir<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #ff00ff;">=</span>RasterLayer, nir<span style="color: #ff00ff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret  <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>red, nir, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> , ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>ARVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">ARVI_calc</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">2</span>*red <span style="color: #ff00ff;">-</span> blue<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">2</span>*red <span style="color: #ff00ff;">-</span> blue<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>numeric, red<span style="color: #ff00ff;">=</span>numeric, nir<span style="color: #ff00ff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>matrix, red<span style="color: #ff00ff;">=</span>matrix, nir<span style="color: #ff00ff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #ff00ff;">=</span>RasterLayer, red<span style="color: #ff00ff;">=</span>RasterLayer, 
                            nir<span style="color: #ff00ff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>blue, red, nir, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-47" class="outline-2">
<h2 id="sec-47"><span class="section-number-2">47</span> teamlucc-package.R</h2>
<div class="outline-text-2" id="text-47">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #daa520;">NULL</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-48" class="outline-2">
<h2 id="sec-48"><span class="section-number-2">48</span> threshold.R</h2>
<div class="outline-text-2" id="text-48">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">threshold</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, method<span style="color: #ff00ff;">=</span>huang, n_bin<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1000</span>, maxpixels<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span>e<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>huang<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, maxpixels, useGDAL<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, asRaster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">setMinMax</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    mins <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">minValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    maxs <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">maxValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    bys <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>maxs <span style="color: #ff00ff;">-</span> mins<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>n_bin<span style="color: #20b2aa;">)</span>
    bandnum<span style="color: #ff00ff;">=</span>minval<span style="color: #ff00ff;">=</span>maxval<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
    thresholds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>bandnum<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>, minval<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mins<span style="color: #20b2aa;">)</span>, 
                          maxval<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>maxs<span style="color: #20b2aa;">)</span>, by<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>bys<span style="color: #20b2aa;">)</span>,
                          .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc<span style="color: #20b2aa;">)</span>,
                          .combine<span style="color: #ff00ff;">=</span>c<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
        image_hist <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">hist</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>bandnum<span style="color: #20b2aa;">]]</span>, breaks<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>minval, maxval<span style="color: #ff00ff;">+</span>by, by<span style="color: #ff00ff;">=</span>by<span style="color: #20b2aa;">)</span>, 
                           plot<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, maxpixels<span style="color: #ff00ff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
        threshold_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">threshold_Huang</span><span style="color: #20b2aa;">(</span>image_hist$counts<span style="color: #20b2aa;">)</span>
        image_hist$breaks<span style="color: #20b2aa;">[</span>threshold_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>thresholds<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-49" class="outline-2">
<h2 id="sec-49"><span class="section-number-2">49</span> topocorr_samp.R</h2>
<div class="outline-text-2" id="text-49">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">.calc_IL_vector</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    IL <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * 
        <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">-</span> aspect<span style="color: #20b2aa;">)</span>
    IL<span style="color: #20b2aa;">[</span>IL <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> IL.epsilon
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_IL</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>slope, aspect,
            fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>slope_vals, aspect_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">.calc_IL_vector</span><span style="color: #20b2aa;">(</span>slope_vals, aspect_vals, sunzenith, sunazimuth, 
                               IL.epsilon<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">})</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">topocorr_samp</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth, method<span style="color: #ff00ff;">=</span>cosine, 
                          na.value<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NA</span>, IL.epsilon<span style="color: #ff00ff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span>,
                          sampleindices<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>
    sunzenith <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #ff00ff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    x<span style="color: #20b2aa;">[</span>x <span style="color: #ff00ff;">==</span> na.value<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    IL <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">.calc_IL</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rm</span><span style="color: #20b2aa;">(</span>aspect, sunazimuth<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>minnaert, minslope, 
                                                   ccorrection<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>sampleindices are not used when method is <span style="color: #00ff00;">", method,</span>
<span style="color: #00ff00;">                       "</span>. Ignoring sampleindices.<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    METHODS <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>cosine, improvedcosine, minnaert, minslope, 
                 ccorrection, gamma, SCS, illumination<span style="color: #20b2aa;">)</span>
    method <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">pmatch</span><span style="color: #20b2aa;">(</span>method, METHODS<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>method<span style="color: #20b2aa;">))</span> 
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>invalid method<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> 
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>ambiguous method<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">){</span>

        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>IL<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        ILmean <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>IL, stat<span style="color: #ff00ff;">=</span>mean, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>x * <span style="color: #20b2aa;">(</span>ILmean <span style="color: #ff00ff;">-</span> IL<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>ILmean<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        targetslope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #ff00ff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #ff00ff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>



            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> 
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span>IL<span style="color: #20b2aa;">)</span> ^ K
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>



        targetslope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #ff00ff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">/</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span>, 
                                x<span style="color: #ff00ff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>


            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> 
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)))</span> ^ K
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            band.lm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span> ~ IL<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">])</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            band.lm <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        C <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span><span style="color: #ff00ff;">/</span><span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> C<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #ff00ff;">+</span> C<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>


        viewterrain <span style="color: #ff00ff;">&lt;-</span> pi<span style="color: #ff00ff;">/</span><span style="color: #daa520;">2</span> <span style="color: #ff00ff;">-</span> slope
        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>pi <span style="color: #ff00ff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>viewterrain<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        xout <span style="color: #ff00ff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span><span style="color: #ff00ff;">/</span>IL
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        xout <span style="color: #ff00ff;">&lt;-</span> IL
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span><span style="color: #20b2aa;">(</span>method !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> 
        xout<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span> <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>slope <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        xout <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>xout, fun<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #ff00ff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                     <span style="color: #20b2aa;">})</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>xout<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-50" class="outline-2">
<h2 id="sec-50"><span class="section-number-2">50</span> topographic_corr.R</h2>
<div class="outline-text-2" id="text-50">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">topographic_corr</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, slopeaspect, sunelev, sunazimuth, 
                             method<span style="color: #ff00ff;">=</span>minnaert_full, sampleindices<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                             scale_factor<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span>, asinteger<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, DN_min<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, 
                             DN_max<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x must be a Raster* object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterBrick, RasterStack<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>slopeaspect must be a RasterBrick or RasterStack object<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    slope <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    aspect <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #ff00ff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>

    uncorr_layer<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>
    was_rasterlayer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> RasterLayer

    x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    corr_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>uncorr_layer<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, .combine<span style="color: #ff00ff;">=</span>addLayer, 
                        .multicombine<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, .init<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>, 
                        .packages<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>teamlucc, rgdal<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">%</span>dopar<span style="color: #ff00ff;">%</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #ff00ff;">==</span> minnaert_full<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            minnaert_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">minnaert_samp</span><span style="color: #20b2aa;">(</span>uncorr_layer, slope, aspect, 
                                           sunelev<span style="color: #ff00ff;">=</span>sunelev, 
                                           sunazimuth<span style="color: #ff00ff;">=</span>sunazimuth, 
                                           sampleindices<span style="color: #ff00ff;">=</span>sampleindices, 
                                           DN_min<span style="color: #ff00ff;">=</span>DN_min, DN_max<span style="color: #ff00ff;">=</span>DN_max, ...<span style="color: #20b2aa;">)</span>
            corr_layer <span style="color: #ff00ff;">&lt;-</span> minnaert_data$minnaert
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            corr_layer <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">topocorr_samp</span><span style="color: #20b2aa;">(</span>uncorr_layer, slope, aspect, 
                                        sunelev<span style="color: #ff00ff;">=</span>sunelev, sunazimuth<span style="color: #ff00ff;">=</span>sunazimuth, 
                                        method<span style="color: #ff00ff;">=</span>method, 
                                        sampleindices<span style="color: #ff00ff;">=</span>sampleindices,
                                        DN_min<span style="color: #ff00ff;">=</span>DN_min, DN_max<span style="color: #ff00ff;">=</span>DN_max, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>was_rasterlayer<span style="color: #20b2aa;">)</span> corr_img <span style="color: #ff00ff;">&lt;-</span> corr_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, tc<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>scale_factor !<span style="color: #ff00ff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        corr_img <span style="color: #ff00ff;">&lt;-</span> corr_img * scale_factor
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>asinteger<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        corr_img <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-51" class="outline-2">
<h2 id="sec-51"><span class="section-number-2">51</span> tpa2df.R</h2>
<div class="outline-text-2" id="text-51">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">tpa2df</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">([</span>.<span style="color: #20b2aa;">]</span>tpa$, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a .tpa file<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>max_num_seasons<span style="color: #20b2aa;">)</span> || max_num_seasons <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify maximum number of seasons represented <span style="color: #00ffff;">in</span> tpa file<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    NUM_SEASONAL_INDICATORS <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">11</span>


    LINE_HEADER_SIZE <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">3</span>
    tpa_file_obj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>x, rb<span style="color: #20b2aa;">)</span>
    raw_vector <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>tpa_file_obj, n<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>$size, <span style="color: #ff6347;">raw</span><span style="color: #20b2aa;">())</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>tpa_file_obj<span style="color: #20b2aa;">)</span>


    offset <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    raw_vec_length <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>raw_vector<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">offset_readBin</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>raw_vec, what, n<span style="color: #ff00ff;">=</span>n, size<span style="color: #ff00ff;">=</span>size, increment_offset<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bin_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>raw_vec<span style="color: #20b2aa;">[</span>offset:<span style="color: #20b2aa;">(</span>n * size <span style="color: #ff00ff;">+</span> offset<span style="color: #20b2aa;">)]</span>, what, n, size, ...<span style="color: #20b2aa;">)</span>

        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>increment_offset<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span><span style="color: #ff6347;">assign</span><span style="color: #20b2aa;">(</span>offset, offset <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>size*n<span style="color: #20b2aa;">)</span>, inherits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)}</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>bin_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    file_header <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #ff00ff;">=</span><span style="color: #daa520;">6</span>, size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    num_years <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    rowstart <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    rowstop <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span>
    colstart <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span>
    colstop <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">]</span>
    num_rows <span style="color: #ff00ff;">&lt;-</span> rowstop <span style="color: #ff00ff;">-</span> rowstart <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    num_cols <span style="color: #ff00ff;">&lt;-</span> colstop <span style="color: #ff00ff;">-</span> colstart <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    num_pixels <span style="color: #ff00ff;">&lt;-</span> num_cols * num_rows
    tpa_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>nrow<span style="color: #ff00ff;">=</span>num_pixels*max_num_seasons,
                       ncol<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">(</span>LINE_HEADER_SIZE <span style="color: #ff00ff;">+</span> NUM_SEASONAL_INDICATORS<span style="color: #20b2aa;">))</span>

    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:num_pixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        line_header <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #ff00ff;">=</span><span style="color: #daa520;">3</span>, size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>

        num_seasons <span style="color: #ff00ff;">&lt;-</span> line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>num_seasons <span style="color: #ff00ff;">&gt;</span> max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pixel, pixelnum, has, num_seasons,
                       seasons, but max_num_seasons was set to , max_num_seasons, 
                       seasons<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>num_seasons <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

            <span style="color: #00ffff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>seasonnum <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

            tpa_data_row <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #ff00ff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>*num_seasons <span style="color: #ff00ff;">+</span> seasonnum
            line_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">numeric</span><span style="color: #20b2aa;">()</span>, 
                                        n<span style="color: #ff00ff;">=</span>NUM_SEASONAL_INDICATORS, size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
            tpa_data<span style="color: #20b2aa;">[</span>tpa_data_row, <span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                          seasonnum, line_data<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    tpa_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span>
    tpa_data <span style="color: #ff00ff;">&lt;-</span> tpa_data<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">))</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">))</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>row, col, season, start, end, length,
                         base_value, peak_time, peak_value, amp, left_deriv,
                         right_deriv, large_integ, small_integ<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-52" class="outline-2">
<h2 id="sec-52"><span class="section-number-2">52</span> tpadf2raster.R</h2>
<div class="outline-text-2" id="text-52">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">tpadf2raster</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, base_image, variable<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a tpa data.frame<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a valid base image raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    var_col <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>^, variable, $, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>var_col<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>variable, not found <span style="color: #00ffff;">in</span> tpa dataframe<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    base_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">2</span>
    seasons <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$season<span style="color: #20b2aa;">))</span>
    out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>season <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$season<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        season_data <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$season <span style="color: #ff00ff;">==</span> season, <span style="color: #20b2aa;">]</span>
        data_matrix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span>
        vector_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> * season_data$col<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> 
            <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> season_data$row<span style="color: #20b2aa;">)</span>
        data_matrix<span style="color: #20b2aa;">[</span>vector_indices<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> season_data<span style="color: #20b2aa;">[</span>, var_col<span style="color: #20b2aa;">]</span>
        out_raster <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>data_matrix, template<span style="color: #ff00ff;">=</span>base_image<span style="color: #20b2aa;">)</span>
        out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out_rasters, out_raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>season_, seasons<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-53" class="outline-2">
<h2 id="sec-53"><span class="section-number-2">53</span> track_time.R</h2>
<div class="outline-text-2" id="text-53">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span>Track_time, slots<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>timers<span style="color: #ff00ff;">=</span>data.frame, notify<span style="color: #ff00ff;">=</span><span style="color: #00ffff;">function</span><span style="color: #20b2aa;">)</span>,
    prototype<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>timers<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #ff00ff;">=</span>Default, starttime<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">())</span>, 
                   notify<span style="color: #ff00ff;">=</span>print<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">Track_time</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>notify<span style="color: #ff00ff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>Track_time,
               timers<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #ff00ff;">=</span>Default, starttime<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">())</span>,
               notify<span style="color: #ff00ff;">=</span>notify<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">print.Track_time</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    timers <span style="color: #ff00ff;">&lt;-</span> x@timers
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>label <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> timers$label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", label, "</span>,  timer not defined<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            timers <span style="color: #ff00ff;">&lt;-</span> timers<span style="color: #20b2aa;">[</span>timers$label <span style="color: #ff00ff;">==</span> label, <span style="color: #20b2aa;">]</span> 
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>timers<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
       x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>timers$label<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, timer:,
                <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">-</span> timers$starttime<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                elapsed<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #ff00ff;">=</span>Track_time<span style="color: #20b2aa;">)</span>, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #ff6347;">.start_timer</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>label <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> x@timers$label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", label, "</span>,  timer already defined<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        x@timers <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@timers, <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #ff00ff;">=</span>label, starttime<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()))</span>
        x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #ff00ff;">==</span> label<span style="color: #20b2aa;">]</span>, : started <span style="color: #00ff00;">", label, "</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #ff00ff;">==</span> Default<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>
        x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #ff00ff;">==</span> Default<span style="color: #20b2aa;">]</span>, : started<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>start_timer<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>Track_time<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.start_timer</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>Track_time, label<span style="color: #ff00ff;">=</span>character<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.start_timer</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">.stop_timer</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #ff00ff;">=</span>Default<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>label <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> x@timers$label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">", label, "</span>,  timer not defined<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    elapsed <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span> <span style="color: #ff00ff;">-</span> x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #ff00ff;">==</span> label<span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>label <span style="color: #ff00ff;">==</span> Default<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>

        x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #ff00ff;">==</span> Default<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        x@timers <span style="color: #ff00ff;">&lt;-</span> x@timers<span style="color: #20b2aa;">[</span>x@timers$label !<span style="color: #ff00ff;">=</span> label, <span style="color: #20b2aa;">]</span> 
    <span style="color: #20b2aa;">}</span>
    x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>, : finished <span style="color: #00ff00;">", label, "</span> <span style="color: #20b2aa;">(</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>elapsed, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>, elapsed<span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #ff00ff;">=</span>Default<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>stop_timer<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>Track_time<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.stop_timer</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>Track_time, label<span style="color: #ff00ff;">=</span>character<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.stop_timer</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-54" class="outline-2">
<h2 id="sec-54"><span class="section-number-2">54</span> train_classifier.R</h2>
<div class="outline-text-2" id="text-54">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">train_classifier</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>train_data, type<span style="color: #ff00ff;">=</span>rf, use_training_flag<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>, 
                             train_control<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, tune_grid<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>,
                             use_rfe<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, factors<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>svm, rf<span style="color: #20b2aa;">))</span>
    predictor_names <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">)</span>

    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">==</span> <span style="color: #daa520;">0</span> || <span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">%</span><span style="color: #00ffff;">in</span><span style="color: #ff00ff;">%</span> predictor_names<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)))</span> <span style="color: #ff00ff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>factor_var <span style="color: #00ffff;">in</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        pred_index <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>predictor_names <span style="color: #ff00ff;">==</span> factor_var<span style="color: #20b2aa;">)</span>
        train_data@x<span style="color: #20b2aa;">[</span>, pred_index<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">[</span>, pred_index<span style="color: #20b2aa;">]</span>, 
                                             levels<span style="color: #ff00ff;">=</span>factors<span style="color: #20b2aa;">[[</span>factor_var<span style="color: #20b2aa;">]])</span>
    <span style="color: #20b2aa;">}</span>


    model_formula <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">formula</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>y ~, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>predictor_names, collapse<span style="color: #ff00ff;">=</span> <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">)))</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>use_rfe<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>recursive feature extraction not yet supported<span style="color: #20b2aa;">)</span>


        svmFuncs <span style="color: #ff00ff;">&lt;-</span> caretFuncs

        normalization <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">preProcess</span><span style="color: #20b2aa;">(</span>train_data@x, method<span style="color: #ff00ff;">=</span>range<span style="color: #20b2aa;">)</span>
        scaled_predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>normalization, train_data@x<span style="color: #20b2aa;">)</span>
        scaled_predictors <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>scaled_predictors<span style="color: #20b2aa;">)</span>
        subsets <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>predictor_names<span style="color: #20b2aa;">))</span>
        ctrl <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rfeControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #ff00ff;">=</span>repeatedcv,
                           repeats<span style="color: #ff00ff;">=</span><span style="color: #daa520;">5</span>,
                           verbose<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span>,
                           functions<span style="color: #ff00ff;">=</span>svmFuncs<span style="color: #20b2aa;">)</span>


        rfe_x <span style="color: #ff00ff;">&lt;-</span> scaled_predictors<span style="color: #20b2aa;">[</span>train_data@training_flag, <span style="color: #20b2aa;">]</span>
        rfe_y <span style="color: #ff00ff;">&lt;-</span> train_data@y<span style="color: #20b2aa;">[</span>train_data@training_flag, <span style="color: #20b2aa;">]</span>
        rfe_res <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">rfe</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>rfe_x, rfe_y,
                       sizes<span style="color: #ff00ff;">=</span>subsets,
                       metric<span style="color: #ff00ff;">=</span>ROC,
                       rfeControl<span style="color: #ff00ff;">=</span>ctrl,
                       method<span style="color: #ff00ff;">=</span>svmRadial,
                       trControl<span style="color: #ff00ff;">=</span>train_control,
                       tuneGrid<span style="color: #ff00ff;">=</span>tune_grid<span style="color: #20b2aa;">)</span>

    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        rfe_res <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    <span style="color: #20b2aa;">}</span>
    train_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>y<span style="color: #ff00ff;">=</span>train_data@y,
                        train_data@x,
                        training_flag<span style="color: #ff00ff;">=</span>train_data@training_flag,
                        poly_src<span style="color: #ff00ff;">=</span>train_data@pixel_src$src,
                        poly_ID<span style="color: #ff00ff;">=</span>train_data@pixel_src$ID<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">==</span> rf<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>train_control<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            train_control <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">trainControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #ff00ff;">=</span>oob, classProbs<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">train</span><span style="color: #20b2aa;">(</span>model_formula, data<span style="color: #ff00ff;">=</span>train_data, method<span style="color: #ff00ff;">=</span>rf,
                       subset<span style="color: #ff00ff;">=</span>train_data$training_flag,
                       trControl<span style="color: #ff00ff;">=</span>train_control, tuneGrid<span style="color: #ff00ff;">=</span>tune_grid, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #ff00ff;">==</span> svm<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>train_control<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            train_control <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">trainControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #ff00ff;">=</span>cv, classProbs<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        model <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">train</span><span style="color: #20b2aa;">(</span>model_formula, data<span style="color: #ff00ff;">=</span>train_data, method<span style="color: #ff00ff;">=</span>svmRadial,
                       preProc<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>center, scale<span style="color: #20b2aa;">)</span>, subset<span style="color: #ff00ff;">=</span>train_data$training_flag,
                       trControl<span style="color: #ff00ff;">=</span>train_control, tuneGrid<span style="color: #ff00ff;">=</span>tune_grid, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>

        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>model type not recognized<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-55" class="outline-2">
<h2 id="sec-55"><span class="section-number-2">55</span> tts2df.R</h2>
<div class="outline-text-2" id="text-55">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">tts2df</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">([</span>.<span style="color: #20b2aa;">]</span>tts$, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a .tts file<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>


    LINE_HEADER_SIZE <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">2</span>
    tts_file_obj <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>x, rb<span style="color: #20b2aa;">)</span>
    raw_vector <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>tts_file_obj, n<span style="color: #ff00ff;">=</span><span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>$size, <span style="color: #ff6347;">raw</span><span style="color: #20b2aa;">())</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>tts_file_obj<span style="color: #20b2aa;">)</span>


    offset <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">1</span>
    raw_vec_length <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>raw_vector<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">offset_readBin</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>raw_vec, what, n<span style="color: #ff00ff;">=</span>n, size<span style="color: #ff00ff;">=</span>size, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bin_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>raw_vec<span style="color: #20b2aa;">[</span>offset:<span style="color: #20b2aa;">(</span>n * size <span style="color: #ff00ff;">+</span> offset<span style="color: #20b2aa;">)]</span>, what, n, size, ...<span style="color: #20b2aa;">)</span>

        <span style="color: #ff6347;">assign</span><span style="color: #20b2aa;">(</span>offset, offset <span style="color: #ff00ff;">+</span> <span style="color: #20b2aa;">(</span>size*n<span style="color: #20b2aa;">)</span>, inherits<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>bin_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    file_header <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #ff00ff;">=</span><span style="color: #daa520;">6</span>, size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    num_years <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    n_pts_per_year <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    rowstart <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    rowstop <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span>
    colstart <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span>
    colstop <span style="color: #ff00ff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">]</span>
    num_pixels <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span>colstop <span style="color: #ff00ff;">-</span> colstart<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>rowstop <span style="color: #ff00ff;">-</span> rowstart<span style="color: #20b2aa;">)</span>

    tts_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>nrow<span style="color: #ff00ff;">=</span>num_pixels, ncol<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span> <span style="color: #ff00ff;">+</span> n_pts_per_year * num_years<span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:num_pixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        line_header <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #ff00ff;">=</span><span style="color: #daa520;">2</span>, size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>

        tts_data<span style="color: #20b2aa;">[</span>pixelnum, <span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                  <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">numeric</span><span style="color: #20b2aa;">()</span>, 
                                                 n<span style="color: #ff00ff;">=</span>n_pts_per_year*num_years, 
                                                 size<span style="color: #ff00ff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    tts_data <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>row, col,
                         <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>t, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, n_pts_per_year*num_years<span style="color: #20b2aa;">)</span>, sep<span style="color: #ff00ff;">=</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-56" class="outline-2">
<h2 id="sec-56"><span class="section-number-2">56</span> ttsdf2raster.R</h2>
<div class="outline-text-2" id="text-56">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">ttsdf2raster</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, base_image<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a tts data.frame<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>must specify a valid base image raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    t_cols <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>^t<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">1</span>,<span style="color: #daa520;">4</span><span style="color: #20b2aa;">}</span>$, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    base_image <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>
    out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>t_col <span style="color: #00ffff;">in</span> t_cols<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        this_time_data <span style="color: #ff00ff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>, t_col<span style="color: #20b2aa;">]</span>
        data_matrix <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span>
        vector_indices <span style="color: #ff00ff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> * x$col<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> 
            <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">-</span> x$row<span style="color: #20b2aa;">)</span>
        data_matrix<span style="color: #20b2aa;">[</span>vector_indices<span style="color: #20b2aa;">]</span> <span style="color: #ff00ff;">&lt;-</span> this_time_data
        out_raster <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>data_matrix, template<span style="color: #ff00ff;">=</span>base_image<span style="color: #20b2aa;">)</span>
        out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out_rasters, out_raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_rasters <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>t_cols<span style="color: #20b2aa;">])</span>
    <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-57" class="outline-2">
<h2 id="sec-57"><span class="section-number-2">57</span> unstack_ledapscdr.R</h2>
<div class="outline-text-2" id="text-57">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">unstack_ledapscdr</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, output_folder<span style="color: #ff00ff;">=</span><span style="color: #daa520;">NULL</span>, overwrite<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span>, 
                              rmhdf<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        output_folder <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>f, x<span style="color: #20b2aa;">))</span> | <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> !<span style="color: #ff00ff;">=</span> .hdf<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>x must be an existing file ending <span style="color: #00ffff;">in</span> <span style="color: #00ff00;">".hdf"</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">-</span>d, output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>output_folder must be a directory<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_basename <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    sds <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">get_subdatasets</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    loc <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">regexpr</span><span style="color: #20b2aa;">([</span>a<span style="color: #ff00ff;">-</span>zA<span style="color: #ff00ff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #ff00ff;">-</span><span style="color: #daa520;">9</span>_<span style="color: #ff00ff;">-</span><span style="color: #20b2aa;">]</span>*$, sds<span style="color: #20b2aa;">)</span>
    <span style="color: #00ffff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sds<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        start_char <span style="color: #ff00ff;">&lt;-</span> loc<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>
        stop_char <span style="color: #ff00ff;">&lt;-</span> start_char <span style="color: #ff00ff;">+</span> <span style="color: #ff6347;">attr</span><span style="color: #20b2aa;">(</span>loc, match.length<span style="color: #20b2aa;">)[</span>n<span style="color: #20b2aa;">]</span>
        band_name <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sds<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, start_char, stop_char<span style="color: #20b2aa;">)</span>
        this_out <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_folder, out_basename<span style="color: #20b2aa;">)</span>, _, band_name, .tif<span style="color: #20b2aa;">)</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>this_out<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span>this_out<span style="color: #20b2aa;">)</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, hdr<span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, hdr<span style="color: #20b2aa;">))</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, tif.aux.xml<span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, tif.aux.xml<span style="color: #20b2aa;">))</span>
                <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, tif.enp<span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, tif.enp<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00ffff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>this_out, already exists <span style="color: #ff00ff;">-</span> skipping file<span style="color: #20b2aa;">))</span>
                <span style="color: #00ffff;">next</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        out_rast <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">gdal_translate</span><span style="color: #20b2aa;">(</span>x, of<span style="color: #ff00ff;">=</span>GTiff, sd_index<span style="color: #ff00ff;">=</span>n, this_out, 
                                   outRaster<span style="color: #ff00ff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>rmhdf<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, hdf<span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, hdf<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, hdr<span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, hdr<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, .hdf.hdr<span style="color: #20b2aa;">)))</span>
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, .hdf.hdr<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, txt<span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, txt<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-58" class="outline-2">
<h2 id="sec-58"><span class="section-number-2">58</span> utm_zone.R</h2>
<div class="outline-text-2" id="text-58">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #ff00ff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>utm_zone<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">utm_zone_calc</span> <span style="color: #ff00ff;">&lt;-</span> <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">180</span> || x <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>longitude must be between <span style="color: #ff00ff;">-</span><span style="color: #daa520;">180</span> and <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #ff00ff;">&lt;</span> <span style="color: #ff00ff;">-</span><span style="color: #daa520;">90</span> || y <span style="color: #ff00ff;">&gt;</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">stop</span><span style="color: #20b2aa;">(</span>latitude must be between <span style="color: #ff00ff;">-</span><span style="color: #daa520;">90</span> and <span style="color: #daa520;">90</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">((</span>x <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span><span style="color: #ff00ff;">/</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">56</span>.<span style="color: #daa520;">0</span> &amp;&amp; y <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">64</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">3</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">12</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">32</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">72</span>.<span style="color: #daa520;">0</span> &amp;&amp; y <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">84</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">9</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">31</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">9</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">21</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">33</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">21</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">33</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">35</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">33</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #ff00ff;">&lt;</span> <span style="color: #daa520;">42</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #ff00ff;">&lt;-</span> <span style="color: #daa520;">37</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #ff00ff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ns <span style="color: #ff00ff;">&lt;-</span> N
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        ns <span style="color: #ff00ff;">&lt;-</span> S
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">if</span> <span style="color: #20b2aa;">(</span>ns <span style="color: #ff00ff;">==</span> N<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">+</span>init<span style="color: #ff00ff;">=</span>epsg:<span style="color: #daa520;">326</span>, <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">02</span>i, zone_num<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">+</span>init<span style="color: #ff00ff;">=</span>epsg:<span style="color: #daa520;">327</span>, <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">%</span><span style="color: #daa520;">02</span>i, zone_num<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #00ffff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>zone_num, ns<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>numeric, numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone_calc</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #ff00ff;">=</span>Spatial, y<span style="color: #ff00ff;">=</span>missing<span style="color: #20b2aa;">)</span>,
    <span style="color: #00ffff;">function</span><span style="color: #20b2aa;">(</span>x, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">+</span>init<span style="color: #ff00ff;">=</span>epsg:<span style="color: #daa520;">4236</span><span style="color: #20b2aa;">))</span>
        centroid <span style="color: #ff00ff;">&lt;-</span> <span style="color: #ff6347;">coordinates</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gCentroid</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
        <span style="color: #00ffff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone_calc</span><span style="color: #20b2aa;">(</span>centroid<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, centroid<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: tian</p>
<p class="date">Created: 2014-09-15 Mon 20:58</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.7c)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
