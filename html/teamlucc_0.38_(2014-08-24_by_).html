<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>teamlucc_0.38_(2014-08-24_by_)</title>
<!-- 2014-09-22 Mon 17:24 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="tian" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">teamlucc_0.38_(2014-08-24_by_)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. accuracy.R</a></li>
<li><a href="#sec-2">2. apply<sub>windowed</sub>.R</a></li>
<li><a href="#sec-3">3. auto<sub>calc</sub><sub>predictors</sub>.R</a></li>
<li><a href="#sec-4">4. auto<sub>chg</sub><sub>detect</sub>.R</a></li>
<li><a href="#sec-5">5. auto<sub>classify</sub>.R</a></li>
<li><a href="#sec-6">6. auto<sub>cloud</sub><sub>fill</sub>.R</a></li>
<li><a href="#sec-7">7. auto<sub>gap</sub><sub>fill</sub>.R</a></li>
<li><a href="#sec-8">8. auto<sub>normalize</sub>.R</a></li>
<li><a href="#sec-9">9. auto<sub>preprocess</sub><sub>landsat</sub>.R</a></li>
<li><a href="#sec-10">10. auto<sub>QA</sub><sub>stats</sub>.R</a></li>
<li><a href="#sec-11">11. auto<sub>setup</sub><sub>dem</sub>.R</a></li>
<li><a href="#sec-12">12. browse<sub>image</sub>.R</a></li>
<li><a href="#sec-13">13. chg<sub>dir</sub>.R</a></li>
<li><a href="#sec-14">14. chg<sub>mag</sub>.R</a></li>
<li><a href="#sec-15">15. chg<sub>traj</sub>.R</a></li>
<li><a href="#sec-16">16. chg<sub>traj</sub><sub>stats</sub>.R</a></li>
<li><a href="#sec-17">17. classify.R</a></li>
<li><a href="#sec-18">18. class<sub>statistics</sub>.R</a></li>
<li><a href="#sec-19">19. cloud<sub>remove</sub>.R</a></li>
<li><a href="#sec-20">20. color<sub>image</sub>.R</a></li>
<li><a href="#sec-21">21. compcont.R</a></li>
<li><a href="#sec-22">22. DFPS.R</a></li>
<li><a href="#sec-23">23. ee<sub>plot</sub>.R</a></li>
<li><a href="#sec-24">24. ee<sub>read</sub>.R</a></li>
<li><a href="#sec-25">25. espa<sub>download</sub>.R</a></li>
<li><a href="#sec-26">26. espa<sub>extract</sub>.R</a></li>
<li><a href="#sec-27">27. espa<sub>scenelist</sub>.R</a></li>
<li><a href="#sec-28">28. fill<sub>gaps</sub>.R</a></li>
<li><a href="#sec-29">29. get<sub>band</sub><sub>names</sub><sub>from</sub><sub>hdr</sub>.R</a></li>
<li><a href="#sec-30">30. get<sub>extent</sub><sub>polys</sub>.R</a></li>
<li><a href="#sec-31">31. get<sub>metadata</sub><sub>item</sub>.R</a></li>
<li><a href="#sec-32">32. gridsample.R</a></li>
<li><a href="#sec-33">33. linear<sub>stretch</sub>.R</a></li>
<li><a href="#sec-34">34. ls<sub>catalog</sub>.R</a></li>
<li><a href="#sec-35">35. match<sub>rasters</sub>.R</a></li>
<li><a href="#sec-36">36. minnaert<sub>samp</sub>.R</a></li>
<li><a href="#sec-37">37. normalize.R</a></li>
<li><a href="#sec-38">38. overlay<sub>poly</sub>.R</a></li>
<li><a href="#sec-39">39. pixel<sub>data</sub>.R</a></li>
<li><a href="#sec-40">40. proj4comp.R</a></li>
<li><a href="#sec-41">41. RcppExports.R</a></li>
<li><a href="#sec-42">42. sample<sub>raster</sub>.R</a></li>
<li><a href="#sec-43">43. scale<sub>raster</sub>.R</a></li>
<li><a href="#sec-44">44. simplify<sub>polygon</sub>.R</a></li>
<li><a href="#sec-45">45. split<sub>classes</sub>.R</a></li>
<li><a href="#sec-46">46. SVIs.R</a></li>
<li><a href="#sec-47">47. teamlucc-package.R</a></li>
<li><a href="#sec-48">48. threshold.R</a></li>
<li><a href="#sec-49">49. topocorr<sub>samp</sub>.R</a></li>
<li><a href="#sec-50">50. topographic<sub>corr</sub>.R</a></li>
<li><a href="#sec-51">51. tpa2df.R</a></li>
<li><a href="#sec-52">52. tpadf2raster.R</a></li>
<li><a href="#sec-53">53. track<sub>time</sub>.R</a></li>
<li><a href="#sec-54">54. train<sub>classifier</sub>.R</a></li>
<li><a href="#sec-55">55. tts2df.R</a></li>
<li><a href="#sec-56">56. ttsdf2raster.R</a></li>
<li><a href="#sec-57">57. unstack<sub>ledapscdr</sub>.R</a></li>
<li><a href="#sec-58">58. utm<sub>zone</sub>.R</a></li>
</ul>
</div>
</div>
<ul class="org-ul">
<li>Package: teamlucc
</li>
<li>Version: 0.38
</li>
<li>Date: 2014-08-24
</li>
<li>Title: TEAM land use and cover change data processing toolkit
</li>
<li>Authors@R: c(person(&ldquo;Alex&rdquo;, &ldquo;Zvoleff&rdquo;, email="azvoleff@conservation.org&rdquo;,
</li>
<li>role=c(&ldquo;aut&rdquo;, &ldquo;cre&rdquo;)), person(&ldquo;Sarah&rdquo;, &ldquo;Goslee&rdquo;, role = &ldquo;ctb&rdquo;),
</li>
<li>person(&ldquo;Xiaolin&rdquo;, &ldquo;Zhu&rdquo;, role = &ldquo;ctb&rdquo;))
</li>
<li>Maintainer: Alex Zvoleff &lt;azvoleff@conservation.org&gt;
</li>
<li>Depends:
</li>
<li>R (&gt;= 2.10.0),
</li>
<li>Rcpp (&gt;= 0.11.0),
</li>
<li>methods,
</li>
<li>raster (&gt;= 2.2-6)
</li>
<li>Imports:
</li>
<li>sp,
</li>
<li>foreach,
</li>
<li>iterators,
</li>
<li>glcm,
</li>
<li>wrspathrow,
</li>
<li>rgeos,
</li>
<li>rgdal,
</li>
<li>mgcv,
</li>
<li>dplyr,
</li>
<li>lmodel2,
</li>
<li>reshape2,
</li>
<li>ggplot2,
</li>
<li>stringr,
</li>
<li>kernlab,
</li>
<li>e1071,
</li>
<li>randomForest,
</li>
<li>SDMTools,
</li>
<li>grid,
</li>
<li>spatial.tools,
</li>
<li>RCurl,
</li>
<li>gdalUtils,
</li>
<li>caret,
</li>
<li>maptools,
</li>
<li>mclust,
</li>
<li>lubridate,
</li>
<li>XML
</li>
<li>Suggests:
</li>
<li>testthat,
</li>
<li>landsat
</li>
<li>LinkingTo: Rcpp, RcppArmadillo
</li>
<li>SystemRequirements: To perform gap filling of Landsat 7 SLC-off images or
</li>
<li>Landsat scenes with heavy clouds using the IDL code by Xiaolin Zhu at the
</li>
<li>Ohio State University requires licenses for both EXELIS IDL and ENVI, and
</li>
<li>ENVI version 5 or greater.
</li>
<li>Description: teamlucc is a set of routines to support analyzing land use and
</li>
<li>cover change (LUCC) in R. The package was designed to support analyzing
</li>
<li>LUCC in the Zone of Interaction (ZOIs) of monitoring sites in the Tropical
</li>
<li>Ecology Assessment and Monitoring (TEAM) Network.
</li>
<li>License: GPL (&gt;= 3)
</li>
<li>URL: <a href="https://www.azvoleff.com/teamlucc">https://www.azvoleff.com/teamlucc</a>
</li>
<li>BugReports: <a href="https://github.com/azvoleff/teamlucc/issues">https://github.com/azvoleff/teamlucc/issues</a>
</li>
<li>LazyData: true
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> accuracy.R</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> A class for representing accuracy assessment results</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@exportClass</span><span style="color: #00bfff;"> accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> accuracy-class</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> ct a simple sample contingency table</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> pop_ct a population contingency table (if \code{pop} was provided - </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> see \code{\link{accuracy}})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> Q quantity disagreement</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> A allocation disagreement</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> n_test the number of samples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> pop the population of each class as a numeric</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'accuracy'</span>, slots<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>ct<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'table'</span>, pop_ct<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'table'</span>, Q<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'numeric'</span>, 
                             A<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'numeric'</span>, n_test<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'numeric'</span>,
                             pop<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'numeric'</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> summary accuracy</span>
<span style="color: #ff6347;">summary.accuracy</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    obj <span style="color: #00ffff;">=</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'Q'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> object@Q
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'A'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> object@A
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'ct'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> object@ct
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'pop_ct'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> object@pop_ct
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_test'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> object@n_test
    margined_pop_ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>object@pop_ct<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'overall_acc'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> margined_pop_ct<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>margined_pop_ct<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>obj<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'summary.accuracy'</span>
    obj
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> print summary.accuracy</span>
<span style="color: #ff6347;">print.summary.accuracy</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Object of class '</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Testing samples:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_test'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Sample contingency table:\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'ct'</span><span style="color: #20b2aa;">]]))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Population contingency table:\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">.add_ct_margins</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'pop_ct'</span><span style="color: #20b2aa;">]]))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Overall accuracy:\t, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'overall_acc'</span><span style="color: #20b2aa;">]]</span>, digits<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, \n, sep <span style="color: #00ffff;">=</span> <span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Quantity disagreement:\t\t'</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'Q'</span><span style="color: #20b2aa;">]]</span>, digits<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\n'</span>, sep <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Allocation disagreement:\t'</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'A'</span><span style="color: #20b2aa;">]]</span>, digits<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\n'</span>, sep <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">invisible</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> print accuracy</span>
<span style="color: #ff6347;">print.accuracy</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #00ffff;">=</span>accuracy<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> A class for error adjusted class areas</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{adj_areas}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@exportClass</span><span style="color: #00bfff;"> error_adj_area</span>
<span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'error_adj_area'</span>, slots<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'matrix'</span><span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculated adjusted class areas for an image classification</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the adjusted areas of each class in an image after taking account </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of omission and commission errors. For unbiased adjustments, error rates </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> should be calculated using a population sample matrix (see </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{accuracy}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Standard errors for the adjusted areas are calculated as in Olofsson et al.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (</span><span style="color: #daa520;">2013</span><span style="color: #00bfff;">).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> adj_areas</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> an \code{accuracy} object or a list of populations as a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{numeric}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> missing, or a contingency table</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Olofsson, P., G. M. Foody, S. V. Stehman, and C. E. Woodcock.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">2013</span><span style="color: #00bfff;">. Making better use of accuracy data in land change studies: Estimating </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> accuracy and area and quantifying uncertainty using stratified estimation.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Remote Sensing of Environment </span><span style="color: #daa520;">129</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">122</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">131</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>adj_areas<span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> adj_areas</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> adj_areas,numeric,table-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>numeric, y<span style="color: #00ffff;">=</span>table<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    pop <span style="color: #00ffff;">&lt;-</span> x
    ct <span style="color: #00ffff;">&lt;-</span> y
    Wi <span style="color: #00ffff;">&lt;-</span> pop <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span>
    adj_area_est <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>Wi * <span style="color: #20b2aa;">(</span>ct <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate standard errors of the proportions</span>
    std_err_p <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>Wi^<span style="color: #daa520;">2</span> *
                              <span style="color: #20b2aa;">(((</span>ct <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>*<span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span> <span style="color: #00ffff;">-</span> ct <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">/</span>
                               <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Now calculate standard error of adjusted area estimate</span>
    std_err_area <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> * std_err_p
    adj_area_mat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>pop, adj_area_est, std_err_area, <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * std_err_area<span style="color: #20b2aa;">)</span>
    adj_area_mat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>adj_area_mat, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Mapped area'</span>, <span style="color: #00ff00;">'Adj. area'</span>, <span style="color: #00ff00;">'S.E.'</span>, 
                                     <span style="color: #00ff00;">'</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">.</span><span style="color: #daa520;">96</span><span style="color: #00ff00;"> * S.E.'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'error_adj_area'</span>, adj_area_mat<span style="color: #00ffff;">=</span>adj_area_mat<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> adj_areas</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> adj_areas,numeric,matrix-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>numeric, y<span style="color: #00ffff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> table
    <span style="color: #ff6347;">adj_areas</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> adj_areas</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> adj_areas,numeric,missing-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>adj_areas, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>accuracy, y<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'missing'</span><span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    pop <span style="color: #00ffff;">&lt;-</span> x@pop
    ct <span style="color: #00ffff;">&lt;-</span> x@ct
    <span style="color: #ff6347;">adj_areas</span><span style="color: #20b2aa;">(</span>pop, ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #00ffff;">=</span>error_adj_area<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Object of class: error_adj_area\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Accuracy-adjusted area table:\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object@adj_area_mat<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">plot.error_adj_area</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    classes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>x@adj_area_mat<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    areas <span style="color: #00ffff;">&lt;-</span> x@adj_area_mat<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    se <span style="color: #00ffff;">&lt;-</span> x@adj_area_mat<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    plt_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>classes, y<span style="color: #00ffff;">=</span>areas, se<span style="color: #00ffff;">=</span>se<span style="color: #20b2aa;">)</span>
    y <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span> <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Fix for R CMD check</span>
    <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>plt_data, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">geom_bar</span><span style="color: #20b2aa;">(</span>stat<span style="color: #00ffff;">=</span>identity<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> 
        <span style="color: #ff6347;">geom_errorbar</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>ymin<span style="color: #00ffff;">=</span>y <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * se, ymax<span style="color: #00ffff;">=</span>y <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>.<span style="color: #daa520;">96</span> * se<span style="color: #20b2aa;">)</span>, width<span style="color: #00ffff;">=</span>.<span style="color: #daa520;">25</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
        <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span>Class<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">ylab</span><span style="color: #20b2aa;">(</span>Area<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_pop_ct</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>ct, pop<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Below uses the notation of Pontius and Millones (</span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">)</span>
    nijsum <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, ncol<span style="color: #00ffff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>
    Ni <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>pop, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>, ncol<span style="color: #00ffff;">=</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">pop_ct is the population contigency table</span>
    pop_ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>ct <span style="color: #00ffff;">/</span> nijsum<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>Ni <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'table'</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_Q</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate quantity disagreement (Pontius and Millones, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, eqns </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">)</span>
    qg_mat <span style="color: #00ffff;">=</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>qg_mat<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_A</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate allocation disagreement (Pontius and Millones, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, eqns </span><span style="color: #daa520;">4</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">)</span>
    diag_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">diag</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    ag_mat <span style="color: #00ffff;">=</span> <span style="color: #daa520;">2</span> * <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> pop_ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span>,
                             <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> pop_ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">])</span>, <span style="color: #daa520;">1</span>, min<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ag_mat<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">Adds margins to contingency table</span>
<span style="color: #ff6347;">.add_ct_margins</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>ct, digits<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">For user's, producer's, and overall accuracy formulas, see Table </span>
    <span style="color: #00bfff;"># </span><span style="color: #daa520;">21</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> in Foody, G.M., Stehman, S.V., </span><span style="color: #daa520;">2009</span><span style="color: #00bfff;">. Accuracy Assessment, in: </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Warner, T.A., Nellis, M.D., Foody, G.M. (Eds.), The SAGE Handbook of </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Remote Sensing. SAGE.</span>
    diag_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">diag</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    users_acc <span style="color: #00ffff;">&lt;-</span> ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    prod_acc <span style="color: #00ffff;">&lt;-</span> ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    overall_acc <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">[</span>diag_indices<span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">addmargins</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]][</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> Total
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]][</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> Total
    ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>ct, Producers<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>users_acc, <span style="color: #daa520;">NA</span><span style="color: #20b2aa;">))</span>
    ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>ct, Users<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>prod_acc, <span style="color: #daa520;">NA</span>, overall_acc<span style="color: #20b2aa;">))</span>
    ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>ct, digits<span style="color: #00ffff;">=</span>digits<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>predicted<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>,
                         observed<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]])</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'table'</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate statistics summarizing classification accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates a contingency table and various statistics for use in image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classification accuracy assessment and map comparison. Contingency table </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> includes user's, producer's, and overall accuracies for an image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classification, and quantity disagreement \code{Q} and allocation </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> disagreement \code{A}. \code{Q} and \code{A} are calculated based on Pontius </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and Millones (</span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">). Standard errors for </span><span style="color: #daa520;">95</span><span style="color: #00bfff;"> percent confidence intervals for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the user's, producer's and overall accuracies are calculated as in Foody and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Stehman (</span><span style="color: #daa520;">2009</span><span style="color: #00bfff;">) Table </span><span style="color: #daa520;">21</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">. To avoid bias due to the use of a sample </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> contingency table, the contingency table will be converted to a population </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> contingency table if the variable 'pop' is provided. For an accuracy </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> assessment using testing data from a simple random sample, 'pop' does not </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> need to be provided (see Details).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{x} can be one of:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \enumerate{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A prediction model as output from one of the \code{teamlucc} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \code{classify} functions. If \code{x} is a model, and testing data </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   is included in the model, \code{pop} and \code{test_data} can both be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   missing, and accuracy will still run (though the output will in this case </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   be biased unless the testing data is from a simple random sample). If </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \code{x} is a \code{RasterLayer}, then \code{test_data} must be supplied.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A \code{RasterLayer} with a predicted map.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{test_data} can be one of:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \enumerate{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item \code{NULL}. If test_data is \code{NULL}, \code{accuracy} will try to use </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         testing data included in \code{x}. This will only work if \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         is a model of class \code{train} from the \code{caret} package, and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         if the model was run using the one of the \code{teamlucc} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         \code{classify} functions.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A \code{SpatialPolygonsDataFrame} object, in which case \code{accuracy} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         will extract the predicted classes within each polygon from \code{x}.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         This will only work if \code{x} is a \code{RasterLayer}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A \code{pixel_data} object, in which case \code{accuracy} will use the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         included \code{training_flag} indicator to separate testing and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         training data.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{pop} can be one of:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \enumerate{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item NULL, in which case the sample frequencies will be used as estimates </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         of the population frequencies of each class.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A list of length equal to the number of classes in the map giving </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         the total number of pixels in the population for each class.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   \item A predicted cover map from as a \code{RasterLayer}, from which the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         class frequencies will be tabulated and used as the population </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">         frequencies.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> either a classification model with a \code{predict} method or a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterLayer} (see Details)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">test_data</span><span style="color: #00bfff;"> a \code{link{pixel_data}} object, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{SpatialPolygonsDataFrame}, or NULL (see Details).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">pop</span><span style="color: #00bfff;"> A \code{RasterLayer}, \code{numeric} of length equal to the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> number of clasess, or NULL (see Details).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_col</span><span style="color: #00bfff;"> required if \code{test_data} is a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{SpatialPolygonsDataFrame}. Defines the name of the column containing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the observed cover class IDs</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">reclass_mat</span><span style="color: #00bfff;"> a reclassification matrix to be used in the case of a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> model fit by \code{classify} with the \code{do_split} option selected</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{\link{accuracy-class}} instance</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Pontius, R. G., and M. Millones. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Death to Kappa: birth of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> quantity disagreement and allocation disagreement for accuracy assessment.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> International Journal of Remote Sensing </span><span style="color: #daa520;">32</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">4407</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">4429</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Olofsson, P., G. M. Foody, S. V. Stehman, and C. E. Woodcock.  </span><span style="color: #daa520;">2013</span><span style="color: #00bfff;">. Making </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> better use of accuracy data in land change studies: Estimating accuracy and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> area and quantifying uncertainty using stratified estimation.  Remote </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sensing of Environment </span><span style="color: #daa520;">129</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">122</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">131</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Foody, G.M., Stehman, S.V., </span><span style="color: #daa520;">2009</span><span style="color: #00bfff;">. Accuracy Assessment, in: Warner, T.A., </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Nellis, M.D., Foody, G.M. (Eds.), The SAGE Handbook of Remote Sensing. SAGE.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                          training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> model &lt;- train_classifier(train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> accuracy(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_rfmodel)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> 
           <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>accuracy<span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> accuracy,train,ANY,ANY,missing,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>train, test_data<span style="color: #00ffff;">=</span>ANY, pop<span style="color: #00ffff;">=</span>ANY, class_col<span style="color: #00ffff;">=</span>missing, reclass_mat<span style="color: #00ffff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            test_data <span style="color: #00ffff;">&lt;-</span> x$trainingData
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'.outcome'</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'y'</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            test_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>test_data@y, 
                               test_data@x,
                               training_flag<span style="color: #00ffff;">=</span>test_data@training_flag<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'training_flag'</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no training_flag variable found - assuming none of test_data was used for model training'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>test_data$training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>test_data$training_flag<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cannot conduct accuracy assessment without independent testing data'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        test_data <span style="color: #00ffff;">&lt;-</span> test_data<span style="color: #20b2aa;">[</span>!test_data$training_flag, <span style="color: #20b2aa;">]</span>
        complete_rows <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>complete_rows<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'ignored'</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>complete_rows<span style="color: #20b2aa;">)</span>, 
                          <span style="color: #00ff00;">'rows because of missing data'</span><span style="color: #20b2aa;">))</span>
            test_data <span style="color: #00ffff;">&lt;-</span> test_data<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>test_data<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        predicted <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>x, test_data<span style="color: #20b2aa;">)</span>
        observed <span style="color: #00ffff;">&lt;-</span> test_data$y
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> accuracy,RasterLayer,pixel_data,ANY,missing,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>RasterLayer, test_data<span style="color: #00ffff;">=</span>pixel_data, pop<span style="color: #00ffff;">=</span>ANY, class_col<span style="color: #00ffff;">=</span>missing, reclass_mat<span style="color: #00ffff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>test_data@training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cannot conduct accuracy assessment without independent testing data'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>test_data@training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">All the test_data is for testing</span>
            predicted <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, test_data@polys, small<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
            observed <span style="color: #00ffff;">&lt;-</span> test_data@y
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Mix of testing and validation data</span>
            predicted <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, test_data@polys<span style="color: #20b2aa;">[</span>!test_data@training_flag<span style="color: #20b2aa;">]</span>, 
                                 small<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
            observed <span style="color: #00ffff;">&lt;-</span> test_data@y<span style="color: #20b2aa;">[</span>!test_data@training_flag<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        predicted <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>predicted, labels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>observed<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> accuracy</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> accuracy,RasterLayer,SpatialPolygonsDataFrame,ANY,character,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>accuracy, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>RasterLayer, test_data<span style="color: #00ffff;">=</span>SpatialPolygonsDataFrame, pop<span style="color: #00ffff;">=</span>ANY, class_col<span style="color: #00ffff;">=</span>character, reclass_mat<span style="color: #00ffff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, test_data, pop, class_col, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>x, test_data, class_col<span style="color: #00ffff;">=</span>class_col<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Since x is the predicted image, the output of get_pixels gives </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the predicted value in slot x, and the observed value in slot y.  </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">However x is converted to a numeric from a factor, so it needs to be </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">converted back to a factor with the same levels as y.</span>
        observed <span style="color: #00ffff;">&lt;-</span> ext@y
        predicted <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>ext@x<span style="color: #20b2aa;">[</span>, <span style="color: #20b2aa;">]</span>, labels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>ext@y<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">calc_accuracy</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #ff6347;">calc_accuracy</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>predicted, observed, pop, reclass_mat<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>reclass_mat<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'reclass_mat not yet supported'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">ct is the sample contigency table</span>
    ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>predicted, observed<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'pop was not provided - assuming sample frequencies equal population frequencies'</span><span style="color: #20b2aa;">)</span>
        pop <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'RasterLayer'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        pop <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>pop, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span><span style="color: #20b2aa;">)[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'number of classes in pop must be equal to nrow(ct)'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'integer'</span>, <span style="color: #00ff00;">'numeric'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pop<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>ct<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'length(pop) must be equal to number of classes in the predicted data'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span> 
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'pop must be a numeric vector or integer vector of length equal to the number of classes in x, or a RasterLayer, or NULL'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pop_ct <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_pop_ct</span><span style="color: #20b2aa;">(</span>ct, pop<span style="color: #20b2aa;">)</span>
    Q <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_Q</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
    A <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_A</span><span style="color: #20b2aa;">(</span>pop_ct<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>accuracy, ct<span style="color: #00ffff;">=</span>ct, pop_ct<span style="color: #00ffff;">=</span>pop_ct, Q<span style="color: #00ffff;">=</span>Q, A<span style="color: #00ffff;">=</span>A, 
               n_test<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>observed<span style="color: #20b2aa;">)</span>, pop<span style="color: #00ffff;">=</span>pop<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> apply<sub>windowed</sub>.R</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Apply a raster function with edge effects over a series of blocks</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function can be useful when applying windowed functions over a raster, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as with \code{glcm}. This function allows windows functions that have edge </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> effects to be applied over a raster in block-by-block fashion.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{apply_windowed} avoids the striping that would result if the edge </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> effects were ignored.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">fun</span><span style="color: #00bfff;"> the function to apply</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">edge</span><span style="color: #00bfff;"> length </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> numberic with number of rows on top and bottom with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> edge effects, defined as c(top, bottom)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chunksize</span><span style="color: #00bfff;"> the number of rows to read per block (passed to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{raster} \code{blockSize} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">filename</span><span style="color: #00bfff;"> file on disk to save \code{Raster*} to (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite any existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">datatype</span><span style="color: #00bfff;"> the \code{raster} datatype to use</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments to pass to \code{fun}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> &lt;- raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> min_x &lt;- cellStats(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, 'min')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> max_x &lt;- cellStats(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, 'max')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> apply_windowed(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, glcm, edge=c(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">), min_x=min_x, max_x=max_x)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">apply_windowed</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, fun, edge<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>, chunksize<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, filename<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span>, 
                          overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'FLT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">S'</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'numeric'</span><span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span>edge <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'edge must be a length </span><span style="color: #daa520;">2</span><span style="color: #00ff00;"> positive numeric'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>chunksize<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>x, chunksize<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_blocks <span style="color: #00ffff;">&lt;-</span> bs$n
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">bs_mod is the blocksize that will contain blocks that have been expanded </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">to avoid edge effects</span>
    bs_mod <span style="color: #00ffff;">&lt;-</span> bs
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Expand blocks to account for edge effects on the top:</span>
    bs_mod$row<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> bs_mod$row<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Need to read additional rows from these blocks to avoid an offset</span>
    bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span>:n_blocks<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Read additional bottom rows to account for edge effects on the bottom:</span>
    bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span>n_blocks <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> bs_mod$nrows<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span>n_blocks <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">+</span> edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span>bs_mod$row <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'too many blocks to read without edge effects - try increasing chunksize'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">((</span>bs_mod$nrows <span style="color: #00ffff;">+</span> bs_mod$row <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'too many blocks to read without edge effects - try increasing chunksize'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    started_writes <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        this_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x, row<span style="color: #00ffff;">=</span>bs_mod$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                nrows<span style="color: #00ffff;">=</span>bs_mod$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                format<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'matrix'</span><span style="color: #20b2aa;">)</span>
        out_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">fun</span><span style="color: #20b2aa;">(</span>this_block, ...<span style="color: #20b2aa;">)</span>
        layer_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]]</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Drop the padding added to top to avoid edge effects, unless we are </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">really on the top of the image, where top edge effects cannot be </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">avoided</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>block_num !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #00ffff;">&lt;-</span> out_block<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>, , <span style="color: #20b2aa;">]</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">The below line is needed to maintain a </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> dimensional array, </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">even when an n x m x </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> array is returned from </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">calc_texture_full_image because a single statistic was chosen. </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Without the below line, removing a row will coerce the </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">d array </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">to a </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">d matrix, and the bottom padding removal will fail as it </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">references a </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">d matrix).</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Drop the padding added to bottom to avoid edge effects, unless we are </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">really on the bottom of the image, where bottom edge effects cannot </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">be avoided</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>block_num !<span style="color: #00ffff;">=</span> n_blocks<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #00ffff;">&lt;-</span> out_block<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">((</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">-</span>edge<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span><span style="color: #00ffff;">+</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span>, , <span style="color: #20b2aa;">]</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!started_writes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup an output raster with number of layers equal to the number </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">of layers in out_block, and extent/resolution equal to extent and </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">resolution of x</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>, values<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>filename <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">)</span> filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
            out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #00ffff;">=</span>filename, overwrite<span style="color: #00ffff;">=</span>overwrite, 
                              datatype<span style="color: #00ffff;">=</span>datatype<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> layer_names
            started_writes <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">To write to a RasterBrick the out_block needs to be structured as </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">a </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">-d matrix with bands in columns and columns as row-major vectors</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">aperm</span><span style="color: #20b2aa;">(</span>out_block, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
            out_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>out_block, ncol<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            out_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">aperm</span><span style="color: #20b2aa;">(</span>out_block, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
            out_block <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>out_block, ncol<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_block<span style="color: #20b2aa;">)</span>, byrow<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, out_block, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">calc_glcm_edge</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>shift, window<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> shift <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.vector</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>shift, length<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> &amp;&amp;
         !<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> ||
        !<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'shift must be a list of length </span><span style="color: #daa520;">2</span><span style="color: #00ff00;"> integer vectors, or a </span><span style="color: #daa520;">2</span><span style="color: #00ff00;"> column matrix'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.matrix</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        shift <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>shift<span style="color: #20b2aa;">)</span>, ncol<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span>, byrow<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    neg_shifts <span style="color: #00ffff;">&lt;-</span> shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">][</span>shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span>
    pos_shifts <span style="color: #00ffff;">&lt;-</span> shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">][</span>shift<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>neg_shifts<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> neg_shifts <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pos_shifts<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> pos_shifts <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>neg_shifts<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">ceiling</span><span style="color: #20b2aa;">(</span>window<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>,
             <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>pos_shifts<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">ceiling</span><span style="color: #20b2aa;">(</span>window<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> auto<sub>calc</sub><sub>predictors</sub>.R</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate predictor layers for a classification</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function automates the calculation of a layer stack of predictor layers </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to use in a land use and/or land cover classification. See Details for the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output layers.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The layers in the output layer stack are listed below. Note that all the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> layers are rescaled so that they range between -</span><span style="color: #daa520;">32</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">767</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">32</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">767</span><span style="color: #00bfff;"> (allowing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> them to be stored as </span><span style="color: #daa520;">16</span><span style="color: #00bfff;"> bit unsigned integers).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \bold{Predictor layer stack:}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \tabular{ll}{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">4</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">5</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">: \tab Band </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> reflectance \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">7</span><span style="color: #00bfff;">: \tab MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">: \tab GLCM mean (from MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">9</span><span style="color: #00bfff;">: \tab GLCM variance (from MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">: \tab GLCM dissimilarity (from MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">11</span><span style="color: #00bfff;">: \tab Elevation \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">12</span><span style="color: #00bfff;">: \tab Slope (radians X </span><span style="color: #daa520;">10000</span><span style="color: #00bfff;">) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     Layer </span><span style="color: #daa520;">13</span><span style="color: #00bfff;">: \tab Aspect (see below) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The aspect is recoded as:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \bold{Aspect coding:}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \tabular{ll}{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">: \tab north facing (</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">45</span><span style="color: #00bfff;"> degrees, </span><span style="color: #daa520;">315</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">360</span><span style="color: #00bfff;"> degrees) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">: \tab east facing (</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">135</span><span style="color: #00bfff;"> degrees) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">: \tab south facing (</span><span style="color: #daa520;">135</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">225</span><span style="color: #00bfff;"> degrees) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">     </span><span style="color: #daa520;">4</span><span style="color: #00bfff;">: \tab west facing (</span><span style="color: #daa520;">225</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">315</span><span style="color: #00bfff;"> degrees) \cr</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">glcm</span><span style="color: #00bfff;"> glcm</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> path to a preprocessed image as output by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} or \code{auto_cloud_fill}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dem</span><span style="color: #00bfff;"> DEM \code{RasterLayer} as output by \code{auto_setup_dem}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slopeaspect</span><span style="color: #00bfff;"> \code{RasterStack} as output by \code{auto_setup_dem}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_path</span><span style="color: #00bfff;"> the path to use for the output (optional - if NULL then </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output images will be saved alongside the input images in the same folder).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when saving output rasters (determines </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output file format).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;">  additional arguments passed to \code{\link{glcm}}, such as</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{n_grey}, \code{window}, or \code{shift}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function). See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #ff6347;">auto_calc_predictors</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, dem, slopeaspect, output_path<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                                 ext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'tif'</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, notify<span style="color: #00ffff;">=</span>print,
                                 ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>f, x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>input image, x, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Predictor calculation'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup a regex to identify preprocessed images</span>
    preproc_regex <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'^[a-zA-Z]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">,</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}_[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}-[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}_[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">}-[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}_L[</span><span style="color: #daa520;">457</span><span style="color: #00ff00;">][ET]SR(_tc)?'</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Update the basename to refer the chosen file</span>
    image_basename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    image_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        output_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    mask_stack_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, mask_stack_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        mask_stack_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'(_tc)?.'</span>, ext, <span style="color: #00ff00;">'$'</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>, x<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, mask_stack_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'using masks file with old format (pre v</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">.</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">) teamlucc naming'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'could not find masks file'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>mask_stack_file<span style="color: #20b2aa;">)</span>
    image_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>maskvals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Mask clouds, cloud shadow, and fill</span>
        <span style="color: #20b2aa;">(</span>maskvals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>maskvals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>maskvals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">})</span>
    <span style="color: #00bfff;">######################################################################</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate additional predictor layers (MSAVI and textures)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                 <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, <span style="color: #00ff00;">'_MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">.'</span>, ext<span style="color: #20b2aa;">))</span>
    MSAVI<span style="color: #daa520;">2</span>_layer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                           nir<span style="color: #00ffff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Truncate MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> to range between </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, and scale by </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">000</span><span style="color: #00bfff;"> so it </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">can be saved as a INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S</span>
    MSAVI<span style="color: #daa520;">2</span>_layer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_layer, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
            vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>vals * <span style="color: #daa520;">10000</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, filename<span style="color: #00ffff;">=</span>MSAVI<span style="color: #daa520;">2</span>_filename, overwrite<span style="color: #00ffff;">=</span>overwrite, datatype<span style="color: #00ffff;">=</span>INT<span style="color: #daa520;">2</span>S<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating GLCM textures'</span><span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_glcm_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                      <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, 
                                            <span style="color: #00ff00;">'_MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">_glcm.'</span>, ext<span style="color: #20b2aa;">))</span>
    glcm_statistics <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'mean'</span>, <span style="color: #00ff00;">'variance'</span>, <span style="color: #00ff00;">'homogeneity'</span>, <span style="color: #00ff00;">'contrast'</span>, 
                         <span style="color: #00ff00;">'dissimilarity'</span>, <span style="color: #00ff00;">'entropy'</span>, <span style="color: #00ff00;">'second_moment'</span>, 
                         <span style="color: #00ff00;">'correlation'</span><span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_layer<span style="color: #20b2aa;">[</span>image_mask<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Need to know window and shift to calculate edge for apply_windowed. So if </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">they are not in the dotted args, assume the defaults (since glcm will use </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the defaults if these parameters are not supplied).</span>
    dots <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>...<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>window <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>dots<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        dots$window <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>shift <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>dots<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        dots$shift <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    edge <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc_glcm_edge</span><span style="color: #20b2aa;">(</span>dots$shift, dots$window<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note the min_x and max_x are given for MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> that has been scaled by </span>
    <span style="color: #00bfff;"># </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">000</span>
    apply_windowed_args <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>MSAVI<span style="color: #daa520;">2</span>_layer, fun<span style="color: #00ffff;">=</span>glcm, edge<span style="color: #00ffff;">=</span>edge, min_x<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>, 
                             max_x<span style="color: #00ffff;">=</span><span style="color: #daa520;">10000</span>, filename<span style="color: #00ffff;">=</span>MSAVI<span style="color: #daa520;">2</span>_glcm_filename, 
                             overwrite<span style="color: #00ffff;">=</span>overwrite, statistics<span style="color: #00ffff;">=</span>glcm_statistics, 
                             na_opt<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'center'</span><span style="color: #20b2aa;">)</span>
    apply_windowed_args <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>apply_windowed_args, dots<span style="color: #20b2aa;">)</span>
    MSAVI<span style="color: #daa520;">2</span>_glcm <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">do.call</span><span style="color: #20b2aa;">(</span>apply_windowed, apply_windowed_args<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'glcm'</span>, glcm_statistics, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating GLCM textures'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Processing slopeaspect'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slope'</span>, <span style="color: #00ff00;">'aspect'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Classify aspect into north facing, east facing, etc., recalling </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">that the aspect is stored in radians scaled by </span><span style="color: #daa520;">1000</span><span style="color: #00bfff;">.</span>
        <span style="color: #00bfff;">#     </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">: north facing (</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">315</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">360</span><span style="color: #00bfff;">)</span>
        <span style="color: #00bfff;">#     </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">: east facing (</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">135</span><span style="color: #00bfff;">)</span>
        <span style="color: #00bfff;">#     </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">: south facing (</span><span style="color: #daa520;">135</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">225</span><span style="color: #00bfff;">)</span>
        <span style="color: #00bfff;">#     </span><span style="color: #daa520;">4</span><span style="color: #00bfff;">: west facing (</span><span style="color: #daa520;">225</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">315</span><span style="color: #00bfff;">)</span>
        aspect_cut <span style="color: #00ffff;">&lt;-</span> raster::<span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slopeaspect$aspect<span style="color: #00ffff;">/</span><span style="color: #daa520;">1000</span>,
                                  <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">45</span>, <span style="color: #daa520;">135</span>, <span style="color: #daa520;">225</span>, <span style="color: #daa520;">315</span>, <span style="color: #daa520;">361</span><span style="color: #20b2aa;">)</span>*<span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code both </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">45</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">315</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">360</span><span style="color: #00bfff;"> aspect as North facing (</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
        aspect_cut<span style="color: #20b2aa;">[</span>aspect_cut <span style="color: #00ffff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>aspect_cut<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'aspect'</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Processing slopeaspect'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;">######################################################################</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Layer stack predictor layers:</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Writing predictors'</span><span style="color: #20b2aa;">)</span>
    predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>image_stack, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>,
                        MSAVI<span style="color: #daa520;">2</span>_layer,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_mean<span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_variance<span style="color: #20b2aa;">)</span>,
                        <span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>_glcm$glcm_dissimilarity<span style="color: #20b2aa;">))</span>
    predictor_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'b</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'b</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'b</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'b</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'b</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'b</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'msavi'</span>, 
                         <span style="color: #00ff00;">'msavi_glcm_mean'</span>, <span style="color: #00ff00;">'msavi_glcm_variance'</span>, 
                         <span style="color: #00ff00;">'msavi_glcm_dissimilarity'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>dem<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>predictors, dem<span style="color: #20b2aa;">)</span>
        predictor_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>predictor_names, <span style="color: #00ff00;">'elev'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>predictors, slopeaspect$slope, aspect_cut<span style="color: #20b2aa;">)</span>
        predictor_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>predictor_names, <span style="color: #00ff00;">'slope'</span>, <span style="color: #00ff00;">'aspect'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    predictors_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                     <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, <span style="color: #00ff00;">'_predictors.'</span>, 
                                            ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> predictor_names
    predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>predictors, image_mask, maskvalue<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, 
                       filename<span style="color: #00ffff;">=</span>predictors_filename, 
                       overwrite<span style="color: #00ffff;">=</span>overwrite, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> predictor_names
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save a copy of the original masks file along with the predictors file, so </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the masks can be easily located later.</span>
    predictors_mask_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                          <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>image_basename, 
                                                 <span style="color: #00ff00;">'_predictors_masks.'</span>, ext<span style="color: #20b2aa;">))</span>
    mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>mask_stack, filename<span style="color: #00ffff;">=</span>predictors_mask_filename, 
                              overwrite<span style="color: #00ffff;">=</span>overwrite, 
                              datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Writing predictors'</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Predictor calculation'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> auto<sub>chg</sub><sub>detect</sub>.R</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Perform change detection for two Landsat CDR surface reflectance images</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This image automates the change detection process using the Change Vector </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Analysis in Posterior Probability Space (CVAPS) algorithm. The threshold for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> change/no-change mapping is determined using Huang's algorithm (see </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{threshold}} or can be specified manually. First the images </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> should be classified using the \code{auto_classify} function (or any other </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classification approach that yields per-pixel probabilities of class </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> membership).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">1</span><span style="color: #ffa500;">_classes</span><span style="color: #00bfff;"> cover classes as output from \code{auto_classify_image} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for time </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">1</span><span style="color: #ffa500;">_probs</span><span style="color: #00bfff;"> per class probabilities as output from </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_classify_image} for time </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">2</span><span style="color: #ffa500;">_probs</span><span style="color: #00bfff;"> per class probabilities as output from </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_classify_image} for time </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_path</span><span style="color: #00bfff;"> the path to use for the output</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_basename</span><span style="color: #00bfff;"> the base filename for output files from </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_chg_detect} (without an extension)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when saving output rasters (determines </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output file format).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_threshold</span><span style="color: #00bfff;"> the threshold to use determining change and no-change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> areas from the change magnitude image (see \code{\link{chg_mag}}. If </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{NULL}, then \code{\link{threshold}} will be used to dermine this </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> threshold value automatically. A threshold in the range of .</span><span style="color: #daa520;">75</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> recommended as a starting point.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function).  See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R.  The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing - used for the side effect of performing change detection</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> analysis in posterior probability space: a new method for land cover change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> detection.  IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">auto_chg_detect</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_classes, t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, output_path, 
                            output_basename, ext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'tif'</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                            chg_threshold<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, notify<span style="color: #00ffff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change detection'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;">###########################################################################</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate change magnitude and direction</span>
    <span style="color: #00bfff;">###########################################################################</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change magnitude and direction'</span><span style="color: #20b2aa;">)</span>
    chg_dir_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, 
                                                     <span style="color: #00ff00;">'_chgdir.'</span>, ext<span style="color: #20b2aa;">))</span>
    chg_dir_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">chg_dir</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, filename<span style="color: #00ffff;">=</span>chg_dir_filename, 
                             overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    chg_mag_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, 
                                                     <span style="color: #00ff00;">'_chgmag.'</span>, ext<span style="color: #20b2aa;">))</span>
    chg_mag_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">chg_mag</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>_probs, t<span style="color: #daa520;">2</span>_probs, filename<span style="color: #00ffff;">=</span>chg_mag_filename, 
                             overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change magnitude and direction'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;">###########################################################################</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate change trajectories</span>
    <span style="color: #00bfff;">###########################################################################</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change trajectories'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>chg_threshold<span style="color: #20b2aa;">))</span> chg_threshold <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">threshold</span><span style="color: #20b2aa;">(</span>chg_mag_image<span style="color: #20b2aa;">)</span>

    <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Using threshold='</span>, chg_threshold<span style="color: #20b2aa;">))</span>
    chg_traj_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                   <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>output_basename, <span style="color: #00ff00;">'_chgtraj.'</span>, ext<span style="color: #20b2aa;">))</span>
    chg_traj_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">chg_traj</span><span style="color: #20b2aa;">(</span>chg_mag_image, chg_dir_image, 
                             chg_threshold<span style="color: #00ffff;">=</span>chg_threshold, overwrite<span style="color: #00ffff;">=</span>overwrite, 
                             filename<span style="color: #00ffff;">=</span>chg_traj_filename<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change trajectories'</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Change detection'</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> auto<sub>classify</sub>.R</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Classify a preprocessed surface reflectance image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> First the image should be preprocessed using the \code{auto_preprocess} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> function. For Landsat CDR imagery, predictor layers can be generated using </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the \code{auto_generate_predictors} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgdal</span><span style="color: #00bfff;"> readOGR</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> spTransform</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">predictor_file</span><span style="color: #00bfff;"> a \code{Raster*} of predictor layers output by the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess} function or path to an image stack in a format </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> readable by the \code{raster} package.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">train_shp</span><span style="color: #00bfff;"> a file readable by readOGR with training polygons</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_path</span><span style="color: #00bfff;"> the path to use for the output</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_col</span><span style="color: #00bfff;"> the name of the column containing the response variable </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (for example the land cover type of each pixel)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">training</span><span style="color: #00bfff;"> indicator of which polygons to use in training. Can be: </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> string giving the name of a column indicating whether each polygon is to be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> used in training (column equal to TRUE) or in testing (column equal to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> FALSE), or </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) a logical vector of length equal to length(polys), or </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">) a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> number between </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> indicating the fraction of the polygons to be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> randomly selected for use in training.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function). See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> #TODO: Add example</span>
<span style="color: #ff6347;">auto_classify</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>predictor_file, train_shp, output_path, 
                          class_col<span style="color: #00ffff;">=</span>Poly_Type, training<span style="color: #00ffff;">=</span>.<span style="color: #daa520;">6</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                          notify<span style="color: #00ffff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>f, train_shp<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>train_shp, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>f, predictor_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>predictor_file, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running auto_classify'</span><span style="color: #20b2aa;">)</span>
    predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>predictor_file<span style="color: #20b2aa;">)</span>
    pred_rast_basename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>predictor_file<span style="color: #20b2aa;">))</span>
    train_polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readOGR</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>train_shp<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>train_shp<span style="color: #20b2aa;">)))</span>
    train_polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>train_polys, <span style="color: #ff6347;">crs</span><span style="color: #20b2aa;">(</span>predictors<span style="color: #20b2aa;">))</span>
    train_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>predictors, train_polys, class_col<span style="color: #00ffff;">=</span>class_col, 
                             training<span style="color: #00ffff;">=</span>training<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running classification'</span><span style="color: #20b2aa;">)</span>
    classification <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">classify</span><span style="color: #20b2aa;">(</span>predictors, train_data<span style="color: #20b2aa;">)</span>
    model <span style="color: #00ffff;">&lt;-</span> classification$model
    <span style="color: #ff6347;">save</span><span style="color: #20b2aa;">(</span>model, file<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                  <span style="color: #00ff00;">'predmodel.RData'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>classification$pred_classes,
                filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                      <span style="color: #00ff00;">'predclasses.tif'</span>, 
                                                      sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">))</span>,
                datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">scale_raster</span><span style="color: #20b2aa;">(</span>classification$pred_probs<span style="color: #20b2aa;">)</span>,
                filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, 
                                                      <span style="color: #00ff00;">'predprobs.tif'</span>, 
                                                      sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">))</span>,
                datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running classification'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cls &lt;- levels(train_data$y) </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cls &lt;- data.frame(code=seq(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">:length(cls)), name=cls)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">color_image(classification$predclasses, cls,</span>
    <span style="color: #00bfff;">#             </span><span style="color: #00bfff;">file.path(output_path, paste(pred_rast_basename, </span>
    <span style="color: #00bfff;">#             </span><span style="color: #00bfff;">'predclasses_colored.tif', sep='_')))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Perform accuracy assessment using an independent dataset:</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running accuracy assessment'</span><span style="color: #20b2aa;">)</span>
    acc <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">accuracy</span><span style="color: #20b2aa;">(</span>classification$model, 
                    pop<span style="color: #00ffff;">=</span>classification$pred_classes<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>acc<span style="color: #20b2aa;">)</span>,
                   file<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pred_rast_basename, <span style="color: #00ff00;">'predacc.txt'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">)))</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running accuracy assessment'</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Running auto_classify'</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> auto<sub>cloud</sub><sub>fill</sub>.R</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">pct_clouds</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    num_clouds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span>, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    num_clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span>, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>num_clouds <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>num_clouds <span style="color: #00ffff;">+</span> num_clear<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Automated removal of clouds from Landsat CDR imagery</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Uses one of four cloud reomval algorithms (see \code{\link{cloud_remove}}) </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to remove thick clouds from Landsat imagery. In hilly areas, topographic </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> correction should be done before cloud fill.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The \code{auto_cloud_fill} function allows an analyst to automatically </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> construct a cloud-filled image after specifying: \code{data_dir} (a folder </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of Landsat images), \code{wrspath} and \code{wrsrow} (the WRS-</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> path/row to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> use), and \code{start_date} and \code{end_date} (a start and end date </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> limiting the images to use in the algorithm).  The analyst can also </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> optionally specify a \code{base_date}, and the \code{auto_cloud_fill} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> function will automatically pick the image closest to that date to use as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the base image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> As the \code{auto_cloud_fill} function automatically chooses images for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> inclusion in the cloud fill process, it relies on having images stored on </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> disk in a particular way, and currently only supports cloud fill for Landsat </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> CDR surface reflectance images. To ensure that images are correctly stored </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> on your hard disk, use the \code{\link{auto_preprocess_landsat}} function to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> extract the original Landsat CDR hdf files from the USGS archive. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} function will ensure that images are </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> extracted and renamed properly so that they can be used with the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_cloud_fill} script.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> as.duration new_interval</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">SDMTools</span><span style="color: #00bfff;"> ConnCompLabel</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">data_dir</span><span style="color: #00bfff;"> folder where input images are located, with filenames as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output by the \code{\link{auto_preprocess_landsat}} function. This folder </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be searched recursively for images (taking the below path/row, date, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and topographic correction options into account).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrspath</span><span style="color: #00bfff;"> World Reference System (WRS) path</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrsrow</span><span style="color: #00bfff;"> World Reference System (WRS) row</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">start_date</span><span style="color: #00bfff;"> start date of period from which images will be chosen to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fill cloudy areas in the base image (as \code{Date} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">end_date</span><span style="color: #00bfff;"> end date of period from which images will be chosen to fill </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloudy areas in the the base image (as \code{Date} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">base_date</span><span style="color: #00bfff;"> ideal date for base image (base image will be chosen as the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image among the available images that is closest to this date). If NULL, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> then the base image will be the image with the lowest cloud cover.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out_name</span><span style="color: #00bfff;"> base filename (without an extension - see \code{ext} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> argument) for cloud filled image.  The mask file for the cloud filled image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be saved with the same name, with the added suffix _mask.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tc</span><span style="color: #00bfff;"> if \code{TRUE}, use topographically corrected imagery as output by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat}. IF \code{FALSE} use bands </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> surface </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> reflectance as output by \code{unstack_ledaps} or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} (if \code{auto_preprocess_landsat} was also </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> run with tc=FALSE).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when searching for input rasters and when </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> saving output rasters (determines output file format). Should match file </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> extension of input rasters (and should most likely match the value chosen </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for \code{ext} when \code{auto_preprocess_landsat} was run).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sensors</span><span style="color: #00bfff;"> choose the sensors to include when selecting images (useful </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for excluding images from a particular satellite if desired). Can be any of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">T, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">T, L</span><span style="color: #daa520;">7</span><span style="color: #00bfff;">E, and/or L</span><span style="color: #daa520;">8</span><span style="color: #00bfff;">C.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">img_type</span><span style="color: #00bfff;"> type of Landsat imagery to preprocess. Can be CDR for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat Climate Data Record (CDR) imagery in HDR format, or L</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Standard Terrain Correction (Level </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T) imagery. Note that if L</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T imagery is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> used, fmask must be run locally (see https://code.google.com/p/fmask) prior </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to using \code{auto_preprocess_landsat}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">threshold</span><span style="color: #00bfff;"> maximum percent cloud cover allowable in base image. Cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fill will iterate until percent cloud cover in base image is below this </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> value, or until \code{max_iter} iterations have been run</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_iter</span><span style="color: #00bfff;"> maximum number of times to run cloud fill script</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function).  See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R.  The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages. Set to FALSE or </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for no status messages. Set to </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> for basic status messages. Set to </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> detailed status messages.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite \code{out_name} if it already exists</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;">  additional arguments passed to \code{\link{cloud_remove}}, such </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as \code{DN_min}, \code{DN_max}, \code{algorithm}, \code{byblock}, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{verbose}, etc. See \code{\link{cloud_remove}} for details</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a list with two elements: filled, a \code{Raster*} object with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloud filled image, and mask, a \code{RasterLayer} object with the cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> mask for the cloud filled image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Zhu, X., Gao, F., Liu, D., Chen, J., </span><span style="color: #daa520;">2012</span><span style="color: #00bfff;">. A modified </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> neighborhood similar pixel interpolator approach for removing thick clouds </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in Landsat images.  Geoscience and Remote Sensing Letters, IEEE </span><span style="color: #daa520;">9</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">521</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">525</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> doi:</span><span style="color: #daa520;">10</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">1109</span><span style="color: #00bfff;">/LGRS.</span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">2173290</span>
<span style="color: #ff6347;">auto_cloud_fill</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>data_dir, wrspath, wrsrow, start_date, end_date, 
                            out_name, base_date<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, tc<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, ext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'tif'</span>,
                            sensors<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'L</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">T'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">T'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">E'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">C'</span><span style="color: #20b2aa;">)</span>, 
                            img_type<span style="color: #00ffff;">=</span>CDR, threshold<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, max_iter<span style="color: #00ffff;">=</span><span style="color: #daa520;">5</span>, 
                            notify<span style="color: #00ffff;">=</span>print, verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, data_dir<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'data_dir does not exist'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output folder does not exist'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> out_name<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'out_name should not have a file extension'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>
    output_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, <span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, output_file<span style="color: #20b2aa;">)</span> &amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file '</span>, output_file, <span style="color: #00ff00;">' already exists'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>sensors <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'L</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">T'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">T'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">E'</span>, <span style="color: #00ff00;">'L</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">C'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'sensors must be a list of one or more of: L</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">T, L</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">T, L</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">E, L</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">C'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    log_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, <span style="color: #00ff00;">'_log.txt'</span><span style="color: #20b2aa;">)</span>, open<span style="color: #00ffff;">=</span>wt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">msg</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>txt, <span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>, file<span style="color: #00ffff;">=</span>log_file, append<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>msg<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Cloud fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span>
    wrspath <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, wrspath<span style="color: #20b2aa;">)</span>
    wrsrow <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, wrsrow<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Find image files based on start and end dates</span>
    prefix_re <span style="color: #00ffff;">&lt;-</span> ^<span style="color: #20b2aa;">([</span>a<span style="color: #00ffff;">-</span>zA<span style="color: #00ffff;">-</span>Z<span style="color: #20b2aa;">]</span>*_<span style="color: #20b2aa;">)</span>?
    <span style="color: #00bfff;">#</span><span style="color: #00bfff;">pathrow_re &lt;-[</span><span style="color: #daa520;">012</span><span style="color: #00bfff;">][</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">9</span><span style="color: #00bfff;">]{</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">}-[</span><span style="color: #daa520;">012</span><span style="color: #00bfff;">][</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">9</span><span style="color: #00bfff;">]{</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">}</span>
    pathrow_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>wrspath, wrsrow, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'-'</span><span style="color: #20b2aa;">)</span>
    date_re <span style="color: #00ffff;">&lt;-</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">19</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">01</span><span style="color: #20b2aa;">]))[</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0123</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sensor_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'('</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'('</span>, sensors,<span style="color: #00ff00;">')'</span><span style="color: #20b2aa;">)</span>, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'|'</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">')'</span>, SR<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sensor_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'('</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'('</span>, sensors,<span style="color: #00ff00;">')'</span><span style="color: #20b2aa;">)</span>, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'|'</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">')'</span>, L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_tc.'</span>, ext, <span style="color: #00ff00;">'$'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'.'</span>, ext, <span style="color: #00ff00;">'$'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    file_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix_re, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pathrow_re, date_re, sensor_re, 
                                       sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">)</span>, suffix_re<span style="color: #20b2aa;">)</span>
    img_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>data_dir, pattern<span style="color: #00ffff;">=</span>file_re, recursive<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, date_re<span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #00ff00;">'%Y-%j'</span><span style="color: #20b2aa;">)</span>
    which_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">((</span>img_dates <span style="color: #00ffff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span> &amp;
                          <span style="color: #20b2aa;">(</span>img_dates <span style="color: #00ffff;">&lt;</span> end_date<span style="color: #20b2aa;">))</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">]</span>
    img_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>data_dir, img_files<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">])</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no images found - check date_dir, check wrspath, wrsrow, start_date, and end_date'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Only'</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>,
                   <span style="color: #00ff00;">'image(s) found. Need at least two images to perform cloud fill'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Found'</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'image(s)'</span><span style="color: #20b2aa;">))</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Analyzing cloud cover in input images'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Run QA stats</span>
    fmasks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    fill_QAs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    imgs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>img_file <span style="color: #ff00ff;">in</span> img_files<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        masks_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, masks_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            masks_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>suffix_re, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>, img_file<span style="color: #20b2aa;">)</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, masks_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'using masks file with old format (pre v</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">.</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">) teamlucc naming'</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'could not find masks file'</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        this_fill_QA <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        fill_QAs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_QAs, this_fill_QA<span style="color: #20b2aa;">)</span>
        this_fmask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        fmasks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fmasks, this_fmask<span style="color: #20b2aa;">)</span>
        this_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>
        imgs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>imgs, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>this_img<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>imgs, res<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, orig<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>fmasks, res<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, orig<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    freq_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">)</span>, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span>, merge<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert frequency table to fractions</span>
    freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Analyzing cloud cover in input images'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating cloud masks'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Find image that is either closest to base date, or has the maximum </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">percent clear</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>base_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        clear_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table$value <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        base_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        base_date_diff <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> 
                                 <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>x, base_date<span style="color: #20b2aa;">)))</span>
        base_date_diff <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>base_date_diff <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle ties - two images that are the same distance from base date.  </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Default to earlier image.</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>base_img_index<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            base_img_index <span style="color: #00ffff;">&lt;-</span> base_img_index<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save the original base image fmask so it can be used to recode the final </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cloud mask at the end of cloud filling</span>
    base_fmask <span style="color: #00ffff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    base_fill_QA <span style="color: #00ffff;">&lt;-</span> fill_QAs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert masks to indicate: </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear; </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = cloud or shadow; </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = fill</span>
    <span style="color: #00bfff;">#</span>
    <span style="color: #00bfff;">#   </span><span style="color: #00bfff;">fmask_band key:</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = water</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = cloud_shadow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> = snow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> = cloud</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">255</span><span style="color: #00bfff;"> = fill value</span>
    <span style="color: #ff6347;">calc_cloud_mask</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>fmask, img<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code clouds and cloud shadows as </span><span style="color: #daa520;">1</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code fill as </span><span style="color: #daa520;">2</span>
        ret<span style="color: #20b2aa;">[</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">2</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code other missing data that is not in fill areas as NA. The (ret != </span>
        <span style="color: #00bfff;"># </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) test is necessary to ensures that only NAs that are NOT in clouds </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">will be copied to the mask images (the assumption being that NAs in </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">clouds should be marked as cloud and fill should be attempted).  This </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">is necessary in case clouded areas in img are mistakenly coded NA </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(they should not be).</span>
        ret<span style="color: #20b2aa;">[(</span>ret !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>ret !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>img<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        fmasks<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, imgs<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]][[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>, fun<span style="color: #00ffff;">=</span>calc_cloud_mask, 
                             datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]))</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    imgs <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_mask <span style="color: #00ffff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    fmasks <span style="color: #00ffff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_img_date <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>base_img_index<span style="color: #20b2aa;">]</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Using image from'</span>, base_img_date, <span style="color: #00ff00;">'as base image.'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Calculating cloud masks'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Masking base image'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Mask out clouds in base image. Save this image to disk so it is available </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">even if no cloud fill is done (if the pct_clouds in this image is below </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the threshold).</span>
    base_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_img, base_mask,
        fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>base_vals, mask_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set clouds/shadows to </span><span style="color: #daa520;">0</span>
            base_vals<span style="color: #20b2aa;">[</span>mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Allow fill to be attempted in NA areas</span>
            base_vals<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>base_vals<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set slc-off gaps and areas outside scene to NA</span>
            base_vals<span style="color: #20b2aa;">[</span>mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>base_vals<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>, 
        filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    cur_pct_clouds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Base image has '</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>cur_pct_clouds, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'% cloud cover before fill'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Masking base image'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">while</span> <span style="color: #20b2aa;">((</span>cur_pct_clouds <span style="color: #00ffff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">&lt;</span> max_iter<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>imgs<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Fill iteration'</span>, n <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate a raster indicating the pixels in each potential fill image </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">that are available for filling pixels of base_img that are missing </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">due to cloud contamination. Areas coded </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> are missing due to cloud or </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">shadow in the base image and are available in the merge image. This </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">will return a stack with number of layers equal to number of masks.</span>
        fill_areas <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fmasks<span style="color: #20b2aa;">)</span>,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>base_mask_vals, fill_mask_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>base_mask_vals<span style="color: #20b2aa;">))</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code cloudy in base, clear in fill as </span><span style="color: #daa520;">1</span>
                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code clear in base, clear in fill as </span><span style="color: #daa520;">0</span>
                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code NA in base, clear in fill as clouded, so these NAs will </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">be filled if possible.</span>
                ret<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>base_mask_vals<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure SLC-off gaps and background areas in each image are </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">not filled:</span>
                ret<span style="color: #20b2aa;">[(</span>base_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fill_mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
        fill_areas_freq <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>fill_areas, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span>, merge<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Below is necessary as for some reason when fill_areas is of length </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">one, freq returns a matrix rather than a data.frame</span>
        fill_areas_freq <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Select the fill image with the maximum number of available pixels </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(counting only pixels in the fill image that are not ALSO clouded in </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the fill image)</span>
        avail_fill_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq$value <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>avail_fill_row<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'No fill pixels available. Stopping fill.'</span><span style="color: #20b2aa;">))</span>
            <span style="color: #ff00ff;">break</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Remove the now unnecessary value column</span>
        fill_areas_freq <span style="color: #00ffff;">&lt;-</span> fill_areas_freq<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'value'</span><span style="color: #20b2aa;">)]</span>
        fill_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #20b2aa;">]</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>fill_img_index<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> ||
            <span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, fill_img_index<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'No fill pixels available. Stopping fill.'</span><span style="color: #20b2aa;">))</span>
            <span style="color: #ff00ff;">break</span>
        <span style="color: #20b2aa;">}</span>
        fill_img <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        imgs <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        base_img_mask <span style="color: #00ffff;">&lt;-</span> fill_areas<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        fmasks <span style="color: #00ffff;">&lt;-</span> fmasks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        fill_img_date <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>fill_img_index<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Add numbered IDs to the cloud patches</span>
        base_img_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ConnCompLabel</span><span style="color: #20b2aa;">(</span>base_img_mask<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure dataType is properly set prior to handing off to IDL</span>
        <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img_mask<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Filling image from '</span>, base_img_date,
                          <span style="color: #00ff00;">' with image from '</span>, fill_img_date, <span style="color: #00ff00;">'.'</span><span style="color: #20b2aa;">))</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span>Performing fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        base_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove</span><span style="color: #20b2aa;">(</span>base_img, fill_img, base_img_mask, 
                                 out_name<span style="color: #00ffff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, 
                                 verbose<span style="color: #00ffff;">=</span>verbose, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">base_img &lt;- cloud_remove(base_img, fill_img, base_img_mask, </span>
        <span style="color: #00bfff;">#                          </span><span style="color: #00bfff;">out_name=extension(rasterTmpFile(), ext), </span>
        <span style="color: #00bfff;">#                          </span><span style="color: #00bfff;">verbose=verbose, overwrite=TRUE, </span>
        <span style="color: #00bfff;">#                          </span><span style="color: #00bfff;">DN_min=DN_min, DN_max=DN_max, </span>
        <span style="color: #00bfff;">#                          </span><span style="color: #00bfff;">algorithm=algorithm, byblock=byblock)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span>Performing fill<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Revise base mask to account for newly filled pixels</span>
        base_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, base_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>mask_vals, filled_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                mask_vals<span style="color: #20b2aa;">[(</span>mask_vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>filled_vals !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>mask_vals<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>, 
            filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        cur_pct_clouds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">msg</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Base image has '</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>cur_pct_clouds, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>,
                          <span style="color: #00ff00;">'% cloud cover remaining'</span><span style="color: #20b2aa;">))</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Fill iteration'</span>, n <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        n <span style="color: #00ffff;">&lt;-</span> n <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_img, filename<span style="color: #00ffff;">=</span>output_file, datatype<span style="color: #00ffff;">=</span>INT<span style="color: #daa520;">2</span>S, 
                            overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Recode base mask so final coding matches that of fmask (though cloud and </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cloud shadow are no longer differentiated)</span>
    <span style="color: #00bfff;">#   </span><span style="color: #00bfff;">fmask_band key:</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = water</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = cloud_shadow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> = snow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> = cloud</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">255</span><span style="color: #00bfff;"> = fill value</span>
    <span style="color: #00bfff;">#   </span><span style="color: #00bfff;">base_mask key:</span>
    <span style="color: #00bfff;">#           </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear</span>
    <span style="color: #00bfff;">#           </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = cloud</span>
    <span style="color: #00bfff;">#           </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = fill</span>
    mask_output_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_name, <span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>
    filled_fmask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask, base_fmask,
        fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>after_fill, before_fill<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            ret <span style="color: #00ffff;">&lt;-</span> after_fill
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code clear after filling but water in fmask as water (</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> in fmask)</span>
            ret<span style="color: #20b2aa;">[(</span>after_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>before_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code clear after filling but snow in fmask as snow (</span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> in fmask)</span>
            ret<span style="color: #20b2aa;">[(</span>after_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>before_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">3</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code cloudy after filling as cloud (</span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> in fmask)</span>
            ret<span style="color: #20b2aa;">[</span>after_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">4</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code gap in fmask as gap (</span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> in fmask)</span>
            ret<span style="color: #20b2aa;">[</span>before_fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">255</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
    final_masks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>base_fill_QA, filled_fmask<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>final_masks<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_QA, fmask<span style="color: #20b2aa;">)</span>
    final_masks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>final_masks, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>, 
                               filename<span style="color: #00ffff;">=</span>mask_output_file, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Cloud fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>log_file<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>filled<span style="color: #00ffff;">=</span>base_img, mask<span style="color: #00ffff;">=</span>final_masks<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> auto<sub>gap</sub><sub>fill</sub>.R</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">pct_gap</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>gap_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    num_gap <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>gap_mask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span>, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    num_clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>gap_mask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span>, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>num_gap <span style="color: #00ffff;">/</span> num_clear<span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Automated removal of gaps in SLC-off images using GNSPI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Uses the GNSPI algorithm from Zhu et al. See \code{\link{fill_gaps}} for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> details.  In hilly areas, gap fill should be done after topographic </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> correction.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The \code{auto_gap_fill} function allows an analyst to automatically </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> construct a gap-filled image after specifying: \code{data_dir} (a folder of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat images), \code{wrspath} and \code{wrsrow} (the WRS-</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> path/row to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> use), and \code{start_date} and \code{end_date} (a start and end date </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> limiting the images to use in the algorithm).  The analyst can also </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> optionally specify a \code{base_date}, and the \code{auto_gap_fill} function </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will automatically pick the image closest to that date to use as the base </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> As the \code{auto_gap_fill} function automatically chooses images for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> inclusion in the gap fill process, it relies on having images stored on disk </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in a particular way. To ensure that images are correctly stored on your hard </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> disk, use the \code{\link{auto_preprocess_landsat}} function to extract the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> original Landsat CDR hdf files from the USGS archive. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} function will ensure that images are </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> extracted and renamed properly so that they can be used with the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_gap_fill} script.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> sfQuickInit sfQuickStop</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> as.duration new_interval</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">SDMTools</span><span style="color: #00bfff;"> ConnCompLabel</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">data_dir</span><span style="color: #00bfff;"> folder where input images are located, with filenames as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output by the \code{\link{auto_preprocess_landsat}} function. This folder </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be searched recursively for images (taking the below path/row, date, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and topographic correction options into account).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrspath</span><span style="color: #00bfff;"> World Reference System (WRS) path</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrsrow</span><span style="color: #00bfff;"> World Reference System (WRS) row</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">start_date</span><span style="color: #00bfff;"> start date of period from which images will be chosen to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fill cloudy areas in the base image (as \code{Date} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">end_date</span><span style="color: #00bfff;"> end date of period from which images will be chosen to fill </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloudy areas in the the base image (as \code{Date} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">base_date</span><span style="color: #00bfff;"> ideal date for base image (base image will be chosen as the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image among the available images that is closest to this date). If NULL, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> then the base image will be the image with the lowest cloud cover.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tc</span><span style="color: #00bfff;"> if \code{TRUE}, use topographically corrected imagery as output by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat}. IF \code{FALSE} use bands </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> surface </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> reflectance as output by \code{unstack_ledaps} or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} (if \code{auto_preprocess_landsat} was also </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> run with tc=FALSE).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">threshold</span><span style="color: #00bfff;"> maximum percent gap allowable in base image. Gap fill will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> not occur unless percent gap in base image is greater than this value.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">n_cpus</span><span style="color: #00bfff;"> the number of CPUs to use for processes that can run in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parallel</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function).  See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R.  The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments passed to \code{\link{fill_gaps}}, such as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{DN_min}, \code{DN_max}, \code{use_IDL}, \code{verbose}, etc. See </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{fill_gaps}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{Raster*} object with gap filled image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Zhu, X., Liu, D., Chen, J., </span><span style="color: #daa520;">2012</span><span style="color: #00bfff;">. A new geostatistical approach </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for filling gaps in Landsat ETM+ SLC-off images. Remote Sensing of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Environment </span><span style="color: #daa520;">124</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">49</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">60</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">auto_gap_fill</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>data_dir, wrspath, wrsrow, start_date, end_date, 
                          base_date<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, tc<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, threshold<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, n_cpus<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, 
                          notify<span style="color: #00ffff;">=</span>print, verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'auto_gap_fill not yet supported'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, data_dir<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'data_dir does not exist'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Gap fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_cpus <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sfQuickInit</span><span style="color: #20b2aa;">(</span>n_cpus<span style="color: #20b2aa;">)</span>
    wrspath <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, wrspath<span style="color: #20b2aa;">)</span>
    wrsrow <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, wrsrow<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Find image files based on start and end dates</span>
    prefix_re <span style="color: #00ffff;">&lt;-</span> ^<span style="color: #20b2aa;">([</span>a<span style="color: #00ffff;">-</span>zA<span style="color: #00ffff;">-</span>Z<span style="color: #20b2aa;">]</span>*_<span style="color: #20b2aa;">)</span>?
    <span style="color: #00bfff;">#</span><span style="color: #00bfff;">pathrow_re &lt;-[</span><span style="color: #daa520;">012</span><span style="color: #00bfff;">][</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">9</span><span style="color: #00bfff;">]{</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">}-[</span><span style="color: #daa520;">012</span><span style="color: #00bfff;">][</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">9</span><span style="color: #00bfff;">]{</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">}</span>
    pathrow_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>wrspath, wrsrow, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'-'</span><span style="color: #20b2aa;">)</span>
    date_re <span style="color: #00ffff;">&lt;-</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">19</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">01</span><span style="color: #20b2aa;">]))[</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">[</span><span style="color: #daa520;">0123</span><span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">}</span>
    sensor_re <span style="color: #00ffff;">&lt;-</span><span style="color: #20b2aa;">((</span>L<span style="color: #20b2aa;">[</span><span style="color: #daa520;">45</span><span style="color: #20b2aa;">]</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">7</span>E<span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span>L<span style="color: #daa520;">8</span>C<span style="color: #20b2aa;">))</span>SR
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'_tc.tif$'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        suffix_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'.tif$'</span>
    <span style="color: #20b2aa;">}</span>
    file_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix_re, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>pathrow_re, date_re, sensor_re, 
                                       sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">)</span>, suffix_re<span style="color: #20b2aa;">)</span>
    img_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>data_dir, pattern<span style="color: #00ffff;">=</span>file_re, recursive<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, date_re<span style="color: #20b2aa;">)</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #00ff00;">'%Y-%j'</span><span style="color: #20b2aa;">)</span>
    which_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">((</span>img_dates <span style="color: #00ffff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span> &amp;
                          <span style="color: #20b2aa;">(</span>img_dates <span style="color: #00ffff;">&lt;</span> end_date<span style="color: #20b2aa;">))</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">]</span>
    img_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>data_dir, img_files<span style="color: #20b2aa;">[</span>which_files<span style="color: #20b2aa;">])</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no images found - check date_dir, check wrspath, wrsrow, start_date, and end_date'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Only'</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>,
                   <span style="color: #00ff00;">'image(s) found. Need at least two images to perform gap fill'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Found'</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>img_files<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'image(s)'</span><span style="color: #20b2aa;">))</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Analyzing cloud cover and gaps in input images'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Run QA stats - remember band </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> is fmask band, and band </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> is fill_QA</span>
    masks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    imgs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>img_file <span style="color: #ff00ff;">in</span> img_files<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        masks_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>suffix_re, <span style="color: #00ff00;">'_masks.tif'</span>, img_file<span style="color: #20b2aa;">)</span>
        this_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>masks_file, band<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        masks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>masks, this_mask<span style="color: #20b2aa;">)</span>
        this_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>img_file<span style="color: #20b2aa;">)</span>
        imgs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>imgs, <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>this_img<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    freq_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">)</span>, merge<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert frequency table to fractions</span>
    freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Analyzing cloud cover and gaps in input images'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Find image that is either closest to base date, or has the maximum </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">percent not in cloud or gap</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>base_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        clear_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>freq_table$value<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span>clear_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        base_date_diff <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>img_dates, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> 
                                 <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>x, base_date<span style="color: #20b2aa;">)))</span>
        base_date_diff <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
        base_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>base_date_diff <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>base_date_diff<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert masks to binary indicating: </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">=other; </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">=gap, shadow, or cloud.  </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that gaps are coded as NAs in the fmask band.</span>
    <span style="color: #00bfff;">#</span>
    <span style="color: #00bfff;">#   </span><span style="color: #00bfff;">band</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">: fmask_band</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = water</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = cloud_shadow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> = snow</span>
    <span style="color: #00bfff;">#       </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> = cloud</span>
    <span style="color: #00bfff;">#       </span><span style="color: #00bfff;">NA = gap or background</span>
    <span style="color: #00bfff;">#   </span><span style="color: #00bfff;">band </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">: fill_QA</span>
    <span style="color: #00bfff;">#           </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = not fill</span>
    <span style="color: #00bfff;">#           </span><span style="color: #daa520;">255</span><span style="color: #00bfff;"> = fill</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        masks<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]))</span> | <span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>masks<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code areas of imgs that are background, gap, cloud, or shadow as </span><span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>imgs<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        imgs<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">][</span>masks<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #20b2aa;">}</span>
    base_img <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    imgs <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_mask <span style="color: #00ffff;">&lt;-</span> masks<span style="color: #20b2aa;">[[</span>base_img_index<span style="color: #20b2aa;">]]</span>
    masks <span style="color: #00ffff;">&lt;-</span> masks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    base_img_date <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>base_img_index<span style="color: #20b2aa;">]</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_img_index<span style="color: #20b2aa;">]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save base_img in filled so it will be returned if base_img already has </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">pct_gap below threshold</span>
    start_pct_gap <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pct_gap</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Base image has '</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>start_pct_gap, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'% gap before fill'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>start_pct_gap <span style="color: #00ffff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Performing gap fill'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate a raster indicating the pixels in each potential fill image </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">that are available for filling pixels of base_img that are missing </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">due to SLC-off gaps. Areas coded </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> are missing due to gaps in the </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">base image and are available (i.e. are not gaps or clouds) in the </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">merge image.</span>
        fill_areas <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>mask_img <span style="color: #ff00ff;">in</span> masks<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            fill_areas <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>fill_areas, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>base_mask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span> &amp; mask_img <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        fill_areas_freq <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>fill_areas<span style="color: #20b2aa;">)</span>, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span>, merge<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Select the fill image with the maximum number of available pixels </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(counting only pixels in the fill image that are not ALSO in gaps or </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">clouded in the fill image)</span>
        avail_fill_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq$value <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        fill_img_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> 
                                <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>fill_areas_freq<span style="color: #20b2aa;">[</span>avail_fill_row, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
        fill_img <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        imgs <span style="color: #00ffff;">&lt;-</span> imgs<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        cloud_mask <span style="color: #00ffff;">&lt;-</span> fill_areas<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        fill_img_mask <span style="color: #00ffff;">&lt;-</span> masks<span style="color: #20b2aa;">[[</span>fill_img_index<span style="color: #20b2aa;">]]</span>
        masks <span style="color: #00ffff;">&lt;-</span> masks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        fill_img_date <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>fill_img_index<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>fill_img_index<span style="color: #20b2aa;">]</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Mark areas of the cloud_mask where fill_img is blank (clouded) with </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">-</span><span style="color: #daa520;">1</span>
        coded_cloud_mask<span style="color: #20b2aa;">[</span>fill_img_mask<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span>
        <span style="color: #ff6347;">NAvalue</span><span style="color: #20b2aa;">(</span>coded_cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">2</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Filling image from '</span>, base_img_date,
                          <span style="color: #00ff00;">' with image from '</span>, fill_img_date, <span style="color: #00ff00;">'as input image...'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">fill_gaps</span><span style="color: #20b2aa;">(</span>base_img, fill_img, imgs, verbose<span style="color: #00ffff;">=</span>verbose, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Fill complete.'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Revise base mask to account for newly filled pixels</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Fix this</span>
        base_mask<span style="color: #20b2aa;">[</span>coded_cloud_mask <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
        max_iter <span style="color: #00ffff;">&lt;-</span> max_iter <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            final_pct_gap <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pct_gap</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Base image has '</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>final_pct_gap, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'% gap remaining'</span><span style="color: #20b2aa;">))</span>
            timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Performing gap fill'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Percent gap &lt; threshold. Skipping gap fill.'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Gap fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_cpus <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sfQuickStop</span><span style="color: #20b2aa;">(</span>n_cpus<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> auto<sub>normalize</sub>.R</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Normalize a set of preprocessed CDR images to a base image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function uses model II regression to perform relative normalization to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> match a set of Landsat CDR surface reflectance images. The function assumes </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the images were preprocessed using the \code{auto_preprocess_landsat} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> function. A base image can be optionally supplied. If a base image is not </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> supplied, then the function will calculate the percent cloud cover of each </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> input image, and automatically choose the image with the least cloud cover </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as the base image. This function assumes that the images (and image masks) </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> were preprocessed using the \code{auto_preprocess_landsat} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> foreach</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">image_files</span><span style="color: #00bfff;"> list of filenames for images to normalize</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">base</span><span style="color: #00bfff;"> (optional) filename of base image. If not supplied, the base </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image will be automatically chosen from the images in \code{image_files}, as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the image with the lowest percent cloud cover.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing - used for side effect of normalizing imagery</span>
<span style="color: #ff6347;">auto_normalize</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>image_files, base, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    image_stacks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>image_files, stack<span style="color: #20b2aa;">)</span>
    mask_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_masks'</span>, 
                         <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">))</span>
    mask_stacks <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>mask_files, stack<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        base_img_file <span style="color: #00ffff;">&lt;-</span> base
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base<span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'length of image_files is </span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> but no base image was supplied'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Figure out which image has lowest percent cloud cover - use that </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">image as the base image</span>
        <span style="color: #ff6347;">pct_clouds</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            clouded_pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>cloud_mask, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">For fmask layer, </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> is cloud shadow, and </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> is cloud</span>
                <span style="color: #20b2aa;">(</span>vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>vals <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">})</span>
            num_clouds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>clouded_pixels, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">For fmask layer, </span><span style="color: #daa520;">255</span><span style="color: #00bfff;"> is fill</span>
            num_clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>cloud_mask !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">255</span>, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'sum'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>num_clouds <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>num_clouds <span style="color: #00ffff;">+</span> num_clear<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        cloud_cover <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">)</span>,
                 .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span>, <span style="color: #00ff00;">'stringr'</span>, <span style="color: #00ff00;">'rgdal'</span><span style="color: #20b2aa;">)</span>,
                 .combine<span style="color: #00ffff;">=</span>c<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that fmask layer is </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">nd layer in stack</span>
            <span style="color: #ff6347;">pct_clouds</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]])</span>
        <span style="color: #20b2aa;">}</span>
        base_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>cloud_cover <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>cloud_cover<span style="color: #20b2aa;">))</span>

        base_img <span style="color: #00ffff;">&lt;-</span> image_stacks<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        image_stacks <span style="color: #00ffff;">&lt;-</span> image_stacks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_index<span style="color: #20b2aa;">]</span>
        base_img_file <span style="color: #00ffff;">&lt;-</span> image_files<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        image_files <span style="color: #00ffff;">&lt;-</span> image_files<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_index<span style="color: #20b2aa;">]</span>
        base_mask <span style="color: #00ffff;">&lt;-</span> mask_stacks<span style="color: #20b2aa;">[[</span>base_index<span style="color: #20b2aa;">]]</span>
        mask_stacks <span style="color: #00ffff;">&lt;-</span> mask_stacks<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>base_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Copy the base image to a new file with the _base.tif extension</span>
    base_copy_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>base_img_file<span style="color: #20b2aa;">)</span>, 
                                 <span style="color: #00ff00;">'_normbase.tif'</span><span style="color: #20b2aa;">)</span>
    base_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_img, filename<span style="color: #00ffff;">=</span>base_copy_filename, 
                            datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                            overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    base_mask_copy_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>base_img_file<span style="color: #20b2aa;">)</span>, 
                                      <span style="color: #00ff00;">'_normbase_masks.tif'</span><span style="color: #20b2aa;">)</span>
    base_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>base_mask, filename<span style="color: #00ffff;">=</span>base_mask_copy_filename, 
                             datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                             overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_stacks<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">))</span>
    image_file<span style="color: #00ffff;">=</span>image_stack<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Now normalize each remaining image to the _base.tif file</span>
    <span style="color: #ff6347;">foreach</span> <span style="color: #20b2aa;">(</span>image_file<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>image_files<span style="color: #20b2aa;">)</span>, image_stack<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>image_stacks<span style="color: #20b2aa;">)</span>, 
             mask_stack<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mask_stacks<span style="color: #20b2aa;">)</span>,
             .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span>, <span style="color: #00ff00;">'stringr'</span>, <span style="color: #00ff00;">'tools'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Preprocessing '</span>, image_file<span style="color: #20b2aa;">))</span>
        output_normed_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_file<span style="color: #20b2aa;">)</span>, 
                                     <span style="color: #00ff00;">'_normalized.tif'</span><span style="color: #20b2aa;">)</span>
        output_normed_masks_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>image_file<span style="color: #20b2aa;">)</span>, 
                                           <span style="color: #00ff00;">'_normalized_masks.tif'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that fmask layer is </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">nd layer in stack</span>
        missing_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>, mask_stack<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>,
                            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>base_vals, this_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Only use clear pixels when normalizing (</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> in fmask)</span>
            <span style="color: #20b2aa;">(</span>base_vals !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>this_vals !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_mask<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">500000</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            size <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">500000</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            size <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        normed_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">normalize</span><span style="color: #20b2aa;">(</span>base_img, image_stack, missing_vals, size<span style="color: #00ffff;">=</span>size<span style="color: #20b2aa;">)</span>
        normed_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>normed_image, filename<span style="color: #00ffff;">=</span>output_normed_file, 
                                    datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>base_img<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                                    overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
        mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>mask_stack, 
                                  filename<span style="color: #00ffff;">=</span>output_normed_masks_file, 
                                  datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, 
                                  overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> auto<sub>preprocess</sub><sub>landsat</sub>.R</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">get_gdalinfo_item</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>item, gdalinfo_text<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    gdalinfo_text <span style="color: #00ffff;">&lt;-</span> gdalinfo_text<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[ ]*'</span>, item<span style="color: #20b2aa;">)</span>, gdalinfo_text<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>gdalinfo_text<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'more than one item found'</span><span style="color: #20b2aa;">)</span>
    gdalinfo_text <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[ ]*'</span>, item, <span style="color: #00ff00;">'='</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">''</span>, gdalinfo_text<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>gdalinfo_text<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">get_mtl_item</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>item, mtl_txt<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    mtl_txt <span style="color: #00ffff;">&lt;-</span> mtl_txt<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[ ]*'</span>, item<span style="color: #20b2aa;">)</span>, mtl_txt<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>mtl_txt<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'more than one item found'</span><span style="color: #20b2aa;">)</span>
    mtl_txt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[ ]*'</span>, item, <span style="color: #00ff00;">' = '</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">''</span>, mtl_txt<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Strip leading/following quotes</span>
    mtl_txt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^'</span>, <span style="color: #00ff00;">''</span>, mtl_txt<span style="color: #20b2aa;">)</span>
    mtl_txt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'$'</span>, <span style="color: #00ff00;">''</span>, mtl_txt<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>mtl_txt<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00bfff;"> gdalinfo</span>
<span style="color: #ff6347;">get_metadata</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>ls_file, img_type<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    meta <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ls_file_gdalinfo <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gdalinfo</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>
        aq_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'AcquisitionDate'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">)</span>
        meta$aq_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">strptime</span><span style="color: #20b2aa;">(</span>aq_date, format<span style="color: #00ffff;">=%</span>Y<span style="color: #00ffff;">-%</span>m<span style="color: #00ffff;">-%</span>dT<span style="color: #00ffff;">%</span>H:<span style="color: #00ffff;">%</span>M:<span style="color: #00ffff;">%</span>OSZ, tz<span style="color: #00ffff;">=</span>UTC<span style="color: #20b2aa;">)</span>
        meta$WRS_Path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'WRS_Path'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">)))</span>
        meta$WRS_Row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'WRS_Row'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">)))</span>
        meta$sunelev <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">90</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SolarZenith'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">))</span>
        meta$sunazimuth <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SolarAzimuth'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">))</span>
        meta$short_name  <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_gdalinfo_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'ShortName'</span>, ls_file_gdalinfo<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>_MTL.txt$, ls_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>ls_file must be a *_MTL.txt file<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        mtl_txt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readLines</span><span style="color: #20b2aa;">(</span>ls_file, warn<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        aq_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'DATE_ACQUIRED'</span>, mtl_txt<span style="color: #20b2aa;">)</span>
        aq_time <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SCENE_CENTER_TIME'</span>, mtl_txt<span style="color: #20b2aa;">)</span>
        meta$aq_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">strptime</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>aq_date, <span style="color: #daa520;">T</span>, aq_time<span style="color: #20b2aa;">)</span>, format<span style="color: #00ffff;">=%</span>Y<span style="color: #00ffff;">-%</span>m<span style="color: #00ffff;">-%</span>dT<span style="color: #00ffff;">%</span>H:<span style="color: #00ffff;">%</span>M:<span style="color: #00ffff;">%</span>OSZ, tz<span style="color: #00ffff;">=</span>UTC<span style="color: #20b2aa;">)</span>
        meta$WRS_Path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'WRS_PATH'</span>, mtl_txt<span style="color: #20b2aa;">)))</span>
        meta$WRS_Row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'WRS_ROW'</span>, mtl_txt<span style="color: #20b2aa;">)))</span>
        meta$sunelev <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SUN_ELEVATION'</span>, mtl_txt<span style="color: #20b2aa;">))</span>
        meta$sunazimuth <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SUN_AZIMUTH'</span>, mtl_txt<span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Build a shortname based on satellite and img_type that is consistent </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">with the format of the CDR image shortnames</span>
        satellite <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">get_mtl_item</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'SPACECRAFT_ID'</span>, mtl_txt<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'[</span><span style="color: #daa520;">4578</span><span style="color: #00ff00;">]'</span><span style="color: #20b2aa;">)</span>
        sensor_string <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'^((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))'</span><span style="color: #20b2aa;">)</span>
        meta$short_name  <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>,
                                   <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                                   <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sensor_string, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, img_type<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>meta<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">calc_cloud_mask</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>mask_stack, mask_type, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'fmask'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Make a mask where clouds and gaps are coded as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, clear as </span><span style="color: #daa520;">0</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">fmask_band key:</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> = clear</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> = water</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> = cloud_shadow</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> = snow</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> = cloud</span>
        <span style="color: #00bfff;">#       </span><span style="color: #daa520;">255</span><span style="color: #00bfff;"> = fill value</span>
        cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>mask_stack$fmask_band,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>fmask<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">This cloud mask includes the cloud_QA, cloud_shadow_QA, and </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">adjacent_cloud_QA layers. Pixels in cloud, cloud shadow, or </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">adjacent cloud are coded as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">.</span>
        cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>mask_stack$fill_QA,
                              mask_stack$cloud_QA, 
                              mask_stack$cloud_shadow_QA, 
                              mask_stack$adjacent_cloud_QA,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>fill, clo, sha, adj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>fill <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>clo <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>sha <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | 
                       <span style="color: #20b2aa;">(</span>adj <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>mask_type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'both'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>mask_stack$fmask_band, 
                              mask_stack$cloud_QA, 
                              mask_stack$cloud_shadow_QA, 
                              mask_stack$adjacent_cloud_QA,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>fmask, clo, sha, adj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">((</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>fmask <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | 
                       <span style="color: #20b2aa;">(</span>clo <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>sha <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">)</span> | <span style="color: #20b2aa;">(</span>adj <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'unrecognized option '</span>, cloud_mask, <span style="color: #00ff00;">' for mask_type'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>

<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00bfff;"> get_subdatasets gdalbuildvrt</span>
<span style="color: #ff6347;">build_band_vrt</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>ls_file, band_vrt_file, img_type<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    image_bands <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'band</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'band</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'band</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'band</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'band</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'band</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_subdatasets</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>
        band_sds <span style="color: #00ffff;">&lt;-</span> sds<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">':('</span>, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>image_bands, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'|'</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">')$'</span><span style="color: #20b2aa;">)</span>, sds<span style="color: #20b2aa;">)]</span>
        <span style="color: #ff6347;">gdalbuildvrt</span><span style="color: #20b2aa;">(</span>band_sds, band_vrt_file, separate<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>_MTL.txt$, ls_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>ls_file must be a *_MTL.txt file<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        ls_file_base <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>_MTL.txt, <span style="color: #00ff00;">", ls_file)</span>
<span style="color: #00ff00;">        ls_files &lt;- dir(dirname(ls_file_base),</span>
<span style="color: #00ff00;">                        pattern=paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(basename(ls_file_base), '_B[</span><span style="color: #daa520;">123457</span><span style="color: #00ff00;">].((TIF)|(tif))$'),</span>
<span style="color: #00ff00;">                        full.names=TRUE)</span>
<span style="color: #00ff00;">        gdalbuildvrt(ls_files, band_vrt_file, separate=TRUE)</span>

<span style="color: #00ff00;">    } else {</span>
<span style="color: #00ff00;">        stop(paste(img_type, is not a recognized img_type))</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    return(image_bands)</span>
<span style="color: #00ff00;">}</span>

<span style="color: #00ff00; font-weight: bold;">#'</span><span style="color: #00ff00;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00ff00;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00ff00;"> get_subdatasets gdalbuildvrt</span>
<span style="color: #ff6347;">build_mask_vrt</span><span style="color: #00ff00;"> &lt;- function(ls_file, mask_vrt_file, img_type) {</span>
<span style="color: #00ff00;">    if (img_type == CDR) {</span>
<span style="color: #00ff00;">        mask_bands &lt;- c('fill_QA', 'cfmask_band', 'cloud_QA', 'cloud_shadow_QA', </span>
<span style="color: #00ff00;">                        'adjacent_cloud_QA')</span>
<span style="color: #00ff00;">        sds &lt;- get_subdatasets(ls_file)</span>
<span style="color: #00ff00;">        # Below is to support CDR imagery downloaded prior to late August </span><span style="color: #daa520;">2014</span>
<span style="color: #00ff00;">        if (any(grepl(fmask_band, sds))) {</span>
<span style="color: #00ff00;">            warning('Using fmask_band instead of newer cfmask_band band name')</span>
<span style="color: #00ff00;">            mask_bands[grepl(^cfmask_band$, mask_bands)] &lt;- fmask_band</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        mask_sds &lt;- sds[grepl(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(':(', paste(mask_bands, collapse='|'), ')$'), sds)]</span>
<span style="color: #00ff00;">        stopifnot(length(mask_sds) == </span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)</span>
<span style="color: #00ff00;">        gdalbuildvrt(mask_sds, mask_vrt_file, separate=TRUE, srcnodata='None')</span>
<span style="color: #00ff00;">    } else if (img_type == L</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">T) {</span>
<span style="color: #00ff00;">        mask_bands &lt;- c('fill_QA', 'fmask_band')</span>
<span style="color: #00ff00;">        if (!grepl(_MTL.txt$, ls_file)) {</span>
<span style="color: #00ff00;">            stop(ls_file must be a *_MTL.txt file)</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        ls_file_base &lt;- gsub(_MTL.txt, "</span>, ls_file<span style="color: #20b2aa;">)</span>

        fmask_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>ls_file_base<span style="color: #20b2aa;">)</span>,
                          pattern<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>ls_file_base<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_MTLFmask$'</span><span style="color: #20b2aa;">)</span>,
                          full.names<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate a QA mask file from the fmask file, since teamlucc expects </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">this file as part of the mask stack.</span>
        qa_mask_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, <span style="color: #00ff00;">'.tif'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Check if this is proper coding - should it be reversed?</span>
        qa_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>fmask_file<span style="color: #20b2aa;">)</span>,
                        fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                            out <span style="color: #00ffff;">&lt;-</span> x <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span>
                            out<span style="color: #20b2aa;">[</span>x <span style="color: #00ffff;">==</span> <span style="color: #daa520;">255</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">255</span>
                            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
                        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span>INT<span style="color: #daa520;">2</span>S, filename<span style="color: #00ffff;">=</span>qa_mask_file<span style="color: #20b2aa;">)</span>

        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that allow_projection_difference is used below as GDAL thinks </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the two images have different projection systems, even though they </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">are in identical projection systems.</span>
        <span style="color: #ff6347;">gdalbuildvrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>qa_mask_file, fmask_file<span style="color: #20b2aa;">)</span>, mask_vrt_file, 
                     separate<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, allow_projection_difference<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>,
                     srcnodata<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'None'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>mask_bands<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>

<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Preprocess surface reflectance imagery from the Landsat CDR archive</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function preprocesses surface reflectance imagery from the Landsat </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Climate Data Record (CDR) archive. \code{auto_preprocess_landsat} can </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> reproject CDR tiles to match the projection of a given \code{aoi}, crop the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> tiles to match the \code{aoi} or a common WRS-</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> path/row polygon, mask </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> missing data and clouds out of the CDR tiles, and perform topographic </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> correction.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{mask_type} chooses the cloud mask to use if topographic correction is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> performed (\code{tc=TRUE}). The mask can be one of three different options: </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">S, fmask, or combined. Each option uses a different combination of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloud mask layers from the CDR product. The </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">S masks out any areas coded </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as fill (fill_QA=</span><span style="color: #daa520;">255</span><span style="color: #00bfff;">), cloud (cloud_QA=</span><span style="color: #daa520;">255</span><span style="color: #00bfff;">), cloud shadow</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (cloud_shadow_QA=</span><span style="color: #daa520;">255</span><span style="color: #00bfff;">) or adjacent to cloud (adjacent_cloud_QA=</span><span style="color: #daa520;">255</span><span style="color: #00bfff;">). The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fmask option masks out any areas coded as fill (fmask=</span><span style="color: #daa520;">255</span><span style="color: #00bfff;">), cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (fmask=</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">) or cloud shadow (fmask=</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">).  The combined option combines the </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">S </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and fmask approaches to masks out areas coded as fill, cloud, cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> shadow, or adjacent to cloud using either method. Note that fmask is the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> only supported option when \code{img_type} is L</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Prior to running \code{auto_preprocess_landsat}, \code{\link{espa_extract}} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> should be used to extract the original zipfiles supplied by USGS. To perform </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> topographic correction with \code{auto_preprocess_landsat}, first run </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{auto_setup_dem}} to preprocess a set of DEM tiles. Then run </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{auto_preprocess_landsat} with the \code{tc=TRUE} option.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> If topographic correction is being performed, it will be run in parallel if </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> a parallel backend is registered with \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgeos</span><span style="color: #00bfff;"> gIntersection</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrspathrow</span><span style="color: #00bfff;"> pathrow_poly</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00bfff;"> gdalwarp</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> is.projected</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">image_dirs</span><span style="color: #00bfff;"> list of paths to a set of Landsat CDR image files in HDF </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> format</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">prefix</span><span style="color: #00bfff;"> string to use as a prefix for all filenames</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">img_type</span><span style="color: #00bfff;"> type of Landsat imagery to preprocess. Can be CDR for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat Climate Data Record (CDR) imagery in HDR format, or L</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Standard Terrain Correction (Level </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T) imagery. Note that if L</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">T imagery is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> used, fmask must be run locally (see https://code.google.com/p/fmask) prior </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to using \code{auto_preprocess_landsat}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tc</span><span style="color: #00bfff;"> whether to topographically correct imagery (if \code{TRUE}, then </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{dem_path} must be specified)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dem_path</span><span style="color: #00bfff;"> path to a set of DEMs as output by \code{auto_setup_dem} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (only required if tc=TRUE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">aoi</span><span style="color: #00bfff;"> area of interest (AOI), as a \code{SpatialPolygonsDataFrame}.  If </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> supplied, this aoi is used to crop and set the projection system of the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output. Must be in a projected coordinate system.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_path</span><span style="color: #00bfff;"> the path to use for the output (optional - if NULL then </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output images will be saved alongside the input images in the same folder).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">mask_type</span><span style="color: #00bfff;"> which cloud mask to use to mask clouds when performing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> topographic correction. Can be one of fmask, </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">S, or both.  See </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Details.  (Ignored if \code{tc=FALSE)}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">mask_output</span><span style="color: #00bfff;"> if \code{TRUE}, cloud, cloud shadow, and fill areas </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (SLC-off gaps and areas with no data) will be set to \code{NA} in the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output. Note this setting affects the final output file only - cloud, cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> shadow, and gap areas are masked out of the image during topographic </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> correction regardless of the value of \code{mask_output}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">n_cpus</span><span style="color: #00bfff;"> the number of CPUs to use for processes that can run in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parallel</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cleartmp</span><span style="color: #00bfff;"> whether to clear temp files on each run through the loop</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">of</span><span style="color: #00bfff;"> output format to use when saving output rasters. See description </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of \code{of} in \code{\link{gdalwarp}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when saving output rasters (determines </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output file format). Should match file extension for output format chosen by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{of}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function). See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages and timing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> information</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing - used for the side effect of preprocessing imagery</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{espa_extract}}, \code{\link{unstack_ledapscdr}}, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{auto_setup_dem}}</span>
<span style="color: #ff6347;">auto_preprocess_landsat</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>image_dirs, prefix, img_type<span style="color: #00ffff;">=</span>CDR, 
                                    tc<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, dem_path<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, aoi<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                                    output_path<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, mask_type<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'fmask'</span>, 
                                    mask_output<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, n_cpus<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, 
                                    cleartmp<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>,  overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                                    of<span style="color: #00ffff;">=</span>GTiff, ext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'tif'</span>, notify<span style="color: #00ffff;">=</span>print, 
                                    verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_'</span>, prefix<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'prefix cannot contain underscores (_)'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc &amp;&amp; <span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>dem_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'dem_path must be supplied if tc=TRUE'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc &amp;&amp; !<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, dem_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>dem_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'aoi should be a SpatialPolygonsDataFrame of length </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.projected</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>

    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup a regex to identify Landsat CDR images</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ls_regex <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'^(lndsr.)?((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[a-zA-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}.hdf$'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ls_regex <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[a-zA-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}_MTL.txt$'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>img_type, is not a recognized img_type<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> CDR<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>mask_type <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask'</span>, <span style="color: #00ff00;">'</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">S'</span>, <span style="color: #00ff00;">'both'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>img_type <span style="color: #00ffff;">==</span> L<span style="color: #daa520;">1</span>T<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>mask_type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'fmask'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    ls_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>image_dir <span style="color: #ff00ff;">in</span> image_dirs<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, image_dir<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>image_dir, does not exist<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        ls_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>ls_files, <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>image_dir, pattern<span style="color: #00ffff;">=</span>ls_regex, full.names<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>ls_files<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'No Landsat files found using img_type='</span>, img_type, <span style="color: #00ff00;">'.'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>ls_file <span style="color: #ff00ff;">in</span> ls_files<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Determine image basename for use in naming subsequent files</span>
        meta <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_metadata</span><span style="color: #20b2aa;">(</span>ls_file, img_type<span style="color: #20b2aa;">)</span>

        image_basename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>meta$WRS_Path, <span style="color: #00ff00;">'-'</span>, meta$WRS_Row, <span style="color: #00ff00;">'_'</span>,
                                 <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>meta$aq_date, <span style="color: #00ff00;">'%Y-%j'</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_'</span>, meta$short_name<span style="color: #20b2aa;">)</span>

        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            this_output_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>ls_file<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            this_output_path  <span style="color: #00ffff;">&lt;-</span> output_path
        <span style="color: #20b2aa;">}</span>

        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            output_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>this_output_path,
                                         <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix, <span style="color: #00ff00;">'_'</span>, image_basename, 
                                                <span style="color: #00ff00;">'_tc.'</span>, ext<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Skip topographic correction, so don't append _tc to filename</span>
            output_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>this_output_path,
                                         <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>prefix, <span style="color: #00ff00;">'_'</span>, image_basename, 
                                                <span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>

        log_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>output_filename<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_log.txt'</span><span style="color: #20b2aa;">)</span>, open<span style="color: #00ffff;">=</span>wt<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">msg</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>txt, <span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>, file<span style="color: #00ffff;">=</span>log_file, append<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>

        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>msg<span style="color: #20b2aa;">)</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Preprocessing'</span>, image_basename<span style="color: #20b2aa;">))</span>

        <span style="color: #00bfff;">#######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Crop and reproject images to match the projection being used for this </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">image.  This is either the projection of the aoi (if aoi is </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">supplied), or the UTM zone of the centroid of this path and row.</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'cropping and reprojecting'</span><span style="color: #20b2aa;">)</span>

        band_vrt_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, <span style="color: #00ff00;">'.vrt'</span><span style="color: #20b2aa;">)</span>
        band_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">build_band_vrt</span><span style="color: #20b2aa;">(</span>ls_file, band_vrt_file, img_type<span style="color: #20b2aa;">)</span>
        mask_vrt_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, <span style="color: #00ff00;">'.vrt'</span><span style="color: #20b2aa;">)</span>
        mask_band_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">build_mask_vrt</span><span style="color: #20b2aa;">(</span>ls_file, mask_vrt_file, img_type<span style="color: #20b2aa;">)</span>

        this_pathrow_poly <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pathrow_poly</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span>meta$WRS_Path<span style="color: #20b2aa;">)</span>, 
                                          <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span>meta$WRS_Row<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">utm_zone</span><span style="color: #20b2aa;">(</span>this_pathrow_poly, proj<span style="color: #daa520;">4</span>string<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>

        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate minimum bounding box coordinates:</span>
        this_pathrow_poly <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>this_pathrow_poly, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>to_srs<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">If an aoi IS supplied, match the image extent to that of the AOI </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cropped to the appropriate Landsat path/row polygon.</span>
            crop_area <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gIntersection</span><span style="color: #20b2aa;">(</span>this_pathrow_poly, aoi, byid<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">If an aoi IS NOT supplied, match the image extent to the </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">appropriate Landsat path/row polygon.</span>
            crop_area <span style="color: #00ffff;">&lt;-</span> this_pathrow_poly
        <span style="color: #20b2aa;">}</span>
        out_te <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>crop_area<span style="color: #20b2aa;">))</span>

        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure origin is set at </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">0</span>
        to_res <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">30</span>, <span style="color: #daa520;">30</span><span style="color: #20b2aa;">)</span>
        out_te <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">normalize_extent</span><span style="color: #20b2aa;">(</span>out_te, to_res<span style="color: #20b2aa;">)</span>

        image_stack_reproj_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>
        image_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gdalwarp</span><span style="color: #20b2aa;">(</span>band_vrt_file,
                                dstfile<span style="color: #00ffff;">=</span>image_stack_reproj_file,
                                te<span style="color: #00ffff;">=</span>out_te, t_srs<span style="color: #00ffff;">=</span>to_srs, tr<span style="color: #00ffff;">=</span>to_res, 
                                r<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'cubicspline'</span>, output_Raster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, of<span style="color: #00ffff;">=</span>of, 
                                multi<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, wo<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>NUM_THREADS<span style="color: #00ffff;">=</span>, n_cpus<span style="color: #20b2aa;">)</span>, 
                                overwrite<span style="color: #00ffff;">=</span>overwrite, ot<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> band_names

        mask_stack_reproj_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">))</span>
        mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gdalwarp</span><span style="color: #20b2aa;">(</span>mask_vrt_file,
                               dstfile<span style="color: #00ffff;">=</span>mask_stack_reproj_file,
                               te<span style="color: #00ffff;">=</span>out_te, t_srs<span style="color: #00ffff;">=</span>to_srs, tr<span style="color: #00ffff;">=</span>to_res, 
                               r<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'near'</span>, output_Raster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, of<span style="color: #00ffff;">=</span>of, 
                               multi<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, wo<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>NUM_THREADS<span style="color: #00ffff;">=</span>, n_cpus<span style="color: #20b2aa;">)</span>, 
                               overwrite<span style="color: #00ffff;">=</span>overwrite, ot<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Can't just directly assign mask_bands as the names since the bands </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">may have been read in different order from the HDF file</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> mask_band_names

        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'cropping and reprojecting'</span><span style="color: #20b2aa;">)</span>

        <span style="color: #00bfff;">######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Perform topographic correction if tc=TRUE</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>tc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'topocorr'</span><span style="color: #20b2aa;">)</span>

            <span style="color: #00bfff;">######################################################################</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Load dem, slope, and aspect</span>
            slopeaspect_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>dem_path,
                                              <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slopeaspect_'</span>, 
                                                     meta$WRS_Path, <span style="color: #00ff00;">'-'</span>, meta$WRS_Row, <span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">))</span>
            slopeaspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>slopeaspect_filename<span style="color: #20b2aa;">)</span>

            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">comp</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slopeaspect and image_stack projections do not match.\nslopeaspect proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string: '</span>, 
                            <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\nimage_stack proj</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">string: '</span>,
                            <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Projection strings are functionally identical - so make sure </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">their textual representations are the same.</span>
                <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>image_stack<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>

            <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>slopeaspect, image_stack, orig<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>

            image_stack_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc_cloud_mask</span><span style="color: #20b2aa;">(</span>mask_stack, mask_type<span style="color: #20b2aa;">)</span>

            image_stack_masked <span style="color: #00ffff;">&lt;-</span> image_stack
            image_stack_masked<span style="color: #20b2aa;">[</span>image_stack_mask<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>image_stack_masked<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">500000</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Draw a sample for the Minnaert k regression. Note that </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">sampleRegular with cells=TRUE returns cell numbers in the </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">first column</span>
                sampleindices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>image_stack_masked, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">500000</span>, 
                                               cells<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
                sampleindices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.vector</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                sampleindices <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
            <span style="color: #20b2aa;">}</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Remember that slopeaspect layers are scaled to INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S, but </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">topographic_corr expects them as floats, so apply the scale factors </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">used in auto_setup_dem</span>
            slopeaspect_flt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">10000</span>,
                                     <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">1000</span><span style="color: #20b2aa;">)</span>
            image_stack_tc <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">topographic_corr</span><span style="color: #20b2aa;">(</span>image_stack_masked, 
                                               slopeaspect_flt, meta$sunelev, 
                                               meta$sunazimuth, 
                                               method<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'minnaert_full'</span>, 
                                               asinteger<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                                               sampleindices<span style="color: #00ffff;">=</span>sampleindices<span style="color: #20b2aa;">)</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!mask_output<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Add back in the original values of areas that were masked out </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">from the topographic correction:</span>
                image_stack_tc<span style="color: #20b2aa;">[</span>image_stack_mask<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> image_stack<span style="color: #20b2aa;">[</span>image_stack_mask<span style="color: #20b2aa;">]</span>
            <span style="color: #20b2aa;">}</span>
            image_stack <span style="color: #00ffff;">&lt;-</span> image_stack_tc

            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'topocorr'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>

        <span style="color: #00bfff;">######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Write final data</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'writing data'</span><span style="color: #20b2aa;">)</span>

        mask_stack_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>output_filename<span style="color: #20b2aa;">)</span>, 
                                  <span style="color: #00ff00;">'_masks.'</span>, ext<span style="color: #20b2aa;">)</span>
        mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>mask_stack$fill_QA,
                                        mask_stack$fmask_band<span style="color: #20b2aa;">)</span>,
                                  filename<span style="color: #00ffff;">=</span>mask_stack_path, 
                                  overwrite<span style="color: #00ffff;">=</span>overwrite, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fill_QA'</span>, <span style="color: #00ff00;">'fmask_band'</span><span style="color: #20b2aa;">)</span>

        image_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>image_stack, filename<span style="color: #00ffff;">=</span>output_filename, 
                                   overwrite<span style="color: #00ffff;">=</span>overwrite, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'writing data'</span><span style="color: #20b2aa;">)</span>

        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Preprocessing'</span>, image_basename<span style="color: #20b2aa;">))</span>

        <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>log_file<span style="color: #20b2aa;">)</span>

        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>cleartmp<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">removeTmpFiles</span><span style="color: #20b2aa;">(</span>h<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> auto<sub>QA</sub><sub>stats</sub>.R</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff;"># </span><span style="color: #00bfff;">Function for retrieving frequencies from a raster frequency table, given a </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">band name and value. Handles the case of a given code not occurring in a </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">particular raster, in which case it will not show up as a row in the </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">frequency table.</span>
<span style="color: #ff6347;">get_freq</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>band, value, freq_table<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    band_col <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>band, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>value <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> freq_table<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Return </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> if this value never shows up in the raster</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    frac <span style="color: #00ffff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> value, band_col<span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>frac<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>frac, <span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate statistics on imagery within an AOI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">image_dirs</span><span style="color: #00bfff;"> list of paths to a set of Landsat CDR image files in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> GeoTIFF format as output by the \code{unstack_ledapscdr} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">aoi</span><span style="color: #00bfff;"> an area of interest (AOI) to crop from each image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{data.frame}</span>
<span style="color: #ff6347;">auto_QA_stats</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>image_dirs, aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lndsr_regex <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'^(lndsr.)?((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">12</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}[a-zA-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}'</span>
    mask_bands <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fill_QA'</span>, <span style="color: #00ff00;">'fmask_band'</span><span style="color: #20b2aa;">)</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>image_dir <span style="color: #ff00ff;">in</span> image_dirs<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        lndsr_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>image_dir, pattern<span style="color: #00ffff;">=</span>lndsr_regex<span style="color: #20b2aa;">)</span>
        image_basenames <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>lndsr_files,lndsr_regex<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>image_basenames<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no files found in'</span>, image_dir<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>image_basename <span style="color: #ff00ff;">in</span> image_basenames<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Processing '</span>, image_basename, <span style="color: #00ff00;">'...'</span><span style="color: #20b2aa;">))</span>
            metadata_string <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>image_basename, 
                                           <span style="color: #00ff00;">'((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">13</span><span style="color: #00ff00;">}'</span><span style="color: #20b2aa;">)</span>
            sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #00ff00;">'^((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))'</span><span style="color: #20b2aa;">)</span>
            year <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">13</span><span style="color: #20b2aa;">)</span>
            julian_day <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">14</span>, <span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
            img_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>
            img_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">9</span><span style="color: #20b2aa;">)</span>
            mask_band_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
            <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>mask_band <span style="color: #ff00ff;">in</span> mask_bands<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                mask_band_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>mask_band_files,
                                     <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>image_dir, 
                                                     image_basename<span style="color: #20b2aa;">)</span>, 
                                           mask_band, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_'</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>
            mask_band_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>mask_band_files, <span style="color: #00ff00;">'.tif'</span><span style="color: #20b2aa;">)</span>
            mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>mask_band_files<span style="color: #20b2aa;">)</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> mask_bands
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Raster'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        aoi <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">projectRaster</span><span style="color: #20b2aa;">(</span>aoi, mask_stack<span style="color: #20b2aa;">)</span>
                    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                        aoi <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>aoi, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>mask_stack<span style="color: #20b2aa;">)))</span>
                    <span style="color: #20b2aa;">}</span>
                <span style="color: #20b2aa;">}</span>
                mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">crop</span><span style="color: #20b2aa;">(</span>mask_stack, aoi<span style="color: #20b2aa;">)</span>
                mask_stack <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>mask_stack, aoi<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            freq_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>mask_stack, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span>, merge<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert frequency table to fractions</span>
            freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">colSums</span><span style="color: #20b2aa;">(</span>freq_table<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>img_path,
                                    img_row,
                                    year,
                                    julian_day,
                                    sensor,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fill_QA'</span>, <span style="color: #daa520;">0</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fill_QA'</span>, <span style="color: #daa520;">255</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">0</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">1</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">2</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">3</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">4</span>, freq_table<span style="color: #20b2aa;">)</span>,
                                    <span style="color: #ff6347;">get_freq</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fmask_band'</span>, <span style="color: #daa520;">255</span>, freq_table<span style="color: #20b2aa;">))))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, byrow<span style="color: #00ffff;">=</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'path'</span>, <span style="color: #00ff00;">'row'</span>, <span style="color: #00ff00;">'year'</span>, <span style="color: #00ff00;">'julian'</span>, <span style="color: #00ff00;">'sensor'</span>,
                    <span style="color: #00ff00;">'fill_QA_notfill'</span>, <span style="color: #00ff00;">'fill_QA_fill'</span>, <span style="color: #00ff00;">'fmask_clear'</span>, 
                    <span style="color: #00ff00;">'fmask_water'</span>, <span style="color: #00ff00;">'fmask_cloud_shadow'</span>, <span style="color: #00ff00;">'fmask_snow'</span>, 
                    <span style="color: #00ff00;">'fmask_cloud'</span>, <span style="color: #00ff00;">'fmask_fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> auto<sub>setup</sub><sub>dem</sub>.R</h2>
<div class="outline-text-2" id="text-11">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">normalize_extent</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>te, res<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">30</span>, <span style="color: #daa520;">30</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup xmin</span>
    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup ymin</span>
    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup xmax</span>
    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Setup ymax</span>
    te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">%%</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">==</span> <span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> res<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>te<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Setup the DEM mosaic for a given AOI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will setup a set of DEM tiles for each the Landsat path/row </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> needed to cover a given AOI. The tiles can optionally be cropped to cover </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> only the portion of each path/row that is included in the AOI, or can cover </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the full scene for each path/row needed to cover the AOI.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function uses \code{gdalUtils}, which requires a local GDAL </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> installation.  See http://trac.osgeo.org/gdal/wiki/DownloadingGdalBinaries </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> or http://trac.osgeo.org/osgeo</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">w/ to download the appropriate installer for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> your operating system.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">wrspathrow</span><span style="color: #00bfff;"> pathrow_num</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgdal</span><span style="color: #00bfff;"> readOGR writeOGR</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> spTransform is.projected</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgeos</span><span style="color: #00bfff;"> gBuffer gIntersects gUnaryUnion gIntersection</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00bfff;"> mosaic_rasters gdalwarp</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">aoi</span><span style="color: #00bfff;"> area of interest (AOI), as a \code{SpatialPolygonsDataFrame}, to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> use as as bounding box when selecting DEMs. Also used to crop and set </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> projection of the output DEM(s) if \code{crop_to_aoi=TRUE}. Must be in a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> projected coordinate system.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_path</span><span style="color: #00bfff;"> the path to use for the output</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dem_extents</span><span style="color: #00bfff;"> a \code{SpatialPolygonsDataFrame} of the extents and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> filenames for a set of locally available DEM raster(s) that cover the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{aoi}. See the \code{\link{get_extent_polys}} function for one means of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> generating this list. \code{dem_extents} must have a filename column.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">of</span><span style="color: #00bfff;"> output format to use when saving output rasters. See description </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of \code{of} in \code{\link{gdalwarp}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when saving output rasters (determines </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> output file format). Should match file extension for output format chosen by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{of}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">n_cpus</span><span style="color: #00bfff;"> the number of CPUs to use for processes that can run in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parallel</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">crop_to_aoi</span><span style="color: #00bfff;"> whether to crop the dem to the supplied AOI, or to the</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat path/row polygon for that particular path/row</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> notifier to use (defaults to \code{print} function). See the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notifyR} package for one way of sending notifications from R. The </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{notify} function should accept a string as the only argument.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages and timing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> information</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing - used for the side effect of setting up DEMs</span>
<span style="color: #ff6347;">auto_setup_dem</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>aoi, output_path, dem_extents, of<span style="color: #00ffff;">=</span>GTiff, 
                           ext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'tif'</span>, n_cpus<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                           crop_to_aoi<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, notify<span style="color: #00ffff;">=</span>print, verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">-</span>d, output_path<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_path, does not exist<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'aoi should be a SpatialPolygonsDataFrame of length </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.projected</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">))</span>
    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Track_time</span><span style="color: #20b2aa;">(</span>notify<span style="color: #20b2aa;">)</span>
    pathrows <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pathrow_num</span><span style="color: #20b2aa;">(</span>aoi, wrs_type<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span>, wrs_mode<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'D'</span>, as_polys<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    aoi_prproj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>aoi, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)))</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Processing DEMS for'</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, 
                                            <span style="color: #00ff00;">'path/rows'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>crop_to_aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Do a rough crop of the pathrows to the AOI in the pathrow CRS </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(pathrow will later be cropped in the AOI CRS).</span>
        pathrows_cropped <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gIntersection</span><span style="color: #20b2aa;">(</span>pathrows, aoi_prproj, byid<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>pathrows_cropped<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>
        pathrows_cropped <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>pathrows_cropped, 
                                                     data<span style="color: #00ffff;">=</span>pathrows@data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        pathrows_cropped <span style="color: #00ffff;">&lt;-</span> pathrows
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Add a </span><span style="color: #daa520;">500</span><span style="color: #00bfff;"> m buffer in UTM coordinate system, as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) slope calculation </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">requires a window of pixels, and </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) this buffer also helps avoid missing </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">pixels on the sides of the DEM due to slight misalignments from the </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">reprojection that will occur later. After buffering transform back to </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">WGS</span><span style="color: #daa520;">84</span><span style="color: #00bfff;"> to use for preliminary cropping of the dem mosaic. </span>
    pathrows_utm <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>pathrows_cropped,
                                <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone</span><span style="color: #20b2aa;">(</span>pathrows_cropped, proj<span style="color: #daa520;">4</span>string<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)))</span>
    pathrows_buffered <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gBuffer</span><span style="color: #20b2aa;">(</span>pathrows_utm, width<span style="color: #00ffff;">=</span><span style="color: #daa520;">500</span>, byid<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, 
                                 <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>dem_extents<span style="color: #20b2aa;">)))</span>
    intersecting <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.logical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gIntersects</span><span style="color: #20b2aa;">(</span>dem_extents, 
                                           <span style="color: #ff6347;">gUnaryUnion</span><span style="color: #20b2aa;">(</span>pathrows_buffered<span style="color: #20b2aa;">)</span>, byid<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>intersecting<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no intersecting dem extents found'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        dem_extents <span style="color: #00ffff;">&lt;-</span> dem_extents<span style="color: #20b2aa;">[</span>intersecting, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    dem_list <span style="color: #00ffff;">&lt;-</span> dem_extents$filename
    dem_rasts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>dem_list, raster<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>dem_list<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Verify projections of DEMs match</span>
        dem_prj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>dem_rasts<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>dem_rasts, projection<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> dem_prj<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>each DEM <span style="color: #ff00ff;">in</span> dem_list must have the same projection<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #00bfff;">######################################################################</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Mosaic DEMs</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Mosaicking DEMs'</span><span style="color: #20b2aa;">)</span>
        mosaic_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, ext<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate minimum bounding box coordinates:</span>
        mosaic_te <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>pathrows_buffered<span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Use mosaic_rasters from gdalUtils for speed:</span>
        <span style="color: #ff6347;">mosaic_rasters</span><span style="color: #20b2aa;">(</span>dem_list, mosaic_file, te<span style="color: #00ffff;">=</span>mosaic_te, of<span style="color: #00ffff;">=</span>of, 
                       overwrite<span style="color: #00ffff;">=</span>overwrite, ot<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
        dem_mosaic <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>mosaic_file<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Mosaicking DEMs'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        dem_mosaic <span style="color: #00ffff;">&lt;-</span> dem_rasts<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
        mosaic_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>dem_mosaic<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        pathrow <span style="color: #00ffff;">&lt;-</span> pathrows<span style="color: #20b2aa;">[</span>n, <span style="color: #20b2aa;">]</span>
        pathrow_label <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, pathrow@data$PATH<span style="color: #20b2aa;">)</span>, 
                               <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">03</span><span style="color: #00ff00;">i'</span>, pathrow@data$ROW<span style="color: #20b2aa;">)</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'-'</span><span style="color: #20b2aa;">)</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Processing '</span>, n, <span style="color: #00ff00;">' of '</span>, 
                                                 <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">': '</span>, 
                                                 pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer,
                                          label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Cropping/reprojecting DEM mosaic crop for'</span>, 
                                          pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>crop_to_aoi<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>aoi<span style="color: #20b2aa;">)</span>
            pathrow_tosrs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>pathrow, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>to_srs<span style="color: #20b2aa;">))</span>
            to_ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gIntersection</span><span style="color: #20b2aa;">(</span>pathrow_tosrs, aoi, byid<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            to_srs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">utm_zone</span><span style="color: #20b2aa;">(</span>pathrow, proj<span style="color: #daa520;">4</span>string<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
            to_ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">projectExtent</span><span style="color: #20b2aa;">(</span>pathrow, to_srs<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        dem_te <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">bbox</span><span style="color: #20b2aa;">(</span>to_ext<span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure origin is set at </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">,</span><span style="color: #daa520;">0</span>
        to_res <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">30</span>, <span style="color: #daa520;">30</span><span style="color: #20b2aa;">)</span>
        dem_te <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">normalize_extent</span><span style="color: #20b2aa;">(</span>dem_te, to_res<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate minimum bounding box coordinates:</span>
        dem_mosaic_crop_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                         <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'dem_'</span>, pathrow_label, 
                                                <span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">))</span>
        dem_mosaic_crop <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gdalwarp</span><span style="color: #20b2aa;">(</span>mosaic_file, 
                                    dstfile<span style="color: #00ffff;">=</span>dem_mosaic_crop_filename,
                                    te<span style="color: #00ffff;">=</span>dem_te, t_srs<span style="color: #00ffff;">=</span>to_srs, tr<span style="color: #00ffff;">=</span>to_res, 
                                    r<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'cubicspline'</span>, output_Raster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                                    multi<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, of<span style="color: #00ffff;">=</span>of,
                                    wo<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>NUM_THREADS<span style="color: #00ffff;">=</span>, n_cpus<span style="color: #20b2aa;">)</span>, 
                                    overwrite<span style="color: #00ffff;">=</span>overwrite, ot<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer,
                                         label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Cropping/reprojecting DEM mosaic crop for'</span>, 
                                         pathrow_label<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">start_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Calculating slope/aspect for'</span>, 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
        slopeaspect_filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_path,
                                          <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slopeaspect_'</span>,
                                                 pathrow_label, <span style="color: #00ff00;">'.'</span>, ext<span style="color: #20b2aa;">))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that the default output of 'terrain' is in radians</span>
        slopeaspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">terrain</span><span style="color: #20b2aa;">(</span>dem_mosaic_crop, opt<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slope'</span>, <span style="color: #00ff00;">'aspect'</span><span style="color: #20b2aa;">))</span>
        slopeaspect$aspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>slopeaspect$aspect, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">2</span>*pi<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
            vals
            <span style="color: #20b2aa;">})</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that slopeaspect is scaled - slope by </span><span style="color: #daa520;">10000</span><span style="color: #00bfff;">, and aspect by </span><span style="color: #daa520;">1000</span><span style="color: #00bfff;"> so </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">that the layers can be saved as INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S</span>
        slopeaspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">10000</span><span style="color: #20b2aa;">)</span>,
                             <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">1000</span><span style="color: #20b2aa;">))</span>
        slopeaspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>slopeaspect, filename<span style="color: #00ffff;">=</span>slopeaspect_filename, 
                                   overwrite<span style="color: #00ffff;">=</span>overwrite, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Calculating slope/aspect for'</span>, 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
        timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Processing '</span>, n, <span style="color: #00ff00;">' of '</span>, 
                                                <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">': '</span>, 
                                                pathrow_label<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    timer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stop_timer</span><span style="color: #20b2aa;">(</span>timer, label<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Processing DEMS for'</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">)</span>, 
                                            <span style="color: #00ff00;">'path/rows'</span><span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> browse<sub>image</sub>.R</h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">plotprep</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, maxpixels<span style="color: #00ffff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">255</span>, x_fun<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, size<span style="color: #00ffff;">=</span>maxpixels, asRaster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, useGDAL<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>x, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> DN_min
        vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> DN_max
        vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">((</span>vals <span style="color: #00ffff;">-</span> DN_min<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>DN_max <span style="color: #00ffff;">-</span> DN_min<span style="color: #20b2aa;">))</span> * <span style="color: #daa520;">255</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>x_fun<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">x_fun</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">U'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Simple function to make small preview plot from large raster image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> input \code{RasterBrick} or \code{RasterStack} with at least three </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">m</span><span style="color: #00bfff;"> an optional mask \code{RasterLayer} to output below the browse </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maxpixels</span><span style="color: #00bfff;"> maximum number of pixels to use in plotting</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> minimum DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> maximum DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">r</span><span style="color: #00bfff;"> index in \code{x} of the band to use as the red band</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">g</span><span style="color: #00bfff;"> index in \code{x} of the band to use as the green band</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">b</span><span style="color: #00bfff;"> index in \code{x} of the band to use as the blue band</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x_fun</span><span style="color: #00bfff;"> an optional function to apply to \code{x} after x is resampled </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> according to \code{maxpixels}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">m_fun</span><span style="color: #00bfff;"> an optional function to apply to \code{m} after m is resampled </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> according to \code{maxpixels}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing - used for side-effect of saving browse image</span>
<span style="color: #ff6347;">browse_image</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, m<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, maxpixels<span style="color: #00ffff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">255</span>, 
                         r<span style="color: #00ffff;">=</span><span style="color: #daa520;">3</span>, g<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span>, b<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, x_fun<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, m_fun<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span> <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">plotprep</span><span style="color: #20b2aa;">(</span>x, maxpixels<span style="color: #00ffff;">=</span><span style="color: #daa520;">500000</span>, DN_min<span style="color: #00ffff;">=</span>DN_min, DN_max<span style="color: #00ffff;">=</span>DN_max, 
                  x_fun<span style="color: #00ffff;">=</span>x_fun<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m_fun<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        m <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>m, fun<span style="color: #00ffff;">=</span>m_fun, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>m<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        m <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>m, size<span style="color: #00ffff;">=</span>maxpixels, asRaster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, useGDAL<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #ff6347;">par</span><span style="color: #20b2aa;">(</span>mfrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">else</span> <span style="color: #ff6347;">par</span><span style="color: #20b2aa;">(</span>mfrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">plotRGB</span><span style="color: #20b2aa;">(</span>x, r<span style="color: #00ffff;">=</span>r, g<span style="color: #00ffff;">=</span>g, b<span style="color: #00ffff;">=</span>b, maxpixels<span style="color: #00ffff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">plot</span><span style="color: #20b2aa;">(</span>m, maxpixels<span style="color: #00ffff;">=</span>maxpixels, axes<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, legend<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, box<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">plotRGB</span><span style="color: #20b2aa;">(</span>x, r<span style="color: #00ffff;">=</span>r, g<span style="color: #00ffff;">=</span>g, b<span style="color: #00ffff;">=</span>b, maxpixels<span style="color: #00ffff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> chg<sub>dir</sub>.R</h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Change Direction Image for CVAPS</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This code calculate the change direction image for the Change Vector </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Analysis in Posterior Probability Space (CVAPS) method of Chen et al. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Use the change direction image in conjunction with the change magnitude </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image from \code{chg_dir}, and \code{DFPS} to use the Double Window Flexible </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Pace Search method (Chen et al. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">) to determine the threshold to use to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> map areas of change and no-change.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">1</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> posterior probability \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">2</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> posterior probability \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">filename</span><span style="color: #00bfff;"> (optional) filename for output change direction</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional parameters to pass to rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{Raster*} object with change direction image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., P. Gong, C. He, R. Pu, and P. Shi. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Land-use/land-cover change detection using improved change-vector analysis.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Photogrammetric Engineering and Remote Sensing </span><span style="color: #daa520;">69</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">369</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">380</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector analysis in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> posterior probability space: a new method for land cover change detection.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">,training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgdir &lt;- chg_dir(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$probs, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds$probs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">chg_dir</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, filename, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> coordinate systems do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> extents do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> probability maps have differing number of classes'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file already exists and overwrite=FALSE'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_classes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_classes <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cannot calculate change probabilities for only one class'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #ff6347;">calc_chg_dir_st</span><span style="color: #00bfff;"> &lt;- function(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p, t</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">p, n_classes, ...) {</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;"># Calculate change direction (eqns </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">6</span><span style="color: #00bfff;"> in Chen </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">)</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">dP &lt;- array(t</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">p - t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p, dim=c(dim(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p)[</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">], dim(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p)[</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">], n_classes))</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">unit_vecs &lt;- array(diag(n_classes), dim=c(n_classes, n_classes))</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">Eab &lt;- apply(dP, c(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">), function(pixel) pixel %*% unit_vecs)</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">chgdir &lt;- apply(Eab, c(</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">),</span>
    <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">function(pixel) which(pixel == max(pixel)))</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">chgdir &lt;- array(chgdir, dim=c(dim(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p)[</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">], dim(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p)[</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">], </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">))</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">return(chgdir)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">out &lt;- rasterEngine(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p=t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">p, t</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">p=t</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">p, fun=calc_chg_dir_st, </span>
    <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">args=list(n_classes=n_classes), </span>
    <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">outbands=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, datatype='INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S', ...)</span>
    <span style="color: #00bfff;">#</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;"># spatial.tools can only output the raster package grid format - so output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;"># to a tempfile in that format then copy over to the requested final output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;"># format if a filename was supplied</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">if (!missing(filename)) {</span>
    <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">out &lt;- writeRaster(out, filename=filename, dataType='INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S', </span>
    <span style="color: #00bfff;">#                        </span><span style="color: #00bfff;">overwrite=overwrite)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
        overwrite <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
    <span style="color: #20b2aa;">}</span>

    bs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #00ffff;">=</span>filename, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span>Processing block , block_num,  of , bs$n, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        dims <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">))</span>
        t<span style="color: #daa520;">1</span>p_bl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, row<span style="color: #00ffff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                 nrows<span style="color: #00ffff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                        dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        t<span style="color: #daa520;">2</span>p_bl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p, row<span style="color: #00ffff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                       nrows<span style="color: #00ffff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                        dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        chg_dirs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc_chg_dir</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p_bl, t<span style="color: #daa520;">2</span>p_bl<span style="color: #20b2aa;">)</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, chg_dirs, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> chg<sub>mag</sub>.R</h2>
<div class="outline-text-2" id="text-14">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Change Magnitude Image for CVAPS</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This code calculate the change magnitude image for the Change Vector </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Analysis in Posterior Probability Space (CVAPS) method of Chen et al. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Use the change magnitude image and use it in conjunction with the change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> direction image from \code{chg_dir} to map areas of change and no-change.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The threshold can be determined using \code{\link{DFPS}} (to use the Double </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Window Flexible Pace Search method, from Chen et al. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">) or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{threshold}} (which uses an unsupervised method).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">1</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> posterior probability \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">2</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> posterior probability \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">filename</span><span style="color: #00bfff;"> (optional) filename for output change magnitude</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional parameters to pass to rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{Raster*} object with change magnitude image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., P. Gong, C. He, R. Pu, and P. Shi. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Land-use/land-cover change detection using improved change-vector analysis.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Photogrammetric Engineering and Remote Sensing </span><span style="color: #daa520;">69</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">369</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">380</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector analysis in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> posterior probability space: a new method for land cover change detection.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">,training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgmag &lt;- chg_mag(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$probs, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds$probs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">chg_mag</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, filename, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> coordinate systems do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> extents do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t</span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> probability maps have differing number of classes'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file already exists and overwrite=FALSE'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    n_classes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">calc_chg_mag</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p, n_classes, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle RasterLayer images</span>
            chgmag <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p <span style="color: #00ffff;">-</span> t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle RasterStack or RasterBrick images</span>
            chgmag <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">2</span>p <span style="color: #00ffff;">-</span> t<span style="color: #daa520;">1</span>p, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>pixel<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>pixel^<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
        chgmag <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>chgmag, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>chgmag<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p<span style="color: #00ffff;">=</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #00ffff;">=</span>t<span style="color: #daa520;">2</span>p, fun<span style="color: #00ffff;">=</span>calc_chg_mag, 
                        args<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>n_classes<span style="color: #00ffff;">=</span>n_classes<span style="color: #20b2aa;">)</span>, 
                        outbands<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, outfiles<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, ...<span style="color: #20b2aa;">)</span>

    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">spatial.tools can only output the raster package grid format - so output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">to a tempfile in that format then copy over to the requested final output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">format if a filename was supplied</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #00ffff;">=</span>filename, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> chg<sub>traj</sub>.R</h2>
<div class="outline-text-2" id="text-15">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate change-trajectory lookup table</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will format a lookup table (lut) to allow coding change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> trajectories. Useful for use in conjunction with \code{\link{chg_traj}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_codes</span><span style="color: #00bfff;"> a list of integer codes used to code land use/cover </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classes</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_names</span><span style="color: #00bfff;"> an (optional) list of class names as character vectors</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> lut &lt;- traj_lut(c(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">), c(NonForest, Forest))</span>
<span style="color: #ff6347;">traj_lut</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>class_codes, class_names<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lut <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">expand.grid</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">0</span>_code<span style="color: #00ffff;">=</span>class_codes, t<span style="color: #daa520;">1</span>_code<span style="color: #00ffff;">=</span>class_codes<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>class_names<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_names<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_codes<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'class_names must be NULL or a vector of length equal to number of classes in initial image'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        lut$t<span style="color: #daa520;">0</span>_name <span style="color: #00ffff;">&lt;-</span> class_names<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">0</span>_code, class_codes<span style="color: #20b2aa;">)]</span>
        lut$t<span style="color: #daa520;">1</span>_name <span style="color: #00ffff;">&lt;-</span> class_names<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">1</span>_code, class_codes<span style="color: #20b2aa;">)]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Code trajectories by summing t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> after multiplying t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> by the number </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">of classes.</span>
    lut$Code <span style="color: #00ffff;">&lt;-</span> lut$t<span style="color: #daa520;">0</span>_code <span style="color: #00ffff;">+</span> lut$t<span style="color: #daa520;">1</span>_code * <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_codes<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Exclude classes that are persistence - CVAPS doesn't directly code the </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">class for classes that persist</span>
    lut <span style="color: #00ffff;">&lt;-</span> lut<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>lut$t<span style="color: #daa520;">0</span>_code <span style="color: #00ffff;">==</span> lut$t<span style="color: #daa520;">1</span>_code<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>lut<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate change-trajectory image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will calculate trajectories of land cover change using the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Change Vector Analysis in Posterior Probability Space (CVAPS) approach of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> comparing posterior probabilities of class membership with an automatically </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> determined threshold. Areas of no change are coded as -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">. A lookup table for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the codes output by \code{chg_traj} can be calculated with \code{traj_lut}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_mag</span><span style="color: #00bfff;"> change magnitude \code{RasterLayer} from \code{CVAPS}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_dir</span><span style="color: #00bfff;"> change direction \code{RasterLayer} from \code{CVAPS}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_threshold</span><span style="color: #00bfff;"> the threshold to use as a minimum when determining change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> areas (can use \code{DFPS} to determine this value).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">filename</span><span style="color: #00bfff;"> filename to save the output \code{RasterLayer} to disk </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files (otherwise an error </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will be raised)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional parameters to pass to rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a {RasterLayer} of change trajectories, with change trajectories </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> coded as in the \code{lut} output by \code{traj_lut}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., P. Gong, C.  He, R.  Pu, and P.  Shi.  </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Land-use/land-cover change detection using improved change-vector analysis.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Photogrammetric Engineering and Remote Sensing </span><span style="color: #daa520;">69</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">369</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">380</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector analysis in</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> posterior probability space: a new method for land cover change detection.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">,training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model &lt;- train_classifier(t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgmag &lt;- chg_mag(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$probs, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds$probs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgdir &lt;- chg_dir(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$probs, t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_preds$probs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> lut &lt;- traj_lut(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$codes$code, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_preds$codes$class)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgtraj &lt;- chg_traj(lut, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgmag, t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgdir, .</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Change areas are coded following the above lookup-table (lut):</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgtraj)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # No change areas are -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">_t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">_chgtraj == -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">chg_traj</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir, chg_threshold, filename, 
                     overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'chg_mag has more than </span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> layer'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'chg_dir has more than </span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> layer'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, filename<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file already exists and overwrite=FALSE'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">calc_chg_traj</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>chg_mag, chg_dir, chg_threshold, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Trajectories in chg_dir were coded by summing t</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> classes after </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">multiplying t</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> class by the number of classes</span>
        chg_dir<span style="color: #20b2aa;">[</span>chg_mag <span style="color: #00ffff;">&lt;</span> chg_threshold<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span>
        chg_dir<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">2</span>
        chg_dir <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>chg_dir, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>chg_dir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>chg_mag<span style="color: #00ffff;">=</span>chg_mag, chg_dir<span style="color: #00ffff;">=</span>chg_dir, fun<span style="color: #00ffff;">=</span>calc_chg_traj,
                        args<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>chg_threshold<span style="color: #00ffff;">=</span>chg_threshold<span style="color: #20b2aa;">)</span>,
                        datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">spatial.tools doesn't properly handle NA values for integer layers, so </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">they were coded as -</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> above - now recode them as NA</span>
    out<span style="color: #20b2aa;">[</span>out <span style="color: #00ffff;">==</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">spatial.tools can only output the raster package grid format - so output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">to a tempfile in that format then copy over to the requested final output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">format if a filename was supplied</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, filename<span style="color: #00ffff;">=</span>filename, overwrite<span style="color: #00ffff;">=</span>overwrite, 
                           datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> chg<sub>traj</sub><sub>stats</sub>.R</h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate change-trajectory statistics</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">traj</span><span style="color: #00bfff;"> a list (as output by \code{chg_traj} with two elements: traj_lut </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (a lookup table of change trajectory codes) and chg_traj (a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterLayer} of change trajectory codes.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{data.frame} object with change trajectory statistics</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> #TODO: Add examples</span>
<span style="color: #ff6347;">chg_traj_stats</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>traj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    chg_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>traj$chg_traj<span style="color: #20b2aa;">))</span>
    summ_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>Traj_Code<span style="color: #00ffff;">=</span>traj$traj_lut$Code,
                             Trajectory<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>traj$traj_lut$t<span style="color: #daa520;">0</span>_name, traj$traj_lut$t<span style="color: #daa520;">1</span>_name, 
                                              sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'-'</span><span style="color: #20b2aa;">))</span>
    summ_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>summ_table, n_pixels<span style="color: #00ffff;">=</span>chg_table<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>chg_table<span style="color: #20b2aa;">)</span>, summ_table$Traj_Code<span style="color: #20b2aa;">)])</span>
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>summ_table<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    summ_table$Frac_Chg <span style="color: #00ffff;">&lt;-</span> summ_table$n_pixels <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>summ_table$n_pixels<span style="color: #20b2aa;">)</span>
    summ_table$Frac_Tot <span style="color: #00ffff;">&lt;-</span> summ_table$n_pixels <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>traj$chg_traj<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>summ_table<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> classify.R</h2>
<div class="outline-text-2" id="text-17">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Classify an image using a trained classifier</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will produce two outputs - a prediction image and a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> probability image. The prediction image contains the predicted classes, the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and the probability image contains the per-pixel predicted probabilities of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> occurrence of each class.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}} - TEMPORARILY DISABLED.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> caret</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*} image with the predictor layer(s) for the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classification</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">model</span><span style="color: #00bfff;"> a trained classifier as output by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{train_classifier}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes_file</span><span style="color: #00bfff;"> filename for predicted classes (or missing)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">prob_file</span><span style="color: #00bfff;"> filename for predicted probabilities (or missing)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">factors</span><span style="color: #00bfff;"> a list of character vector giving the names of predictors </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (layer names from the images used to build \code{train_data}) that should be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> treated as factors, and specifying the levels of each factor. For example, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{factors=list(year=c(</span><span style="color: #daa520;">1990</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">1995</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2000</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2005</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2010</span><span style="color: #00bfff;">))}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite \code{out_name} if it already exists</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a list with </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> elements: the predicted classes as a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterLayer} and the class probabilities as a \code{RasterBrick}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                          training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> model &lt;- train_classifier(train_data)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> preds &lt;- classify(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, model)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(preds$classes)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(preds$probs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">classify</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, model, classes_file, prob_file, factors<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, 
                     overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Check with Jonathan why below fix is needed</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>RasterBrick <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>prob_file<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, prob_file<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file'</span>, prob_file, <span style="color: #00ff00;">'already exists and overwrite=FALSE'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>classes_file<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, classes_file<span style="color: #20b2aa;">)</span> &amp;&amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file'</span>, classes_file, <span style="color: #00ff00;">'already exists and overwrite=FALSE'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">make_preds</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>inrast, model, factors, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">First, preserve the names:</span>
        band_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dimnames</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">][[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Flatten the array to a matrix (we lose the names here)</span>
        inrast_mat <span style="color: #00ffff;">&lt;-</span> inrast
        <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast_mat<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>*<span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">])</span>
        inrast_df <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>inrast_mat<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> band_names
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Make sure any factor variables are converted to factors and that the </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">proper levels are assigned</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                factor_var <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)[</span>n<span style="color: #20b2aa;">]</span>
                factor_col <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> factor_var<span style="color: #20b2aa;">)</span>
                inrast_df<span style="color: #20b2aa;">[</span>, factor_col<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">[</span>, factor_col<span style="color: #20b2aa;">]</span>, 
                                                  levels<span style="color: #00ffff;">=</span>factors<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]])</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        good_obs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span>
        preds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>inrast_df<span style="color: #20b2aa;">)</span>, ncol<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>good_obs<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            good_preds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>model, inrast_df<span style="color: #20b2aa;">[</span>good_obs, <span style="color: #20b2aa;">]</span>, type<span style="color: #00ffff;">=</span>prob<span style="color: #20b2aa;">)</span>
            preds<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>good_obs<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.matrix</span><span style="color: #20b2aa;">(</span>good_preds<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        preds_array <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>preds, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                          <span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>preds_array<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    probs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterEngine</span><span style="color: #20b2aa;">(</span>inrast<span style="color: #00ffff;">=</span>x, fun<span style="color: #00ffff;">=</span>make_preds,
                          args<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>model<span style="color: #00ffff;">=</span>model, factors<span style="color: #00ffff;">=</span>factors<span style="color: #20b2aa;">)</span>,
                          filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, overwrite<span style="color: #00ffff;">=</span>overwrite, 
                          datatype<span style="color: #00ffff;">=</span>FLT<span style="color: #daa520;">4</span>S, .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>randomForest<span style="color: #20b2aa;">)</span>,
                          setMinMax<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">spatial.tools can only output the raster package grid format - so output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">to a tempfile in that format then copy over to the requested final output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">format if a filename was supplied</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>prob_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        probs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>probs, filename<span style="color: #00ffff;">=</span>prob_file, overwrite<span style="color: #00ffff;">=</span>overwrite, 
                             datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'FLT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">S'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>probs<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate the highest probability class from the class probabilities</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>classes_file<span style="color: #20b2aa;">))</span> classes_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
    classes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>probs, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Subtract </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> below as software like ENVI starts class codes at zero</span>
            out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>vals <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>
            <span style="color: #00bfff;">#</span><span style="color: #00bfff;">TODO: Need to handle case of ties (length(out) &gt; </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> out <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'INT</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">S'</span>, filename<span style="color: #00ffff;">=</span>classes_file, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>classes<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'prediction'</span>
    codes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>code<span style="color: #00ffff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span>, class<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>classes<span style="color: #00ffff;">=</span>classes, probs<span style="color: #00ffff;">=</span>probs, codes<span style="color: #00ffff;">=</span>codes<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> class<sub>statistics</sub>.R</h2>
<div class="outline-text-2" id="text-18">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Exports statistics on pixels within each of a set of land cover classes</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dplyr</span><span style="color: #00bfff;"> group_by summarize</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">reshape</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> melt</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> A \code{RasterLayer} from which class statistics will be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> calculated.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> A \code{SpatialPolygonsDataFrame} with cover class </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> polygons</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_col</span><span style="color: #00bfff;"> the name of the column containing the response variable </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (for example the land cover type of each pixel)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A data.frame of class statistics.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> class_statistics(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">)</span>
<span style="color: #ff6347;">class_statistics</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, class_col<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Coordinate systems do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> SpatialPolygonsDataFrame<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_pixels</span><span style="color: #20b2aa;">(</span>x, y, class_col<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterBrick, 
                                         RasterStack<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'class_statistics cannot yet handle Raster* objects'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">melt</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>pixels@x, y<span style="color: #00ffff;">=</span>pixels@y<span style="color: #20b2aa;">)</span>, idvar<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'y'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set y and variable to NULL to pass R CMD CHECK without notes</span>
    value<span style="color: #00ffff;">=</span>variable<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
    class_stats <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>pixels, y, variable<span style="color: #20b2aa;">)</span>, mean<span style="color: #00ffff;">=</span><span style="color: #ff6347;">mean</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, 
                             sd<span style="color: #00ffff;">=</span><span style="color: #ff6347;">sd</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, min<span style="color: #00ffff;">=</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, max<span style="color: #00ffff;">=</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>, 
                             n_pixels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">))</span>
    class_stats <span style="color: #00ffff;">&lt;-</span> class_stats<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>class_stats$variable, class_stats$y<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> cloud<sub>remove</sub>.R</h2>
<div class="outline-text-2" id="text-19">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff;"># </span><span style="color: #00bfff;">Function to test if ENVI will load in IDL</span>
<span style="color: #ff6347;">check_ENVI_IDL</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    idl_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'-e e=ENVI(/HEADLESS)'</span><span style="color: #20b2aa;">)</span>, 
                      intern<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>Restored file: ENVI, idl_out<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">Function to ensure only character variables handed to IDL are quoted</span>
<span style="color: #ff6347;">format_IDL_param</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>varname, varvalue<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #00ff00;">'='</span>, varvalue, <span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.list</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #00ff00;">'=['</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, varvalue<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>
                <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, <span style="color: #00ff00;">''</span>, varvalue<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">)</span>
                <span style="color: #20b2aa;">}</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>varvalue<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                    param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, <span style="color: #00ff00;">', '</span><span style="color: #20b2aa;">)</span>
                <span style="color: #20b2aa;">}</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>param, <span style="color: #00ff00;">']\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        param <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>varname, <span style="color: #00ff00;">'='</span>, varvalue, <span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>param<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #ff6347;">cloud_remove_IDL</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name,
                             algorithm, num_class, min_pixel, max_pixel, 
                             cloud_nbh, DN_min, DN_max, 
                             verbose, idl, byblock, overwrite,
                             patch_long<span style="color: #00ffff;">=</span><span style="color: #daa520;">1000</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span>verbose not supported with CLOUD_REMOVE and CLOUD_REMOVE_FAST algorithms<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'CLOUD_REMOVE_FAST'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        script_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, CLOUD_REMOVE_FAST.pro, 
                                   package<span style="color: #00ffff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
        function_name <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'CLOUD_REMOVE_FAST'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'CLOUD_REMOVE'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        script_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, CLOUD_REMOVE.pro, 
                                   package<span style="color: #00ffff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
        function_name <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'CLOUD_REMOVE'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'unrecognized cloud fill algorithm '</span>, algorithm, <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-x'</span>, idl<span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, idl<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'IDL not found - check idl parameter'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">check_ENVI_IDL</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>Unable to load ENVI <span style="color: #ff00ff;">in</span> IDL <span style="color: #00ffff;">-</span> do you have ENVI and IDL licenses, and ENVI <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">5</span>.<span style="color: #daa520;">0</span>?<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!byblock<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        patch_long <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string and extent to ensure the same proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string and extent is </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">returned even if they are changed by IDL</span>
    orig_proj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    orig_ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Write in-memory rasters to files for hand off to IDL. The capture.output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">line is used to avoid printing the rasterOptions to screen as they are </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">temporarily reset.</span>
    dummy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span>def_format <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">()</span>$format<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'ENVI'</span><span style="color: #20b2aa;">)</span>
    cloudy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>cloudy, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, 
                          datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>clear, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>cloud_mask, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, 
                              datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    cloudy_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    clear_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span>
    cloud_mask_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span>
    dummy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #00ffff;">=</span>def_format<span style="color: #20b2aa;">))</span>
    param_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>cloudy_file, clear_file, mask_file, out_name, 
                     num_class, min_pixel, extent<span style="color: #daa520;">1</span>, DN_min, DN_max, 
                     patch_long<span style="color: #20b2aa;">)</span>
    param_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cloudy_file, clear_file, cloud_mask_file, out_name, 
                       num_class, min_pixel, cloud_nbh, DN_min, DN_max, 
                       patch_long<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span>format_IDL_param, param_names, param_vals<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>idl_params, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">)</span>
    script_dir <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>script_path<span style="color: #20b2aa;">)</span>
    idl_script <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">(</span>fileext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'.pro'</span><span style="color: #20b2aa;">)</span>
    idl_cmd <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'CD, '</span>, script_dir, <span style="color: #00ff00;">'\n'</span>, idl_params, function_name, <span style="color: #00ff00;">','</span>, 
                      <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>param_names, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">','</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\nexit'</span><span style="color: #20b2aa;">)</span>
    f <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>idl_script, <span style="color: #00ff00;">'wt'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_cmd, f<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl_script<span style="color: #20b2aa;">))</span>, intern<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    log_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_idllog.txt'</span><span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\r'</span>, <span style="color: #00ff00;">''</span>, idl_out<span style="color: #20b2aa;">)</span>
    f <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>log_file, <span style="color: #00ff00;">'wt'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_out, f<span style="color: #20b2aa;">)</span> 
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)</span>
    filled<span style="color: #20b2aa;">[</span>filled <span style="color: #00ffff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure original proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string and extent are saved and returned</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_ext
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>filled, filename<span style="color: #00ffff;">=</span>out_name, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                          datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">Wrapper around C++ cloud fill function, to enable calling the function with </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">rasterEngine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> Rcpp</span>
<span style="color: #ff6347;">cloud_fill_rasterengine</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, 
                                    num_class, min_pixel, max_pixel, cloud_nbh, 
                                    DN_min, DN_max, verbose, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    dims<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">RcppArmadillo crashes when you pass it a cube, so resize and pass </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">mats</span>
    cloudy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>cloudy, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>clear, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>cloud_mask, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, dims, 
                                  num_class,  min_pixel, max_pixel, cloud_nbh, 
                                  DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">RcppArmadillo crashes when you return a cube, so resize the returned </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">mat</span>
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span>filled, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">This function decides which RcppArmadillo exported function to call: </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">cloud_fill, or cloud_fill_simple</span>
<span style="color: #ff6347;">call_cpp_cloud_fill</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, dims, 
                                num_class, min_pixel, max_pixel, cloud_nbh, 
                                DN_min, DN_max, verbose, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">==</span> teamlucc<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, 
                             min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, 
                             verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">==</span> simple<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cloud_fill_simple</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, 
                                    cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'unrecognized cloud fill algorithm '</span>, algorithm, <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">spatial.tools</span><span style="color: #00bfff;"> rasterEngine</span>
<span style="color: #ff6347;">cloud_remove_R</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name, algorithm, 
                           num_class, min_pixel, max_pixel, cloud_nbh, DN_min, 
                           DN_max, verbose, byblock, overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that call_cpp_cloud_fill uses the algorithm to decide whether to </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">call cloud_fill or cloud_fill_simple (and call_cpp_cloud_fill is called </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">by cloud_fill_rasterengine)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>byblock<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">blockSize</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>cloudy, values<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStart</span><span style="color: #20b2aa;">(</span>out, out_name, overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>block_num <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:bs$n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span>Processing block , block_num,  of , bs$n, ...<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            dims <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">))</span>
            cloudy_bl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>cloudy, row<span style="color: #00ffff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                              nrows<span style="color: #00ffff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                               dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
            clear_bl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>clear, row<span style="color: #00ffff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>,
                                            nrows<span style="color: #00ffff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>,
                            dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
            cloud_mask_bl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValuesBlock</span><span style="color: #20b2aa;">(</span>cloud_mask, 
                                                  row<span style="color: #00ffff;">=</span>bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">]</span>, 
                                                  nrows<span style="color: #00ffff;">=</span>bs$nrows<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>, 
                                   dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
            filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy_bl, clear_bl, cloud_mask_bl, 
                                          algorithm, dims, num_class, 
                                          min_pixel, max_pixel, cloud_nbh, 
                                          DN_min, DN_max, verbose<span style="color: #00ffff;">&gt;</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
            out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeValues</span><span style="color: #20b2aa;">(</span>out, filled, bs$row<span style="color: #20b2aa;">[</span>block_num<span style="color: #20b2aa;">])</span>
        <span style="color: #20b2aa;">}</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeStop</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">out &lt;- rasterEngine(cloudy=cloudy, clear=clear, </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cloud_mask=cloud_mask,</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">fun=cloud_fill_rasterengine,</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">args=list(algorithm=algorithm, num_class=num_class, </span>
        <span style="color: #00bfff;">#                               </span><span style="color: #00bfff;">min_pixel=min_pixel, max_pixel=max_pixel, </span>
        <span style="color: #00bfff;">#                               </span><span style="color: #00bfff;">cloud_nbh=cloud_nbh, DN_min=DN_min, </span>
        <span style="color: #00bfff;">#                               </span><span style="color: #00bfff;">DN_max=DN_max, verbose=verbose),</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">processing_unit='chunk',</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">outbands=nlayers(cloudy), outfiles=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">,</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">verbose=verbose,</span>
        <span style="color: #00bfff;">#                     </span><span style="color: #00bfff;">filename=out_name)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        dims <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
        out_datatype <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span>cloudy, values<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, filename<span style="color: #00ffff;">=</span>out_name<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">RcppArmadillo crashes when you pass it a cube, so resize and pass </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">mats</span>
        cloudy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span>, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]))</span>
        cloud_mask <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span>, dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> * dims<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">call_cpp_cloud_fill</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, algorithm, 
                                      dims, num_class, min_pixel, max_pixel, 
                                      cloud_nbh, DN_min, DN_max, verbose<span style="color: #00ffff;">&gt;</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>out, filled<span style="color: #20b2aa;">)</span>
        out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>out, out_name, datatype<span style="color: #00ffff;">=</span>out_datatype, 
                           overwrite<span style="color: #00ffff;">=</span>overwrite<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Remove clouds From Landsat imagery</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This code uses one of several different algorithms (depending on the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> settings, see Details) to fill heavy clouds in a Landsat image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The \code{algorithm} parameter determines what algorithm is used for the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloud fill. \code{algorithm} must be one of: CLOUD_REMOVE, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> CLOUD_REMOVE_FAST, teamlucc, or simple (the default). If set to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> CLOUD_REMOVE the script uses a (slightly modified to be called from R) </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> version of  Xiaolin Zhu's NSPI IDL code. If set to CLOUD_REMOVE_FAST, the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> algorithm uses the fast version of Xiaolin's code. Both of these two </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> algorithms require an IDL license to run (and therefore \code{idl_path} must </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> be set).  The teamlucc algorithm uses a version of the NSPI algorithm </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (based on the CLOUD_REMOVE code) that is coded in C++ and  can be run from R </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> without an IDL license. The simple algorithm uses a cloud fill model that </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> is based on fitting a linear model to the surface reflectance from the clear </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image in a window around each cloud, and using this linear model to predict </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> reflectance in unobserved (cloudy) areas.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloudy</span><span style="color: #00bfff;"> the cloudy image (base image) as a \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">clear</span><span style="color: #00bfff;"> the clear image as a \code{Raster*} to use for filling </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{img_cloudy}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_mask</span><span style="color: #00bfff;"> the cloud mask as a \code{RasterLayer}, with each cloud </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> patch assigned a unique integer code. Areas that are clear in both </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{cloudy_rast} and \code{clear_rast} should be coded </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">, while areas that </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> are clouded in \code{clear_rast} should be coded -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out_name</span><span style="color: #00bfff;"> filename for cloud filled image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">algorithm</span><span style="color: #00bfff;"> must be one of: CLOUD_REMOVE, CLOUD_REMOVE_FAST, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> teamlucc, or simple. Default is simple. See Details.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">num_class</span><span style="color: #00bfff;"> set the estimated number of classes in image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">min_pixel</span><span style="color: #00bfff;"> the sample size of similar pixels (ignored when </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{algorithm==TRUE})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_pixel</span><span style="color: #00bfff;"> the maximum sample size to search for similar pixels </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (ignored when \code{algorithm==TRUE})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_nbh</span><span style="color: #00bfff;"> the range of cloud neighborhood (in pixels)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> the minimum valid DN value (default of </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> the maximum valid DN value (default of </span><span style="color: #daa520;">10000</span><span style="color: #00bfff;"> assumes </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> byte </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> integer imagery)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">idl</span><span style="color: #00bfff;"> path to the IDL binary on your machine (on Windows, the path to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> idl.exe)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages. Set to FALSE or </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for no status messages. Set to </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> for basic status messages. Set to </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> detailed status messages.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">byblock</span><span style="color: #00bfff;"> whether to process images block by block </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (\code{byblock=TRUE}) or all at once (\code{byblock=FALSE}). Use </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{byblock=FALSE} with caution, as this option will cause the cloud fill </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> routine to consume a large amount of memory.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite \code{out_name} if it already exists</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments passed to the chosen cloud fill routine</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{Raster*} with cloud-filled image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Zhu, X., Gao, F., Liu, D., Chen, J., </span><span style="color: #daa520;">2012</span><span style="color: #00bfff;">. A modified</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> neighborhood similar pixel interpolator approach for removing thick clouds </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in Landsat images. Geoscience and Remote Sensing Letters, IEEE </span><span style="color: #daa520;">9</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">521</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">525</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloudy &lt;- raster(system.file('tests', 'testthat_idl', 'cloud_remove', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'L</span><span style="color: #daa520;">20080724</span><span style="color: #00bfff;">_cloudy', package='teamlucc'))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> clear &lt;- raster(system.file('tests', 'testthat_idl', 'cloud_remove', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'L</span><span style="color: #daa520;">20080606</span><span style="color: #00bfff;">', package='teamlucc'))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cloud_mask &lt;- raster(system.file('tests', 'testthat_idl', 'cloud_remove', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'cloud_mask', package='teamlucc'))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> filled &lt;- cloud_remove(cloudy, clear, cloud_mask, fast=TRUE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">cloud_remove</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                         algorithm<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'simple'</span>,
                         num_class<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span>, min_pixel<span style="color: #00ffff;">=</span><span style="color: #daa520;">20</span>, max_pixel<span style="color: #00ffff;">=</span><span style="color: #daa520;">1000</span>, 
                         cloud_nbh<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>, DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">10000</span>, 
                         idl<span style="color: #00ffff;">=</span>C:<span style="color: #00ffff;">/</span>Program Files<span style="color: #00ffff;">/</span>Exelis<span style="color: #00ffff;">/</span>IDL<span style="color: #daa520;">83</span><span style="color: #00ffff;">/</span>bin<span style="color: #00ffff;">/</span>bin.x<span style="color: #daa520;">86</span>_<span style="color: #daa520;">64</span><span style="color: #00ffff;">/</span>idl.exe,
                         verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, byblock<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'CLOUD_REMOVE'</span>, <span style="color: #00ff00;">'CLOUD_REMOVE_FAST'</span>, <span style="color: #00ff00;">'teamlucc'</span>, 
                           <span style="color: #00ff00;">'simple'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'algorithm must be one of CLOUD_REMOVE, CLOUD_REMOVE_FAST, teamlucc, or simple'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Using '</span>, algorithm, <span style="color: #00ff00;">' algorithm.'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cloudy must be a Raster* object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'clear must be a Raster* object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cloud_mask must be a RasterLayer object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>cloudy, clear<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>clear<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'number of layers in cloudy must match number of layers in clear'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>cloud_mask<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'cloud_mask should have only one layer'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out_name <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        out_name <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">normalizePath</span><span style="color: #20b2aa;">(</span>out_name, mustWork<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_name<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output folder does not exist'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, out_name<span style="color: #20b2aa;">)</span> &amp; !overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file already exists - use a different out_name'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'CLOUD_REMOVE'</span>, <span style="color: #00ff00;">'CLOUD_REMOVE_FAST'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove_IDL</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name,
                                   algorithm, num_class, min_pixel, max_pixel, 
                                   cloud_nbh, DN_min, DN_max, verbose, idl, 
                                   byblock, overwrite, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span>, <span style="color: #00ff00;">'simple'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cloud_remove_R</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, out_name, 
                                 algorithm, num_class, min_pixel, max_pixel, 
                                 cloud_nbh, DN_min, DN_max, verbose, byblock, 
                                 overwrite, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'unrecognized cloud fill algorithm '</span>, algorithm, <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>cloudy<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-20" class="outline-2">
<h2 id="sec-20"><span class="section-number-2">20</span> color<sub>image</sub>.R</h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Assign class labels to classification file</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgdal</span><span style="color: #00bfff;"> writeGDAL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> SpatialPixelsDataFrame</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> classified image as \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cls</span><span style="color: #00bfff;"> two column matrix, where the first column is the class codes </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (integers) and the second column is the class names</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">outfile</span><span style="color: #00bfff;"> the filename to use for the output</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> #TODO: Add examples</span>
<span style="color: #ff6347;">color_image</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, cls, outfile<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Reclassify image so it is coded from </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> - length(cls[</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">]). ENVI and </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">other classification file formats rely on the codes being sequential, </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">starting at zero.</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">reclassify</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)))</span>
    x.sp <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as</span><span style="color: #20b2aa;">(</span>x, SpatialPixelsDataFrame<span style="color: #20b2aa;">)</span>
    cls_colors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">col</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">rgb</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Select appropriate data type and missing value tag depending on data </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">attributes.</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>x.sp$layer<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">254</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        gdaltype <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'Int</span><span style="color: #daa520;">16</span><span style="color: #00ff00;">'</span>
        gdalmvFlag <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">32768</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        gdaltype <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'Byte'</span>
        gdalmvFlag <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">255</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">writeGDAL</span><span style="color: #20b2aa;">(</span>x.sp, outfile, drivername<span style="color: #00ffff;">=</span>ENVI, type<span style="color: #00ffff;">=</span>gdaltype,
              colorTables<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cls_colors<span style="color: #20b2aa;">)</span>, catNames<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>cls<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]))</span>,
              mvFlag<span style="color: #00ffff;">=</span>gdalmvFlag<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-21" class="outline-2">
<h2 id="sec-21"><span class="section-number-2">21</span> compcont.R</h2>
<div class="outline-text-2" id="text-21">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate a contingency table using the composite operator</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function calculates a cross tabulation for a map comparison using the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> composite operator recommended by Pontius and Cheuk (</span><span style="color: #daa520;">2006</span><span style="color: #00bfff;">).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> matrix with contingency table</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Pontius, R. G., and M. L. Cheuk. </span><span style="color: #daa520;">2006</span><span style="color: #00bfff;">.  A generalized </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cross-tabulation matrix to compare soft-classified maps at multiple </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> resolutions. International Journal of Geographical Information Science </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">20</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">30</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">compcont</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">()</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'compcont is not yet finished'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;">#</span><span style="color: #00bfff;">TODO: finish coding this function</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-22" class="outline-2">
<h2 id="sec-22"><span class="section-number-2">22</span> DFPS.R</h2>
<div class="outline-text-2" id="text-22">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Double-Window Flexible Pace Search (DFPS) threshold determination</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgeos</span><span style="color: #00bfff;"> gDifference gBuffer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_polys</span><span style="color: #00bfff;"> \code{SpatialPolygonsDataFrame} with polygons of change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> areas surrounded by windows of no-change</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">chg_mag</span><span style="color: #00bfff;"> change magnitude \code{RasterLayer} from \code{CVAPS}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">radius</span><span style="color: #00bfff;"> radius of no-change surrounding change area polygons</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">delta</span><span style="color: #00bfff;"> the minimum difference between Lmax and Lmin that will allow </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> another pass through the search loop</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">m</span><span style="color: #00bfff;"> number of potential thresholds per search iteration (see Chen et </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> al., </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">). Recommended to leave at default value.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maxiter</span><span style="color: #00bfff;"> maximum number of iterations of the main search process</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., P. Gong, C. He, R. Pu, and P. Shi. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Land-use/land-cover change detection using improved change-vector analysis.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Photogrammetric Engineering and Remote Sensing </span><span style="color: #daa520;">69</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">369</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">380</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector analysis in</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> posterior probability space: a new method for land cover change detection.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">DFPS</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>chg_polys, chg_mag, radius<span style="color: #00ffff;">=</span><span style="color: #daa520;">100</span>, delta<span style="color: #00ffff;">=</span>.<span style="color: #daa520;">01</span>, m<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, maxiter<span style="color: #00ffff;">=</span><span style="color: #daa520;">20</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    chg_pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>chg_mag, chg_polys<span style="color: #20b2aa;">))</span>
    nochg_polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gDifference</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gBuffer</span><span style="color: #20b2aa;">(</span>chg_polys, width<span style="color: #00ffff;">=</span>radius<span style="color: #20b2aa;">)</span>, chg_polys<span style="color: #20b2aa;">)</span>
    nochg_pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>chg_mag, nochg_polys<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate total number of pixels (used later)</span>
    A <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>nochg_pixels<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set initial values for Lmax and Lmin that ensure the below while loop </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">will run.</span>
    Lmax <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
    Lmin <span style="color: #00ffff;">&lt;-</span> Lmax <span style="color: #00ffff;">-</span> <span style="color: #daa520;">2</span> * delta
    min_threshold <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span>
    max_threshold <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>chg_pixels<span style="color: #20b2aa;">)</span>
    n <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">while</span> <span style="color: #20b2aa;">((</span>Lmax <span style="color: #00ffff;">-</span> Lmin<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> delta &amp;&amp; n <span style="color: #00ffff;">&lt;</span> maxiter<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        p <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>max_threshold <span style="color: #00ffff;">-</span> min_threshold<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> m
        thresholds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>min_threshold, max_threshold, p<span style="color: #20b2aa;">)</span>
        L <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>threshold <span style="color: #ff00ff;">in</span> thresholds<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            A<span style="color: #daa520;">1</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>chg_pixels <span style="color: #00ffff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span>
            A<span style="color: #daa520;">2</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>nochg_pixels <span style="color: #00ffff;">&gt;</span> threshold<span style="color: #20b2aa;">)</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Calculate A according to equation </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> in Chen et al. </span><span style="color: #daa520;">2003</span>
            L <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>L, <span style="color: #20b2aa;">((</span>A<span style="color: #daa520;">1</span> <span style="color: #00ffff;">-</span> A<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> A<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        kmax <span style="color: #00ffff;">&lt;-</span> thresholds<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>, L<span style="color: #20b2aa;">)]</span>
        min_threshold <span style="color: #00ffff;">&lt;-</span> kmax <span style="color: #00ffff;">-</span> p
        max_threshold <span style="color: #00ffff;">&lt;-</span> kmax <span style="color: #00ffff;">+</span> p
        Lmin <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>
        Lmax <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>L<span style="color: #20b2aa;">)</span>
        n <span style="color: #00ffff;">&lt;-</span> n <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>kmax<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-23" class="outline-2">
<h2 id="sec-23"><span class="section-number-2">23</span> ee<sub>plot</sub>.R</h2>
<div class="outline-text-2" id="text-23">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Plot EarthExplorer scene list</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function can produce two different types of plots from a USGS </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> EarthExplorer Landsat CDR Surface Reflectance scene list.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> ggplot</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dplyr</span><span style="color: #00bfff;"> group_by summarize</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> new_interval %within%</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{data.frame} with a list of Landsat scenes as output by</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{ee_read}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">start_date</span><span style="color: #00bfff;"> starting date as a \code{Date} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">end_date</span><span style="color: #00bfff;"> end date as a \code{Date} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">min_clear</span><span style="color: #00bfff;"> the minimum percent clear to plot (calculated as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> - </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> percent cloud cover). Images with less than \code{min_clear} fraction of the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image area free of clouds will be ignored.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">exclude</span><span style="color: #00bfff;"> a list of sensors to exclude (for example, set </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{exclude=c('LE</span><span style="color: #daa520;">7</span><span style="color: #00bfff;">', 'LT</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">')} to exclude Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> ETM+ and Landsat </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> TM </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> images.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">normalize</span><span style="color: #00bfff;"> if \code{TRUE}, plot as a normalized line plot</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">title</span><span style="color: #00bfff;"> title for plot (or \code{NULL} for no title)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> used for side effect of producing a plot</span>
<span style="color: #ff6347;">ee_plot</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, start_date, end_date, min_clear<span style="color: #00ffff;">=</span>.<span style="color: #daa520;">7</span>, exclude<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, 
                    normalize<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, title<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'start_date must be a Date object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'end_date must be a Date object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>x$Sensor <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> exclude<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x$Sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>x$Sensor<span style="color: #20b2aa;">)</span>
    x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>x$WRS.Path, x$WRS.Row<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Frac_Clear <span style="color: #00ffff;">&gt;=</span> min_clear, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> ||
        <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'both start_date and end_date must be provided'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        sel_interval <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>start_date, end_date<span style="color: #20b2aa;">)</span>
        x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Date.Acquired <span style="color: #00ffff;">%</span>within<span style="color: #00ffff;">%</span> sel_interval, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no data to plot - try different start/end dates'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!normalize<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        YearMonth<span style="color: #00ffff;">=</span>Month<span style="color: #00ffff;">=</span>Cum_Month<span style="color: #00ffff;">=</span>Path_Row<span style="color: #00ffff;">=</span>Sensor<span style="color: #00ffff;">=</span>Frac_Clear<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span> <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Keep R CMD CHECK happy</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">transform</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>x, YearMonth<span style="color: #20b2aa;">)</span>,
                       Cum_Month<span style="color: #00ffff;">=</span><span style="color: #ff6347;">cumsum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>Month<span style="color: #20b2aa;">))))</span>
        p <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>xmin<span style="color: #00ffff;">=</span>Month,
                           xmax<span style="color: #00ffff;">=</span>Month <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>, 
                           ymin<span style="color: #00ffff;">=</span>Cum_Month <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>, 
                           ymax<span style="color: #00ffff;">=</span>Cum_Month,
                           colour<span style="color: #00ffff;">=</span>Sensor,
                           fill<span style="color: #00ffff;">=</span>Path_Row,
                           alpha<span style="color: #00ffff;">=</span>Frac_Clear<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">geom_rect</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">facet_grid</span><span style="color: #20b2aa;">(</span>Year ~ ., scales<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'free_y'</span>, space<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'free_y'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Month'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">scale_x_continuous</span><span style="color: #20b2aa;">(</span>breaks<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">9</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">11</span>, <span style="color: #daa520;">12</span><span style="color: #20b2aa;">)</span>,
                               labels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Jan'</span>, <span style="color: #00ff00;">'Feb'</span>, <span style="color: #00ff00;">'Mar'</span>, <span style="color: #00ff00;">'Apr'</span>, <span style="color: #00ff00;">'May'</span>, <span style="color: #00ff00;">'Jun'</span>, 
                                        <span style="color: #00ff00;">'Jul'</span>, <span style="color: #00ff00;">'Aug'</span>, <span style="color: #00ff00;">'Sep'</span>, <span style="color: #00ff00;">'Oct'</span>, <span style="color: #00ff00;">'Nov'</span>, <span style="color: #00ff00;">'Dec'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>panel.grid.minor.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, 
                  panel.grid.major.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  panel.grid.major.x<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.ticks.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  axis.text.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">scale_colour_brewer</span><span style="color: #20b2aa;">(</span>type<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'qual'</span>, palette<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Set</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">'</span>, drop<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, name<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Sensor'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">scale_fill_brewer</span><span style="color: #20b2aa;">(</span>type<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'qual'</span>, palette<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Set</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span>, drop<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, name<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Path/Row'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">scale_alpha</span><span style="color: #20b2aa;">(</span>name<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Fraction Clear'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Keep R CMD CHECK happy:</span>
        YearMonth<span style="color: #00ffff;">=</span>Path_Row<span style="color: #00ffff;">=</span>Year<span style="color: #00ffff;">=</span>Month<span style="color: #00ffff;">=</span>Max_Frac_Clear<span style="color: #00ffff;">=</span>Frac_Clear<span style="color: #00ffff;">=</span>Sum_Max_Frac_Clear<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
        Frac_Clear_Stats <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>x, YearMonth, Path_Row<span style="color: #20b2aa;">)</span>,
                                      Year<span style="color: #00ffff;">=</span>Year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, Month<span style="color: #00ffff;">=</span>Month<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                                      Max_Frac_Clear<span style="color: #00ffff;">=</span><span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>Frac_Clear<span style="color: #20b2aa;">))</span>
        Frac_Clear_Stats <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>Frac_Clear_Stats, YearMonth<span style="color: #20b2aa;">)</span>, 
                                      Year<span style="color: #00ffff;">=</span>Year<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, Month<span style="color: #00ffff;">=</span>Month<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                                      Sum_Max_Frac_Clear<span style="color: #00ffff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>Max_Frac_Clear<span style="color: #20b2aa;">))</span>
        p <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>Frac_Clear_Stats, <span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>xmin<span style="color: #00ffff;">=</span>Month <span style="color: #00ffff;">+</span> .<span style="color: #daa520;">05</span>,
                                          xmax<span style="color: #00ffff;">=</span>Month <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #00ffff;">-</span>.<span style="color: #daa520;">05</span>, 
                                          ymin<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>, 
                                          ymax<span style="color: #00ffff;">=</span>Sum_Max_Frac_Clear<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">geom_rect</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">facet_grid</span><span style="color: #20b2aa;">(</span>Year ~ .<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">xlab</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Month'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">ylab</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Total Fraction Clear'</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">scale_x_continuous</span><span style="color: #20b2aa;">(</span>breaks<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">9</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">11</span>, <span style="color: #daa520;">12</span><span style="color: #20b2aa;">)</span>,
                               labels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Jan'</span>, <span style="color: #00ff00;">'Feb'</span>, <span style="color: #00ff00;">'Mar'</span>, <span style="color: #00ff00;">'Apr'</span>, <span style="color: #00ff00;">'May'</span>, <span style="color: #00ff00;">'Jun'</span>, 
                                        <span style="color: #00ff00;">'Jul'</span>, <span style="color: #00ff00;">'Aug'</span>, <span style="color: #00ff00;">'Sep'</span>, <span style="color: #00ff00;">'Oct'</span>, <span style="color: #00ff00;">'Nov'</span>, <span style="color: #00ff00;">'Dec'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>panel.grid.minor.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, 
                  panel.grid.major.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  panel.grid.major.x<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.ticks.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
                  axis.text.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">())</span> <span style="color: #00ffff;">+</span>
            <span style="color: #ff6347;">geom_hline</span><span style="color: #20b2aa;">(</span>yintercept<span style="color: #00ffff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>,<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$Path_Row<span style="color: #20b2aa;">)))</span>, colour<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'white'</span>, linetype<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'dashed'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>title<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        p <span style="color: #00ffff;">&lt;-</span> p <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">ggtitle</span><span style="color: #20b2aa;">(</span>title<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>p<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-24" class="outline-2">
<h2 id="sec-24"><span class="section-number-2">24</span> ee<sub>read</sub>.R</h2>
<div class="outline-text-2" id="text-24">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Read EarthExplorer CSV format scene list</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function reads in a CSV file of Landsat CDR Surface Reflectance images </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as output from USGS EarthExplorer. param x a \code{data.frame} with a list </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of Landsat scenes as output from the save metadata function on </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> path to a CSV file with a list of Landsat scenes as output from the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> save metadata function on http://earthexplorer.usgs.gov</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> x a \code{data.frame} with a list of Landsat scenes and their </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> associated metadata</span>
<span style="color: #ff6347;">ee_read</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    scenes <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">read.csv</span><span style="color: #20b2aa;">(</span>x, stringsAsFactors<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, quote<span style="color: #00ffff;">=</span>, 
                          na.strings<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'NA'</span>, <span style="color: #00ff00;">' '</span><span style="color: #20b2aa;">))</span>
    scenes$Sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>scenes$Landsat.Scene.Identifier, <span style="color: #daa520;">1</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
    scenes$Sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>scenes$Sensor<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Dates are formatted as either: </span><span style="color: #daa520;">1999</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">12</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">31</span><span style="color: #00bfff;"> or </span><span style="color: #daa520;">12</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">31</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">1999</span>
    yr_first <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">}/'</span>, scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    yr_last <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'/[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">}$'</span>, scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>yr_first<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>yr_last<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'unrecognized date format in Date.Acquired column'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    acq_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">)</span>
    acq_date<span style="color: #20b2aa;">[</span>yr_first<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">[</span>yr_first<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'%Y/%m/%d'</span><span style="color: #20b2aa;">)</span>
    acq_date<span style="color: #20b2aa;">[</span>yr_last<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired<span style="color: #20b2aa;">[</span>yr_last<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'%m/%d/%Y'</span><span style="color: #20b2aa;">)</span>
    scenes$Date.Acquired <span style="color: #00ffff;">&lt;-</span> acq_date
    scenes$Year <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #00ff00;">'%Y'</span><span style="color: #20b2aa;">))</span>
    scenes$Month <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #00ff00;">'%m'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">-</span> .<span style="color: #daa520;">5</span>
    scenes$MonthFactor <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>scenes$Date.Acquired, <span style="color: #00ff00;">'%m'</span><span style="color: #20b2aa;">))</span>
    scenes$Path_Row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>scenes$WRS.Path, scenes$WRS.Row, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'/'</span><span style="color: #20b2aa;">))</span>
    scenes$YearMonth <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>scenes$Year, scenes$MonthFactor, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'/'</span><span style="color: #20b2aa;">)</span>
    scenes$Frac_Clear <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">100</span> <span style="color: #00ffff;">-</span> scenes$Cloud.Cover<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #daa520;">100</span>
    scenes <span style="color: #00ffff;">&lt;-</span> scenes<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>scenes$WRS.Path, scenes$WRS.Row<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no data found in'</span>, x,
                    <span style="color: #00ff00;">' - is scenes an EarthExplorer CSV export?'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Drop ENGINEERING, TEST, EXCHANGE, and VALIDATION data. See the Landsat </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">data dictionary at: https://lta.cr.usgs.gov/landsat_dictionary.html</span>
    scenes <span style="color: #00ffff;">&lt;-</span> scenes<span style="color: #20b2aa;">[</span>scenes$Data.Category <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'NOMINAL'</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>scenes<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-25" class="outline-2">
<h2 id="sec-25"><span class="section-number-2">25</span> espa<sub>download</sub>.R</h2>
<div class="outline-text-2" id="text-25">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">verify_download</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>espa_url, local_path<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    cksum_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">()</span>
    ret_code <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">download.file</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\\.tar\\.gz$'</span>, <span style="color: #00ff00;">'.cksum'</span>, espa_url<span style="color: #20b2aa;">)</span>, 
                              cksum_file, mode<span style="color: #00ffff;">=</span>w, quiet<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Warning: problem downloading cksum for'</span>, local_path<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Check return code and handle accordingly</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">The first element is the cksum, second is the expected file size in </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">bytes, and the third is the filename</span>
        espa_checksum <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scan</span><span style="color: #20b2aa;">(</span>cksum_file, what<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'integer'</span>, <span style="color: #00ff00;">'integer'</span>, 
                                                 <span style="color: #00ff00;">'character'</span><span style="color: #20b2aa;">)</span>, quiet<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span>cksum_file<span style="color: #20b2aa;">)</span>
        local_size <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>local_path<span style="color: #20b2aa;">)</span>$size
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Figure out how to compute a checksum in R that matches the checksum </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">output ESPA gives. It appears the ESPA checksum is a CRC from 'cksum' </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">command run on Linux. This is not a CRC-</span><span style="color: #daa520;">32</span><span style="color: #00bfff;"> checksum, so the R digest </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">package won't work for computing it. bitops has a function, 'cksum' that </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">might work.</span>
        <span style="color: #00bfff;">#</span><span style="color: #00bfff;">local_crc &lt;- strtoi(digest(, algo=crc</span><span style="color: #daa520;">32</span><span style="color: #00bfff;">, file=TRUE), base=</span><span style="color: #daa520;">16</span><span style="color: #00bfff;">L)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">f = file(local_path,rb)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">local_crc &lt;- cksum(rawToChar(readBin(f, raw(), n=local_size)))</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">close(f)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">if (espa_checksum[</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">] != local_crc) {</span>
        <span style="color: #00bfff;">#     </span><span style="color: #00bfff;">return(</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">} else if (espa_checksum[</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">] != local_size) {</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>espa_checksum<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> !<span style="color: #00ffff;">=</span> local_size<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">download_ESPA_file</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>espa_url, output_path<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    ret_code <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">download.file</span><span style="color: #20b2aa;">(</span>espa_url, output_path, mode<span style="color: #00ffff;">=</span>wb<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Warning: problem downloading'</span>, output_path<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">verify_download</span><span style="color: #20b2aa;">(</span>espa_url, output_path<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>Warning: checksum mismatch on, output_path<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Download a completed ESPA order</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Function to download a set of Landsat images from ESPA given a valid order </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> ID and the email that placed the ESPA order.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">RCurl</span><span style="color: #00bfff;"> getURL getCurlHandle postForm</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">email</span><span style="color: #00bfff;"> address used to place the order</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">order_ID</span><span style="color: #00bfff;"> the ESPA order ID</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_folder</span><span style="color: #00bfff;"> the folder to save output data in</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">username</span><span style="color: #00bfff;"> your USGS EarthExplorer username</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">password</span><span style="color: #00bfff;"> your USGS EarthExplorer password</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> used for the side effect of downloading Landsat scenes</span>
<span style="color: #ff6347;">espa_download</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>email, order_ID, output_folder, username,
                          password<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>Due to changes <span style="color: #ff00ff;">in</span> the ESPA system, espa_download is not working as of <span style="color: #daa520;">7</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">1</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">2014</span><span style="color: #20b2aa;">)</span>
    email_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'^[A-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">._%+-]+@[A-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">.-]+\\.[A-Z]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">,</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">}$'</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>email_re, email, ignore.case<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>email, <span style="color: #00ff00;">'does not appear to be a valid email address'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Below is for old format ESPA order IDs (through end of </span><span style="color: #daa520;">2013</span><span style="color: #00bfff;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">ESPA generates order IDs with below Python code:</span>
    <span style="color: #00bfff;">#    </span><span style="color: #00bfff;">d = datetime.datetime.now()</span>
    <span style="color: #00bfff;">#    </span><span style="color: #00bfff;">return '%s-%s%s%s-%s%s%s' % (email,d.month,d.day,d.year,d.hour,d.minute,d.second)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that the above does not guarantee unique ESPA order IDs. See</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">https://code.google.com/p/espa/issues/detail?id=</span><span style="color: #daa520;">123</span><span style="color: #00bfff;"> for details.</span>
    mth_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'([</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]|(</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">]))'</span>
    day_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'([</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]|([</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">])|(</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">]))'</span>
    yr_re  <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'</span><span style="color: #daa520;">20</span><span style="color: #00ff00;">[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]'</span>
    hr_re  <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'([</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]|(</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">])|(</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">]))'</span>
    min_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'([</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]|([</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]))'</span>
    sec_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'([</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]|([</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">][</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]))'</span>
    order_id_re <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^'</span>, mth_re, day_re, yr_re, <span style="color: #00ff00;">'-'</span>,  hr_re, min_re, sec_re, <span style="color: #00ff00;">'$'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>order_id_re, order_ID<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>order_ID, <span style="color: #00ff00;">'does not appear to be a valid ESPA order ID'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>output_folder, <span style="color: #00ff00;">'does not appear to be a valid directory'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Parse ESPA page for download links</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Rewrite using httr - see http://bit.ly/</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">m</span><span style="color: #daa520;">8</span><span style="color: #00bfff;">ZWXf</span>
    email_noat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'@'</span>, <span style="color: #00ff00;">'%</span><span style="color: #daa520;">40</span><span style="color: #00ff00;">'</span>, email<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">options</span><span style="color: #20b2aa;">(</span>RCurlOptions<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>cainfo<span style="color: #00ffff;">=</span><span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>CurlSSL, cacert.pem, 
                                                 package<span style="color: #00ffff;">=</span>RCurl<span style="color: #20b2aa;">)))</span>
    curl<span style="color: #00ffff;">=</span><span style="color: #ff6347;">getCurlHandle</span><span style="color: #20b2aa;">()</span>
    login_page <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">strsplit</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getURL</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'https://espa.cr.usgs.gov/login/'</span>, curl<span style="color: #00ffff;">=</span>curl<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">))</span>
    csrfmiddlewaretoken <span style="color: #00ffff;">&lt;-</span> login_page<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span>csrfmiddlewaretoken, login_page<span style="color: #20b2aa;">)]</span>
    csrfmiddlewaretoken <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">((</span>value<span style="color: #00ffff;">=</span><span style="color: #20b2aa;">)</span>|<span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'), '',</span>
<span style="color: #00ff00;">                                str_extract(csrfmiddlewaretoken, </span>
<span style="color: #00ff00;">                                            value='</span><span style="color: #20b2aa;">[</span>a<span style="color: #00ffff;">-</span>zA<span style="color: #00ffff;">-</span>Z<span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]</span>*<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">    params &lt;- list('</span>username<span style="color: #00ff00;">'=username,</span>
<span style="color: #00ff00;">                   '</span>password<span style="color: #00ff00;">'=password,</span>
<span style="color: #00ff00;">                   '</span>submit<span style="color: #00ff00;">'=Log In,</span>
<span style="color: #00ff00;">                   '</span><span style="color: #ff00ff;">next</span><span style="color: #00ff00;">'=,</span>
<span style="color: #00ff00;">                   '</span>csrfmiddlewaretoken<span style="color: #00ff00;">'=csrfmiddlewaretoken)</span>
<span style="color: #00ff00;">    post_res &lt;- postForm('</span>https:<span style="color: #00ffff;">//</span>espa.cr.usgs.gov<span style="color: #00ffff;">/</span>login<span style="color: #00ff00;">',</span>
<span style="color: #00ff00;">                         .params=params, style=POST, curl=curl)</span>
<span style="color: #00ff00;">    tryCatch(espa_page &lt;- getURL(paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">(http://espa.cr.usgs.gov/ordering/status/, email_noat, </span>
<span style="color: #00ff00;">                             -, order_ID, curl=curl)),</span>
<span style="color: #00ff00;">             error=function(e) stop('</span>error loading order <span style="color: #00ffff;">-</span> check order ID and email<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">    url_re &lt;- paste</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">('</span>http:<span style="color: #00ffff;">//</span>espa\\.cr\\.usgs\\.gov<span style="color: #00ffff;">/</span>orders<span style="color: #00ffff;">/</span><span style="color: #00ff00;">', email, '</span><span style="color: #00ffff;">-</span><span style="color: #00ff00;">', </span>
<span style="color: #00ff00;">                     order_ID, '</span><span style="color: #00ffff;">/</span>L<span style="color: #20b2aa;">[</span>ET<span style="color: #20b2aa;">][</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">14</span><span style="color: #20b2aa;">}</span><span style="color: #00ffff;">-</span>SC<span style="color: #20b2aa;">[</span><span style="color: #daa520;">0</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">9</span><span style="color: #20b2aa;">]{</span><span style="color: #daa520;">14</span><span style="color: #20b2aa;">}</span>\\.tar\\.gz<span style="color: #00ff00;">')</span>
<span style="color: #00ff00;">    espa_urls &lt;- espa_page[grepl(url_re, espa_page)]</span>
<span style="color: #00ff00;">    espa_urls &lt;- str_extract(espa_urls, url_re)</span>
<span style="color: #00ff00;">    if (length(espa_urls) == </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">        stop('</span>no download links found<span style="color: #00ff00;">')</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    successes &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    failures &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    skips &lt;- </span><span style="color: #daa520;">0</span>
<span style="color: #00ff00;">    message(paste('</span>Found<span style="color: #00ff00;">', length(espa_urls), '</span>ESPA downloads.<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">    for (n in </span><span style="color: #daa520;">1</span><span style="color: #00ff00;">:length(espa_urls)) {</span>
<span style="color: #00ff00;">        espa_url &lt;- espa_urls[n]</span>
<span style="color: #00ff00;">        img_file &lt;- basename(espa_url)</span>
<span style="color: #00ff00;">        output_path &lt;- file.path(output_folder, img_file)</span>
<span style="color: #00ff00;">        if (file.exists(output_path)) {</span>
<span style="color: #00ff00;">            if (verify_download(espa_url, output_path)) {</span>
<span style="color: #00ff00;">                message(paste(img_file, '</span>exists but has bad checksum <span style="color: #00ffff;">-</span> re<span style="color: #00ffff;">-</span>downloading file<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">            } else {</span>
<span style="color: #00ff00;">                message(paste(img_file, '</span>exists and has good checksum <span style="color: #00ffff;">-</span> skipping download<span style="color: #00ff00;">'))</span>
<span style="color: #00ff00;">                skips &lt;- skips + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">                next</span>
<span style="color: #00ff00;">            }</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">        if (download_ESPA_file(espa_url, output_path) == </span><span style="color: #daa520;">0</span><span style="color: #00ff00;">) {</span>
<span style="color: #00ff00;">            successes &lt;- successes + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">        } else {</span>
<span style="color: #00ff00;">            failures &lt;- failures + </span><span style="color: #daa520;">1</span>
<span style="color: #00ff00;">        }</span>
<span style="color: #00ff00;">    }</span>
<span style="color: #00ff00;">    message(paste(successes, file(s) succeeded,, skips, file(s) skipped,, </span>
<span style="color: #00ff00;">                failures, file(s) failed.))</span>
<span style="color: #00ff00;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-26" class="outline-2">
<h2 id="sec-26"><span class="section-number-2">26</span> espa<sub>extract</sub>.R</h2>
<div class="outline-text-2" id="text-26">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Extract a set of Landsat tarballs into a folder tree organized by image date</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Each image .tar.gz file will be extracted into a subfolder within </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{output_folder}. The subfolders will be named according to the year and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Julian date of capture, and the sensor type (LT</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, LT</span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> or LE</span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> for Landsat </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> TM, Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> TM, and Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> ETM+ respectively). For example, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> LT</span><span style="color: #daa520;">50150531986037</span><span style="color: #00bfff;">-SC</span><span style="color: #daa520;">20130816144215</span><span style="color: #00bfff;">.tar.gz would be extracted into a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> subfolder named </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">037</span><span style="color: #00bfff;">_LT</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">', for </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, Julian day </span><span style="color: #daa520;">37</span><span style="color: #00bfff;">, and Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> TM.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Zip files for images from sensors not included in \code{sensors}, from </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> path/rows not included in \code{pathrows} or with acquisition dates</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> outside of the period defined by \code{start_date} and \code{end_date} will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> be ignored.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">in_folder</span><span style="color: #00bfff;"> Path to a folder of .tar.gz Landsat surface reflectance </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> images</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out_folder</span><span style="color: #00bfff;"> output folder</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">pathrows</span><span style="color: #00bfff;"> a list of paths/rows to include. Each path/row should be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> specified as a six digit string. For example, path </span><span style="color: #daa520;">231</span><span style="color: #00bfff;">, row </span><span style="color: #daa520;">62</span><span style="color: #00bfff;"> would be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> specified as </span><span style="color: #daa520;">231062</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">start_date</span><span style="color: #00bfff;"> start date of period from which images will be extracted</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to (as \code{Date} object).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">end_date</span><span style="color: #00bfff;"> end date of period from which images will be extracted</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to (as \code{Date} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sensors</span><span style="color: #00bfff;"> a list of the sensors to include (can be any of LT</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, LT</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> LE</span><span style="color: #daa520;">7</span><span style="color: #00bfff;">, or LC</span><span style="color: #daa520;">8</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing (used for side effect of unzipping Landsat CDR tarballs)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Don't filter:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> espa_extract('D:/Landsat_Originals', 'D:/Landsat_Out')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Filter by start and end date:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> start_date &lt;- as.Date('</span><span style="color: #daa520;">2010</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> end_date &lt;- as.Date('</span><span style="color: #daa520;">2010</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">12</span><span style="color: #00bfff;">/</span><span style="color: #daa520;">31</span><span style="color: #00bfff;">')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> espa_extract('D:/Landsat_Originals', 'D:/Landsat_Out',</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">              start_date=start_date, end_date=end_date)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Filter by start and end date, sensor, and pathrow:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> espa_extract('D:/Landsat_Originals', 'D:/Landsat_Out', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">              start_date=start_date, end_date=end_date, sensors='LE</span><span style="color: #daa520;">7</span><span style="color: #00bfff;">',</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">              pathrows='</span><span style="color: #daa520;">231062</span><span style="color: #00bfff;">')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">espa_extract</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>in_folder, out_folder, pathrows<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, start_date<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                         end_date<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, sensors<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>in_folder, <span style="color: #00ff00;">'does not exist'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, out_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>out_folder, <span style="color: #00ff00;">'does not exist'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>

    zipfiles <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>in_folder, pattern<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'^.*.tar.gz(ip)?$'</span><span style="color: #20b2aa;">)</span>

    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Filter by date</span>
    img_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-'</span>, <span style="color: #00ff00;">''</span>, <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, <span style="color: #00ff00;">'[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">}-'</span><span style="color: #20b2aa;">))</span>, <span style="color: #00ff00;">'%Y%j'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span>
        inc_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>img_dates <span style="color: #00ffff;">&gt;=</span> start_date<span style="color: #20b2aa;">)</span>
        zipfiles <span style="color: #00ffff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span>
        inc_dates <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>img_dates <span style="color: #00ffff;">&lt;</span> end_date<span style="color: #20b2aa;">)</span>
        zipfiles <span style="color: #00ffff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_dates<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Filter by pathrow</span>
    img_pathrows <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'(LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">)'</span>, <span style="color: #00ff00;">''</span>, <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, <span style="color: #00ff00;">'((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>pathrows<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>pathrows, <span style="color: #00ff00;">'[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">6</span><span style="color: #00ff00;">}'</span><span style="color: #20b2aa;">)))</span>
        inc_pathrows <span style="color: #00ffff;">&lt;-</span> img_pathrows <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> pathrows
        zipfiles <span style="color: #00ffff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
        img_pathrows <span style="color: #00ffff;">&lt;-</span> img_pathrows<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_pathrows<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Filter by sensor</span>
    img_sensors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>zipfiles, <span style="color: #00ff00;">'^((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sensors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>sensors, <span style="color: #00ff00;">'^((LT[</span><span style="color: #daa520;">45</span><span style="color: #00ff00;">])|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))$'</span><span style="color: #20b2aa;">)))</span>
        inc_sensors <span style="color: #00ffff;">&lt;-</span> img_sensors <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> sensors
        zipfiles <span style="color: #00ffff;">&lt;-</span> zipfiles<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_pathrows <span style="color: #00ffff;">&lt;-</span> img_pathrows<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_sensors <span style="color: #00ffff;">&lt;-</span> img_sensors<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
        img_dates <span style="color: #00ffff;">&lt;-</span> img_dates<span style="color: #20b2aa;">[</span>inc_sensors<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>

    img_paths <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>img_pathrows, <span style="color: #00ff00;">'^[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}'</span><span style="color: #20b2aa;">)</span>
    img_rows <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>img_pathrows, <span style="color: #00ff00;">'[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}$'</span><span style="color: #20b2aa;">)</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'No images found'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        zipfile_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>in_folder, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Figure out which satellite the image is from</span>
        year <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_dates<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'%Y'</span><span style="color: #20b2aa;">)</span>
        julian_day <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_dates<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'%j'</span><span style="color: #20b2aa;">)</span>
        this_out_folder <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_folder,
                                     <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>img_paths<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>,<span style="color: #00ff00;">'-'</span>, img_rows<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'_'</span>, year, 
                                            <span style="color: #00ff00;">'-'</span>, julian_day, <span style="color: #00ff00;">'_'</span>, img_sensors<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, this_out_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">dir.create</span><span style="color: #20b2aa;">(</span>this_out_folder<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Skipping'</span>, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'- output dir'</span>, 
                          this_out_folder, <span style="color: #00ff00;">'already exists.'</span><span style="color: #20b2aa;">))</span>
            <span style="color: #ff00ff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>n, <span style="color: #00ff00;">' of '</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>zipfiles<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'. Extracting '</span>, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">' to '</span>, this_out_folder<span style="color: #20b2aa;">))</span>
        ret_code <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">untar</span><span style="color: #20b2aa;">(</span>zipfile_path, exdir<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>this_out_folder<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>ret_code !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'WARNING: error extracting'</span>, zipfiles<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'- return </span>
<span style="color: #00ff00;">                          code'</span>, ret_code<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-27" class="outline-2">
<h2 id="sec-27"><span class="section-number-2">27</span> espa<sub>scenelist</sub>.R</h2>
<div class="outline-text-2" id="text-27">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Save scenelist from EarthExplorer metadata for upload to ESPA</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> new_interval %within%</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{data.frame} with a list of Landsat scenes as output from </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the save metadata function on http://earthexplorer.usgs.gov</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">start_date</span><span style="color: #00bfff;"> starting date as a \code{Date} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">end_date</span><span style="color: #00bfff;"> end date as a \code{Date} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out_file</span><span style="color: #00bfff;"> filename for output text file for later upload to ESPA</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">min_clear</span><span style="color: #00bfff;"> the minimum percent clear to plot (calculated as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> - </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> percent cloud cover). Images with less than \code{min_clear} fraction of the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> image area free of clouds will be ignored.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">exclude</span><span style="color: #00bfff;"> a list of sensors to exclude (for example, set </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{exclude=c('LE</span><span style="color: #daa520;">7</span><span style="color: #00bfff;">', 'LT</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">')} to exclude Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> ETM+ and Landsat </span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> TM </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> images.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> used for side effect of producing ESPA scene list</span>
<span style="color: #ff6347;">espa_scenelist</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, start_date, end_date, out_file, min_clear<span style="color: #00ffff;">=</span>.<span style="color: #daa520;">7</span>, 
                         exclude<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">())</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'start_date must be a Date object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Date'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'end_date must be a Date object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> ||
        <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'both start_date and end_date must be provided'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>start_date<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>end_date<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        sel_interval <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">new_interval</span><span style="color: #20b2aa;">(</span>start_date, end_date<span style="color: #20b2aa;">)</span>
        x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Date.Acquired <span style="color: #00ffff;">%</span>within<span style="color: #00ffff;">%</span> sel_interval, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no data to download - try different start/end dates'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>x$Sensor <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> exclude<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    x <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$Frac_Clear <span style="color: #00ffff;">&gt;=</span> min_clear, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">write.table</span><span style="color: #20b2aa;">(</span>x$Landsat.Scene.Identifier, out_file, row.names<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                col.names<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, quote<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-28" class="outline-2">
<h2 id="sec-28"><span class="section-number-2">28</span> fill<sub>gaps</sub>.R</h2>
<div class="outline-text-2" id="text-28">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Perform SLC-off gap fill of Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> ETM+ image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calls GNSPI.pro IDL script by Xiaolin Zhu to fill gaps in SLC-off Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> ETM+ image. The script requires \code{fill} to be a TM (Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;">) image.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{slc_off} must be a Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> SLC-off image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> If supplied, \code{timeseries} should be a list of TM images.  Performing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> gap fill using SLC-Off ETM+ images as the input is not yet supported.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Pixels in gaps, background, and/or clouds in \code{slc_off}, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{input_image}, and the images in \code{timeseries} should be coded as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slc_off</span><span style="color: #00bfff;"> the SLC-off Landsat </span><span style="color: #daa520;">7</span><span style="color: #00bfff;"> file to gap fill, as a \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">fill</span><span style="color: #00bfff;"> the first TM image to use to fill in the gaps, as a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">timeseries</span><span style="color: #00bfff;"> a timeseries of TM images as \code{Raster*} objects to use </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as additional inputs to the gap fill algorithm (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out_base</span><span style="color: #00bfff;"> path and base filename for the output file. The script will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> save the output files by appending _GNSPI.envi and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> _GNSPI_uncertainty.envi to this base filename.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">ext</span><span style="color: #00bfff;"> file extension to use when and when saving output rasters </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (determines output file format). Must be supported by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{writeRaster}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">algorithm</span><span style="color: #00bfff;"> the algorithm to use, as a string (GNSPI_IDL is currently </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the only supported algorithm)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sample_size</span><span style="color: #00bfff;"> the sample size of sample pixels</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">size_wind</span><span style="color: #00bfff;"> the maximum window size</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_num</span><span style="color: #00bfff;"> the estimated number of classes</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> the minimum DN value of the image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> the maximum DN value of the image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">patch_long</span><span style="color: #00bfff;"> the size of block, to process whole ETM scene, set to </span><span style="color: #daa520;">1000</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">idl</span><span style="color: #00bfff;"> path to the IDL binary</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite output files if they already exist</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a list of two rasters: </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) filled, the gap filled image, and </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> uncertainty, the uncertainty image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Zhu, X., Liu, D., Chen, J., </span><span style="color: #daa520;">2012</span><span style="color: #00bfff;">. A new geostatistical approach </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for filling gaps in Landsat ETM+ SLC-off images. Remote Sensing of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Environment </span><span style="color: #daa520;">124</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">49</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">60</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> slc_off &lt;- brick(system.file('tests', 'testthat_idl', 'fill_gaps', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'TM</span><span style="color: #daa520;">20100429</span><span style="color: #00bfff;">_toaR_gap', package='teamlucc'))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fill &lt;- brick(system.file('tests', 'testthat_idl', 'fill_gaps', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'TM</span><span style="color: #daa520;">20100515</span><span style="color: #00bfff;">_toaR', package='teamlucc'))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timeseries &lt;- c(brick(system.file('tests', 'testthat_idl', 'fill_gaps', </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'TM</span><span style="color: #daa520;">20100208</span><span style="color: #00bfff;">_toaR', package='teamlucc')))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> filled &lt;- fill_gaps(slc_off, fill, timeseries)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">fill_gaps</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>, out_base<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, ext<span style="color: #00ffff;">=</span>tif,
                      algorithm<span style="color: #00ffff;">=</span>GNSPI_IDL, sample_size<span style="color: #00ffff;">=</span><span style="color: #daa520;">20</span>, size_wind<span style="color: #00ffff;">=</span><span style="color: #daa520;">12</span>, 
                      class_num<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span>, 
                      DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>.<span style="color: #daa520;">0</span>, patch_long<span style="color: #00ffff;">=</span><span style="color: #daa520;">1000</span>,
                      idl<span style="color: #00ffff;">=</span>C:<span style="color: #00ffff;">/</span>Program Files<span style="color: #00ffff;">/</span>Exelis<span style="color: #00ffff;">/</span>IDL<span style="color: #daa520;">83</span><span style="color: #00ffff;">/</span>bin<span style="color: #00ffff;">/</span>bin.x<span style="color: #daa520;">86</span>_<span style="color: #daa520;">64</span><span style="color: #00ffff;">/</span>idl.exe,
                      verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slc_off must be a Raster* object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'fill must be a Raster* object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'number of layers in slc_off must match number of layers in fill'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>slc_off, fill<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'GNSPI_IDL'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'algorithm must be GNSPI_IDL - no other algorithms are supported'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^[.]'</span>, <span style="color: #00ff00;">''</span>, ext<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>timeseries_img <span style="color: #ff00ff;">in</span> timeseries<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>RasterLayer, RasterStack, RasterBrick<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'each timeseries image be a Raster* object'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'number of layers in slc_off must match number of layers of each image in timeseries'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>slc_off, timeseries_img<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out_base<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        out_base <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">())</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        out_base <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">normalizePath</span><span style="color: #20b2aa;">(</span>out_base, mustWork<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>out_base<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output folder does not exist'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!overwrite &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_GNSPI.'</span>, ext<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output file already exists - use a different out_base'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!overwrite &amp;&amp; <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_GNSPI_uncertainty.'</span>, ext<span style="color: #20b2aa;">))))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output uncertainty file already exists - use a different out_base'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>

    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>algorithm <span style="color: #00ffff;">==</span> GNSPI_IDL<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">fill_gaps_idl</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries, out_base, 
                                sample_size, size_wind, class_num, DN_min, 
                                DN_max, patch_long, idl, algorithm, ext, 
                                verbose<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>Native R gap filling not yet supported<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">fill_gaps_idl</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slc_off, fill, timeseries, out_base, sample_size, 
                          size_wind, class_num, DN_min, DN_max, patch_long, 
                          idl, algorithm, ext, verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'verbose=TRUE not supported when algorithm=GNSPI_IDL'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    script_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system.file</span><span style="color: #20b2aa;">(</span>idl, GNSPI.pro, package<span style="color: #00ffff;">=</span>teamlucc<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-x'</span>, idl<span style="color: #20b2aa;">)</span> || <span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, idl<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'IDL not found - check idl parameter'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">check_ENVI_IDL</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>Unable to load ENVI <span style="color: #ff00ff;">in</span> IDL <span style="color: #00ffff;">-</span> do you have ENVI and IDL licenses, and ENVI <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">5</span>.<span style="color: #daa520;">0</span>?<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string and extend to ensure the same proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string and extent is </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">returned even if they are changed by IDL</span>
    orig_proj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    orig_ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    orig_datatype <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Write in-memory rasters to files for hand off to IDL. The capture.output </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">line is used to avoid printing the rasterOptions to screen as they are </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">temporarily reset.</span>
    dummy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span>def_format <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">()</span>$format<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'ENVI'</span><span style="color: #20b2aa;">)</span>
    slc_off <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>slc_off, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    slc_off_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>slc_off<span style="color: #20b2aa;">)</span>
    fill <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>fill, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    fill_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)</span>
    timeseries_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>timeseries<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Ensure timeseries_files equals an empty matrix, in IDL format</span>
        timeseries_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>timeseries_img <span style="color: #ff00ff;">in</span> timeseries<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            timeseries_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>timeseries_img, <span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">()</span>, datatype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>fill<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
            timeseries_files <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>timeseries_files, <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>timeseries_img<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    temp_dir <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">tempdir</span><span style="color: #20b2aa;">()</span>
    dummy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">capture.output</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterOptions</span><span style="color: #20b2aa;">(</span>format<span style="color: #00ffff;">=</span>def_format<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Save IDL output to a temp folder - it will be copied over and saved with </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">writeRaster later to ensure the extents and projection are not modified </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">from those of the original files.</span>
    temp_out_base <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rasterTmpFile</span><span style="color: #20b2aa;">())</span>
    param_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>slc_off_file, fill_file, timeseries_files,
                       temp_out_base, sample_size, size_wind, class_num,
                       DN_min, DN_max, patch_long, temp_dir<span style="color: #20b2aa;">)</span>
    param_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slc_off_file'</span>, <span style="color: #00ff00;">'input_file'</span>, <span style="color: #00ff00;">'timeseries_files'</span>, 
                        <span style="color: #00ff00;">'out_base'</span>, <span style="color: #00ff00;">'sample_size'</span>, <span style="color: #00ff00;">'size_wind'</span>, <span style="color: #00ff00;">'class_num'</span>, 
                        <span style="color: #00ff00;">'DN_min'</span>, <span style="color: #00ff00;">'DN_max'</span>, <span style="color: #00ff00;">'patch_long'</span>, <span style="color: #00ff00;">'temp_dir'</span><span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span>format_IDL_param, param_names, param_vals<span style="color: #20b2aa;">)</span>
    idl_params <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>idl_params, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">)</span>
    script_dir <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>script_path<span style="color: #20b2aa;">)</span>
    idl_script <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">tempfile</span><span style="color: #20b2aa;">(</span>fileext<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'.pro'</span><span style="color: #20b2aa;">)</span>
    idl_cmd <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'CD, '</span>, script_dir, <span style="color: #00ff00;">'\n'</span>, idl_params, <span style="color: #00ff00;">'GNSPI,'</span>, 
                      <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>param_names, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">','</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\nexit'</span><span style="color: #20b2aa;">)</span>
    f <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>idl_script, <span style="color: #00ff00;">'wt'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_cmd, f<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">system</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">shQuote</span><span style="color: #20b2aa;">(</span>idl_script<span style="color: #20b2aa;">))</span>, intern<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    log_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #00ff00;">'_GNSPI_idllog.txt'</span><span style="color: #20b2aa;">)</span>
    idl_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\r'</span>, <span style="color: #00ff00;">''</span>, idl_out<span style="color: #20b2aa;">)</span>
    f <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>log_file, <span style="color: #00ff00;">'wt'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">writeLines</span><span style="color: #20b2aa;">(</span>idl_out, f<span style="color: #20b2aa;">)</span> 
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>f<span style="color: #20b2aa;">)</span>
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>temp_out_base, <span style="color: #00ff00;">'_GNSPI.envi'</span><span style="color: #20b2aa;">))</span>
    filled_out_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_GNSPI.'</span>, ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>filled<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_ext
    filled <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>filled, filename<span style="color: #00ffff;">=</span>filled_out_file, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                          datatype<span style="color: #00ffff;">=</span>orig_datatype<span style="color: #20b2aa;">)</span>
    uncertainty <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">brick</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>temp_out_base, <span style="color: #00ff00;">'_GNSPI_uncertainty.envi'</span><span style="color: #20b2aa;">))</span>
    uncertainty_out_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>out_base, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_GNSPI_uncertainty.'</span>, ext<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>uncertainty<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_proj
    <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>uncertainty<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> orig_ext
    uncertainty <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>uncertainty, filename<span style="color: #00ffff;">=</span>uncertainty_out_file, 
                               overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, datatype<span style="color: #00ffff;">=</span>orig_datatype<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>filled<span style="color: #00ffff;">=</span>filled, uncertainty<span style="color: #00ffff;">=</span>uncertainty<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-29" class="outline-2">
<h2 id="sec-29"><span class="section-number-2">29</span> get<sub>band</sub><sub>names</sub><sub>from</sub><sub>hdr</sub>.R</h2>
<div class="outline-text-2" id="text-29">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Extract the band names listed in an ENVI format header file (.hdr)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">hdr_file</span><span style="color: #00bfff;"> an ENVI format header file with a .hdr extension</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A /code{list} of band names extracted from the /code{hdr_file}</span>
<span style="color: #ff6347;">get_band_names_from_hdr</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>hdr_file<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    txt <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readLines</span><span style="color: #20b2aa;">(</span>hdr_file<span style="color: #20b2aa;">)</span>
    line_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^band names'</span>, txt<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    band_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> line_num:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>txt<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        band_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>band_names, <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[,}][[:space:]]*$'</span>, <span style="color: #00ff00;">''</span>, txt<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'}'</span>, txt<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">break</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>band_names<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-30" class="outline-2">
<h2 id="sec-30"><span class="section-number-2">30</span> get<sub>extent</sub><sub>polys</sub>.R</h2>
<div class="outline-text-2" id="text-30">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Generate a SpatialPolygonDataFrame of raster extents</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Also includes the filename associated with each raster object. Useful for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> providing the \code{dem_extents} argument to the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{auto_setup_dem}} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maptools</span><span style="color: #00bfff;"> spRbind</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rast_list</span><span style="color: #00bfff;"> a \code{Raster*} object, or \code{list} of\code{Raster*} objects</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{SpatialPolygonDataFrame} with the extent of each raster object </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as a polygon, with a filename attribute giving the filename for the raster </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> object from with each extent is derived.</span>
<span style="color: #ff6347;">get_extent_polys</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.list</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">))</span> rast_list <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>rast_list<span style="color: #20b2aa;">)</span>
    proj<span style="color: #daa520;">4</span>strings <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>proj<span style="color: #daa520;">4</span>strings <span style="color: #00ffff;">==</span> proj<span style="color: #daa520;">4</span>strings<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'every raster in rast_list must have the same projection'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    extents <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    filenames <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>rast_list, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">filename</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert extents to a list of SpatialPolygons objects</span>
    extent_sps_list <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lapply</span><span style="color: #20b2aa;">(</span>extents, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">as</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'SpatialPolygons'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert from list of SpatialPolygons objects to a single SpatialPolygons </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">object</span>
    extent_sps <span style="color: #00ffff;">&lt;-</span> extent_sps_list<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            extent_sps <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spRbind</span><span style="color: #20b2aa;">(</span>extent_sps, <span style="color: #ff6347;">spChFIDs</span><span style="color: #20b2aa;">(</span>extent_sps_list<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, 
                                                 <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>n<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Finally convert the SpatialPolygons object into a </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">SpatialPolygonsDataFrame that also includes the filename of the raster </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">associated with each extent polygon as an attribute</span>
    extent_polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>extent_sps, 
                                             data<span style="color: #00ffff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>filename<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>filenames<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>extent_polys<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> proj<span style="color: #daa520;">4</span>strings<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    extent_polys$filename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>extent_polys$filename<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>extent_polys<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-31" class="outline-2">
<h2 id="sec-31"><span class="section-number-2">31</span> get<sub>metadata</sub><sub>item</sub>.R</h2>
<div class="outline-text-2" id="text-31">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Extract a metadata item from a metadata file in GDAL PAM format</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> GDAL PAM format metadata files end in .aux.xml.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> extension</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">XML</span><span style="color: #00bfff;"> xmlInternalTreeParse xpathApply xmlValue</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> an image file that has an accompanying GDAL PAM format metadata </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> file (ending in .aux.xml)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">key</span><span style="color: #00bfff;"> a string giving the name of the metadata item to extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> The metadata item (as a string)</span>
<span style="color: #ff6347;">get_metadata_item</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, key<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    metadata_file <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'.aux.xml'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>metadata_file<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Could not find metadata file'</span>, metadata_file<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    doc <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">xmlInternalTreeParse</span><span style="color: #20b2aa;">(</span>metadata_file<span style="color: #20b2aa;">)</span>
    xpath_exp <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ffff;">//</span>MDI<span style="color: #20b2aa;">[</span>@key<span style="color: #00ffff;">=</span><span style="color: #00ff00;">', key, '</span><span style="color: #20b2aa;">])</span>
    value <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">xpathApply</span><span style="color: #20b2aa;">(</span>doc, xpath_exp, xmlValue<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'multiple elements found'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no elements found'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-32" class="outline-2">
<h2 id="sec-32"><span class="section-number-2">32</span> gridsample.R</h2>
<div class="outline-text-2" id="text-32">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Draw a random sample from a grid laid out on a RasterLayer or matrix</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function is used to subsample a \code{RasterLayer} or \code{matrix} by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> dividing the dataset into a grid of \code{horizcells} x \code{vertcells}, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and by then drawing a sample of size \code{nsamp} from within each grid </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cell.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a matrix or RasterLayer to draw sample from</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">horizcells</span><span style="color: #00bfff;"> how many cells to break the raster in horizontally (over </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the columns)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">vertcells</span><span style="color: #00bfff;"> how many cells to break the raster in vertically (over </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the rows)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">nsamp</span><span style="color: #00bfff;"> how many samples to draw from each grid cell</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rowmajor</span><span style="color: #00bfff;"> whether to return indices in row-major format (default is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> column-major). Row-major format is useful in conjunction with \code{Raster*} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> objects.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">replace</span><span style="color: #00bfff;"> whether to sample with replacement (within each grid cell)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> vector of sample indices</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@note</span><span style="color: #00bfff;"> TODO: Recode in C++ for speed.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Make a </span><span style="color: #daa520;">100</span><span style="color: #00bfff;">x</span><span style="color: #daa520;">100</span><span style="color: #00bfff;"> matrix</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> x &lt;- matrix(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">10000</span><span style="color: #00bfff;">, nrow=</span><span style="color: #daa520;">100</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Subsample the matrix by breaking it up into a </span><span style="color: #daa520;">10</span><span style="color: #00bfff;"> x </span><span style="color: #daa520;">10</span><span style="color: #00bfff;"> grid, and take </span><span style="color: #daa520;">10</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # random samples from each grid cell without replacement (these are the</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # default parameters).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> y &lt;- gridsample(x)</span>
<span style="color: #ff6347;">gridsample</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, horizcells<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, vertcells<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, nsamp<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, 
                       rowmajor<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, replace<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">horizstart is a vector of column numbers of the first column in each cell </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">in the grid</span>
    horizstart <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> horizcells<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">horizend is a vector of column numbers of the last column in each cell in </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the grid</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        horizend <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">((</span>horizstart <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">)]</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        horizend <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">vertstart is a vector of row numbers of the first row in each cell in the </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">grid</span>
    vertstart <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> vertcells<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">vertend is a vector of row numbers of the last row in each cell in the</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">grid</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        vertend <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">((</span>vertstart <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)[</span><span style="color: #daa520;">2</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">)]</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        vertend <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">retvalues is a vector to store the sample values chosen from x</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">sampindices is a vector to store the column major indices of the locations </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">of each sampled value in x</span>
    sampindices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">vector</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'numeric'</span>, horizcells * vertcells * nsamp<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">retval_index tracks position in the vector storing the sampled values </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">returned from this function</span>
    retval_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">row is used in calculating the column-major index of the first entry </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(top left) of each grid cell</span>
    cell<span style="color: #daa520;">1</span>row <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>vertcellnum <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>vertstart<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">col is used in calculating the column-major index of the first </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">entry (top left) of each grid cell</span>
        cell<span style="color: #daa520;">1</span>col <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell_nrows is the number of rows in this particular cell (cells may </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">have varying numbers of rows due to rounding)</span>
        cell_nrows <span style="color: #00ffff;">&lt;-</span> vertend<span style="color: #20b2aa;">[</span>vertcellnum<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> vertstart<span style="color: #20b2aa;">[</span>vertcellnum<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>horizcellnum <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>horizstart<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">colmajindex is the column-major index of the first (top </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">left) value in this particular grid cell</span>
            cell<span style="color: #daa520;">1</span>colmajindex <span style="color: #00ffff;">&lt;-</span> cell<span style="color: #daa520;">1</span>row <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>cell<span style="color: #daa520;">1</span>col <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell_ncols is the number of rows in this particular cell (cells </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">may have varying numbers of columns due to rounding)</span>
            cell_ncols <span style="color: #00ffff;">&lt;-</span> horizend<span style="color: #20b2aa;">[</span>horizcellnum<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> horizstart<span style="color: #20b2aa;">[</span>horizcellnum<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">cell_colmaj_indices is a matrix of column-major indices of the </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">position of each value in this grid cell, within the larger </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">matrix x</span>
            cell_colmaj_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:cell_nrows, cell_ncols<span style="color: #20b2aa;">)</span>,
                                          nrow<span style="color: #00ffff;">=</span>cell_nrows<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
                                   <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>cell<span style="color: #daa520;">1</span>colmajindex, by<span style="color: #00ffff;">=</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                                  length.out<span style="color: #00ffff;">=</span>cell_ncols<span style="color: #20b2aa;">)</span>, 
                                              cell_nrows<span style="color: #20b2aa;">)</span>, nrow<span style="color: #00ffff;">=</span>cell_nrows, 
                                          byrow<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>
            samp_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sample</span><span style="color: #20b2aa;">(</span>cell_colmaj_indices, nsamp, replace<span style="color: #00ffff;">=</span>replace<span style="color: #20b2aa;">)</span>
            sampindices<span style="color: #20b2aa;">[</span>retval_index:<span style="color: #20b2aa;">(</span>retval_index <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>samp_indices<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> samp_indices
            retval_index <span style="color: #00ffff;">&lt;-</span> retval_index <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>samp_indices<span style="color: #20b2aa;">)</span>
            cell<span style="color: #daa520;">1</span>col  <span style="color: #00ffff;">&lt;-</span> cell<span style="color: #daa520;">1</span>col <span style="color: #00ffff;">+</span> cell_ncols
        <span style="color: #20b2aa;">}</span>
        cell<span style="color: #daa520;">1</span>row <span style="color: #00ffff;">&lt;-</span> cell<span style="color: #daa520;">1</span>row <span style="color: #00ffff;">+</span> cell_nrows
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>rowmajor<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        sampindices <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">((</span>sampindices <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%%</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> * <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #20b2aa;">((</span>sampindices <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%/%</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>sampindices<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-33" class="outline-2">
<h2 id="sec-33"><span class="section-number-2">33</span> linear<sub>stretch</sub>.R</h2>
<div class="outline-text-2" id="text-33">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">.do_stretch</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, pct, max_val<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    lower <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>x, prob<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span> <span style="color: #00ffff;">+</span> pct<span style="color: #00ffff;">/</span><span style="color: #daa520;">100</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    upper <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>x, prob<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span> <span style="color: #00ffff;">-</span> pct<span style="color: #00ffff;">/</span><span style="color: #daa520;">100</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    x<span style="color: #20b2aa;">[</span>x <span style="color: #00ffff;">&gt;</span> upper<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> upper
    x<span style="color: #20b2aa;">[</span>x <span style="color: #00ffff;">&lt;</span> lower<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> lower
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">((</span>x <span style="color: #00ffff;">-</span> lower<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>upper<span style="color: #00ffff;">-</span>lower<span style="color: #20b2aa;">))</span> * max_val
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Apply a linear stretch to an image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Applies a linear stretch to an image (default linear </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">% stretch), and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> returns the image with each band individually stretched and rescaled to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> range between zero and \code{max_val} (default of \code{max_val} is </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> image to stretch</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">pct</span><span style="color: #00bfff;"> percent stretch</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_val</span><span style="color: #00bfff;"> maximum value of final output (image will be rescaled to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> range from </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> - \code{max_val})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> image with stretch applied</span>
<span style="color: #ff6347;">linear_stretch</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, pct<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span>, max_val<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Applies linear stretch (</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> percent by default). Assumes image is arranged </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">with bands in columns. Returns the image with stretch applied and bands </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">rescaled to range from </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> - max_val.</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>pct <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> | pct <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">50</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'pct must be &gt; </span><span style="color: #daa520;">0</span><span style="color: #00ff00;"> and &lt; </span><span style="color: #daa520;">50</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'RasterLayer'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, pct, max_val<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'RasterStack'</span>, <span style="color: #00ff00;">'RasterBrick'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">setValues</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>x, layer<span style="color: #00ffff;">=</span>n<span style="color: #20b2aa;">))</span>,
                                          pct, max_val<span style="color: #20b2aa;">)</span>, layer<span style="color: #00ffff;">=</span>n<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> || <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">dim</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle a vector, matrix, or n x m x </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> array</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">.do_stretch</span><span style="color: #20b2aa;">(</span>x, pct, max_val<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-34" class="outline-2">
<h2 id="sec-34"><span class="section-number-2">34</span> ls<sub>catalog</sub>.R</h2>
<div class="outline-text-2" id="text-34">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Catalog a folder of Landsat images</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function is used to produce a \code{data.frame} of Landsat images </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> stored locally after download from the USGS. The images should be in a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> series of subfolders named following the naming scheme of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{espa_extract}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">in_folder</span><span style="color: #00bfff;"> path to a folder of Landsat surface reflectance images (for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> example, as extracted by the \code{espa_extract} function).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{data.frame} with a list of the Landsat images found within </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in_folder</span>
<span style="color: #ff6347;">ls_catalog</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>in_folder<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>in_folder, <span style="color: #00ff00;">'does not exist'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>outer_item <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>in_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        outer_item_full <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>in_folder, outer_item<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">First cycle through the yearly folders</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, outer_item_full<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>inner_item <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">dir</span><span style="color: #20b2aa;">(</span>outer_item_full<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            inner_item_full <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>outer_item_full, inner_item<span style="color: #20b2aa;">)</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Check to ensure inner item is a Landsat HDF file</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, inner_item_full<span style="color: #20b2aa;">)</span> ||
                !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^(lndsr.)?((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">13</span><span style="color: #00ff00;">}[A-Z]{</span><span style="color: #daa520;">3</span><span style="color: #00ff00;">}[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">}.hdf$'</span>, 
                       inner_item<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">next</span>
            <span style="color: #20b2aa;">}</span>
            metadata_string <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>inner_item, 
                                           <span style="color: #00ff00;">'((LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">)|(LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">)|(LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">)|(LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">))[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">13</span><span style="color: #00ff00;">}'</span><span style="color: #20b2aa;">)</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">'</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'LT</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">'</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">'</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'LT</span><span style="color: #daa520;">5</span><span style="color: #00ff00;">'</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">'</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'LE</span><span style="color: #daa520;">7</span><span style="color: #00ff00;">'</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">'</span>, metadata_string<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                sensor <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'LC</span><span style="color: #daa520;">8</span><span style="color: #00ff00;">'</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">message</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Skipping'</span>, inner_item,
                              <span style="color: #00ff00;">'- cannot determine sensor from filename.'</span><span style="color: #20b2aa;">))</span>
                <span style="color: #ff00ff;">next</span>
            <span style="color: #20b2aa;">}</span>
            year <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">13</span><span style="color: #20b2aa;">)</span>
            julian_day <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">14</span>, <span style="color: #daa520;">16</span><span style="color: #20b2aa;">)</span>
            img_path <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span>
            img_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>metadata_string, <span style="color: #daa520;">7</span>, <span style="color: #daa520;">9</span><span style="color: #20b2aa;">)</span>
            img_date <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.Date</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>year, julian_day<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'%Y%j'</span><span style="color: #20b2aa;">)</span>
            out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out, <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>img_path,
                                    img_row,
                                    year,
                                    julian_day,
                                    sensor,
                                    <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_date, <span style="color: #00ff00;">'%m'</span><span style="color: #20b2aa;">)</span>, 
                                    <span style="color: #ff6347;">format</span><span style="color: #20b2aa;">(</span>img_date, <span style="color: #00ff00;">'%d'</span><span style="color: #20b2aa;">)</span>,
                                    inner_item<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no images found'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>, byrow<span style="color: #00ffff;">=</span><span style="color: #daa520;">T</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'path'</span>, <span style="color: #00ff00;">'row'</span>, <span style="color: #00ff00;">'year'</span>, <span style="color: #00ff00;">'julian'</span>, <span style="color: #00ff00;">'sensor'</span>,
                    <span style="color: #00ff00;">'month'</span>, <span style="color: #00ff00;">'day'</span>, <span style="color: #00ff00;">'filename'</span><span style="color: #20b2aa;">)</span>
    out <span style="color: #00ffff;">&lt;-</span> out<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">order</span><span style="color: #20b2aa;">(</span>out$path, out$row, out$year, out$julian, out$sensor<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-35" class="outline-2">
<h2 id="sec-35"><span class="section-number-2">35</span> match<sub>rasters</sub>.R</h2>
<div class="outline-text-2" id="text-35">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Match the coordinate system and extent of two rasters</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">baseimg</span><span style="color: #00bfff;"> A /code{Raster*} to use as the base image. This layer will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> determine the output coordinate system.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">matchimg</span><span style="color: #00bfff;"> A /code{Raster*} to match to the base image. If necessary </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the /code{matchimg} will be reprojected to match the coordinate system of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the /code{baseimg}. The /code{matchimg} will then be cropped and extended to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> match the extent of the /code{baseimg}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">filename</span><span style="color: #00bfff;"> file on disk to save \code{Raster*} to (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">method</span><span style="color: #00bfff;"> the method to use if projection is needed to match image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> coordinate systems, or if resampling is needed to align image origins. Can </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> be ngb for nearest-neighbor, or binlinear for bilinear interpolation</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments to pass to \code{writeRaster} (such as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> datatype and filename)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> The /code{matchimg} reprojected (if necessary), cropped, and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> extended to match the /code{baseimg}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@details</span><span style="color: #00bfff;"> Note that \code{match_rasters} can run in parallel if </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{beginCluster()} is run prior to running \code{match_rasters}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Mosaic the two ASTER DEM tiles needed to a Landsat image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> DEM_mosaic &lt;- mosaic(ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_EAST, ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_WEST, fun='mean')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Crop and extend the DEM mosaic to match the Landsat image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> matched_DEM &lt;- match_rasters(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, DEM_mosaic)</span>
<span style="color: #ff6347;">match_rasters</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>baseimg, matchimg, filename, method<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'bilinear'</span>,
                          ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">projectRaster</span><span style="color: #20b2aa;">(</span>from<span style="color: #00ffff;">=</span>matchimg, to<span style="color: #00ffff;">=</span>baseimg, method<span style="color: #00ffff;">=</span>method<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Crop overlapping area</span>
    matchimg <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">crop</span><span style="color: #20b2aa;">(</span>matchimg, baseimg<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">resample</span><span style="color: #20b2aa;">(</span>matchimg, baseimg, method<span style="color: #00ffff;">=</span>method<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>baseimg<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        matchimg <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extend</span><span style="color: #20b2aa;">(</span>matchimg, baseimg<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>filename<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            matchimg <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">writeRaster</span><span style="color: #20b2aa;">(</span>matchimg, filename<span style="color: #00ffff;">=</span>filename, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>matchimg<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-36" class="outline-2">
<h2 id="sec-36"><span class="section-number-2">36</span> minnaert<sub>samp</sub>.R</h2>
<div class="outline-text-2" id="text-36">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> mgcv</span>
<span style="color: #ff6347;">.calc_k_table</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, IL, slope, sampleindices, slopeclass,
                          coverclass, sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>x<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>,
                        IL<span style="color: #00ffff;">=</span>IL<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>, 
                        slope<span style="color: #00ffff;">=</span>slope<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">])</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Remember that the sample indices are row-major (as they were drawn </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">for a RasterLayer), so the coverclass matrix needs to be transposed </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">as it is stored in column-major order</span>
        <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">))</span> coverclass <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">t</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">)[</span>sampleindices<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, IL<span style="color: #00ffff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>, 
                        slope<span style="color: #00ffff;">=</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>coverclass<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>coverclass, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;">## </span><span style="color: #00bfff;">K is between </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">IL can be &lt;=</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> under certain conditions</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">but that makes it impossible to take log</span><span style="color: #daa520;">10</span><span style="color: #00bfff;"> so remove those elements</span>
    K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>rowvals<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>rowvals<span style="color: #20b2aa;">)))</span>, <span style="color: #20b2aa;">]</span>
    K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
    K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$IL <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
    k_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">0</span>, nrow<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>, ncol<span style="color: #00ffff;">=</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'midpoint'</span>, <span style="color: #00ff00;">'n'</span>, <span style="color: #00ff00;">'k'</span><span style="color: #20b2aa;">)</span>
    k_table$midpoint <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">diff</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span> <span style="color: #00ffff;">+</span> slopeclass<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">don't use slopes outside slopeclass range</span>
    K.cut <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>K$slope, slopeclass<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>slopeclass is inappropriate <span style="color: #ff00ff;">for</span> these <span style="color: #ff6347;">data</span> <span style="color: #20b2aa;">(</span>empty classes<span style="color: #20b2aa;">)</span>\n<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    k_table$n <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">for</span><span style="color: #20b2aa;">(</span>i <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.cut<span style="color: #20b2aa;">)])))</span> <span style="color: #20b2aa;">{</span>
        k_table$k<span style="color: #20b2aa;">[</span>i<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">)[</span>K.cut <span style="color: #00ffff;">==</span> i<span style="color: #20b2aa;">]</span> ~ 
                                        <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$IL<span style="color: #00ffff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))[</span>K.cut <span style="color: #00ffff;">==</span> i<span style="color: #20b2aa;">]))[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>k_table<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">Function to combine classes defined by the upper limits 'lims' with their </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">smallest neighbors until each class has at least n members. 'counts' stores </span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">the number of members in each class.</span>
<span style="color: #ff6347;">clean_intervals</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>counts, lims, n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">while</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;</span> n<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">The rev below is so that the classes at the end are combined first </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(as classes with higher slopes are more more likely to be more rare </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">and therefore have fewer members)</span>
        min_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span>,
                                            <span style="color: #ff6347;">rev</span><span style="color: #20b2aa;">(</span>counts <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>min_index <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #00ffff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">(</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>min_index <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #00ffff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>min_index<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span> <span style="color: #20b2aa;">{</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #00ffff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #20b2aa;">(</span>min_index <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)]</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">We know counts[min_index - </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">] &gt; counts[min_index + </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">]</span>
            counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>min_index <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> counts<span style="color: #20b2aa;">[</span>min_index<span style="color: #20b2aa;">]</span>
            lims <span style="color: #00ffff;">&lt;-</span> lims<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>min_index<span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        counts <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span>min_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>lims<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Topographic correction for satellite imagery using Minnaert method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Perform topographic correction using the Minnaert method. This code is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> modified from the code in the \code{landsat} package written by Sarah </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Goslee.  This version of the code has been altered from the \code{landsat} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> version to allow the option of using a sample of pixels for calculation of k </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in the Minnaert correction (useful when dealing with large images).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> See the help page for \code{minnaert} in the \code{landsat} package for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> additional details on the parameters.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> image as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slope</span><span style="color: #00bfff;"> the slope in radians as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">aspect</span><span style="color: #00bfff;"> the aspect in radians as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunelev</span><span style="color: #00bfff;"> sun elevation in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunazimuth</span><span style="color: #00bfff;"> sun azimuth in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">IL.epsilon</span><span style="color: #00bfff;"> a small amount to add to calculated illumination values </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that are equal to zero to avoid division by zero resulting in Inf values</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slopeclass</span><span style="color: #00bfff;"> the slope classes to calculate k for (in radians), or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> NULL, in which case an algorithm will be used to choose reasonable defaults </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for the given image. If provided, \code{slopeclass} should be a list of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> slope class limits. For example: c(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">5</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">15</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">20</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">25</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">30</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">45</span><span style="color: #00bfff;">) * (pi/</span><span style="color: #daa520;">180</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">coverclass</span><span style="color: #00bfff;"> used to calculate k for specific cover class (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> as \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sampleindices</span><span style="color: #00bfff;"> (optional) row-major indices of sample pixels to use in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the calculation of k values for the Minnaert correction. See</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{gridsample}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> minimum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_min} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> maximum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_max} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> \code{RasterLayer} with topographically corrected data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@author</span><span style="color: #00bfff;"> Sarah Goslee and Alex Zvoleff</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sarah Goslee. Analyzing Remote Sensing Data in {R}: The {landsat} Package.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Journal of Statistical Software, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">43</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, pg </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">25</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.jstatsoft.org/v</span><span style="color: #daa520;">43</span><span style="color: #00bfff;">/i</span><span style="color: #daa520;">04</span><span style="color: #00bfff;">/</span>
<span style="color: #ff6347;">minnaert_samp</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth,
                          IL.epsilon<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span>, slopeclass<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                          coverclass<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, sampleindices<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                          DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        slopeclass <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">2</span>, <span style="color: #daa520;">3</span>, <span style="color: #daa520;">4</span>, <span style="color: #daa520;">5</span>, <span style="color: #daa520;">6</span>, <span style="color: #daa520;">8</span>, <span style="color: #daa520;">10</span>, <span style="color: #daa520;">12</span>,
                        <span style="color: #daa520;">15</span>, <span style="color: #daa520;">20</span>, <span style="color: #daa520;">25</span>, <span style="color: #daa520;">30</span>, <span style="color: #daa520;">45</span>, <span style="color: #daa520;">75</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        counts <span style="color: #00ffff;">&lt;-</span> raster::<span style="color: #ff6347;">freq</span><span style="color: #20b2aa;">(</span>raster::<span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slope, slopeclass,
                                           include.lowest<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, 
                               useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Eliminate empty bins:</span>
        slopeclass <span style="color: #00ffff;">&lt;-</span> slopeclass<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span>, <span style="color: #daa520;">1</span>:<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> counts<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])]</span>
        counts <span style="color: #00ffff;">&lt;-</span> counts<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        counts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">table</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cut</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span>, slopeclass, 
                                       include.lowest<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>, useNA<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'no'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">The [-</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">] below is because clean_intervals only needs the upper limits</span>
    slopeclass <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">clean_intervals</span><span style="color: #20b2aa;">(</span>counts, slopeclass<span style="color: #20b2aa;">[</span><span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, <span style="color: #daa520;">100</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'insufficient sample size to develop k model - try changing slopeclass or sampleindices'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    slopeclass <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>*pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span>, slopeclass<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">((</span>slopeclass <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; slopeclass <span style="color: #00ffff;">&lt;=</span> pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">some inputs are in degrees, but we need radians</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>
    sunzenith <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #00ffff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    IL <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_IL</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rm</span><span style="color: #20b2aa;">(</span>aspect, sunazimuth<span style="color: #20b2aa;">)</span>
    k_table <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_k_table</span><span style="color: #20b2aa;">(</span>x, IL, slope, sampleindices, slopeclass, 
                             coverclass, sunzenith<span style="color: #20b2aa;">)</span>

    k_model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>k_table, <span style="color: #ff6347;">bam</span><span style="color: #20b2aa;">(</span>k ~ <span style="color: #ff6347;">s</span><span style="color: #20b2aa;">(</span>midpoint, k<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>midpoint<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, data<span style="color: #00ffff;">=</span>k_table<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">If slope is greater than modeled range, use maximum of modeled range. If </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">slope is less than modeled range, treat it as flat.</span>
    slopeclass_max <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span>
    slopeclass_min <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">min</span><span style="color: #20b2aa;">(</span>slopeclass<span style="color: #20b2aa;">)</span>
    slope <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>slope,
                  fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> slopeclass_max<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> slopeclass_max
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> slopeclass_min<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
                      <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  <span style="color: #20b2aa;">})</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'midpoint'</span>
    K.all <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>slope, k_model<span style="color: #20b2aa;">)</span>
    K.all <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>K.all,
                  fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
                      vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
                      <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  <span style="color: #20b2aa;">})</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Perform correction</span>
    xout <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>x, IL, K.all,
                    fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x_vals, IL_vals, K.all_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        x_vals * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span>IL_vals<span style="color: #20b2aa;">)</span> ^ K.all_vals
                    <span style="color: #20b2aa;">})</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Don't correct flat areas</span>
    xout<span style="color: #20b2aa;">[</span>K.all <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>K.all <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>K.all<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        xout <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>xout, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                     <span style="color: #20b2aa;">})</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>classcoef<span style="color: #00ffff;">=</span>k_table, model<span style="color: #00ffff;">=</span>k_model, minnaert<span style="color: #00ffff;">=</span>xout, sampleindices<span style="color: #00ffff;">=</span>sampleindices<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-37" class="outline-2">
<h2 id="sec-37"><span class="section-number-2">37</span> normalize.R</h2>
<div class="outline-text-2" id="text-37">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Normalizes two rasters</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Performs relative normalization on two rasters using model II regression. </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Based on the approach in the \code{relnorm} function in the \code{landsat} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> package.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">iterators</span><span style="color: #00bfff;"> iter</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> foreach</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> lmodel</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*} to use as the base image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> a \code{Raster*} to normalize to the base image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">msk</span><span style="color: #00bfff;"> a \code{RasterLayer} with missing values in \code{x} or in {y} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> coded as </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, and all other values coded as </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> (optional)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">method</span><span style="color: #00bfff;"> the regression method to use (must be a method recognized by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{lmodel</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">size</span><span style="color: #00bfff;"> the number of pixels to use in developing the model</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{Raster*} of \code{y} normalized to \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_normed_</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> &lt;- normalize(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plotRGB(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_normed_</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, stretch='lin')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Use only half as many pixels to calculate the models</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_normed_</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> &lt;- normalize(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                                  size=ncell(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">)/</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plotRGB(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_normed_</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">, stretch='lin')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sarah Goslee. Analyzing Remote Sensing Data in {R}: The {landsat} Package.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Journal of Statistical Software, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">43</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, pg </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">25</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.jstatsoft.org/v</span><span style="color: #daa520;">43</span><span style="color: #00bfff;">/i</span><span style="color: #daa520;">04</span><span style="color: #00bfff;">/</span>
<span style="color: #ff6347;">normalize</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, msk, method<span style="color: #00ffff;">=</span>MA, size<span style="color: #00ffff;">=</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    orig_datatype <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dataType</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>size <span style="color: #00ffff;">&lt;=</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">compareRaster</span><span style="color: #20b2aa;">(</span>x, msk<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>size <span style="color: #00ffff;">&lt;</span> <span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Note that sampleRegular with cells=TRUE returns cell numbers in the </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">first column</span>
        x_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, size<span style="color: #00ffff;">=</span>size, cells<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x_vals <span style="color: #00ffff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">[</span>x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]])</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
        y_vals <span style="color: #00ffff;">&lt;-</span> y<span style="color: #20b2aa;">[</span>x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
        x_vals <span style="color: #00ffff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>, <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        x_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
        y_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            x_vals <span style="color: #00ffff;">&lt;-</span> x_vals<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
            y_vals <span style="color: #00ffff;">&lt;-</span> y_vals<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>y_vals<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x_vals<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        unnormed_layer <span style="color: #00ffff;">&lt;-</span> x_sample <span style="color: #00ffff;">&lt;-</span> y_sample <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
        normed_y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unnormed_layer<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>,
                            x_sample<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>x_vals, by<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'column'</span><span style="color: #20b2aa;">)</span>,
                            y_sample<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>y_vals, by<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'column'</span><span style="color: #20b2aa;">)</span>,
                            .combine<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'addLayer'</span>, .multicombine<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                            .init<span style="color: #00ffff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>,
                            .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'raster'</span>, <span style="color: #00ff00;">'lmodel</span><span style="color: #daa520;">2</span><span style="color: #00ff00;">'</span>, <span style="color: #00ff00;">'rgdal'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
            model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">suppressMessages</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>x_sample ~ y_sample, nperm<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
            model <span style="color: #00ffff;">&lt;-</span> model$regression.results<span style="color: #20b2aa;">[</span>model$regression.results<span style="color: #20b2aa;">[</span>, Method<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> method, <span style="color: #20b2aa;">]</span>
            <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^ *, , <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
            normed_layer <span style="color: #00ffff;">&lt;-</span> model$Slope * unnormed_layer <span style="color: #00ffff;">+</span> model$Intercept
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">suppressMessages</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">lmodel</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">(</span>x_vals ~ y_vals, nperm<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">))</span>
        model <span style="color: #00ffff;">&lt;-</span> model$regression.results<span style="color: #20b2aa;">[</span>model$regression.results<span style="color: #20b2aa;">[</span>, Method<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">==</span> method, <span style="color: #20b2aa;">]</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span>^ *, , <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">))</span>
        normed_y <span style="color: #00ffff;">&lt;-</span> model$Slope * y <span style="color: #00ffff;">+</span> model$Intercept
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>msk<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Copy masked values back into the output raster</span>
        normed_y<span style="color: #20b2aa;">[</span>msk<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> y<span style="color: #20b2aa;">[</span>msk<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;">#</span><span style="color: #00bfff;">dataType(normed_y) &lt;- orig_datatype</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>normed_y<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-38" class="outline-2">
<h2 id="sec-38"><span class="section-number-2">38</span> overlay<sub>poly</sub>.R</h2>
<div class="outline-text-2" id="text-38">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Make plot of image with overlaid polygon</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Useful for quick plots showing overlap between an area of interest (AOI) and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> a satellite image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">grid</span><span style="color: #00bfff;"> unit</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> ggplot</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> image as a \code{Raster*} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> polygon to overlay, as \code{SpatialPolygonDataFrame}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">out</span><span style="color: #00bfff;"> filename for output image. The extension of this file will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> determine the output file format (png, pdf, etc.).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">title</span><span style="color: #00bfff;"> title of plot</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">width</span><span style="color: #00bfff;"> width (in inches) of output image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">height</span><span style="color: #00bfff;"> height (in inches) of output image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dpi</span><span style="color: #00bfff;"> DPI for output image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments to \code{ggsave}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> used for writing plot to a file</span>
<span style="color: #ff6347;">overlay_poly</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, out, title<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span>, width<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span>, height<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span>, dpi<span style="color: #00ffff;">=</span><span style="color: #daa520;">150</span>,
                         ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'overlay_poly is not yet supported'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x must be a one or three band image'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>y, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    maxpixels <span style="color: #00ffff;">&lt;-</span> width*height*dpi^<span style="color: #daa520;">2</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Below is based on gplot from rasterVis package</span>
    nl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span>nl <span style="color: #00ffff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, maxpixels*nl, ext<span style="color: #00ffff;">=</span>y, asRaster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mask</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span>
    coords <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">xyFromCell</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">seq_len</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    dat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">linear_stretch</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    dat <span style="color: #00ffff;">&lt;-</span> dat<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    coords <span style="color: #00ffff;">&lt;-</span> coords<span style="color: #20b2aa;">[</span><span style="color: #ff6347;">complete.cases</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        dat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rgb</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    dat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>coords, color<span style="color: #00ffff;">=</span>dat<span style="color: #20b2aa;">)</span>
    color<span style="color: #00ffff;">=</span>long<span style="color: #00ffff;">=</span>lat<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>  <span style="color: #00bfff;"># </span><span style="color: #00bfff;">fix for R CMD CHECK</span>
    <span style="color: #ff6347;">theme_set</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">theme_bw</span><span style="color: #20b2aa;">(</span>base_size<span style="color: #00ffff;">=</span><span style="color: #daa520;">8</span><span style="color: #20b2aa;">))</span>
    p <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ggplot</span><span style="color: #20b2aa;">(</span>dat<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
        <span style="color: #ff6347;">geom_raster</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">aes</span><span style="color: #20b2aa;">(</span>x, y, fill<span style="color: #00ffff;">=</span>color<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">coord_fixed</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">+</span>
        <span style="color: #ff6347;">scale_fill_identity</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">+</span>
        <span style="color: #ff6347;">labs</span><span style="color: #20b2aa;">(</span>title<span style="color: #00ffff;">=</span>title<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span>
        <span style="color: #ff6347;">theme</span><span style="color: #20b2aa;">(</span>axis.text.x<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.text.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              axis.title.x<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.title.y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              panel.background<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, panel.border<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              panel.grid.major<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, panel.grid.minor<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              plot.background<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>, axis.ticks<span style="color: #00ffff;">=</span><span style="color: #ff6347;">element_blank</span><span style="color: #20b2aa;">()</span>,
              plot.margin<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unit</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span>, .<span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'cm'</span><span style="color: #20b2aa;">))</span>
    p
    <span style="color: #ff6347;">ggsave</span><span style="color: #20b2aa;">(</span>out, width<span style="color: #00ffff;">=</span>width, height<span style="color: #00ffff;">=</span>height, dpi<span style="color: #00ffff;">=</span>dpi, ...<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-39" class="outline-2">
<h2 id="sec-39"><span class="section-number-2">39</span> pixel<sub>data</sub>.R</h2>
<div class="outline-text-2" id="text-39">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> A class for representing training or testing data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Used to represent training data for a machine learning classifier for image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classificaion, or testing data used for testing a classification.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@exportClass</span><span style="color: #00bfff;"> pixel_data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> pixel_data-class</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> pixel_data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> x a \code{data.frame} of independent variables (usually pixel values)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> y a \code{data.frame} of the dependent variable (usually land cover </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classes)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> pixel_src a data.frame used to link pixels in \code{x} and \code{y} to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> an input polygon</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> training_flag a binary vector of length equal to \code{nrow(x)} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> indicating each row in x should be used in training (TRUE) or in testing </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (FALSE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> polys a \code{SpatialPolygonsDataFrame} of the polygons used to choose </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the pixels in \code{x} and \code{y}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> SpatialPolygonsDataFrame</span>
<span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'pixel_data'</span>, slots<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'data.frame'</span>, y<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'factor'</span>, 
                               pixel_src<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'data.frame'</span>, training_flag<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'logical'</span>, 
                               polys<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'SpatialPolygonsDataFrame'</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> summary pixel_data</span>
<span style="color: #ff6347;">summary.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    obj <span style="color: #00ffff;">=</span> <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_classes'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nlevels</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_sources'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>object@polys$src<span style="color: #20b2aa;">))</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_polys'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>object@polys<span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_pixels'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>object@x<span style="color: #20b2aa;">)</span>
    training_df <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>object@y,
                              pixel_src<span style="color: #00ffff;">=</span><span style="color: #ff6347;">src_name</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span>, 
                              training_flag<span style="color: #00ffff;">=</span>object@training_flag<span style="color: #20b2aa;">)</span>
    y<span style="color: #00ffff;">=</span>pixel_src<span style="color: #00ffff;">=</span>training_flag<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span> <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Keep R CMD CHECK happy</span>
    class_stats <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">summarize</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>training_df, y<span style="color: #20b2aa;">)</span>,
                             n_polys<span style="color: #00ffff;">=</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>pixel_src<span style="color: #20b2aa;">))</span>,
                             n_train_pixels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>,
                             n_test_pixels<span style="color: #00ffff;">=</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!training_flag<span style="color: #20b2aa;">)</span>,
                             train_frac<span style="color: #00ffff;">=</span><span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> 
                                              <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>class_stats<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'y'</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'class'</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class_stats'</span><span style="color: #20b2aa;">]]</span>  <span style="color: #00ffff;">&lt;-</span> class_stats
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_training'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_testing'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    obj<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'training_frac'</span><span style="color: #20b2aa;">]]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>object@training_flag <span style="color: #00ffff;">==</span> <span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>object@training_flag<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>obj<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'summary.pixel_data'</span>
    obj
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> print summary.pixel_data</span>
<span style="color: #ff6347;">print.summary.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Object of class '</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of classes:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_classes'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of polygons:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_polys'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of pixels:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_pixels'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of sources:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_sources'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Training data statistics:\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'class_stats'</span><span style="color: #20b2aa;">]])</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'\n'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of training samples:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_training'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Number of testing samples:\t'</span>, x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'n_testing'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">cat</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Training fraction:\t\t'</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span><span style="color: #00ff00;">'training_frac'</span><span style="color: #20b2aa;">]]</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'\n'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">invisible</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> length pixel_data</span>
<span style="color: #ff6347;">length.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> levels pixel_data</span>
<span style="color: #ff6347;">levels.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> print pixel_data</span>
<span style="color: #ff6347;">print.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">summary</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maptools</span><span style="color: #00bfff;"> spRbind</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> rbind pixel_data</span>
<span style="color: #ff6347;">rbind.pixel_data</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>item <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>...<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x@x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@x, item@x<span style="color: #20b2aa;">)</span>
        x@y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">as.character</span><span style="color: #20b2aa;">(</span>item@y<span style="color: #20b2aa;">)))</span>
        x@pixel_src <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@pixel_src, item@pixel_src<span style="color: #20b2aa;">)</span>
        x@training_flag <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x@training_flag, item@training_flag<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>item@polys<span style="color: #20b2aa;">)))</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'training polygon IDs are not unique - are src_names unique?'</span><span style="color: #20b2aa;">)</span>
        x@polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spRbind</span><span style="color: #20b2aa;">(</span>x@polys, item@polys<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Extract part of pixel_data class</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> [ pixel_data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> extract-methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">i</span><span style="color: #00bfff;"> a class or list of classes to extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">j</span><span style="color: #00bfff;"> unused</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments (none implemented)</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">([</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data, i<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'character'</span>, j<span style="color: #00ffff;">=</span>ANY<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, i, j, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>i <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, i, <span style="color: #00ff00;">''</span>, <span style="color: #00ff00;">' is not a class in this pixel_data object'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    sel_rows <span style="color: #00ffff;">&lt;-</span> x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> i
    used_polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys@data$src, x@polys@data$ID<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> 
                        <span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>x@pixel_src<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>src, ID<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">initialize</span><span style="color: #20b2aa;">(</span>x, x<span style="color: #00ffff;">=</span>x@x<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, y<span style="color: #00ffff;">=</span>x@y<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span>, 
               pixel_src<span style="color: #00ffff;">=</span>x@pixel_src<span style="color: #20b2aa;">[</span>sel_rows, <span style="color: #20b2aa;">]</span>, 
               training_flag<span style="color: #00ffff;">=</span>x@training_flag<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span>, 
               polys<span style="color: #00ffff;">=</span>x@polys<span style="color: #20b2aa;">[</span>used_polys, <span style="color: #20b2aa;">])</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> 
          <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Subsample a pixel_data object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> subsample</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">size</span><span style="color: #00bfff;"> either </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) a number from </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> to </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, indicating \code{size} is the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> fraction of pixels to sample, or </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) a number greater than </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, in which case </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{size} is the number of pixels to sample. Size applies per strata, if </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> stratification is chosen.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">strata</span><span style="color: #00bfff;"> whether to draw samples from within individual classes, nested </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> within source polygons (\code{strata='sources'}), or from within individual </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classes alone (\code{strata='classes'})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">type</span><span style="color: #00bfff;"> whether to subsample training data (\code{type='training'}) or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> testing data (\code{type='testing'}). Whichever type is chosen, the other </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> type will be left untouched (for example, if \code{type='testing'}, the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> training data will not be changed).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">flag</span><span style="color: #00bfff;"> whether to swap training flag on sampled data (for example, flag </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> sampled training data as testing data, if \code{flag=TRUE} and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{type='training'}) or remove sampled data from dataset entirely </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (\code{flag=FALSE}).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes</span><span style="color: #00bfff;"> specifies which classes to sample, defaults to all classes in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> subsample</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> subsample,pixel_data-method</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>subsample, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata<span style="color: #00ffff;">=</span>sources, type<span style="color: #00ffff;">=</span>training, 
                                 flag<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>subsample<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> subsample</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> subsample,pixel_data,numeric-method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dplyr</span><span style="color: #00bfff;"> group_by sample_frac</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>subsample, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data, size<span style="color: #00ffff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata, type, flag, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    row_IDs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>x@y,
                          pixel_src<span style="color: #00ffff;">=</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, x@pixel_src$ID<span style="color: #20b2aa;">)</span>,
                          row_num<span style="color: #00ffff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>size <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>strata <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>sources, classes<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>training, testing<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">==</span> training<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #00ffff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>x@training_flag, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #00ffff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>!x@training_flag, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    row_IDs <span style="color: #00ffff;">&lt;-</span> row_IDs<span style="color: #20b2aa;">[</span>row_IDs$y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>row_IDs<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>strata <span style="color: #00ffff;">==</span> sources<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        y<span style="color: #00ffff;">=</span>pixel_src<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
        row_IDs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>row_IDs, y, pixel_src<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>strata <span style="color: #00ffff;">==</span> classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        row_IDs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">group_by</span><span style="color: #20b2aa;">(</span>row_IDs, y<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>size <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        samp_rows <span style="color: #00ffff;">&lt;-</span> dplyr:::<span style="color: #ff6347;">sample_frac.grouped_df</span><span style="color: #20b2aa;">(</span>row_IDs, size<span style="color: #20b2aa;">)</span>$row_num
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        samp_rows <span style="color: #00ffff;">&lt;-</span> dplyr:::<span style="color: #ff6347;">sample_n.grouped_df</span><span style="color: #20b2aa;">(</span>row_IDs, size<span style="color: #20b2aa;">)</span>$row_num
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>flag<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'testing'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'training'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        x@x <span style="color: #00ffff;">&lt;-</span> x@x<span style="color: #20b2aa;">[</span>samp_rows, <span style="color: #20b2aa;">]</span>
        x@y <span style="color: #00ffff;">&lt;-</span> x@y<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span>
        x@training_flag <span style="color: #00ffff;">&lt;-</span> x@training_flag<span style="color: #20b2aa;">[</span>samp_rows<span style="color: #20b2aa;">]</span>
        x@pixel_src <span style="color: #00ffff;">&lt;-</span> x@pixel_src<span style="color: #20b2aa;">[</span>samp_rows, <span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Get or set training_flag for a pixel_data object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> training_flag</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes</span><span style="color: #00bfff;"> specifies a subset of classes in \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> training_flag,pixel_data-method</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>training_flag, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> training_flag</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>training_flag, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes<span style="color: #20b2aa;">])</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> training_flag</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">value</span><span style="color: #00bfff;"> training flag to assign for pixels in \code{x}</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #00ffff;">&lt;-</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #00ffff;">&lt;-</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> training_flag</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>training_flag<span style="color: #00ffff;">&lt;-</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)</span>, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">More efficiently handle special case of reassigning flags for all </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">classes in x.</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> value <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
        x@training_flag <span style="color: #00ffff;">&lt;-</span> value
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        sel_rows <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> value <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sel_rows<span style="color: #20b2aa;">))</span>
        <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sel_rows<span style="color: #20b2aa;">))</span>
        x@training_flag<span style="color: #20b2aa;">[</span>sel_rows<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> value
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Get number of testing pixels in a pixel_data object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> n_test</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes</span><span style="color: #00bfff;"> specifies a subset of classes in \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> n_test,pixel_data-method</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>n_test, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>n_test<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> n_test</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>n_test, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!x@training_flag<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>!x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes<span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Get number of training pixels in a pixel_data object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> n_train</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes</span><span style="color: #00bfff;"> specifies a subset of classes in \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> n_train,pixel_data-method</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>n_train, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>n_train<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> n_train</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>n_train, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span>x@training_flag<span style="color: #20b2aa;">[</span>x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes<span style="color: #20b2aa;">]))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Get or set src_name for a pixel_data object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> src_name</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{pixel_data} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">classes</span><span style="color: #00bfff;"> specifies a subset of classes in \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> src_name,pixel_data-method</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>src_name, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> src_name pixel_data</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>src_name, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, classes<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span>classes, <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>x@y<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, <span style="color: #00ff00;">'_'</span>, x@pixel_src$ID<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">with</span><span style="color: #20b2aa;">(</span>x@pixel_src<span style="color: #20b2aa;">[</span>x@y <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> classes, <span style="color: #20b2aa;">]</span>, <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>src, <span style="color: #00ff00;">'_'</span>, ID<span style="color: #20b2aa;">)))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> src_name</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">value</span><span style="color: #00bfff;"> a new \code{src_name} to assign for pixels in \code{x}</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #00ffff;">&lt;-</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, value<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #00ffff;">&lt;-</span><span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> src_name</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>src_name<span style="color: #00ffff;">&lt;-</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>pixel_data<span style="color: #20b2aa;">)</span>,
<span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, value<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        value <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span>value, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>value<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'src_name must be equal to </span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> or number of polygons in x'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    old_full_polyID <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys$src, x@polys$ID<span style="color: #20b2aa;">)</span>
    x@polys$src <span style="color: #00ffff;">&lt;-</span> value
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>x@polys<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@polys$src, <span style="color: #00ff00;">'_'</span>, x@polys$ID<span style="color: #20b2aa;">)</span>
    new_full_polyID <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@polys$src, x@polys$ID<span style="color: #20b2aa;">)</span>
    poly_pixel_match <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>x@pixel_src$src, x@pixel_src$ID<span style="color: #20b2aa;">)</span>, 
                              old_full_polyID<span style="color: #20b2aa;">)</span>
    x@pixel_src$src <span style="color: #00ffff;">&lt;-</span> x@polys$src<span style="color: #20b2aa;">[</span>poly_pixel_match<span style="color: #20b2aa;">]</span>
    x@pixel_src$ID <span style="color: #00ffff;">&lt;-</span> x@polys$ID<span style="color: #20b2aa;">[</span>poly_pixel_match<span style="color: #20b2aa;">]</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Extract observed data for use in a classification (training or testing)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*} object from which observed data will be extracted.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The data will be extracted from each layer in a \code{RasterBrick} or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterStack}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">polys</span><span style="color: #00bfff;"> a \code{SpatialPolygonsDataFrame} with polygons, each of which </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> has been assigned to a particular class (using the \code{class_col}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">class_col</span><span style="color: #00bfff;"> the name of the column containing the response variable </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (for example the land cover type of each pixel)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">training</span><span style="color: #00bfff;"> indicator of which polygons to use in training. Can be: </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> string giving the name of a column indicating whether each polygon is to be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> used in training (rows equal to </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">) or in testing (rows equal to FALSE), or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">2</span><span style="color: #00bfff;">) a logical vector of length equal to length(polys), or </span><span style="color: #daa520;">3</span><span style="color: #00bfff;">) a number between </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> indicating the fraction of the polygons to be randomly selected for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">   use in training.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">src</span><span style="color: #00bfff;"> name of this data source. Useful when gathering training </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> data from multiple images.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{link{pixel_data}} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> will contain the the @examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> set.seed(</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                          training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #ff6347;">get_pixels</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, polys, class_col, training<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, src<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'none'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">projection</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Coordinate systems do not match'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>src<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>class_col<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'id'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'class_col cannot be named ID (case insensitive)'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert class_col from the name of the column to an index</span>
    class_colnum <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^'</span>, class_col, <span style="color: #00ff00;">'$'</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>class_colnum<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, class_col, <span style="color: #00ff00;">' not found in polys'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">This is displayed in the dataframe, and should never change</span>
    polys$ID <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span>
    polys$src <span style="color: #00ffff;">&lt;-</span> src
    <span style="color: #ff6347;">row.names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>polys$src, <span style="color: #00ff00;">'_'</span>, polys$ID<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.character</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle case of having column name suppled as 'training'</span>
        training_col_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>training, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training_col_index<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, training,  <span style="color: #00ff00;">' column not found in x'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.logical</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">[</span>training_col_index<span style="color: #20b2aa;">]))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, training,  <span style="color: #00ff00;">' column must be a logical vector'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        training <span style="color: #00ffff;">&lt;-</span> polys<span style="color: #20b2aa;">[</span>, <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span>training, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.numeric</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> &amp;&amp;
               <span style="color: #20b2aa;">(</span>training <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>training <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle case of having fraction supplied as 'training'</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'training_flag'</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'training_flag column already present in polys'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>training <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle training=</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> separately to enable use of quantile function </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">below.</span>
            polys$training_flag <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff6347;">sample_strata</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                rand_vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">runif</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
                rand_vals <span style="color: #00ffff;">&lt;=</span> <span style="color: #ff6347;">quantile</span><span style="color: #20b2aa;">(</span>rand_vals, training<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
            polys$training_flag <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">unlist</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tapply</span><span style="color: #20b2aa;">(</span>polys@data$ID, 
                                                 polys@data<span style="color: #20b2aa;">[</span>class_colnum<span style="color: #20b2aa;">]</span>, 
                                                 sample_strata<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">))</span> &amp;&amp; <span style="color: #ff6347;">is.logical</span><span style="color: #20b2aa;">(</span>training<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Handle case of having vector supplied as 'training'</span>
        polys$training_flag <span style="color: #00ffff;">&lt;-</span> training
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'training must be a column name, vector of same length as polys, or length </span><span style="color: #daa520;">1</span><span style="color: #00ff00;"> numeric'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extract</span><span style="color: #20b2aa;">(</span>x, polys, small<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, df<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    poly_rows <span style="color: #00ffff;">&lt;-</span> pixels$ID
    pixels <span style="color: #00ffff;">&lt;-</span> pixels<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>pixels<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'ID'</span><span style="color: #20b2aa;">)]</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert y classes to valid R variable names - if they are not valid R </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">variable names, the classification algorithm may throw an error</span>
    y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">make.names</span><span style="color: #20b2aa;">(</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, class_colnum<span style="color: #20b2aa;">]))</span>
    pixel_src <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>src<span style="color: #00ffff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$src,
                            ID<span style="color: #00ffff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$ID, 
                            stringsAsFactors<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span>pixel_data, x<span style="color: #00ffff;">=</span>pixels, y<span style="color: #00ffff;">=</span>y, pixel_src<span style="color: #00ffff;">=</span>pixel_src,
               training_flag<span style="color: #00ffff;">=</span>polys@data<span style="color: #20b2aa;">[</span>poly_rows, <span style="color: #20b2aa;">]</span>$training_flag,
               polys<span style="color: #00ffff;">=</span>polys<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-40" class="outline-2">
<h2 id="sec-40"><span class="section-number-2">40</span> proj4comp.R</h2>
<div class="outline-text-2" id="text-40">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Performs a rough comparison of two proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">strings to see if they match</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Compares the proj, ellps, zone (if applicable), units, and datum tags in two </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">strings to determine if two projections match. Requires proj and ellps </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> to be present. If present, zone, units, and datum must match in both </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> strings.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgdal</span><span style="color: #00bfff;"> CRSargs</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">stringr</span><span style="color: #00bfff;"> str_extract</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string to compare with \code{y}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> a proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string to compare with \code{x}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> TRUE or FALSE depending on if the projections match</span>
<span style="color: #ff6347;">proj4comp</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'+init='</span>, x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">CRSargs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'+init='</span>, y<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">CRSargs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    x_proj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'+proj=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    y_proj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #00ff00;">'+proj=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_proj, y_proj<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'proj string is missing'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x_proj !<span style="color: #00ffff;">=</span> y_proj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    x_ellps <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'+ellps=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    y_ellps <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #00ff00;">'+ellps=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_ellps, y_ellps<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'ellps string is missing'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x_ellps !<span style="color: #00ffff;">=</span> y_ellps<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'utm'</span>, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x_proj<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        x_zone <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'+zone=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
        y_zone <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #00ff00;">'+zone=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">sum</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>x_zone, y_zone<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'utm zone must be specified for utm projections'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x_zone !<span style="color: #00ffff;">=</span> y_zone<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        x_south <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'+south'</span><span style="color: #20b2aa;">)</span>
        y_south <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'+south'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_south<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_south<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Get here if one or more of x_south and y_south is not NA</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">xor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_south<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_south<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>x_south !<span style="color: #00ffff;">=</span> y_south<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Get here if ONLY one of x_south and y_south is NA, or, if </span>
                <span style="color: #00bfff;"># </span><span style="color: #00bfff;">x_south and y_south are both not NA and are both not equal</span>
                <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    x_datum <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'+datum=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    y_datum <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #00ff00;">'+datum=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_datum<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_datum<span style="color: #20b2aa;">))</span> &amp; <span style="color: #20b2aa;">(</span>x_datum !<span style="color: #00ffff;">=</span> y_datum<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>

    x_units <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'+units=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    y_units <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">str_extract</span><span style="color: #20b2aa;">(</span>y, <span style="color: #00ff00;">'+units=[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x_units<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>y_units<span style="color: #20b2aa;">))</span> &amp; <span style="color: #20b2aa;">(</span>x_units !<span style="color: #00ffff;">=</span> y_units<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-41" class="outline-2">
<h2 id="sec-41"><span class="section-number-2">41</span> RcppExports.R</h2>
<div class="outline-text-2" id="text-41">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff;"># </span><span style="color: #00bfff;">This file was generated by Rcpp::compileAttributes</span>
<span style="color: #00bfff;"># </span><span style="color: #00bfff;">Generator token: </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">BE</span><span style="color: #daa520;">3573</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">1514</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">C</span><span style="color: #daa520;">36</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">9</span><span style="color: #00bfff;">D</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">C-</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">A</span><span style="color: #daa520;">225</span><span style="color: #00bfff;">CD</span><span style="color: #daa520;">40393</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Threshold an image using Huang's fuzzy thresholding method.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Implements Huang's fuzzy thresholding method. This function is called by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the \code{\link{threshold}} function. It is not intended to be used </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> directly.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Ported to C++ by from the code in the Auto_threshold imageJ plugin by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Gabriel Landini.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> See original code at:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.mecourse.com/landinig/software/autothreshold/autothreshold.html</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">data</span><span style="color: #00bfff;"> the input image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> integer threshold value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Huang, L.-K., and M.-J. J. Wang. </span><span style="color: #daa520;">1995</span><span style="color: #00bfff;">. Image thresholding by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> minimizing the measures of fuzziness. Pattern recognition </span><span style="color: #daa520;">28</span><span style="color: #00bfff;"> (</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">):</span><span style="color: #daa520;">41</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">51</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">threshold_Huang</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>data<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc_threshold_Huang'</span>, PACKAGE <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'teamlucc'</span>, data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculate change direction</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This code calculate the change direction from two probability images. Not</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> intended to be called directly - see \code{chg_dir}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">1</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> posterior probability matrix (with pixels in rows, bands </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in columns)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">t</span><span style="color: #daa520;">2</span><span style="color: #ffa500;">p</span><span style="color: #00bfff;"> time </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> posterior probability matrix (with pixels in rows, bands </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in columns)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> vector of change directions</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Chen, J., P. Gong, C. He, R. Pu, and P. Shi. </span><span style="color: #daa520;">2003</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Land-use/land-cover change detection using improved change-vector analysis.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Photogrammetric Engineering and Remote Sensing </span><span style="color: #daa520;">69</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">369</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">380</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Chen, J., X. Chen, X. Cui, and J. Chen. </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">. Change vector analysis in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> posterior probability space: a new method for land cover change detection.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IEEE Geoscience and Remote Sensing Letters </span><span style="color: #daa520;">8</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">317</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">321</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">calc_chg_dir</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc_calc_chg_dir'</span>, PACKAGE <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'teamlucc'</span>, t<span style="color: #daa520;">1</span>p, t<span style="color: #daa520;">2</span>p<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Cloud fill using the algorithm developed by Xiaolin Zhu</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function is called by the \code{\link{cloud_remove}} function. It is</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> not intended to be used directly.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloudy</span><span style="color: #00bfff;"> the cloudy image as a matrix, with pixels in columns (in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> column-major order) and with number of columns equal to number of bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">clear</span><span style="color: #00bfff;"> the clear image as a matrix, with pixels in columns (in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> column-major order) and with number of columns equal to number of bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_mask</span><span style="color: #00bfff;"> the cloud mask image as a vector (in column-major order), </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> with clouds coded with unique integer codes starting at </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, and with areas </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that are clear in both images  coded as </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">. Areas that are missing in the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> clear image, should be coded as -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dims</span><span style="color: #00bfff;"> the dimensions of the cloudy image as a length </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> vector: (rows, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> columns, bands)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">num_class</span><span style="color: #00bfff;"> set the estimated number of classes in image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">min_pixel</span><span style="color: #00bfff;"> the sample size of similar pixels</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_pixel</span><span style="color: #00bfff;"> the maximum sample size to search for similar pixels</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_nbh</span><span style="color: #00bfff;"> the range of cloud neighborhood (in pixels)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> the minimum valid DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> the maximum valid DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> array with cloud filled image with dims: cols, rows, bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parameter, containing the selected textures measures</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Zhu, X., Gao, F., Liu, D., Chen, J., </span><span style="color: #daa520;">2012</span><span style="color: #00bfff;">. A modified</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> neighborhood similar pixel interpolator approach for removing thick clouds </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in Landsat images. Geoscience and Remote Sensing Letters, IEEE </span><span style="color: #daa520;">9</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">521</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">525</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">cloud_fill</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, verbose <span style="color: #00ffff;">=</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc_cloud_fill'</span>, PACKAGE <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'teamlucc'</span>, cloudy, clear, cloud_mask, dims, num_class, min_pixel, max_pixel, cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Cloud fill using a simple linear model approach</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This algorithm fills clouds using a simple approach in which the value of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> each clouded pixel is calculated using a linear model. The script</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> develops a separate linear model (with slope and intercept) for each band </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and each cloud. For each cloud, and each image band, the script finds all </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> pixels clear in both the cloudy and fill images, and calculates a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> regression model in which pixel values in the fill image are the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> independent variable, and pixel values in the clouded image are the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> dependent variable. The script then uses this model to predict pixel values </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for each band in each cloud in the clouded image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function is called by the \code{\link{cloud_remove}} function. It is</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> not intended to be used directly.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloudy</span><span style="color: #00bfff;"> the cloudy image as a matrix, with pixels in columns (in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> column-major order) and with number of columns equal to number of bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">clear</span><span style="color: #00bfff;"> the clear image as a matrix, with pixels in columns (in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> column-major order) and with number of columns equal to number of bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_mask</span><span style="color: #00bfff;"> the cloud mask image as a vector (in column-major order), </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> with clouds coded with unique integer codes starting at </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, and with areas </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that are clear in both images  coded as </span><span style="color: #daa520;">0</span><span style="color: #00bfff;">. Areas that are missing in the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> clear image, should be coded as -</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">dims</span><span style="color: #00bfff;"> the dimensions of the cloudy image as a length </span><span style="color: #daa520;">3</span><span style="color: #00bfff;"> vector: (rows, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> columns, bands)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">num_class</span><span style="color: #00bfff;"> set the estimated number of classes in image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">cloud_nbh</span><span style="color: #00bfff;"> the range of cloud neighborhood (in pixels)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> the minimum valid DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> the maximum valid DN value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to print detailed status messages</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> array with cloud filled image with dims: cols, rows, bands</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parameter, containing the selected textures measures</span>
<span style="color: #ff6347;">cloud_fill_simple</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>cloudy, clear, cloud_mask, dims, num_class, cloud_nbh, DN_min, DN_max, verbose <span style="color: #00ffff;">=</span> <span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">.Call</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc_cloud_fill_simple'</span>, PACKAGE <span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'teamlucc'</span>, cloudy, clear, cloud_mask, dims, num_class, cloud_nbh, DN_min, DN_max, verbose<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-42" class="outline-2">
<h2 id="sec-42"><span class="section-number-2">42</span> sample<sub>raster</sub>.R</h2>
<div class="outline-text-2" id="text-42">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Generate random sample polygons from a raster layer, optionally with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> stratification</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Useful for gathering training data for an image classification. With the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> default settings, the output polygons will be perfectly aligned with the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> pixels in the input raster.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgdal</span><span style="color: #00bfff;"> writeOGR</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">size</span><span style="color: #00bfff;"> the sample size (number of sample polygons to return)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">side</span><span style="color: #00bfff;"> desired length for each side of the sample polygon (units of the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> input \code{Raster*}, usually meters)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">strata</span><span style="color: #00bfff;"> (optional) a \code{RasterLayer} of integers giving the strata </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of each pixel (for example, a classified image)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">fields</span><span style="color: #00bfff;"> a list of fields to include in the output </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{SpatialPolygonsDataFrame} (such as a class field if you will be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> digitizing classes).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">na.rm</span><span style="color: #00bfff;"> whether to remove pixels with NA values from the sample</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">exp</span><span style="color: #00bfff;"> multiplier used to draw larger initial sample to account for the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> loss of sample polygons lost because they contain NAs, and, for stratified </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> sampling, to account for classes that occur very infrequently in the data.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Increase this value if the final sample has fewer sample polygons than </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> desired.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{SpatialPolygonsDataFrame}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> set.seed(</span><span style="color: #daa520;">0</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;"> &lt;- raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> training_polys &lt;- sample_raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">30</span><span style="color: #00bfff;">,</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                                   side=</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">*xres(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_b</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(training_polys, add=TRUE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">sample_raster</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, size, strata<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, side<span style="color: #00ffff;">=</span><span style="color: #ff6347;">xres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, fields<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>, 
                          na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, exp<span style="color: #00ffff;">=</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        stratified <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">TRUE</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span> !<span style="color: #00ffff;">=</span> <span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x and strata must have the same coordinate system'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x and strata must have the same extent'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">identical</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>strata<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">res</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x and strata must have the same resolution'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        strat_sample <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleStratified</span><span style="color: #20b2aa;">(</span>strata, size, exp<span style="color: #00ffff;">=</span>exp, na.rm<span style="color: #00ffff;">=</span>na.rm<span style="color: #20b2aa;">)</span>
        cell_nums <span style="color: #00ffff;">&lt;-</span> strat_sample<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
        strataids <span style="color: #00ffff;">&lt;-</span> strat_sample<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        stratified <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">FALSE</span>
        cell_nums <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRandom</span><span style="color: #20b2aa;">(</span>x, size, exp<span style="color: #00ffff;">=</span>exp, na.rm<span style="color: #00ffff;">=</span>na.rm<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    xy <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">xyFromCell</span><span style="color: #20b2aa;">(</span>x, cell_nums<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert from cell-center coordinates to ul corner of cell coordinates</span>
    xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">xres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span>
    xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">yres</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Coordinate order is: ll, lr, ur, ul, ll. Need to end with ll to close the </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">polygon</span>
    xcoords <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">+</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">])</span>
    ycoords <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> side,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>,
                     xy<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">-</span> side<span style="color: #20b2aa;">)</span>
    xycoords <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">array</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>xcoords, ycoords<span style="color: #20b2aa;">)</span>,
                      dim<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>xcoords<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>xcoords<span style="color: #20b2aa;">)</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">TODO: Add check to ensure no polygons overlap, and warn if they fall </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">outside raster extent</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Function to make individual polygons for each sample area</span>
    <span style="color: #ff6347;">make_Polygon</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slice<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">Polygon</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>slice<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, y<span style="color: #00ffff;">=</span>slice<span style="color: #20b2aa;">[</span>, <span style="color: #daa520;">2</span><span style="color: #20b2aa;">])))</span>
    <span style="color: #20b2aa;">}</span>
    polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>xycoords, <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>, make_Polygon<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Now convert the list of Polygon objects to a list of Polygons objects </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">(notice the trailing s in Polygons)</span>
    polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">mapply</span><span style="color: #20b2aa;">(</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>poly, ID<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">Polygons</span><span style="color: #20b2aa;">(</span>poly, ID<span style="color: #00ffff;">=</span>ID<span style="color: #20b2aa;">)</span>,
                    polys, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)))</span>
    Sr <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygons</span><span style="color: #20b2aa;">(</span>polys, proj<span style="color: #daa520;">4</span>string<span style="color: #00ffff;">=</span><span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">proj</span><span style="color: #daa520;">4</span><span style="color: #ff6347;">string</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>stratified<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>ID<span style="color: #00ffff;">=</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>Sr<span style="color: #20b2aa;">)</span>, strata<span style="color: #00ffff;">=</span>strataids<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>ID<span style="color: #00ffff;">=</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>Sr<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>field <span style="color: #ff00ff;">in</span> fields<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        out_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>out_data, <span style="color: #ff6347;">rep</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)))</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)[</span><span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>out_data<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> field
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Finally, convert to a SpatialPolygonsDataFrame</span>
    polys <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>Sr, data<span style="color: #00ffff;">=</span>out_data<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;</span> size<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'length of polys &lt; size. Try increasing exp.'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>polys<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-43" class="outline-2">
<h2 id="sec-43"><span class="section-number-2">43</span> scale<sub>raster</sub>.R</h2>
<div class="outline-text-2" id="text-43">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Scales a \code{Raster*} by a power of a given integer and rounds to nearest </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> integer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Useful for scaling and (optionally) rounding a \code{RasterLayer} to integer </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> so that a layer can be saved as an integer datatype such as INT</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">U, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> INT</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">S, INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> or INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> scale_raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{dataType}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Raster*} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">power_of</span><span style="color: #00bfff;"> raster will be scaled using the highest possible power of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> this number</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_out</span><span style="color: #00bfff;"> the scaling factors will be chosen for each layer to ensure </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that the maximum and minimum (if minimum is negative) values of each layer </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> do not exceed \code{max_out}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">do_scaling</span><span style="color: #00bfff;"> perform the scaling and return a \code{Raster*} (if </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{do_scaling} is TRUE) or return a list of scale factors (if </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{do_scaling} is FALSE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">round_output</span><span style="color: #00bfff;"> whether to round the output to the nearest integer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a \code{Raster*} if \code{do_scaling} is TRUE, or a list of scaling </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> factors if \code{do_scaling} is false.</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of<span style="color: #00ffff;">=</span><span style="color: #daa520;">10</span>, max_out<span style="color: #00ffff;">=</span><span style="color: #daa520;">32767</span>, 
                                    round_output<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, do_scaling<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>scale_raster<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">scale_layer</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!x@data@haveminmax<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'no stored minimum and maximum values - running setMinMax'</span><span style="color: #20b2aa;">)</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">setMinMax</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    layer_max <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">max</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">abs</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">minValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">maxValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))))</span>
    scale_factor <span style="color: #00ffff;">&lt;-</span> power_of ^ <span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #20b2aa;">(</span>max_out <span style="color: #00ffff;">/</span> layer_max, base<span style="color: #00ffff;">=</span>power_of<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                  vals <span style="color: #00ffff;">&lt;-</span> vals * scale_factor
                  <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>round_output<span style="color: #20b2aa;">)</span> vals <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                  vals
                  <span style="color: #20b2aa;">})</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>scale_factor<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> scale_raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> scale_raster,RasterLayer,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> foreach</span>
<span style="color: #ff6347;">scale_stack_or_brick</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    unscaled_layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        scale_outputs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unscaled_layer<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                 .combine<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'addLayer'</span>, .multicombine<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                                 .init<span style="color: #00ffff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>, .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span><span style="color: #20b2aa;">)</span>,
                                 .export<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'scale_layer'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
            scale_output <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>unscaled_layer, power_of, max_out, 
                                        round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        scale_outputs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>unscaled_layer<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, 
                                 .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'raster'</span>, <span style="color: #00ff00;">'teamlucc'</span><span style="color: #20b2aa;">)</span>,
                                 .export<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'scale_layer'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
            scale_output <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scale_layer</span><span style="color: #20b2aa;">(</span>unscaled_layer, power_of, max_out, 
                                        round_output, do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>scale_outputs<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>scale_outputs<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> scale_raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> scale_raster,RasterStack,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>RasterStack<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scale_stack_or_brick</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, 
                                    do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> scale_raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> scale_raster,RasterBrick,ANY-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>scale_raster, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>RasterBrick<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, do_scaling<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">scale_stack_or_brick</span><span style="color: #20b2aa;">(</span>x, power_of, max_out, round_output, 
                                    do_scaling<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-44" class="outline-2">
<h2 id="sec-44"><span class="section-number-2">44</span> simplify<sub>polygon</sub>.R</h2>
<div class="outline-text-2" id="text-44">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Count number of vertices in an sp polygon object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">poly_obj</span><span style="color: #00bfff;"> an sp polygon object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> the number of vertices in the polygon</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: Write an example.</span>
<span style="color: #ff6347;">nverts</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    n_verts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sapply</span><span style="color: #20b2aa;">(</span>poly_obj@polygons, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">)</span> 
                      <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>y@Polygons<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>@coords<span style="color: #20b2aa;">))[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>n_verts<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        n_verts <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Need to subtract one as the starting coordinate and ending coordinate </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">are identical, but appear twice - at beginning and at end of list.</span>
        n_verts <span style="color: #00ffff;">&lt;-</span> n_verts <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>n_verts<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Simplify a polygon to contain less than a certain number of vertices</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Useful for simplifying area of interest (AOI) polygons for use with online </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> data portals (like USGS EarthExplorer) that limit the number of vertices </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> allowed in uploaded AOI shapefiles.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgeos</span><span style="color: #00bfff;"> gSimplify</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">poly_obj</span><span style="color: #00bfff;"> a polygon as an sp object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_vertices</span><span style="color: #00bfff;"> the maximum number of vertices to allow in the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> simplified polygon</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maxit</span><span style="color: #00bfff;"> the maximum number of iterations to use to simplify the polygon</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">multiplier</span><span style="color: #00bfff;"> a number used to increase the tolerance for each </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> subsequent iteration, if the number of vertices in the simplified polygon is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> not less than /code{max_vertices}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">initial_tolerance</span><span style="color: #00bfff;"> initial value for tolerance used to remove vertices </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> from polygon.  If set to the default option, dynamic, the code will </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> automatically set the \code{initial_tolerance} to .</span><span style="color: #daa520;">01</span><span style="color: #00bfff;"> * the length of the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> diagonal of the bounding box of the polygon. \code{initial_tolerance} can </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> also be set to an arbitrary value, in the same units as the polygon object.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> polygon with less than \code{max_vertices} vertices</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: add an example</span>
<span style="color: #ff6347;">simplify_polygon</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>poly_obj, max_vertices, maxit<span style="color: #00ffff;">=</span><span style="color: #daa520;">100</span>, 
                             multiplier<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>.<span style="color: #daa520;">05</span>, initial_tolerance<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'dynamic'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'SpatialPolygonsDataFrame'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        poly_data <span style="color: #00ffff;">&lt;-</span> poly_obj@data
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        poly_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    <span style="color: #20b2aa;">}</span>
    n_parts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sapply</span><span style="color: #20b2aa;">(</span>poly_obj@polygons, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>n_parts<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'poly_obj contains more than one polygon'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_parts <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'poly_obj polygon is a multipart polygon'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>initial_tolerance <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'dynamic'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set the initial tolerance as the extent / </span><span style="color: #daa520;">100</span>
        ext <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">extent</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
        diag_seg_length <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">((</span>ext@xmax <span style="color: #00ffff;">-</span> ext@xmin<span style="color: #20b2aa;">)</span>**<span style="color: #daa520;">2</span> <span style="color: #00ffff;">+</span>
                                <span style="color: #20b2aa;">(</span>ext@ymax <span style="color: #00ffff;">-</span> ext@ymin<span style="color: #20b2aa;">)</span>**<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        tolerance <span style="color: #00ffff;">&lt;-</span> diag_seg_length <span style="color: #00ffff;">/</span> <span style="color: #daa520;">100</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        tolerance <span style="color: #00ffff;">&lt;-</span> initial_tolerance
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Iterate, increasing tolerance, until polygon has less than maxpts </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">vertices.</span>
    n_verts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nverts</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
    n <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
    <span style="color: #ff00ff;">while</span> <span style="color: #20b2aa;">((</span>n_verts <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">&lt;</span> maxit<span style="color: #20b2aa;">)</span> &amp;&amp; <span style="color: #20b2aa;">(</span>n_verts <span style="color: #00ffff;">&gt;</span> max_vertices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        poly_obj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gSimplify</span><span style="color: #20b2aa;">(</span>poly_obj, tol<span style="color: #00ffff;">=</span>tolerance<span style="color: #20b2aa;">)</span>
        n_verts <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">nverts</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
        tolerance <span style="color: #00ffff;">&lt;-</span> tolerance * multiplier 
        n <span style="color: #00ffff;">&lt;-</span> n <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n <span style="color: #00ffff;">==</span> maxit<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Reached maximum iterations ('</span>, maxit, <span style="color: #00ff00;">')'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_verts <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Simplified polygon has no vertices.'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>n_verts <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Simplified polygon has only'</span>, n_verts, <span style="color: #00ff00;">'vertices.'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>poly_data<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        poly_obj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">SpatialPolygonsDataFrame</span><span style="color: #20b2aa;">(</span>poly_obj, data<span style="color: #00ffff;">=</span>poly_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>poly_obj<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-45" class="outline-2">
<h2 id="sec-45"><span class="section-number-2">45</span> split<sub>classes</sub>.R</h2>
<div class="outline-text-2" id="text-45">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Split classes in a training dataset using normal mixture modeling</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function can be used to aid in classifying spectrally diverse classes </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> by splitting the input classes into subclasses using a clustering algorithm.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> After classification, these subclasses are merged back into their original </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> parent classes. For example, the training data for an agriculture class </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> might have both fallow and planted fields in the training data, or fields </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> planted with different crops that are spectrally dissimilar.  This function </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> can be used to automatically split the agriculture class into a number of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> subclasses.  The classifier is then run on this larger set of classes, and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> following classification, these subclasses can all be merged together into a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> single overall agriculture class.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">mclust</span><span style="color: #00bfff;"> Mclust</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">train_data</span><span style="color: #00bfff;"> a \code{link{pixel_data}} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">split_levels</span><span style="color: #00bfff;"> (optional) a list giving the names of the levels to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> split. If missing, all levels will be split.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">verbose</span><span style="color: #00bfff;"> whether to report status while running</span>
<span style="color: #ff6347;">split_classes</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>train_data, split_levels, verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    y_reclass <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">vector</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'numeric'</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>split_levels<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        split_levels <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>train_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>level <span style="color: #ff00ff;">in</span> split_levels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        level_ind <span style="color: #00ffff;">&lt;-</span> train_data@y <span style="color: #00ffff;">==</span> level
        model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">Mclust</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">[</span>level_ind, <span style="color: #20b2aa;">])</span>
        y_reclass<span style="color: #20b2aa;">[</span>level_ind<span style="color: #20b2aa;">]</span>  <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>train_data@y<span style="color: #20b2aa;">[</span>level_ind<span style="color: #20b2aa;">]</span>, 
                                       model$classification, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'_clust'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>verbose<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>level, <span style="color: #00ff00;">'split into'</span>, model$g, <span style="color: #00ff00;">'classes'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    y <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>y_reclass<span style="color: #20b2aa;">)</span>
    reclass_mat <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>split_name<span style="color: #00ffff;">=</span><span style="color: #ff6347;">levels</span><span style="color: #20b2aa;">(</span>y<span style="color: #20b2aa;">))</span>
    reclass_mat$split_id <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.numeric</span><span style="color: #20b2aa;">(</span>reclass_mat$split_name<span style="color: #20b2aa;">)</span>
    reclass_mat$name <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gsub</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'_clust[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]*$'</span>, <span style="color: #00ff00;">''</span>, reclass_mat$split_name<span style="color: #20b2aa;">)</span>
    reclass_mat$id <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">match</span><span style="color: #20b2aa;">(</span>reclass_mat$name, <span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>reclass_mat$name<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>reclass_mat<span style="color: #00ffff;">=</span>reclass_mat, y<span style="color: #00ffff;">=</span><span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>y_reclass<span style="color: #20b2aa;">)))</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-46" class="outline-2">
<h2 id="sec-46"><span class="section-number-2">46</span> SVIs.R</h2>
<div class="outline-text-2" id="text-46">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the Normalized Difference Vegetation Index (NDVI)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the NDVI, defined as: (nir - red) / (nir + red).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> NDVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">red</span><span style="color: #00bfff;"> red</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">nir</span><span style="color: #00bfff;"> near-infrared</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments as for \code{\link{writeRaster}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> NDVI_img &lt;- NDVI(red=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">), nir=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                 layer=</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(NDVI_img)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>NDVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">NDVI_calc</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">-</span> red<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">+</span> red<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> NDVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> NDVI,numeric,numeric,numeric-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>numeric, nir<span style="color: #00ffff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> NDVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> NDVI,matrix,matrix,matrix-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>matrix, nir<span style="color: #00ffff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> NDVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> NDVI,RasterLayer,RasterLayer,RasterLayer-method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>NDVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>RasterLayer, nir<span style="color: #00ffff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret  <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>red, nir, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">NDVI_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> , ...<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the Enhanced Vegetation Index (EVI)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> EVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">blue</span><span style="color: #00bfff;"> blue</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">red</span><span style="color: #00bfff;"> red</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">nir</span><span style="color: #00bfff;"> near-infrared</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments as for \code{\link{writeRaster}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Huete, A. R., HuiQing Liu, and W. J. D. van Leeuwen. </span><span style="color: #daa520;">1997</span><span style="color: #00bfff;">. The</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> use of vegetation indices in forested regions: issues of linearity and</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> saturation. Pages </span><span style="color: #daa520;">1966</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">1968</span><span style="color: #00bfff;"> vol.</span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> Geoscience and Remote Sensing, </span><span style="color: #daa520;">1997</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> IGARSS '</span><span style="color: #daa520;">97</span><span style="color: #00bfff;">. Remote Sensing - A Scientific Vision for Sustainable</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Development., </span><span style="color: #daa520;">1997</span><span style="color: #00bfff;"> IEEE International.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> EVI_img &lt;- EVI(blue=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">), red=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">), </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                nir=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(EVI_img)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>EVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">EVI_calc</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>.<span style="color: #daa520;">5</span>*<span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">-</span> red<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span> <span style="color: #00ffff;">+</span> nir <span style="color: #00ffff;">+</span> <span style="color: #daa520;">6</span>*red <span style="color: #00ffff;">-</span> <span style="color: #daa520;">7</span>.<span style="color: #daa520;">5</span>*blue<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> EVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> EVI,numeric,numeric,numeric-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>numeric, red<span style="color: #00ffff;">=</span>numeric, nir<span style="color: #00ffff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> EVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> EVI,numeric,numeric,numeric-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>matrix, red<span style="color: #00ffff;">=</span>matrix, nir<span style="color: #00ffff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> EVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> EVI,RasterLayer,RasterLayer,RasterLayer-method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>EVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>RasterLayer, red<span style="color: #00ffff;">=</span>RasterLayer, 
                           nir<span style="color: #00ffff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>blue, red, nir, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">EVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the Modified Soil-Adjusted Vegetation Index (MSAVI)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Note that this avoids the need for calculating L by using the equation for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> from Qi et al. (</span><span style="color: #daa520;">1994</span><span style="color: #00bfff;">).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">red</span><span style="color: #00bfff;"> red</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">nir</span><span style="color: #00bfff;"> near-infrared</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments as for \code{\link{writeRaster}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Qi, J., A. Chehbouni, A. R. Huete, Y. H. Kerr, and S.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sorooshian. </span><span style="color: #daa520;">1994</span><span style="color: #00bfff;">. A modified soil adjusted vegetation index. Remote Sensing</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of Environment </span><span style="color: #daa520;">48</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">119</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">126</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> MSAVI_img &lt;- MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">(red=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">),</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                     nir=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(MSAVI_img)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">MSAVI2_calc</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span>*nir <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span> <span style="color: #00ffff;">-</span> <span style="color: #ff6347;">sqrt</span><span style="color: #20b2aa;">((</span><span style="color: #daa520;">2</span>*nir <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>^<span style="color: #daa520;">2</span> <span style="color: #00ffff;">-</span> <span style="color: #daa520;">8</span>*<span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">-</span> red<span style="color: #20b2aa;">)))</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">,numeric,numeric,numeric-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>numeric, nir<span style="color: #00ffff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">,matrix,matrix,matrix-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>matrix, nir<span style="color: #00ffff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> MSAVI</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">,RasterLayer,RasterLayer,RasterLayer-method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>MSAVI<span style="color: #daa520;">2</span>, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>red<span style="color: #00ffff;">=</span>RasterLayer, nir<span style="color: #00ffff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret  <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>red, nir, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">MSAVI</span><span style="color: #daa520;">2</span><span style="color: #ff6347;">_calc</span><span style="color: #20b2aa;">(</span>red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span> , ...<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Calculates the Atmospherically Resistant Vegetation Index (ARVI)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> ARVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">blue</span><span style="color: #00bfff;"> blue</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">red</span><span style="color: #00bfff;"> red</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">nir</span><span style="color: #00bfff;"> near-infrared</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments as for \code{\link{writeRaster}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Kaufman, Y. J., and D. Tanre. </span><span style="color: #daa520;">1996</span><span style="color: #00bfff;">. Strategy for direct and</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> indirect methods for correcting the aerosol effect on remote sensing: from</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> AVHRR to EOS-MODIS. Remote Sensing of Environment:</span><span style="color: #daa520;">65</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">79</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> ARVI_img &lt;- ARVI(blue=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">), red=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                  layer=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">), nir=raster(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, layer=</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plot(ARVI_img)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>ARVI<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">ARVI_calc</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    v <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">-</span> <span style="color: #daa520;">2</span>*red <span style="color: #00ffff;">-</span> blue<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>nir <span style="color: #00ffff;">+</span> <span style="color: #daa520;">2</span>*red <span style="color: #00ffff;">-</span> blue<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>v<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> ARVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> ARVI,numeric,numeric,numeric-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>numeric, red<span style="color: #00ffff;">=</span>numeric, nir<span style="color: #00ffff;">=</span>numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> ARVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> ARVI,matrix,matrix,matrix-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>matrix, red<span style="color: #00ffff;">=</span>matrix, nir<span style="color: #00ffff;">=</span>matrix<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> ARVI</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> ARVI,RasterLayer,RasterLayer,RasterLayer-method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">raster</span><span style="color: #00bfff;"> overlay</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>ARVI, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>blue<span style="color: #00ffff;">=</span>RasterLayer, red<span style="color: #00ffff;">=</span>RasterLayer, 
                            nir<span style="color: #00ffff;">=</span>RasterLayer<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ret <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>blue, red, nir, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">ARVI_calc</span><span style="color: #20b2aa;">(</span>blue, red, nir<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">}</span>, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>ret<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-47" class="outline-2">
<h2 id="sec-47"><span class="section-number-2">47</span> teamlucc-package.R</h2>
<div class="outline-text-2" id="text-47">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> TEAM land use and cover change data processing toolkit</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> teamlucc is a set of routines to support analyzing land use and cover change </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (LUCC) in R. The package was designed to support analyzing LUCC in the Zone </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> of Interaction (ZOIs) of monitoring sites in the Tropical Ecology Assessment </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and Monitoring (TEAM) Network.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> teamlucc-package</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> teamlucc</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> package</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@title</span><span style="color: #00bfff;"> TEAM Remote Sensing Processing Tools</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@author</span><span style="color: #00bfff;"> Alex Zvoleff, \email{azvoleff@@conservation.org}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@keywords</span><span style="color: #00bfff;"> package</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@useDynLib</span><span style="color: #00bfff;"> teamlucc</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance Image from February </span><span style="color: #daa520;">6</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;"> (path </span><span style="color: #daa520;">15</span><span style="color: #00bfff;">, row </span><span style="color: #daa520;">53</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Portion of Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance image from the Landsat Climate Data </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Record archive. This subset of the image includes only bands </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, and pixel </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> values have been scaled by </span><span style="color: #daa520;">10000</span><span style="color: #00bfff;"> and rounded off.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance Image from January </span><span style="color: #daa520;">14</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2001</span><span style="color: #00bfff;"> (path </span><span style="color: #daa520;">15</span><span style="color: #00bfff;">, row </span><span style="color: #daa520;">53</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Portion of Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance image from the Landsat Climate Data </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Record archive. This subset of the image includes only bands </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">-</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, and pixel </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> values have been scaled by </span><span style="color: #daa520;">10000</span><span style="color: #00bfff;"> and rounded off.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">2001</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Subset of ASTER Digital Elevation Model V</span><span style="color: #daa520;">002</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_WEST</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_EAST</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Training polygons for </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">2001</span><span style="color: #00bfff;"> Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance images</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Polygons digitized from </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">2001</span><span style="color: #00bfff;"> Landsat </span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> Surface Reflectance image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> from the Landsat Climate Data Record archive. The training polygons can be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> used for testing classification algorithms.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> There are three columns in the dataset. class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;"> is the cover class for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the pixels in the polygon from the </span><span style="color: #daa520;">1986</span><span style="color: #00bfff;"> image. class_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;"> is the cover class </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for the pixels in the polygon from the </span><span style="color: #daa520;">2001</span><span style="color: #00bfff;"> image.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Subset of ASTER Digital Elevation Model V</span><span style="color: #daa520;">002</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_WEST</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_EAST</span>
<span style="color: #daa520;">NULL</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Subset of ASTER Digital Elevation Model V</span><span style="color: #daa520;">002</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@docType</span><span style="color: #00bfff;"> data</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_EAST</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_WEST</span>
<span style="color: #daa520;">NULL</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-48" class="outline-2">
<h2 id="sec-48"><span class="section-number-2">48</span> threshold.R</h2>
<div class="outline-text-2" id="text-48">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Automatically determine value for image thresholding</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The only method currently implemented is Huang's fuzzy thresholding method.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The code for Huang's method was ported to C++ for \code{teamlucc} from the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> code in the Auto_threshold imageJ plugin by Gabriel Landini. See original </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> code at:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.mecourse.com/landinig/software/autothreshold/autothreshold.html</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> foreach</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">iterators</span><span style="color: #00bfff;"> iter</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> the input image, as a matrix or raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">method</span><span style="color: #00bfff;"> the thresholding method. Currently only huang is </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> implemented.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">n_bin</span><span style="color: #00bfff;"> number of bins to use when calculating histogram</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">maxpixels</span><span style="color: #00bfff;"> maximum number of pixels size to use when calculating </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> histogram</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> integer threshold value</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span><span style="color: #00bfff;"> Huang, L.-K., and M.-J. J. Wang. </span><span style="color: #daa520;">1995</span><span style="color: #00bfff;">. Image thresholding by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> minimizing the measures of fuzziness. Pattern recognition </span><span style="color: #daa520;">28</span><span style="color: #00bfff;"> (</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">):</span><span style="color: #daa520;">41</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">51</span><span style="color: #00bfff;">.</span>
<span style="color: #ff6347;">threshold</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, method<span style="color: #00ffff;">=</span>huang, n_bin<span style="color: #00ffff;">=</span><span style="color: #daa520;">1000</span>, maxpixels<span style="color: #00ffff;">=</span><span style="color: #daa520;">5</span>e<span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>huang<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">ncell</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&gt;</span> maxpixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sampleRegular</span><span style="color: #20b2aa;">(</span>x, maxpixels, useGDAL<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, asRaster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">setMinMax</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    mins <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">minValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    maxs <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">maxValue</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    bys <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>maxs <span style="color: #00ffff;">-</span> mins<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>n_bin<span style="color: #20b2aa;">)</span>
    bandnum<span style="color: #00ffff;">=</span>minval<span style="color: #00ffff;">=</span>maxval<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
    thresholds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>bandnum<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nlayers</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>, minval<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>mins<span style="color: #20b2aa;">)</span>, 
                          maxval<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>maxs<span style="color: #20b2aa;">)</span>, by<span style="color: #00ffff;">=</span><span style="color: #ff6347;">iter</span><span style="color: #20b2aa;">(</span>bys<span style="color: #20b2aa;">)</span>,
                          .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span><span style="color: #20b2aa;">)</span>,
                          .combine<span style="color: #00ffff;">=</span>c<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
        image_hist <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">hist</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[[</span>bandnum<span style="color: #20b2aa;">]]</span>, breaks<span style="color: #00ffff;">=</span><span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span>minval, maxval<span style="color: #00ffff;">+</span>by, by<span style="color: #00ffff;">=</span>by<span style="color: #20b2aa;">)</span>, 
                           plot<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, maxpixels<span style="color: #00ffff;">=</span>maxpixels<span style="color: #20b2aa;">)</span>
        threshold_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">threshold_Huang</span><span style="color: #20b2aa;">(</span>image_hist$counts<span style="color: #20b2aa;">)</span>
        image_hist$breaks<span style="color: #20b2aa;">[</span>threshold_index<span style="color: #20b2aa;">]</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>thresholds<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-49" class="outline-2">
<h2 id="sec-49"><span class="section-number-2">49</span> topocorr<sub>samp</sub>.R</h2>
<div class="outline-text-2" id="text-49">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff6347;">.calc_IL_vector</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    IL <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">sin</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * 
        <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #00ffff;">-</span> aspect<span style="color: #20b2aa;">)</span>
    IL<span style="color: #20b2aa;">[</span>IL <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> IL.epsilon
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">.calc_IL</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">overlay</span><span style="color: #20b2aa;">(</span>slope, aspect,
            fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>slope_vals, aspect_vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">.calc_IL_vector</span><span style="color: #20b2aa;">(</span>slope_vals, aspect_vals, sunzenith, sunazimuth, 
                               IL.epsilon<span style="color: #20b2aa;">)</span>
            <span style="color: #20b2aa;">})</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Topographic correction for satellite imagery</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Perform topographic correction using a number of different methods. This </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> code is modified from the code in the \code{landsat} package by Sarah </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Goslee.  This version of the code has been altered from the \code{landsat} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> version to allow the option of using a sample of pixels for calculation of k </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in the Minnaert correction (useful when dealing with large images).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> See the help page for \code{topocorr} in the \code{landsat} package for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> details on the parameters.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> image as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slope</span><span style="color: #00bfff;"> the slope in radians as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">aspect</span><span style="color: #00bfff;"> the aspect in radians as a \code{RasterLayer}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunelev</span><span style="color: #00bfff;"> sun elevation in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunazimuth</span><span style="color: #00bfff;"> sun azimuth in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">method</span><span style="color: #00bfff;"> the method to use for the topographic correction:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> cosine, improvedcosine, minnaert, minslope, ccorrection, gamma, SCS, or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> illumination</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">na.value</span><span style="color: #00bfff;"> the value used to code no data values</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">IL.epsilon</span><span style="color: #00bfff;"> a small amount to add to calculated illumination values </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that are equal to zero to avoid division by zero resulting in Inf values</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sampleindices</span><span style="color: #00bfff;"> (optional) row-major indices of sample pixels to use in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> regression models used for some topographic correction methods (like </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Minnaert). Useful when handling very large images. See</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{gridsample}} for one method of calculating these indices.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> minimum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_min} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> maximum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_max} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> RasterBrick with two layers: 'slope' and 'aspect'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@author</span><span style="color: #00bfff;"> Sarah Goslee and Alex Zvoleff</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sarah Goslee. Analyzing Remote Sensing Data in {R}: The {landsat} Package.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Journal of Statistical Software, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">43</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, pg </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">25</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.jstatsoft.org/v</span><span style="color: #daa520;">43</span><span style="color: #00bfff;">/i</span><span style="color: #daa520;">04</span><span style="color: #00bfff;">/</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> #TODO: add examples</span>
<span style="color: #ff6347;">topocorr_samp</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, slope, aspect, sunelev, sunazimuth, method<span style="color: #00ffff;">=</span>cosine, 
                          na.value<span style="color: #00ffff;">=</span><span style="color: #daa520;">NA</span>, IL.epsilon<span style="color: #00ffff;">=</span><span style="color: #daa520;">0</span>.<span style="color: #daa520;">000001</span>,
                          sampleindices<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">some inputs are in degrees, but we need radians</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>
    sunzenith <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #daa520;">90</span> <span style="color: #00ffff;">-</span> sunelev<span style="color: #20b2aa;">)</span>
    sunazimuth <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> * sunazimuth
    x<span style="color: #20b2aa;">[</span>x <span style="color: #00ffff;">==</span> na.value<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
    IL <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">.calc_IL</span><span style="color: #20b2aa;">(</span>slope, aspect, sunzenith, sunazimuth, IL.epsilon<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">rm</span><span style="color: #20b2aa;">(</span>aspect, sunazimuth<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">)</span> &amp;&amp; !<span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'minnaert'</span>, <span style="color: #00ff00;">'minslope'</span>, 
                                                   <span style="color: #00ff00;">'ccorrection'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'sampleindices are not used when method is '</span>, method,
                       <span style="color: #00ff00;">'. Ignoring sampleindices.'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    METHODS <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>cosine, improvedcosine, minnaert, minslope, 
                 ccorrection, gamma, SCS, illumination<span style="color: #20b2aa;">)</span>
    method <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">pmatch</span><span style="color: #20b2aa;">(</span>method, METHODS<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>method<span style="color: #20b2aa;">))</span> 
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>invalid method<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> 
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>ambiguous method<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">){</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">Cosine method</span>
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span>IL<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">Improved cosine method</span>
        ILmean <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cellStats</span><span style="color: #20b2aa;">(</span>IL, stat<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'mean'</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        xout <span style="color: #00ffff;">&lt;-</span> x <span style="color: #00ffff;">+</span> <span style="color: #20b2aa;">(</span>x * <span style="color: #20b2aa;">(</span>ILmean <span style="color: #00ffff;">-</span> IL<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span>ILmean<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">Minnaert</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">K is between </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">only use points with greater than </span><span style="color: #daa520;">5</span><span style="color: #00bfff;">% slope</span>
        targetslope <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #00ffff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span><span style="color: #00ffff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #00ffff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span><span style="color: #00ffff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">IL can be &lt;=</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> under certain conditions</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">but that makes it impossible to take log</span><span style="color: #daa520;">10</span><span style="color: #00bfff;"> so remove those </span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">elements</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span><span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #00bfff;"># </span><span style="color: #00bfff;">need slope</span>
            <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span>IL<span style="color: #20b2aa;">)</span> ^ K
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">Minnaert with slope</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">K is between </span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> and </span><span style="color: #daa520;">1</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">only use points with greater than </span><span style="color: #daa520;">5</span><span style="color: #00bfff;">% slope</span>
        targetslope <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">atan</span><span style="color: #20b2aa;">(</span>.<span style="color: #daa520;">05</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span>, na.rm<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span>,
                                x<span style="color: #00ffff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">][</span>sampleindices<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">/</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span>, 
                                x<span style="color: #00ffff;">=</span>IL<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">&gt;=</span> targetslope<span style="color: #20b2aa;">]</span><span style="color: #00ffff;">/</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">IL can be &lt;=</span><span style="color: #daa520;">0</span><span style="color: #00bfff;"> under certain conditions</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">but that makes it impossible to take log</span><span style="color: #daa520;">10</span><span style="color: #00bfff;"> so remove those elements</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>!<span style="color: #ff6347;">apply</span><span style="color: #20b2aa;">(</span>K, <span style="color: #daa520;">1</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">any</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span>,<span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$x <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> K<span style="color: #20b2aa;">[</span>K$y <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">0</span>, <span style="color: #20b2aa;">]</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$y<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">log</span><span style="color: #daa520;">10</span><span style="color: #20b2aa;">(</span>K$x<span style="color: #20b2aa;">))</span>
            K <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>K<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span> <span style="color: #00bfff;"># </span><span style="color: #00bfff;">need slope</span>
            <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
            <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>K <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> K <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">0</span>
        <span style="color: #20b2aa;">}</span>
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>IL * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)))</span> ^ K
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">5</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">C correction</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>sampleindices<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            band.lm <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">]</span> ~ IL<span style="color: #20b2aa;">[</span>sampleindices<span style="color: #20b2aa;">])</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            band.lm <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">lm</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> ~ <span style="color: #ff6347;">getValues</span><span style="color: #20b2aa;">(</span>IL<span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        C <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span><span style="color: #00ffff;">/</span><span style="color: #ff6347;">coefficients</span><span style="color: #20b2aa;">(</span>band.lm<span style="color: #20b2aa;">)[[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]]</span>
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> C<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #00ffff;">+</span> C<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">Gamma</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">assumes zenith viewing angle</span>
        viewterrain <span style="color: #00ffff;">&lt;-</span> pi<span style="color: #00ffff;">/</span><span style="color: #daa520;">2</span> <span style="color: #00ffff;">-</span> slope
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>pi <span style="color: #00ffff;">/</span> <span style="color: #daa520;">2</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">/</span> <span style="color: #20b2aa;">(</span>IL <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>viewterrain<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">7</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">SCS method from GZ</span><span style="color: #daa520;">2009</span>
        xout <span style="color: #00ffff;">&lt;-</span> x * <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>sunzenith<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">cos</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">))</span><span style="color: #00ffff;">/</span>IL
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;">## </span><span style="color: #00bfff;">illumination only</span>
        xout <span style="color: #00ffff;">&lt;-</span> IL
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;">## </span><span style="color: #00bfff;">if slope is zero, reflectance does not change</span>
    <span style="color: #ff00ff;">if</span><span style="color: #20b2aa;">(</span>method !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">8</span><span style="color: #20b2aa;">)</span> 
        xout<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span> <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>slope <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span> &amp; !<span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>slope<span style="color: #20b2aa;">)]</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> || <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        xout <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">calc</span><span style="color: #20b2aa;">(</span>xout, fun<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_min<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&lt;</span> DN_min<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>DN_max<span style="color: #20b2aa;">))</span> vals<span style="color: #20b2aa;">[</span>vals <span style="color: #00ffff;">&gt;</span> DN_max<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NA</span>
                        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>vals<span style="color: #20b2aa;">)</span>
                     <span style="color: #20b2aa;">})</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>xout<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-50" class="outline-2">
<h2 id="sec-50"><span class="section-number-2">50</span> topographic<sub>corr</sub>.R</h2>
<div class="outline-text-2" id="text-50">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Topographically correct a raster</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Performs topographic correction using code based on \code{topocorr} from the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{landsat} package by Sarah Goslee. The code in this package has been </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> modifed from \code{topocorr} to allow using a subsample of the image for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Minnaert k calculations, and to provide the option of running the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> topographic correction in parallel using \code{foreach}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> foreach</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> an image to correct</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">slopeaspect</span><span style="color: #00bfff;"> a \code{RasterBrick} or \code{RasterStack} with two </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> layers.  The first layer should be the slope, the second layer should be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the aspect. The slope and aspect are defined as in \code{terrain} in the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{raster} package, and both should be in radians.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunelev</span><span style="color: #00bfff;"> sun elevation in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sunazimuth</span><span style="color: #00bfff;"> sun azimuth in degrees</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">method</span><span style="color: #00bfff;"> the topographic correction method to use. See the help for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{topocorr} for more guidance on this.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sampleindices</span><span style="color: #00bfff;"> (optional) row-major indices of sample pixels to use in </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> regression models used for some topographic correction methods (like </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Minnaert). Useful when handling very large images. See</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{gridsample}} for one method of calculating these indices.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">scale_factor</span><span style="color: #00bfff;"> factor by which to multiply results. Useful if rounding </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> results to integers (see \code{asinteger} argument).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">asinteger</span><span style="color: #00bfff;"> whether to round results to nearest integer. Can be used to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> save space by saving results as, for example, an 'INT</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">S' \code{raster}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_min</span><span style="color: #00bfff;"> minimum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_min} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">DN_max</span><span style="color: #00bfff;"> maximum allowable pixel value after correction (values less </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> than \code{DN_max} are set to NA)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments to pass to \code{minnaert_samp} or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{topocorr_samp}, depending on chosen topographic correction method</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> The topographically corrected image as a \code{RasterLayer} or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{RasterStack}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@references</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Sarah Goslee. Analyzing Remote Sensing Data in {R}: The {landsat} Package.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Journal of Statistical Software, </span><span style="color: #daa520;">2011</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">43</span><span style="color: #00bfff;">:</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">, pg </span><span style="color: #daa520;">1</span><span style="color: #00bfff;">--</span><span style="color: #daa520;">25</span><span style="color: #00bfff;">.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> http://www.jstatsoft.org/v</span><span style="color: #daa520;">43</span><span style="color: #00bfff;">/i</span><span style="color: #daa520;">04</span><span style="color: #00bfff;">/</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Mosaic the two ASTER DEM tiles needed to a Landsat image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> DEM_mosaic &lt;- mosaic(ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_EAST, ASTER_V</span><span style="color: #daa520;">002</span><span style="color: #00bfff;">_WEST, fun='mean')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Crop and extend the DEM mosaic to match the Landsat image</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> matched_DEM &lt;- match_rasters(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, DEM_mosaic)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> slopeaspect &lt;- terrain(matched_DEM, opt=c('slope', 'aspect')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Apply the topographic correction</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> sunelev &lt;- </span><span style="color: #daa520;">90</span><span style="color: #00bfff;"> - </span><span style="color: #daa520;">44</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">97</span><span style="color: #00bfff;"> # From metadata file</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> sunazimuth &lt;- </span><span style="color: #daa520;">124</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">37</span><span style="color: #00bfff;"> # From metadata file</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_topocorr &lt;- topographic_corr(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, slopeaspect, sunelev, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                                         sunazimuth, method='minslope')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plotRGB(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, stretch='lin', r=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">, g=</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">, b=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> plotRGB(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_topocorr, stretch='lin', r=</span><span style="color: #daa520;">3</span><span style="color: #00bfff;">, g=</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">, b=</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">topographic_corr</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, slopeaspect, sunelev, sunazimuth, 
                             method<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'minnaert_full'</span>, sampleindices<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                             scale_factor<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span>, asinteger<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, DN_min<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, 
                             DN_max<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'RasterLayer'</span>, <span style="color: #00ff00;">'RasterStack'</span>, <span style="color: #00ff00;">'RasterBrick'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x must be a Raster* object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>slopeaspect<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'RasterBrick'</span>, <span style="color: #00ff00;">'RasterStack'</span><span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'slopeaspect must be a RasterBrick or RasterStack object'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    slope <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>
    aspect <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>slopeaspect, layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunelev <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunelev <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">((</span>sunazimuth <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> &amp; <span style="color: #20b2aa;">(</span>sunazimuth <span style="color: #00ffff;">&lt;=</span> <span style="color: #daa520;">360</span><span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Set uncorr_layer to NULL to pass R CMD CHECK without notes</span>
    uncorr_layer<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>
    was_rasterlayer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">class</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> RasterLayer
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert x to stack so foreach will run</span>
    x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    corr_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">foreach</span><span style="color: #20b2aa;">(</span>uncorr_layer<span style="color: #00ffff;">=</span><span style="color: #ff6347;">unstack</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, .combine<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'addLayer'</span>, 
                        .multicombine<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, .init<span style="color: #00ffff;">=</span><span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">()</span>, 
                        .packages<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'teamlucc'</span>, <span style="color: #00ff00;">'rgdal'</span><span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">%</span>dopar<span style="color: #00ffff;">%</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>method <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'minnaert_full'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            minnaert_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">minnaert_samp</span><span style="color: #20b2aa;">(</span>uncorr_layer, slope, aspect, 
                                           sunelev<span style="color: #00ffff;">=</span>sunelev, 
                                           sunazimuth<span style="color: #00ffff;">=</span>sunazimuth, 
                                           sampleindices<span style="color: #00ffff;">=</span>sampleindices, 
                                           DN_min<span style="color: #00ffff;">=</span>DN_min, DN_max<span style="color: #00ffff;">=</span>DN_max, ...<span style="color: #20b2aa;">)</span>
            corr_layer <span style="color: #00ffff;">&lt;-</span> minnaert_data$minnaert
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            corr_layer <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">topocorr_samp</span><span style="color: #20b2aa;">(</span>uncorr_layer, slope, aspect, 
                                        sunelev<span style="color: #00ffff;">=</span>sunelev, sunazimuth<span style="color: #00ffff;">=</span>sunazimuth, 
                                        method<span style="color: #00ffff;">=</span>method, 
                                        sampleindices<span style="color: #00ffff;">=</span>sampleindices,
                                        DN_min<span style="color: #00ffff;">=</span>DN_min, DN_max<span style="color: #00ffff;">=</span>DN_max, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>was_rasterlayer<span style="color: #20b2aa;">)</span> corr_img <span style="color: #00ffff;">&lt;-</span> corr_img<span style="color: #20b2aa;">[[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]]</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'tc'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>scale_factor !<span style="color: #00ffff;">=</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        corr_img <span style="color: #00ffff;">&lt;-</span> corr_img * scale_factor
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>asinteger<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        corr_img <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>corr_img<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-51" class="outline-2">
<h2 id="sec-51"><span class="section-number-2">51</span> tpa2df.R</h2>
<div class="outline-text-2" id="text-51">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Function to convert TIMESAT .tpa binary format file to an R dataframe.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> A string giving the location of a .tpa file output by </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> TIMESAT</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">max_num_seasons</span><span style="color: #00bfff;"> the maximum number of seasons for any of the pixels </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> in the file</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A data.frame containing </span><span style="color: #daa520;">14</span><span style="color: #00bfff;"> columns: row, col, season, start, end, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> length, base_value, peak_time, peak_value, amp, left_deriv, right_deriv, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> large_integ, and small_integ</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: Need to add examples here, and need to include a sample TIMESAT tpa </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # file in the package data.</span>
<span style="color: #ff6347;">tpa2df</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[.]tpa$'</span>, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a .tpa file'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>max_num_seasons<span style="color: #20b2aa;">)</span> || max_num_seasons <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify maximum number of seasons represented in tpa file'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">The number of seasonal indicators output by TIMESAT.</span>
    NUM_SEASONAL_INDICATORS <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">11</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Number of elements in the tpa file line header (which are normally: row, </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">column, number of seasons).</span>
    LINE_HEADER_SIZE <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">3</span>
    tpa_file_obj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>x, rb<span style="color: #20b2aa;">)</span>
    raw_vector <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>tpa_file_obj, n<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>$size, <span style="color: #ff6347;">raw</span><span style="color: #20b2aa;">())</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>tpa_file_obj<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">This function is used to track the offset within the binary vector as readBin </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">does not track position except for file objects</span>
    offset <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
    raw_vec_length <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>raw_vector<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">offset_readBin</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>raw_vec, what, n<span style="color: #00ffff;">=</span>n, size<span style="color: #00ffff;">=</span>size, increment_offset<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bin_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>raw_vec<span style="color: #20b2aa;">[</span>offset:<span style="color: #20b2aa;">(</span>n * size <span style="color: #00ffff;">+</span> offset<span style="color: #20b2aa;">)]</span>, what, n, size, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Use a global variable to track the offset</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>increment_offset<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span><span style="color: #ff6347;">assign</span><span style="color: #20b2aa;">(</span>offset, offset <span style="color: #00ffff;">+</span> <span style="color: #20b2aa;">(</span>size*n<span style="color: #20b2aa;">)</span>, inherits<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)}</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>bin_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">File header format is: nyears nptperyear rowstart rowstop colstart colstop</span>
    file_header <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #00ffff;">=</span><span style="color: #daa520;">6</span>, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    num_years <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    rowstart <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    rowstop <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span>
    colstart <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span>
    colstop <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">]</span>
    num_rows <span style="color: #00ffff;">&lt;-</span> rowstop <span style="color: #00ffff;">-</span> rowstart <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    num_cols <span style="color: #00ffff;">&lt;-</span> colstop <span style="color: #00ffff;">-</span> colstart <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    num_pixels <span style="color: #00ffff;">&lt;-</span> num_cols * num_rows
    tpa_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>nrow<span style="color: #00ffff;">=</span>num_pixels*max_num_seasons,
                       ncol<span style="color: #00ffff;">=</span><span style="color: #20b2aa;">(</span>LINE_HEADER_SIZE <span style="color: #00ffff;">+</span> NUM_SEASONAL_INDICATORS<span style="color: #20b2aa;">))</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Read the data and save it in the tpa_data matrix</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:num_pixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        line_header <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #00ffff;">=</span><span style="color: #daa520;">3</span>, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Line header format is: rownum colnum numseasons</span>
        num_seasons <span style="color: #00ffff;">&lt;-</span> line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>num_seasons <span style="color: #00ffff;">&gt;</span> max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'pixel'</span>, pixelnum, <span style="color: #00ff00;">'has'</span>, num_seasons,
                       <span style="color: #00ff00;">'seasons, but max_num_seasons was set to '</span>, max_num_seasons, 
                       <span style="color: #00ff00;">'seasons'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>num_seasons <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">No seasons identified for this pixel - skip</span>
            <span style="color: #ff00ff;">next</span>
        <span style="color: #20b2aa;">}</span>
        <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>seasonnum <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:max_num_seasons<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Seasons were found for this pixel - read them</span>
            tpa_data_row <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #00ffff;">-</span> <span style="color: #daa520;">1</span><span style="color: #20b2aa;">)</span>*num_seasons <span style="color: #00ffff;">+</span> seasonnum
            line_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">numeric</span><span style="color: #20b2aa;">()</span>, 
                                        n<span style="color: #00ffff;">=</span>NUM_SEASONAL_INDICATORS, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
            tpa_data<span style="color: #20b2aa;">[</span>tpa_data_row, <span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                          seasonnum, line_data<span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    tpa_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span>
    tpa_data <span style="color: #00ffff;">&lt;-</span> tpa_data<span style="color: #20b2aa;">[</span>!<span style="color: #20b2aa;">(</span><span style="color: #ff6347;">rowSums</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.na</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">))</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">))</span>, <span style="color: #20b2aa;">]</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>row, col, season, start, end, length,
                         base_value, peak_time, peak_value, amp, left_deriv,
                         right_deriv, large_integ, small_integ<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>tpa_data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-52" class="outline-2">
<h2 id="sec-52"><span class="section-number-2">52</span> tpadf2raster.R</h2>
<div class="outline-text-2" id="text-52">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Function to convert TIMESAT .tpa data.frame to an R raster. </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> A TPA data.frame as output by tpa</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">df</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">base_image</span><span style="color: #00bfff;"> A string giving the location of a raster file to use </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for georeferencing the output raster. Use one of the original raster files </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that was input to TIMESAT.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">variable</span><span style="color: #00bfff;"> A string giving the variable name to write to a raster.  Can </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> be one of: start, end, length, base_value, peak_time, peak_value, amp, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> left_deriv, right_deriv, large_integ, and small_integ.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A raster object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: Need to add examples here, and need to include a sample TIMESAT tpa </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # file in the package data.</span>
<span style="color: #ff6347;">tpadf2raster</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, base_image, variable<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a tpa data.frame'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a valid base image raster'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    var_col <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^'</span>, variable, <span style="color: #00ff00;">'$'</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>var_col<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>variable, <span style="color: #00ff00;">'not found in tpa dataframe'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    base_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> * <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> * <span style="color: #daa520;">2</span>
    seasons <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$season<span style="color: #20b2aa;">))</span>
    out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>season <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">sort</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span>x$season<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        season_data <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>x$season <span style="color: #00ffff;">==</span> season, <span style="color: #20b2aa;">]</span>
        data_matrix <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span>
        vector_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> * season_data$col<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> 
            <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> season_data$row<span style="color: #20b2aa;">)</span>
        data_matrix<span style="color: #20b2aa;">[</span>vector_indices<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> season_data<span style="color: #20b2aa;">[</span>, var_col<span style="color: #20b2aa;">]</span>
        out_raster <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>data_matrix, template<span style="color: #00ffff;">=</span>base_image<span style="color: #20b2aa;">)</span>
        out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out_rasters, out_raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'season_'</span>, seasons<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-53" class="outline-2">
<h2 id="sec-53"><span class="section-number-2">53</span> track<sub>time</sub>.R</h2>
<div class="outline-text-2" id="text-53">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> A class for tracking running time of individual sections of an R script</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> timers a \code{data.frame} tracking timer names and start times</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@slot</span><span style="color: #00bfff;"> notify function to use for outputting timers (defaults to </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{print}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> now</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> Track_time</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@name</span><span style="color: #00bfff;"> Track_time-class</span>
<span style="color: #ff6347;">setClass</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Track_time'</span>, slots<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>timers<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'data.frame'</span>, notify<span style="color: #00ffff;">=</span><span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">)</span>,
    prototype<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">(</span>timers<span style="color: #00ffff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Default'</span>, starttime<span style="color: #00ffff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">())</span>, 
                   notify<span style="color: #00ffff;">=</span>print<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Instantiate a new Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Creates a new Track_time object for use in tracking and printing status the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> running time of processes in an R script.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> Track_time</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> now</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">notify</span><span style="color: #00bfff;"> a function to handle the string output from Track_time.  This </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> function should accept a string as an argument. Default is the</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{print}} function.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{start_timer}}, \code{\link{stop_timer}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- Track_time()</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer)</span>
<span style="color: #ff6347;">Track_time</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>notify<span style="color: #00ffff;">=</span>print<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">new</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'Track_time'</span>,
               timers<span style="color: #00ffff;">=</span><span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Default'</span>, starttime<span style="color: #00ffff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">())</span>,
               notify<span style="color: #00ffff;">=</span>notify<span style="color: #20b2aa;">))</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Print a Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> now as.duration</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">label</span><span style="color: #00bfff;"> (optional) selects a specific tracking timer to print</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> ignored</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@method</span><span style="color: #00bfff;"> print Track_time</span>
<span style="color: #ff6347;">print.Track_time</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    timers <span style="color: #00ffff;">&lt;-</span> x@timers
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>label <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> timers$label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, label, <span style="color: #00ff00;">''</span>, <span style="color: #00ff00;">' timer not defined'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            timers <span style="color: #00ffff;">&lt;-</span> timers<span style="color: #20b2aa;">[</span>timers$label <span style="color: #00ffff;">==</span> label, <span style="color: #20b2aa;">]</span> 
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>timers<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
       x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>timers$label<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">'timer:'</span>,
                <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">-</span> timers$starttime<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">])</span>, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,
                <span style="color: #00ff00;">'elapsed'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>show, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>object<span style="color: #00ffff;">=</span>Track_time<span style="color: #20b2aa;">)</span>, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">print</span><span style="color: #20b2aa;">(</span>object<span style="color: #20b2aa;">))</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> now as.duration</span>
<span style="color: #ff6347;">.start_timer</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>label <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> x@timers$label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, label, <span style="color: #00ff00;">''</span>, <span style="color: #00ff00;">' timer already defined'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #20b2aa;">}</span>
        x@timers <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rbind</span><span style="color: #20b2aa;">(</span>x@timers, <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>label<span style="color: #00ffff;">=</span>label, starttime<span style="color: #00ffff;">=</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()))</span>
        x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #00ffff;">==</span> label<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">': started '</span>, label, <span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Default'</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>
        x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #00ffff;">==</span> Default<span style="color: #20b2aa;">]</span>, <span style="color: #00ff00;">': started'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Start a tracking timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The \code{label} is optional. If not supplied the default timer (labelled </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Default) will be used.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> start_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Track_time} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">label</span><span style="color: #00bfff;"> an optional label used to maintain multiple tracking timers</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{stop_timer}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- Track_time()</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- start_timer(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- stop_timer(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>start_timer<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> start_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> start_timer,Track_time-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>Track_time<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.start_timer</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> start_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> start_timer,Track_time,character-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>start_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>Track_time, label<span style="color: #00ffff;">=</span>character<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.start_timer</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">lubridate</span><span style="color: #00bfff;"> now as.duration</span>
<span style="color: #ff6347;">.stop_timer</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Default'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #20b2aa;">(</span>label <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> x@timers$label<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">''</span>, label, <span style="color: #00ff00;">''</span>, <span style="color: #00ff00;">' timer not defined'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    elapsed <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.duration</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span> <span style="color: #00ffff;">-</span> x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #00ffff;">==</span> label<span style="color: #20b2aa;">])</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>label <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Default'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Never delete the default timer. Only reset it.</span>
        x@timers$starttime<span style="color: #20b2aa;">[</span>x@timers$label <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'Default'</span><span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        x@timers <span style="color: #00ffff;">&lt;-</span> x@timers<span style="color: #20b2aa;">[</span>x@timers$label !<span style="color: #00ffff;">=</span> label, <span style="color: #20b2aa;">]</span> 
    <span style="color: #20b2aa;">}</span>
    x@<span style="color: #ff6347;">notify</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">now</span><span style="color: #20b2aa;">()</span>, <span style="color: #00ff00;">': finished '</span>, label, <span style="color: #00ff00;">' ('</span>, <span style="color: #ff6347;">round</span><span style="color: #20b2aa;">(</span>elapsed, <span style="color: #daa520;">3</span><span style="color: #20b2aa;">)</span>,<span style="color: #00ff00;">' elapsed)'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Stop a tracking timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> The \code{label} is optional. If not supplied, the default timer, labelled </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> 'Default' will be used.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> stop_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a \code{Track_time} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">label</span><span style="color: #00bfff;"> an optional label used to maintain multiple tracking timers</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@seealso</span><span style="color: #00bfff;"> \code{\link{start_timer}}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> Track_time object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- Track_time()</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- start_timer(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> timer &lt;- stop_timer(timer, 'test')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> print(timer)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Default'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>stop_timer<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> stop_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> stop_timer,Track_time-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>Track_time<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.stop_timer</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> stop_timer</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> stop_timer,Track_time,character-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>stop_timer, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>Track_time, label<span style="color: #00ffff;">=</span>character<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span> <span style="color: #ff6347;">.stop_timer</span><span style="color: #20b2aa;">(</span>x, label<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-54" class="outline-2">
<h2 id="sec-54"><span class="section-number-2">54</span> train<sub>classifier</sub>.R</h2>
<div class="outline-text-2" id="text-54">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Train a random forest or SVM classifier</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function trains a Support Vector Machine (SVM) or Random Forest (RF) </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classifier for use in an image classification.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> For \code{type='svm'}, \code{tunegrid} must be a \code{data.frame} with two </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> columns: .sigma and .C. For \code{type='rf'}, must be a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{data.frame} with one column: '.mtry'.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function will run in parallel if a parallel backend is registered with </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{\link{foreach}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> caret randomForest e</span><span style="color: #daa520;">1071</span><span style="color: #00bfff;"> kernlab</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">train_data</span><span style="color: #00bfff;"> a \code{link{pixel_data}} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">type</span><span style="color: #00bfff;"> either svm (to fit a support vector machine) or rf (to fit a</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> random forest).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">use_training_flag</span><span style="color: #00bfff;"> indicates whether to exclude data flagged as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> testing data when training the classifier. For this to work the input </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> train_data \code{data.frame} must have a column named 'training_flag' that </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> indicates, for each pixel, whether that pixel is a training pixel (coded as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> TRUE) or testing pixel (coded as FALSE).</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">train_control</span><span style="color: #00bfff;"> default is NULL (reasonable values will be set </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> automatically).  For details see \code{\link{trainControl}}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tune_grid</span><span style="color: #00bfff;"> the training grid to be used for training the classifier.  </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> See Details.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">use_rfe</span><span style="color: #00bfff;"> whether to use Recursive Feature Extraction (RFE) as </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> implemented in the \code{caret} package to select a subset of the input </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> features to be used in the classification. NOT YET SUPPORTED.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">factors</span><span style="color: #00bfff;"> a list of character vector giving the names of predictors </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> (layer names from the images used to build \code{train_data}) that should be </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> treated as factors, and specifying the levels of each factor. For example, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{factors=list(year=c(</span><span style="color: #daa520;">1990</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">1995</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2000</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2005</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">2010</span><span style="color: #00bfff;">))}.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">...</span><span style="color: #00bfff;"> additional arguments (such as \code{ntree} for random forest </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> classifier) to pass to \code{train}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> a trained model (as a \code{train} object from the \code{caret} </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> package)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> train_data &lt;- get_pixels(L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, L</span><span style="color: #daa520;">5</span><span style="color: #00bfff;">TSR_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">_</span><span style="color: #daa520;">2001</span><span style="color: #00bfff;">_training, class_</span><span style="color: #daa520;">1986</span><span style="color: #00bfff;">, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                          training=.</span><span style="color: #daa520;">6</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> model &lt;- train_classifier(train_data)</span>
<span style="color: #ff6347;">train_classifier</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>train_data, type<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'rf'</span>, use_training_flag<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>, 
                             train_control<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, tune_grid<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>,
                             use_rfe<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, factors<span style="color: #00ffff;">=</span><span style="color: #ff6347;">list</span><span style="color: #20b2aa;">()</span>, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'svm'</span>, <span style="color: #00ff00;">'rf'</span><span style="color: #20b2aa;">))</span>
    predictor_names <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Convert predictors in training data to factors as necessary</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">==</span> <span style="color: #daa520;">0</span> || <span style="color: #ff6347;">all</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">%</span><span style="color: #ff00ff;">in</span><span style="color: #00ffff;">%</span> predictor_names<span style="color: #20b2aa;">))</span>
    <span style="color: #ff6347;">stopifnot</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">unique</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">)))</span> <span style="color: #00ffff;">==</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>factor_var <span style="color: #ff00ff;">in</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>factors<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        pred_index <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">which</span><span style="color: #20b2aa;">(</span>predictor_names <span style="color: #00ffff;">==</span> factor_var<span style="color: #20b2aa;">)</span>
        train_data@x<span style="color: #20b2aa;">[</span>, pred_index<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">factor</span><span style="color: #20b2aa;">(</span>train_data@x<span style="color: #20b2aa;">[</span>, pred_index<span style="color: #20b2aa;">]</span>, 
                                             levels<span style="color: #00ffff;">=</span>factors<span style="color: #20b2aa;">[[</span>factor_var<span style="color: #20b2aa;">]])</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Build the formula, excluding the training flag column (if it exists) from </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">the model formula</span>
    model_formula <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">formula</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'y ~'</span>, <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>predictor_names, collapse<span style="color: #00ffff;">=</span><span style="color: #00ff00;">' + '</span><span style="color: #20b2aa;">)))</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>use_rfe<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'recursive feature extraction not yet supported'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">This recursive feature elimination procedure follows Algorithm </span><span style="color: #daa520;">19</span><span style="color: #00bfff;">.</span><span style="color: #daa520;">5</span><span style="color: #00bfff;"> </span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">in Kuhn and Johnson </span><span style="color: #daa520;">2013</span>
        svmFuncs <span style="color: #00ffff;">&lt;-</span> caretFuncs
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">First center and scale</span>
        normalization <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">preProcess</span><span style="color: #20b2aa;">(</span>train_data@x, method<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'range'</span><span style="color: #20b2aa;">)</span>
        scaled_predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">predict</span><span style="color: #20b2aa;">(</span>normalization, train_data@x<span style="color: #20b2aa;">)</span>
        scaled_predictors <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">as.data.frame</span><span style="color: #20b2aa;">(</span>scaled_predictors<span style="color: #20b2aa;">)</span>
        subsets <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>predictor_names<span style="color: #20b2aa;">))</span>
        ctrl <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rfeControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #00ffff;">=</span>repeatedcv,
                           repeats<span style="color: #00ffff;">=</span><span style="color: #daa520;">5</span>,
                           verbose<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span>,
                           functions<span style="color: #00ffff;">=</span>svmFuncs<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">For the rfe modeling, extract the training data from the main</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">train_data dataset - no need to pass the testing data to rfe</span>
        rfe_x <span style="color: #00ffff;">&lt;-</span> scaled_predictors<span style="color: #20b2aa;">[</span>train_data@training_flag, <span style="color: #20b2aa;">]</span>
        rfe_y <span style="color: #00ffff;">&lt;-</span> train_data@y<span style="color: #20b2aa;">[</span>train_data@training_flag, <span style="color: #20b2aa;">]</span>
        rfe_res <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">rfe</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span>rfe_x, rfe_y,
                       sizes<span style="color: #00ffff;">=</span>subsets,
                       metric<span style="color: #00ffff;">=</span>ROC,
                       rfeControl<span style="color: #00ffff;">=</span>ctrl,
                       method<span style="color: #00ffff;">=</span>svmRadial,
                       trControl<span style="color: #00ffff;">=</span>train_control,
                       tuneGrid<span style="color: #00ffff;">=</span>tune_grid<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;">#</span><span style="color: #00bfff;">TODO: Extract best model from rfe_res</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        rfe_res <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">NULL</span>
    <span style="color: #20b2aa;">}</span>
    train_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">cbind</span><span style="color: #20b2aa;">(</span>y<span style="color: #00ffff;">=</span>train_data@y,
                        train_data@x,
                        training_flag<span style="color: #00ffff;">=</span>train_data@training_flag,
                        poly_src<span style="color: #00ffff;">=</span>train_data@pixel_src$src,
                        poly_ID<span style="color: #00ffff;">=</span>train_data@pixel_src$ID<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'rf'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>train_control<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            train_control <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">trainControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #00ffff;">=</span>oob, classProbs<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">train</span><span style="color: #20b2aa;">(</span>model_formula, data<span style="color: #00ffff;">=</span>train_data, method<span style="color: #00ffff;">=</span>rf,
                       subset<span style="color: #00ffff;">=</span>train_data$training_flag,
                       trControl<span style="color: #00ffff;">=</span>train_control, tuneGrid<span style="color: #00ffff;">=</span>tune_grid, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>type <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'svm'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>train_control<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            train_control <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">trainControl</span><span style="color: #20b2aa;">(</span>method<span style="color: #00ffff;">=</span>cv, classProbs<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #20b2aa;">}</span>
        model <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">train</span><span style="color: #20b2aa;">(</span>model_formula, data<span style="color: #00ffff;">=</span>train_data, method<span style="color: #00ffff;">=</span>svmRadial,
                       preProc<span style="color: #00ffff;">=</span><span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'center'</span>, <span style="color: #00ff00;">'scale'</span><span style="color: #20b2aa;">)</span>, subset<span style="color: #00ffff;">=</span>train_data$training_flag,
                       trControl<span style="color: #00ffff;">=</span>train_control, tuneGrid<span style="color: #00ffff;">=</span>tune_grid, ...<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">should never get here</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>model type not recognized<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>model<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-55" class="outline-2">
<h2 id="sec-55"><span class="section-number-2">55</span> tts2df.R</h2>
<div class="outline-text-2" id="text-55">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Function to convert TIMESAT .tts binary format to an R dataframe.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> A .tts file output by TIMESAT</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A data.frame containing 'row' and 'col' columns giving the the row </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> and column of a pixel in the input image to timesat, and then a number of </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> columns named 't</span><span style="color: #daa520;">1</span><span style="color: #00bfff;">', 't</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">', ...'tn', where n is the total number of image </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> dates input to TIMESAT.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: Need to add examples here, and need to include a sample TIMESAT tts </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # file in the package data.</span>
<span style="color: #ff6347;">tts2df</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">grepl</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[.]tts$'</span>, <span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a .tts file'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Number of elements in the tts file line header (which are normally: row, </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">column).</span>
    LINE_HEADER_SIZE <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">2</span>
    tts_file_obj <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file</span><span style="color: #20b2aa;">(</span>x, rb<span style="color: #20b2aa;">)</span>
    raw_vector <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>tts_file_obj, n<span style="color: #00ffff;">=</span><span style="color: #ff6347;">file.info</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>$size, <span style="color: #ff6347;">raw</span><span style="color: #20b2aa;">())</span>
    <span style="color: #ff6347;">close</span><span style="color: #20b2aa;">(</span>tts_file_obj<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">This function is used to track the offset within the binary vector as readBin </span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">does not track position except for file objects</span>
    offset <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">1</span>
    raw_vec_length <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>raw_vector<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">offset_readBin</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>raw_vec, what, n<span style="color: #00ffff;">=</span>n, size<span style="color: #00ffff;">=</span>size, ...<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        bin_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">readBin</span><span style="color: #20b2aa;">(</span>raw_vec<span style="color: #20b2aa;">[</span>offset:<span style="color: #20b2aa;">(</span>n * size <span style="color: #00ffff;">+</span> offset<span style="color: #20b2aa;">)]</span>, what, n, size, ...<span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Be lazy and use a global variable to track the offset</span>
        <span style="color: #ff6347;">assign</span><span style="color: #20b2aa;">(</span>offset, offset <span style="color: #00ffff;">+</span> <span style="color: #20b2aa;">(</span>size*n<span style="color: #20b2aa;">)</span>, inherits<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>bin_data<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">File header format is: nyears nptperyear rowstart rowstop colstart colstop</span>
    file_header <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #00ffff;">=</span><span style="color: #daa520;">6</span>, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
    num_years <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>
    n_pts_per_year <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>
    rowstart <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">3</span><span style="color: #20b2aa;">]</span>
    rowstop <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">]</span>
    colstart <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">5</span><span style="color: #20b2aa;">]</span>
    colstop <span style="color: #00ffff;">&lt;-</span> file_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">]</span>
    num_pixels <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span>colstop <span style="color: #00ffff;">-</span> colstart<span style="color: #20b2aa;">)</span> * <span style="color: #20b2aa;">(</span>rowstop <span style="color: #00ffff;">-</span> rowstart<span style="color: #20b2aa;">)</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Include </span><span style="color: #daa520;">2</span><span style="color: #00bfff;"> extra columns to code the row and col IDs</span>
    tts_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span>nrow<span style="color: #00ffff;">=</span>num_pixels, ncol<span style="color: #00ffff;">=</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">2</span> <span style="color: #00ffff;">+</span> n_pts_per_year * num_years<span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>pixelnum <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:num_pixels<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        line_header <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">integer</span><span style="color: #20b2aa;">()</span>, n<span style="color: #00ffff;">=</span><span style="color: #daa520;">2</span>, size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">)</span>
        <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Line header format is: rownum colnum</span>
        tts_data<span style="color: #20b2aa;">[</span>pixelnum, <span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, line_header<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, 
                                  <span style="color: #ff6347;">offset_readBin</span><span style="color: #20b2aa;">(</span>raw_vector, <span style="color: #ff6347;">numeric</span><span style="color: #20b2aa;">()</span>, 
                                                 n<span style="color: #00ffff;">=</span>n_pts_per_year*num_years, 
                                                 size<span style="color: #00ffff;">=</span><span style="color: #daa520;">4</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
    tts_data <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">data.frame</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>row, col,
                         <span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'t'</span>, <span style="color: #ff6347;">seq</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">1</span>, n_pts_per_year*num_years<span style="color: #20b2aa;">)</span>, sep<span style="color: #00ffff;">=</span><span style="color: #00ff00;">''</span><span style="color: #20b2aa;">))</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>tts_data<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-56" class="outline-2">
<h2 id="sec-56"><span class="section-number-2">56</span> ttsdf2raster.R</h2>
<div class="outline-text-2" id="text-56">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Function to convert TIMESAT tts data.frame an R raster.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> A TTS data.frame as output by tts</span><span style="color: #daa520;">2</span><span style="color: #00bfff;">df</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">base_image</span><span style="color: #00bfff;"> A string giving the location of a raster file to use </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> for georeferencing the output raster. Use one of the original raster files </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> that was input to TIMESAT.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> A raster object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # TODO: Need to add examples here, and need to include a sample TIMESAT tpa </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # file in the package data.</span>
<span style="color: #ff6347;">ttsdf2raster</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, base_image<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">is.data.frame</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a tts data.frame'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">missing</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span> || !<span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'must specify a valid base image raster'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    t_cols <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">grep</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'^t[</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">]{</span><span style="color: #daa520;">1</span><span style="color: #00ff00;">,</span><span style="color: #daa520;">4</span><span style="color: #00ff00;">}$'</span>, <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    base_image <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>
    out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">()</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>t_col <span style="color: #ff00ff;">in</span> t_cols<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        this_time_data <span style="color: #00ffff;">&lt;-</span> x<span style="color: #20b2aa;">[</span>, t_col<span style="color: #20b2aa;">]</span>
        data_matrix <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">matrix</span><span style="color: #20b2aa;">(</span><span style="color: #daa520;">NA</span>, <span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">)</span>, <span style="color: #ff6347;">ncol</span><span style="color: #20b2aa;">(</span>base_image<span style="color: #20b2aa;">))</span>
        vector_indices <span style="color: #00ffff;">&lt;-</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> * x$col<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> 
            <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">nrow</span><span style="color: #20b2aa;">(</span>data_matrix<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">-</span> x$row<span style="color: #20b2aa;">)</span>
        data_matrix<span style="color: #20b2aa;">[</span>vector_indices<span style="color: #20b2aa;">]</span> <span style="color: #00ffff;">&lt;-</span> this_time_data
        out_raster <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">raster</span><span style="color: #20b2aa;">(</span>data_matrix, template<span style="color: #00ffff;">=</span>base_image<span style="color: #20b2aa;">)</span>
        out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">c</span><span style="color: #20b2aa;">(</span>out_rasters, out_raster<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_rasters <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">stack</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
    <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">names</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">[</span>t_cols<span style="color: #20b2aa;">])</span>
    <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span>out_rasters<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-57" class="outline-2">
<h2 id="sec-57"><span class="section-number-2">57</span> unstack<sub>ledapscdr</sub>.R</h2>
<div class="outline-text-2" id="text-57">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Convert Landsat CDR images from HDF</span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> to GeoTIFF format</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function converts a Landsat surface reflectance (SR) image from the </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Landsat Climate Data Record (CDR) archive into a series of single band </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> images in GeoTIFF format.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> This function uses \code{gdalUtils}, which requires a local GDAL </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> installation.  See http://trac.osgeo.org/gdal/wiki/DownloadingGdalBinaries </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> or http://trac.osgeo.org/osgeo</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">w/ to download the appropriate installer for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> your operating system.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">gdalUtils</span><span style="color: #00bfff;"> gdal_translate get_subdatasets</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">tools</span><span style="color: #00bfff;"> file_path_sans_ext</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> input HDF</span><span style="color: #daa520;">4</span><span style="color: #00bfff;"> file</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">output_folder</span><span style="color: #00bfff;"> output folder (if \code{NULL}, defaults to input folder)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">overwrite</span><span style="color: #00bfff;"> whether to overwrite existing files</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rmhdf</span><span style="color: #00bfff;"> whether to remove hdf files after unstacking them</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@return</span><span style="color: #00bfff;"> nothing (used for side effect of converting Landsat CDR HDF files)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \dontrun{</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Unstack files downloaded from CDR:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> unstack_ledapscdr('lndsr.LT</span><span style="color: #daa520;">50150531986021</span><span style="color: #00bfff;">XXX</span><span style="color: #daa520;">03</span><span style="color: #00bfff;">.hdf')</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # Unstack files downloaded from CDR, overwriting any existing files, and </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> # deleting original HDF files after unstacking:</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> unstack_ledapscdr('lndsr.LT</span><span style="color: #daa520;">50150531986021</span><span style="color: #00bfff;">XXX</span><span style="color: #daa520;">03</span><span style="color: #00bfff;">.hdf', overwrite=TRUE, </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;">                   rmhdf=TRUE)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> }</span>
<span style="color: #ff6347;">unstack_ledapscdr</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, output_folder<span style="color: #00ffff;">=</span><span style="color: #daa520;">NULL</span>, overwrite<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span>, 
                              rmhdf<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">is.null</span><span style="color: #20b2aa;">(</span>output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        output_folder <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">dirname</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">((</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-f'</span>, x<span style="color: #20b2aa;">))</span> | <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">tolower</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span> !<span style="color: #00ffff;">=</span> <span style="color: #00ff00;">'.hdf'</span><span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'x must be an existing file ending in .hdf'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>!<span style="color: #ff6347;">file_test</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'-d'</span>, output_folder<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'output_folder must be a directory'</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    out_basename <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">basename</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
    sds <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">get_subdatasets</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>
    loc <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">regexpr</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'[a-zA-Z</span><span style="color: #daa520;">0</span><span style="color: #00ff00;">-</span><span style="color: #daa520;">9</span><span style="color: #00ff00;">_-]*$'</span>, sds<span style="color: #20b2aa;">)</span>
    <span style="color: #ff00ff;">for</span> <span style="color: #20b2aa;">(</span>n <span style="color: #ff00ff;">in</span> <span style="color: #daa520;">1</span>:<span style="color: #ff6347;">length</span><span style="color: #20b2aa;">(</span>sds<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
        start_char <span style="color: #00ffff;">&lt;-</span> loc<span style="color: #20b2aa;">[</span>n<span style="color: #20b2aa;">]</span>
        stop_char <span style="color: #00ffff;">&lt;-</span> start_char <span style="color: #00ffff;">+</span> <span style="color: #ff6347;">attr</span><span style="color: #20b2aa;">(</span>loc, <span style="color: #00ff00;">'match.length'</span><span style="color: #20b2aa;">)[</span>n<span style="color: #20b2aa;">]</span>
        band_name <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">substr</span><span style="color: #20b2aa;">(</span>sds<span style="color: #20b2aa;">[[</span>n<span style="color: #20b2aa;">]]</span>, start_char, stop_char<span style="color: #20b2aa;">)</span>
        this_out <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.path</span><span style="color: #20b2aa;">(</span>output_folder, out_basename<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'_'</span>, band_name, <span style="color: #00ff00;">'.tif'</span><span style="color: #20b2aa;">)</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span>this_out<span style="color: #20b2aa;">))</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>overwrite<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span>this_out<span style="color: #20b2aa;">)</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'hdr'</span><span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'hdr'</span><span style="color: #20b2aa;">))</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'tif.aux.xml'</span><span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'tif.aux.xml'</span><span style="color: #20b2aa;">))</span>
                <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'tif.enp'</span><span style="color: #20b2aa;">)))</span> 
                    <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'tif.enp'</span><span style="color: #20b2aa;">))</span>
            <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
                <span style="color: #ff00ff;">warning</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #20b2aa;">(</span>this_out, <span style="color: #00ff00;">'already exists - skipping file'</span><span style="color: #20b2aa;">))</span>
                <span style="color: #ff00ff;">next</span>
            <span style="color: #20b2aa;">}</span>
        <span style="color: #20b2aa;">}</span>
        out_rast <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">gdal_translate</span><span style="color: #20b2aa;">(</span>x, of<span style="color: #00ffff;">=</span>GTiff, sd_index<span style="color: #00ffff;">=</span>n, this_out, 
                                   outRaster<span style="color: #00ffff;">=</span><span style="color: #daa520;">TRUE</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>rmhdf<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'hdf'</span><span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'hdf'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'hdr'</span><span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'hdr'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'.hdf.hdr'</span><span style="color: #20b2aa;">)))</span>
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file_path_sans_ext</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">)</span>, <span style="color: #00ff00;">'.hdf.hdr'</span><span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span><span style="color: #ff6347;">file.exists</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'txt'</span><span style="color: #20b2aa;">)))</span> 
            <span style="color: #ff6347;">unlink</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">extension</span><span style="color: #20b2aa;">(</span>x, <span style="color: #00ff00;">'txt'</span><span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-58" class="outline-2">
<h2 id="sec-58"><span class="section-number-2">58</span> utm<sub>zone</sub>.R</h2>
<div class="outline-text-2" id="text-58">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Given a spatial object, calculate the UTM zone of the centroid</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> For a line or polygon, the UTM zone of the centroid is given, after </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> reprojecting the object into WGS-</span><span style="color: #daa520;">84</span><span style="color: #00bfff;">.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> Based on the code on gis.stackexchange.com at http://bit.ly/</span><span style="color: #daa520;">17</span><span style="color: #00bfff;">SdcuN.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">@export</span><span style="color: #00bfff;"> utm_zone</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@import</span><span style="color: #00bfff;"> methods</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">x</span><span style="color: #00bfff;"> a longitude (with western hemisphere longitudes negative), or a </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> \code{Spatial} object</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">y</span><span style="color: #00bfff;"> a latitude (with southern hemisphere latitudes negative), or </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> missing (if x is a \code{Spatial} object)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@param</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">proj</span><span style="color: #daa520;">4</span><span style="color: #ffa500;">string</span><span style="color: #00bfff;"> if FALSE (default) return the UTM zone as a string (for </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> example </span><span style="color: #daa520;">34</span><span style="color: #00bfff;">S for UTM Zone </span><span style="color: #daa520;">34</span><span style="color: #00bfff;"> South). If TRUE, return a proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string using </span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> the EPSG code as an initialization string.</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@examples</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> utm_zone(</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> utm_zone(</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">, -</span><span style="color: #daa520;">10</span><span style="color: #00bfff;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> utm_zone(</span><span style="color: #daa520;">45</span><span style="color: #00bfff;">, </span><span style="color: #daa520;">10</span><span style="color: #00bfff;">, proj</span><span style="color: #daa520;">4</span><span style="color: #00bfff;">string=TRUE)</span>
<span style="color: #ff6347;">setGeneric</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #00ffff;">=</span><span style="color: #daa520;">FALSE</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff6347;">standardGeneric</span><span style="color: #20b2aa;">(</span>utm_zone<span style="color: #20b2aa;">)</span>
<span style="color: #20b2aa;">})</span>
<span style="color: #ff6347;">utm_zone_calc</span> <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">&lt;</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">180</span> || x <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>longitude must be between <span style="color: #00ffff;">-</span><span style="color: #daa520;">180</span> and <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #00ffff;">&lt;</span> <span style="color: #00ffff;">-</span><span style="color: #daa520;">90</span> || y <span style="color: #00ffff;">&gt;</span> <span style="color: #daa520;">90</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">stop</span><span style="color: #20b2aa;">(</span>latitude must be between <span style="color: #00ffff;">-</span><span style="color: #daa520;">90</span> and <span style="color: #daa520;">90</span><span style="color: #20b2aa;">)</span>
    <span style="color: #20b2aa;">}</span>
    zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">floor</span><span style="color: #20b2aa;">((</span>x <span style="color: #00ffff;">+</span> <span style="color: #daa520;">180</span><span style="color: #20b2aa;">)</span><span style="color: #00ffff;">/</span><span style="color: #daa520;">6</span><span style="color: #20b2aa;">)</span> <span style="color: #00ffff;">+</span> <span style="color: #daa520;">1</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">56</span>.<span style="color: #daa520;">0</span> &amp;&amp; y <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">64</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">3</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">12</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">32</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #00bfff;"># </span><span style="color: #00bfff;">Special zone_nums for Svalbard</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">72</span>.<span style="color: #daa520;">0</span> &amp;&amp; y <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">84</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">9</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">31</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">9</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">21</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">33</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">21</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">33</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">35</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>x <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">33</span>.<span style="color: #daa520;">0</span> &amp;&amp; x <span style="color: #00ffff;">&lt;</span> <span style="color: #daa520;">42</span>.<span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            zone_num <span style="color: #00ffff;">&lt;-</span> <span style="color: #daa520;">37</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>y <span style="color: #00ffff;">&gt;=</span> <span style="color: #daa520;">0</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        ns <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'N'</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        ns <span style="color: #00ffff;">&lt;-</span> <span style="color: #00ff00;">'S'</span>
    <span style="color: #20b2aa;">}</span>
    <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">if</span> <span style="color: #20b2aa;">(</span>ns <span style="color: #00ffff;">==</span> <span style="color: #00ff00;">'N'</span><span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'+init=epsg:</span><span style="color: #daa520;">326</span><span style="color: #00ff00;">'</span>, <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">02</span><span style="color: #00ff00;">i'</span>, zone_num<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
            <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'+init=epsg:</span><span style="color: #daa520;">327</span><span style="color: #00ff00;">'</span>, <span style="color: #ff6347;">sprintf</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'%</span><span style="color: #daa520;">02</span><span style="color: #00ff00;">i'</span>, zone_num<span style="color: #20b2aa;">)))</span>
        <span style="color: #20b2aa;">}</span>
    <span style="color: #20b2aa;">}</span> <span style="color: #ff00ff;">else</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">paste</span><span style="color: #daa520;">0</span><span style="color: #20b2aa;">(</span>zone_num, ns<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">}</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> utm_zone</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> utm_zone,numeric,numeric,logical-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>numeric, numeric<span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone_calc</span><span style="color: #20b2aa;">(</span>x, y, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@rdname</span><span style="color: #00bfff;"> utm_zone</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">rgeos</span><span style="color: #00bfff;"> gCentroid</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@importFrom</span><span style="color: #00bfff;"> </span><span style="color: #ffa500;">sp</span><span style="color: #00bfff;"> Spatial coordinates spTransform</span>
<span style="color: #00bfff; font-weight: bold;">#</span><span style="color: #00bfff; font-weight: bold;">'</span><span style="color: #00bfff;"> </span><span style="color: #ff00ff;">@aliases</span><span style="color: #00bfff;"> utm_zone,Spatial,missing,logical-method</span>
<span style="color: #ff6347;">setMethod</span><span style="color: #20b2aa;">(</span>utm_zone, <span style="color: #ff6347;">signature</span><span style="color: #20b2aa;">(</span>x<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'Spatial'</span>, y<span style="color: #00ffff;">=</span><span style="color: #00ff00;">'missing'</span><span style="color: #20b2aa;">)</span>,
    <span style="color: #ff00ff;">function</span><span style="color: #20b2aa;">(</span>x, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">)</span> <span style="color: #20b2aa;">{</span>
        x <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">spTransform</span><span style="color: #20b2aa;">(</span>x, <span style="color: #ff6347;">CRS</span><span style="color: #20b2aa;">(</span><span style="color: #00ff00;">'+init=epsg:</span><span style="color: #daa520;">4236</span><span style="color: #00ff00;">'</span><span style="color: #20b2aa;">))</span>
        centroid <span style="color: #00ffff;">&lt;-</span> <span style="color: #ff6347;">coordinates</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">gCentroid</span><span style="color: #20b2aa;">(</span>x<span style="color: #20b2aa;">))</span>
        <span style="color: #ff00ff;">return</span><span style="color: #20b2aa;">(</span><span style="color: #ff6347;">utm_zone_calc</span><span style="color: #20b2aa;">(</span>centroid<span style="color: #20b2aa;">[</span><span style="color: #daa520;">1</span><span style="color: #20b2aa;">]</span>, centroid<span style="color: #20b2aa;">[</span><span style="color: #daa520;">2</span><span style="color: #20b2aa;">]</span>, proj<span style="color: #daa520;">4</span>string<span style="color: #20b2aa;">))</span>
    <span style="color: #20b2aa;">}</span>
<span style="color: #20b2aa;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
    <p class="postamble">Last Updated .</p> 
</div>
</body>
</html>
